<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Arkeo Marketplace | Sentinel Management</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="images/favicon.ico">
    <link rel="shortcut icon" href="images/favicon.ico">
</head>
<body>

<div id="resultModal" class="overlay hidden">
    <div class="overlay-card modal-card fixed-modal">
        <h3 id="modalTitle">Result</h3>
        <div id="modalBody" class="modal-body scroll-body"></div>
        <div class="modal-actions">
            <button id="modalCloseBtn" class="primary" type="button" onclick="closeModal()" disabled>OK</button>
        </div>
    </div>
</div>

<div class="card header-card">
    <div class="row-between header-top">
        <div class="header-left">
            <div class="header-brand-row">
                <img src="images/arkeo-logo-200px_1.png" alt="Arkeo" class="header-logo">
                <div class="header-brand">
                    <span class="brand-main">Arkeo Marketplace</span>
                    <span class="brand-sep">|</span>
                    <span class="brand-sub">Provider Manager</span>
                </div>
            </div>
            <h1>Sentinel Management</h1>
        </div>
        <div class="header-right header-right-with-actions">
            <a class="btn-ghost" href="index.html">Back to Dashboard</a>
        </div>
    </div>
</div>

<div class="card">
    <div class="row-between">
        <div class="inline">
            <h2 class="mt-0">Sentinel Settings</h2>
            <span id="refreshPill" class="status-badge status-warn hidden">Refreshing…</span>
        </div>
    </div>
    <table>
        <tr>
            <td class="label">
                Provider Name
                <div class="hint">Moniker/label for this sentinel.</div>
            </td>
            <td class="value">
                <input type="text" id="providerName" />
            </td>
        </tr>
        <tr>
            <td class="label">
                Moniker
                <div class="hint">Display moniker for this provider.</div>
            </td>
            <td class="value">
                <input type="text" id="moniker" />
            </td>
        </tr>
        <tr>
            <td class="label">
                Website
                <div class="hint">Public website URL.</div>
            </td>
            <td class="value">
                <input type="text" id="website" />
            </td>
        </tr>
        <tr>
            <td class="label">
                Description
                <div class="hint">Provider description.</div>
            </td>
            <td class="value">
                <input type="text" id="description" />
            </td>
        </tr>
        <tr>
            <td class="label">
                Location
                <div class="hint">Select the region for this sentinel/provider.</div>
            </td>
            <td class="value">
                <select id="locationSelect" required>
                    <option value="">Select a region</option>
                <option>Africa</option>
                <option>Africa – Northern</option>
                <option>Africa – Eastern</option>
                <option>Africa – Middle</option>
                <option>Africa – Western</option>
                    <option>Africa – Southern</option>
                    <option>Americas</option>
                    <option>Americas – Northern</option>
                    <option>Americas – Caribbean</option>
                    <option>Americas – Central</option>
                    <option>Americas – South</option>
                    <option>Asia</option>
                    <option>Asia – Central</option>
                    <option>Asia – Eastern</option>
                    <option>Asia – Southeastern</option>
                    <option>Asia – Southern</option>
                    <option>Asia – Western</option>
                    <option>Europe</option>
                    <option>Europe – Northern</option>
                    <option>Europe – Eastern</option>
                    <option>Europe – Southern</option>
                    <option>Europe – Western</option>
                    <option>Oceania</option>
                    <option>Oceania – Australia &amp; New Zealand</option>
                    <option>Oceania – Melanesia</option>
                    <option>Oceania – Micronesia</option>
                    <option>Oceania – Polynesia</option>
                    <option>Antarctica</option>
                </select>
            </td>
        </tr>
        <tr>
            <td class="label">
                Free Rate Limit
                <div class="hint">Number of free requests allowed per duration.</div>
            </td>
            <td class="value">
                <input type="text" id="freeRateLimit" />
            </td>
        </tr>
        <tr>
            <td class="label">
                Free Rate Limit Duration
                <div class="hint">Duration window for the free rate limit (e.g. 1m).</div>
            </td>
            <td class="value">
                <input type="text" id="freeRateLimitDuration" />
            </td>
        </tr>
        <tr>
            <td class="label">
                Provider Pubkey
                <div class="hint">Bech32 provider pubkey used on-chain.</div>
            </td>
            <td class="value">
                <span id="providerPubkey">(loading...)</span>
            </td>
        </tr>
        <tr>
            <td class="label">
                Listen Address
                <div class="hint">Sentinel API listen address (read-only).</div>
            </td>
            <td class="value"><span id="listenAddr">(loading...)</span></td>
        </tr>
        <tr>
            <td class="label">
                Sentinel URI
                <div class="hint">Endpoint for the sentinel (External).</div>
            </td>
            <td class="value"><span id="sentinelUri">(loading...)</span></td>
        </tr>
        <tr>
            <td class="label">
                Arkeod Node
                <div class="hint">RPC endpoint sentinel watches for events.</div>
            </td>
            <td class="value"><span id="arkeodNode">(loading...)</span></td>
        </tr>
        <tr>
            <td class="label">
                Hotwallet Key
                <div class="hint">Configured provider key name.</div>
            </td>
            <td class="value"><span id="walletKey">(loading...)</span></td>
        </tr>
        <tr>
            <td class="label">
                Hotwallet Pubkey
                <div class="hint">Bech32 pubkey used on-chain.</div>
            </td>
            <td class="value"><span id="bech32Pubkey">(loading...)</span></td>
        </tr>
        <tr>
            <td colspan="2" class="text-left pt-12 no-border">
                <button class="primary" id="saveSentinelBtn" onclick="saveConfig()">Save Sentinel Config</button>
            </td>
        </tr>
    </table>
    <pre id="saveResult" class="hidden"></pre>
</div>

<div class="card footer-card">
    <div class="footer-links">
        <div class="footer-brand">
            <img src="images/arkeo-logo-200px_1.png" alt="Arkeo" class="footer-logo">
            <span class="footer-title">
                <span class="brand-main">Arkeo Marketplace</span>
                <span class="brand-sep">|</span>
                <span class="brand-sub">Provider Manager</span>
            </span>
        </div>
        <div class="footer-links-right">
            <div><a href="https://arkeo.network/" target="_blank" rel="noopener">Arkeo Marketplace Website</a></div>
            <div><a href="https://discord.gg/arkeo" target="_blank" rel="noopener">Arkeo Discord</a></div>
        </div>
    </div>
</div>

<div class="card">

    <h3>Debug Info</h3>

    <button class="primary" onclick="loadInfo()">Refresh</button>
    <pre id="sentinelMeta">(loading...)</pre>
    <pre id="exportResult" class="pre-wrap"></pre>

    <div class="panel mt-14">
        <h3>Sentinel YAML</h3>
        <div class="hint">provider + services from sentinel.yaml</div>
        <pre id="sentinelYaml">(loading...)</pre>
    </div>

    <div class="panel mt-14">
        <h3>Sentinel Metadata</h3>
        <div class="hint">metadata.json from the sentinel endpoint</div>
        <pre id="debugInfo">Loading...</pre>
    </div>

</div>

<script>
    let DEFAULT_ADMIN_API_PORT = (() => {
        try {
            const u = new URL(window.location.href);
            return u.searchParams.get("api_port") || "9999";
        } catch (e) {
            return "9999";
        }
    })();
    let adminHost = (window.location && window.location.hostname) || "localhost";
    let adminApiBase = buildBaseUrl(adminHost, DEFAULT_ADMIN_API_PORT);
    async function loadRuntimePorts() {
        try {
            const res = await fetch("/runtime-ports.json", { cache: "no-store" });
            if (res.ok) {
                const data = await res.json();
                if (data && data.ADMIN_API_PORT) {
                    DEFAULT_ADMIN_API_PORT = String(data.ADMIN_API_PORT);
                    adminApiBase = buildBaseUrl(adminHost, DEFAULT_ADMIN_API_PORT);
                }
            }
        } catch (e) {
            // ignore
        }
    }
    let adminPasswordEnabled = false;
    let adminSessionAuthed = false;
    function requirePasswordGate() {
        sessionStorage.removeItem("adminAuthed");
        adminSessionAuthed = false;
        const gate = document.getElementById("adminPasswordGate");
        if (gate) gate.classList.remove("hidden");
    }
    const realFetch = window.fetch.bind(window);
    window.fetch = (url, options = {}) =>
        realFetch(url, { credentials: "include", ...options }).then((resp) => {
            if (resp && resp.status === 401) {
                requirePasswordGate();
            }
            return resp;
        });

    function resetModal(title, body) {
        const modal = document.getElementById("resultModal");
        const modalTitle = document.getElementById("modalTitle");
        const modalBody = document.getElementById("modalBody");
        if (modalTitle) modalTitle.textContent = title || "Result";
        if (modalBody) modalBody.textContent = body || "";
        setModalCloseEnabled(false);
        if (modal) modal.style.display = "flex";
    }

    function appendModalLine(text) {
        const modalBody = document.getElementById("modalBody");
        if (!modalBody) return;
        const current = modalBody.textContent || "";
        modalBody.textContent = current ? `${current}\n${text}` : text;
        modalBody.scrollTop = modalBody.scrollHeight;
    }

    function setModalCloseEnabled(enabled) {
        const btn = document.getElementById("modalCloseBtn");
        if (!btn) return;
        btn.disabled = !enabled;
        if (enabled) btn.removeAttribute("disabled");
        else btn.setAttribute("disabled", "disabled");
    }

    function closeModal() {
        const modal = document.getElementById("resultModal");
        if (modal) modal.style.display = "none";
        window.location.href = "index.html";
    }

    function buildBaseUrl(host, port) {
        const proto = (window.location && window.location.protocol === "https:") ? "https:" : "http:";
        const cleaned = (host || "").replace(/^https?:\/\//, "").replace(/\/+$/, "");
        return `${proto}//${cleaned}${port ? `:${port}` : ""}`;
    }

    function extractHostFromValue(val) {
        if (!val) return "";
        try {
            const u = val.startsWith("http") ? new URL(val) : new URL(`http://${val}`);
            return u.hostname || "";
        } catch (e) {
            return "";
        }
    }

    function setAdminHost(candidateHost) {
        // Keep adminApiBase anchored to the page host; do not override.
        return;
    }

    function resolveApi(path) {
        if (!path.startsWith("/")) path = `/${path}`;
        return `${adminApiBase}${path}`;
    }

    async function detectAdminApiBase() {
        const tried = new Set();
        let apiHostOverride = null;
        let apiPortOverride = null;
        try {
            const u = new URL(window.location.href);
            apiHostOverride = u.searchParams.get("api_host") || null;
            apiPortOverride = u.searchParams.get("api_port") || null;
        } catch (e) {}
        if (apiPortOverride) {
            adminApiBase = buildBaseUrl(apiHostOverride || adminHost, apiPortOverride);
            return;
        }
        const candidatePorts = [DEFAULT_ADMIN_API_PORT].filter(Boolean);
        for (const port of candidatePorts) {
            const base = buildBaseUrl(apiHostOverride || adminHost, port);
            if (tried.has(base)) continue;
            tried.add(base);
            try {
                const res = await fetch(`${base}/api/ping`, { cache: "no-store" });
                if (res.ok) {
                    adminApiBase = base;
                    return;
                }
            } catch (e) {
                continue;
            }
        }
        // fallback: keep existing adminApiBase
    }

    async function loadInfo() {
        const debug = document.getElementById("debugInfo");
        const pill = document.getElementById("refreshPill");
        if (pill) pill.style.display = "inline-block";
        debug.textContent = "Loading...";
        try {
            // Use loopback for metadata fetch in the form to avoid external loopback issues
            const [provRes, cfgRes, metaRes, settingsRes] = await Promise.all([
                fetch(resolveApi("/api/provider-info")),
                fetch(resolveApi("/api/sentinel-config")),
                fetch(resolveApi("/api/sentinel-metadata?loopback=1")),
                fetch(resolveApi("/api/provider-settings"), { cache: "no-store" }),
            ]);
            const prov = await provRes.json();
            const cfg = await cfgRes.json();
            const meta = await metaRes.json();
            const providerSettings = settingsRes.ok ? await settingsRes.json() : {};
            const ps = (providerSettings && providerSettings.settings) || providerSettings || {};
            const metaCfg = (meta && meta.metadata && meta.metadata.config) || (meta && meta.config) || {};
            const settingsNode = (ps && ps.ARKEOD_NODE) || "";
            const settingsSentinelBase = (ps && ps.SENTINEL_NODE) || "";
            const settingsSentinelPort = (ps && ps.SENTINEL_PORT) || "";
            const ensureMetadataSuffix = (val) => {
                if (!val) return val;
                const trimmed = val.replace(/\/+$/, "");
                if (trimmed.toLowerCase().endsWith("/metadata.json")) return trimmed;
                return `${trimmed}/metadata.json`;
            };
            let sentinelFromSettings = settingsSentinelBase ? settingsSentinelBase.replace(/\/+$/, "") : "";
            if (sentinelFromSettings && settingsSentinelPort) {
                sentinelFromSettings = `${sentinelFromSettings}:${settingsSentinelPort}`;
            }
            const sentinelUriVal = sentinelFromSettings ? ensureMetadataSuffix(sentinelFromSettings) : "(not set)";
            const nodeVal = settingsNode || "(not set)";
            document.getElementById("sentinelUri").textContent = sentinelUriVal;
            document.getElementById("arkeodNode").textContent = nodeVal;

            if (provRes.ok) {
                document.getElementById("walletKey").textContent = prov.user || "(not set)";
                document.getElementById("bech32Pubkey").textContent =
                    (prov.pubkey && prov.pubkey.bech32) || prov.pubkey_error || "(not set)";
                if (sentinelUriVal && sentinelUriVal !== "(not set)") setAdminHost(sentinelUriVal);
            }

            const yamlEl = document.getElementById("sentinelYaml");
            if (cfg.raw) {
                yamlEl.textContent = cfg.raw;
            } else {
                yamlEl.textContent = "(no sentinel.yaml found)";
            }

            // Inputs
            const providerCfg = (cfg.config && cfg.config.provider) || {};
            const apiCfg = (cfg.config && cfg.config.api) || {};
            const envFile = cfg.env_file || {};
            const pick = (...vals) => vals.find(v => v !== undefined && v !== null && `${v}`.trim() !== "");
            const defaultListenPort = settingsSentinelPort || "3636";
            const metaFreeRate = pick(metaCfg.free_tier_rate_limit, metaCfg.free_rate_limit, metaCfg.freeRateLimit);
            const metaFreeDur = pick(metaCfg.free_tier_rate_limit_duration, metaCfg.free_rate_limit_duration, metaCfg.freeRateLimitDuration);
            document.getElementById("providerName").value = pick(metaCfg.provider_name, providerCfg.name, envFile.PROVIDER_NAME, "");
            document.getElementById("providerPubkey").textContent = pick(metaCfg.provider_pubkey, providerCfg.pubkey, prov.pubkey && prov.pubkey.bech32, "(not set)");
            document.getElementById("listenAddr").textContent = pick(
                apiCfg.listen_addr,
                metaCfg.port && `0.0.0.0:${metaCfg.port}`,
                `0.0.0.0:${defaultListenPort}`
            );
            document.getElementById("moniker").value = pick(metaCfg.moniker, envFile.MONIKER, "");
            document.getElementById("website").value = pick(metaCfg.website, envFile.WEBSITE, "");
            document.getElementById("description").value = pick(metaCfg.description, envFile.DESCRIPTION, "");
            let locVal = pick(metaCfg.location, envFile.LOCATION, "");
            if (locVal && locVal.trim().toLowerCase() === "default location") {
                locVal = "";
            }
            const locSelect = document.getElementById("locationSelect");
            if (locSelect) {
                const exists = Array.from(locSelect.options).some(opt => opt.value === locVal);
                // If the location is missing or not in the allowed list, reset to placeholder.
                if (!locVal || !exists) {
                    locVal = "";
                }
                locSelect.value = locVal;
                // If no location is set, ensure placeholder stays selected
                if (!locVal || locSelect.selectedIndex === -1) {
                    locSelect.selectedIndex = 0;
                }
            }
            document.getElementById("freeRateLimit").value = pick(metaFreeRate, envFile.FREE_RATE_LIMIT, "");
            document.getElementById("freeRateLimitDuration").value = pick(metaFreeDur, envFile.FREE_RATE_LIMIT_DURATION, "");

            // metadata view
            document.getElementById("sentinelMeta").textContent = JSON.stringify(meta, null, 2);
            debug.textContent = JSON.stringify({ provider_info: prov, sentinel_config: cfg, sentinel_metadata: meta }, null, 2);
        } catch (e) {
            debug.textContent = "Failed to load info: " + e;
        } finally {
            if (pill) pill.style.display = "none";
        }
    }

    async function fetchAdminPasswordStatus(showGate = true) {
        try {
            const res = await fetch(resolveApi("/api/session"), { cache: "no-store" });
            const data = await res.json();
            adminPasswordEnabled = !!(data && data.enabled);
            adminSessionAuthed = !!(data && data.authed);
        } catch (e) {
            // ignore
        }
        if (adminPasswordEnabled && !adminSessionAuthed) {
            sessionStorage.removeItem("adminAuthed");
        }
        const gateAuthed = sessionStorage.getItem("adminAuthed") === "1" || adminSessionAuthed;
        const gate = document.getElementById("adminPasswordGate");
        if (gate) {
            if (showGate && adminPasswordEnabled && !gateAuthed) {
                gate.classList.remove("hidden");
            } else {
                gate.classList.add("hidden");
            }
        }
    }

    async function submitAdminPasswordGate(event) {
        if (event && event.preventDefault) event.preventDefault();
        const input = document.getElementById("adminPasswordGateInput");
        const statusEl = document.getElementById("adminPasswordGateStatus");
        const pwd = (input && input.value) || "";
        if (statusEl) statusEl.textContent = "Verifying...";
        try {
            const res = await fetch(resolveApi("/api/login"), {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ password: pwd }),
            });
            const data = await res.json();
            if (data && data.ok) {
                sessionStorage.setItem("adminAuthed", "1");
                adminSessionAuthed = true;
                const gate = document.getElementById("adminPasswordGate");
                if (gate) gate.classList.add("hidden");
                if (statusEl) statusEl.textContent = "";
                window.location.href = "index.html";
            } else if (statusEl) {
                statusEl.textContent = "Incorrect password.";
            }
        } catch (e) {
            if (statusEl) statusEl.textContent = `Failed to verify: ${e}`;
        }
    }

    async function saveConfig() {
        const payload = {
            provider_name: document.getElementById("providerName").value.trim(),
            moniker: document.getElementById("moniker").value.trim(),
            website: document.getElementById("website").value.trim(),
            description: document.getElementById("description").value.trim(),
            location: (() => {
                const select = document.getElementById("locationSelect");
                const v = (select && select.value ? select.value : "").trim();
                // Only allow values from the dropdown; otherwise treat as unset.
                const allowed = select ? Array.from(select.options).map(o => o.value) : [];
                if (!v || v.toLowerCase() === "default location" || (allowed.length && !allowed.includes(v))) {
                    return "";
                }
                return v;
            })(),
            free_rate_limit: document.getElementById("freeRateLimit").value.trim(),
            free_rate_limit_duration: document.getElementById("freeRateLimitDuration").value.trim(),
        };
        const locSelect = document.getElementById("locationSelect");
        if (!payload.location || (locSelect && (locSelect.selectedIndex === 0 || !locSelect.value.trim()))) {
            alert("Please select a location.");
            return;
        }
        const btn = document.getElementById("saveSentinelBtn");
        if (btn) { btn.disabled = true; btn.textContent = "Saving..."; }
        resetModal("Save Sentinel Config", "Starting save...");
        const resEl = document.getElementById("saveResult");
        if (resEl) {
            resEl.style.display = "none";
            resEl.textContent = "";
        }
        appendModalLine("Preparing payload...");
        appendModalLine("Saving sentinel config (this may restart the sentinel)...");
        try {
            appendModalLine("Sending request to admin API...");
            const res = await fetch(resolveApi("/api/sentinel-config"), {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
            });
            const data = await res.json();
            if (res.ok) {
                appendModalLine("Saved sentinel config successfully.");
                appendModalLine("Response:");
                appendModalLine(JSON.stringify(data, null, 2));
                appendModalLine("");
                appendModalLine("Sentinel update completed. Allow a few seconds for the Sentinel to come back up.");
                setModalCloseEnabled(true);
            }
            else {
                appendModalLine("Error while saving:");
                appendModalLine(JSON.stringify(data, null, 2));
                setModalCloseEnabled(true);
            }
        } catch (e) {
            appendModalLine("Request failed: " + e);
            setModalCloseEnabled(true);
        } finally {
            if (btn) { btn.disabled = false; btn.textContent = "Save Sentinel Config"; }
        }
    }

    window.addEventListener("load", async () => {
        await loadRuntimePorts();
        await detectAdminApiBase();
        fetchAdminPasswordStatus(true);
        loadInfo();
    });
</script>

<div id="adminPasswordGate" class="overlay overlay-strong hidden">
    <div class="overlay-card password-card">
        <div class="password-title">
            <span>Arkeo Data Marketplace</span>
            <span class="sep">|</span>
            <span class="sub">Provider Manager</span>
        </div>
        <form onsubmit="submitAdminPasswordGate(event); return false;">
            <div class="password-body">
                <h3 class="mt-6 mb-0">Password Required</h3>
                <p class="muted">Enter the admin password to continue.</p>
                <input type="text" name="admin-username-filler" autocomplete="username" value="admin" class="hidden" aria-hidden="true" tabindex="-1" />
                <input type="password" id="adminPasswordGateInput" autocomplete="current-password" placeholder="Admin password" />
            </div>
            <div class="actions center mt-6">
                <button class="primary" type="submit">Unlock</button>
            </div>
            <div id="adminPasswordGateStatus" class="muted mt-6"></div>
        </form>
    </div>
</div>

</body>
</html>

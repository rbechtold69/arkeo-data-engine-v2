<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ArkAuth Test — Arkeo Marketplace</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #0a0a0f;
      color: #e0e0e0;
      min-height: 100vh;
      padding: 2rem;
    }
    .container { max-width: 700px; margin: 0 auto; }
    h1 {
      font-size: 1.8rem;
      margin-bottom: 0.5rem;
      background: linear-gradient(135deg, #ff6b6b, #ff8e53);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .subtitle { color: #888; margin-bottom: 2rem; font-size: 0.9rem; }
    .card {
      background: #14141f;
      border: 1px solid #2a2a3a;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    label { display: block; color: #aaa; font-size: 0.8rem; margin-bottom: 0.3rem; text-transform: uppercase; letter-spacing: 0.05em; }
    input, select {
      width: 100%;
      padding: 0.7rem 1rem;
      background: #1a1a2e;
      border: 1px solid #2a2a3a;
      border-radius: 8px;
      color: #e0e0e0;
      font-size: 0.95rem;
      margin-bottom: 1rem;
      outline: none;
      transition: border-color 0.2s;
    }
    input:focus { border-color: #ff8e53; }
    .btn {
      display: inline-block;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s, transform 0.1s;
      color: #fff;
    }
    .btn:hover { opacity: 0.9; }
    .btn:active { transform: scale(0.98); }
    .btn-primary {
      background: linear-gradient(135deg, #ff6b6b, #ff8e53);
    }
    .btn-secondary {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
    }
    .btn + .btn { margin-left: 0.75rem; }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .status {
      display: inline-block;
      padding: 0.3rem 0.8rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }
    .status-disconnected { background: #3a1a1a; color: #ff6b6b; }
    .status-connected { background: #1a3a1a; color: #6bff6b; }
    .output {
      background: #0d0d15;
      border: 1px solid #2a2a3a;
      border-radius: 8px;
      padding: 1rem;
      font-family: 'JetBrains Mono', 'Fira Code', monospace;
      font-size: 0.8rem;
      line-height: 1.6;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 400px;
      overflow-y: auto;
      color: #9ca3af;
    }
    .output .label { color: #ff8e53; }
    .output .ok { color: #6bff6b; }
    .output .err { color: #ff6b6b; }
    .row { display: flex; gap: 1rem; }
    .row > * { flex: 1; }
    .help { color: #666; font-size: 0.75rem; margin-top: -0.7rem; margin-bottom: 1rem; }
  </style>
</head>
<body>
  <div class="container">
    <h1>⚡ ArkAuth Tester</h1>
    <p class="subtitle">Test PAYG contract authentication against an Arkeo sentinel</p>

    <!-- Wallet -->
    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;">
        <span style="font-weight:600;">Wallet</span>
        <span id="walletStatus" class="status status-disconnected">Disconnected</span>
      </div>
      <label>Chain ID</label>
      <input id="chainId" value="arkeo-main-v1" placeholder="arkeo-main-v1">
      <button id="connectBtn" class="btn btn-secondary">Connect Keplr</button>
      <div id="walletInfo" style="margin-top:0.75rem;font-size:0.85rem;color:#888;"></div>
    </div>

    <!-- Request -->
    <div class="card">
      <span style="font-weight:600;display:block;margin-bottom:1rem;">Request</span>
      <label>Sentinel URL</label>
      <input id="sentinelUrl" value="https://red5-arkeo.duckdns.org" placeholder="https://sentinel.example.com:3636">
      <label>Service</label>
      <input id="service" value="arkeo-mainnet-fullnode" placeholder="arkeo-mainnet-fullnode">
      <div class="row">
        <div>
          <label>Contract ID</label>
          <input id="contractId" type="number" value="911" placeholder="42">
        </div>
        <div>
          <label>Nonce</label>
          <input id="nonce" type="number" value="1" placeholder="1">
          <p class="help">Must be greater than last used nonce</p>
        </div>
      </div>
      <button id="testBtn" class="btn btn-primary" disabled>Test Request</button>
      <button id="genBtn" class="btn btn-secondary" disabled>Generate Only</button>
    </div>

    <!-- Output -->
    <div class="card">
      <span style="font-weight:600;display:block;margin-bottom:1rem;">Output</span>
      <div id="output" class="output"><span style="color:#666;">Connect wallet and send a request to see results…</span></div>
    </div>
  </div>

  <script src="js/arkauth.js"></script>
  <script>
    let signerFn = null;
    let walletAddress = '';
    let pubKeyBech32 = '';

    const $ = id => document.getElementById(id);
    const output = $('output');

    function log(label, value, cls = '') {
      const span = document.createElement('span');
      span.innerHTML = `<span class="label">${label}:</span> <span class="${cls}">${escHtml(value)}</span>\n`;
      output.appendChild(span);
      output.scrollTop = output.scrollHeight;
    }

    function escHtml(s) {
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    function clearOutput() { output.innerHTML = ''; }

    // Connect Keplr
    $('connectBtn').addEventListener('click', async () => {
      clearOutput();
      log('Action', 'Connecting to Keplr…');
      try {
        const chainId = $('chainId').value.trim();
        const result = await ArkAuth.getKeplrSigner(chainId);
        signerFn = result.signerFn;
        walletAddress = result.address;
        pubKeyBech32 = result.pubKeyBech32;

        $('walletStatus').textContent = 'Connected';
        $('walletStatus').className = 'status status-connected';
        $('walletInfo').textContent = `Address: ${walletAddress}`;
        $('testBtn').disabled = false;
        $('genBtn').disabled = false;

        log('Status', 'Keplr connected', 'ok');
        log('Address', walletAddress);
        log('PubKey', pubKeyBech32);
      } catch (err) {
        log('Error', err.message, 'err');
      }
    });

    // Generate only
    $('genBtn').addEventListener('click', async () => {
      clearOutput();
      try {
        const contractId = $('contractId').value.trim();
        const nonce = $('nonce').value.trim();
        log('Preimage', ArkAuth.buildPreimage(contractId, nonce));
        const arkauth = await ArkAuth.generateArkAuth(contractId, nonce, signerFn);
        log('ArkAuth', arkauth, 'ok');
      } catch (err) {
        log('Error', err.message, 'err');
      }
    });

    // Test request (uses 4-part arkauth with spender pubkey for delegate contracts)
    $('testBtn').addEventListener('click', async () => {
      clearOutput();
      try {
        const sentinelUrl = $('sentinelUrl').value.trim();
        const service = $('service').value.trim();
        const contractId = $('contractId').value.trim();
        const nonce = $('nonce').value.trim();

        log('Action', 'Signing and sending request…');

        // Use 4-part format: contractId:pubkey:nonce:sig (needed for delegate auth)
        const arkauth = await ArkAuth.generateArkAuthWithSpender(contractId, nonce, pubKeyBech32, signerFn);
        const url = `${sentinelUrl.replace(/\/$/, '')}/${service}?arkauth=${encodeURIComponent(arkauth)}`;

        log('ArkAuth', arkauth);
        log('URL', url);

        const resp = await fetch(url);
        const body = await resp.text();
        log('Status', `${resp.status}`, resp.status >= 200 && resp.status < 300 ? 'ok' : 'err');
        log('Response', body.substring(0, 2000));

        // Auto-increment nonce
        $('nonce').value = parseInt(nonce) + 1;
      } catch (err) {
        log('Error', err.message, 'err');
      }
    });
  </script>
</body>
</html>

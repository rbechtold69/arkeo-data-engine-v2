<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Close Contract â€” Arkeo</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', -apple-system, sans-serif; background: #0a0a0f; color: #e0e0e0; min-height: 100vh; padding: 2rem; }
    .container { max-width: 600px; margin: 0 auto; }
    h1 { font-size: 1.6rem; margin-bottom: 0.5rem; background: linear-gradient(135deg, #ff6b6b, #ff8e53); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .subtitle { color: #888; margin-bottom: 2rem; font-size: 0.9rem; }
    .card { background: #14141f; border: 1px solid #2a2a3a; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; }
    label { display: block; color: #aaa; font-size: 0.8rem; margin-bottom: 0.3rem; text-transform: uppercase; letter-spacing: 0.05em; }
    input { width: 100%; padding: 0.7rem 1rem; background: #1a1a2e; border: 1px solid #2a2a3a; border-radius: 8px; color: #e0e0e0; font-size: 0.95rem; margin-bottom: 1rem; outline: none; }
    input:focus { border-color: #ff8e53; }
    .btn { display: inline-block; padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-size: 0.95rem; font-weight: 600; cursor: pointer; color: #fff; background: linear-gradient(135deg, #ff6b6b, #ff8e53); margin-right: 0.5rem; }
    .btn:hover { opacity: 0.9; }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .btn-secondary { background: linear-gradient(135deg, #6366f1, #8b5cf6); }
    .status { display: inline-block; padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600; margin-bottom: 1rem; }
    .status-disconnected { background: #3a1a1a; color: #ff6b6b; }
    .status-connected { background: #1a3a1a; color: #6bff6b; }
    .output { background: #0d0d15; border: 1px solid #2a2a3a; border-radius: 8px; padding: 1rem; font-family: monospace; font-size: 0.8rem; line-height: 1.6; white-space: pre-wrap; word-break: break-all; max-height: 300px; overflow-y: auto; color: #9ca3af; }
    .ok { color: #6bff6b; }
    .err { color: #ff6b6b; }
    .lbl { color: #ff8e53; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸ”’ Close Contract</h1>
    <p class="subtitle">Close an Arkeo PAYG contract and reclaim your deposit via Keplr</p>

    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;">
        <span style="font-weight:600;">Wallet</span>
        <span id="walletStatus" class="status status-disconnected">Disconnected</span>
      </div>
      <button id="connectBtn" class="btn btn-secondary">Connect Keplr</button>
      <div id="walletInfo" style="margin-top:0.75rem;font-size:0.85rem;color:#888;"></div>
    </div>

    <div class="card">
      <label>Contract ID</label>
      <input id="contractId" type="number" placeholder="872">
      <button id="closeBtn" class="btn" disabled>Close Contract</button>
    </div>

    <div class="card">
      <span style="font-weight:600;display:block;margin-bottom:1rem;">Output</span>
      <div id="output" class="output"><span style="color:#666;">Connect wallet and close a contract to see resultsâ€¦</span></div>
    </div>
  </div>

  <script>
    const CHAIN_ID = 'arkeo-main-v1';
    const RPC = 'https://rpc-seed.arkeo.network';
    const REST = 'https://rest-seed.arkeo.network';

    let walletAddress = '';
    let walletPubkey = null;

    const $ = id => document.getElementById(id);
    const output = $('output');

    function log(label, value, cls = '') {
      const span = document.createElement('span');
      span.innerHTML = `<span class="lbl">${label}:</span> <span class="${cls}">${esc(value)}</span>\n`;
      output.appendChild(span);
      output.scrollTop = output.scrollHeight;
    }
    function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    function clearOutput() { output.innerHTML = ''; }

    $('connectBtn').addEventListener('click', async () => {
      clearOutput();
      try {
        if (!window.keplr) throw new Error('Keplr not found');
        await window.keplr.enable(CHAIN_ID);
        const key = await window.keplr.getKey(CHAIN_ID);
        walletAddress = key.bech32Address;
        walletPubkey = key.pubKey;
        $('walletStatus').textContent = 'Connected';
        $('walletStatus').className = 'status status-connected';
        $('walletInfo').textContent = walletAddress;
        $('closeBtn').disabled = false;
        log('Status', 'Keplr connected', 'ok');
        log('Address', walletAddress);
      } catch (e) {
        log('Error', e.message, 'err');
      }
    });

    $('closeBtn').addEventListener('click', async () => {
      clearOutput();
      const contractId = $('contractId').value.trim();
      if (!contractId) { log('Error', 'Enter a contract ID', 'err'); return; }

      try {
        // Fetch contract details
        log('Action', 'Fetching contract #' + contractId + '...');
        const contractRes = await fetch(`${REST}/arkeo/contract/${contractId}`);
        const contractData = await contractRes.json();
        const contract = contractData.contract;
        if (!contract) throw new Error('Contract not found');
        log('Provider', contract.provider);
        log('Client', contract.client);
        log('Deposit', (parseInt(contract.deposit) / 1e8).toFixed(4) + ' ARKEO');

        // Fetch account info for sequence/account_number
        log('Action', 'Fetching account info...');
        const acctRes = await fetch(`${REST}/cosmos/auth/v1beta1/accounts/${walletAddress}`);
        const acctData = await acctRes.json();
        const account = acctData.account;
        const accountNumber = account.account_number;
        const sequence = account.sequence;
        log('Account', `#${accountNumber}, seq ${sequence}`);

        // Build the MsgCloseContract
        // Get bech32 pubkey
        const aminoPrefix = new Uint8Array([0xeb, 0x5a, 0xe9, 0x87, 0x21]);
        const pubKeyWithPrefix = new Uint8Array(aminoPrefix.length + walletPubkey.length);
        pubKeyWithPrefix.set(aminoPrefix);
        pubKeyWithPrefix.set(walletPubkey, aminoPrefix.length);
        const pubKeyBech32 = bech32Encode('arkeopub', pubKeyWithPrefix);

        const msg = {
          type: 'arkeo/MsgCloseContract',
          value: {
            creator: walletAddress,
            contract_id: contractId,
            client: pubKeyBech32,
            delegate: pubKeyBech32,
          }
        };

        const fee = { amount: [{ denom: 'uarkeo', amount: '500' }], gas: '300000' };

        const signDoc = {
          chain_id: CHAIN_ID,
          account_number: accountNumber,
          sequence: sequence,
          fee: fee,
          msgs: [msg],
          memo: '',
        };

        log('Action', 'Requesting Keplr signature...');
        const signResponse = await window.keplr.signAmino(CHAIN_ID, walletAddress, signDoc);

        // Broadcast
        log('Action', 'Broadcasting transaction...');
        const tx = {
          tx: {
            msg: signResponse.signed.msgs,
            fee: signResponse.signed.fee,
            signatures: [{
              pub_key: { type: 'tendermint/PubKeySecp256k1', value: btoa(String.fromCharCode(...walletPubkey)) },
              signature: signResponse.signature.signature,
            }],
            memo: '',
          },
          mode: 'sync',
        };

        const broadcastRes = await fetch(`${REST}/cosmos/tx/v1beta1/txs`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            tx_bytes: btoa(JSON.stringify(tx)),
            mode: 'BROADCAST_MODE_SYNC',
          }),
        });
        const broadcastData = await broadcastRes.json();

        if (broadcastData.tx_response) {
          const code = broadcastData.tx_response.code;
          const txhash = broadcastData.tx_response.txhash;
          if (code === 0) {
            log('TX Hash', txhash, 'ok');
            log('Status', 'Contract closed successfully!', 'ok');
          } else {
            log('TX Hash', txhash);
            log('Error', broadcastData.tx_response.raw_log || 'Unknown error', 'err');
          }
        } else {
          // Try amino broadcast fallback
          const aminoBroadcast = await fetch(`${REST}/txs`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tx: tx.tx, mode: 'sync' }),
          });
          const aminoData = await aminoBroadcast.json();
          log('Response', JSON.stringify(aminoData).substring(0, 500));
        }

      } catch (e) {
        log('Error', e.message, 'err');
      }
    });

    // Bech32 encode
    function bech32Encode(prefix, data) {
      const CHARSET = 'qpzry9x8gf2tvdw0s3jn54khce6mua7l';
      const GENERATOR = [0x3b6a57b2, 0x26508e6d, 0x1ea119fa, 0x3d4233dd, 0x2a1462b3];
      function polymod(values) {
        let chk = 1;
        for (const v of values) {
          const top = chk >> 25;
          chk = ((chk & 0x1ffffff) << 5) ^ v;
          for (let i = 0; i < 5; i++) if ((top >> i) & 1) chk ^= GENERATOR[i];
        }
        return chk;
      }
      function hrpExpand(hrp) {
        const ret = [];
        for (let i = 0; i < hrp.length; i++) ret.push(hrp.charCodeAt(i) >> 5);
        ret.push(0);
        for (let i = 0; i < hrp.length; i++) ret.push(hrp.charCodeAt(i) & 31);
        return ret;
      }
      const words = []; let acc = 0, bits = 0;
      for (const b of data) { acc = (acc << 8) | b; bits += 8; while (bits >= 5) { bits -= 5; words.push((acc >> bits) & 31); } }
      if (bits > 0) words.push((acc << (5 - bits)) & 31);
      const values = hrpExpand(prefix).concat(words).concat([0,0,0,0,0,0]);
      const mod = polymod(values) ^ 1;
      const checksum = [];
      for (let i = 0; i < 6; i++) checksum.push((mod >> (5 * (5 - i))) & 31);
      return prefix + '1' + words.concat(checksum).map(v => CHARSET[v]).join('');
    }
  </script>
</body>
</html>

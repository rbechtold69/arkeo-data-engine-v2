<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Find a Provider | Arkeo Marketplace</title>
  <link rel="icon" type="image/png" href="images/arkeo-logo-200px_1.png">
  <style>
    :root {
      --bg-main: #0C0E14;
      --bg-card: #151820;
      --bg-input: #1a1f2e;
      --border: #2a2f3c;
      --border-focus: #3BE0FF;
      --arkeo: #3BE0FF;
      --arkeo-dim: rgba(59, 224, 255, 0.1);
      --success: #10b981;
      --success-dim: rgba(16, 185, 129, 0.1);
      --warning: #f59e0b;
      --error: #ef4444;
      --text: #ffffff;
      --text-dim: #9ca3af;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      background: var(--bg-main);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      min-height: 100vh;
      line-height: 1.6;
    }
    
    /* Navigation */
    .nav {
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      padding: 1rem 2rem;
      position: sticky;
      top: 0;
      z-index: 100;}
    .logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 1.25rem;
      font-weight: 700;
      text-decoration: none;
      color: var(--text);
    }
    .logo img { height: 36px; }
    .logo span { color: var(--arkeo); }
    .back-link {
      color: var(--text-dim);
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: color 0.2s;
    }
    .back-link:hover { color: var(--arkeo); }
    
    /* Main Container */
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 2rem;
    }
    
    /* Progress Bar */
    .progress-container {
      margin-bottom: 2rem;
    }
    .progress-steps {
      display: flex;
      justify-content: space-between;
      position: relative;
      margin-bottom: 0.5rem;
    }
    .progress-steps::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--border);
      transform: translateY(-50%);
      z-index: 0;
    }
    .progress-line {
      position: absolute;
      top: 50%;
      left: 0;
      height: 2px;
      background: var(--arkeo);
      transform: translateY(-50%);
      z-index: 1;
      transition: width 0.3s ease;
    }
    .step-dot {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--bg-card);
      border: 2px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.875rem;
      font-weight: 600;
      position: relative;
      z-index: 2;
      transition: all 0.3s;
    }
    .step-dot.active {
      border-color: var(--arkeo);
      background: var(--arkeo-dim);
      color: var(--arkeo);
    }
    .step-dot.complete {
      border-color: var(--success);
      background: var(--success);
      color: white;
    }
    .step-labels {
      display: flex;
      justify-content: space-between;
    }
    .step-label {
      font-size: 0.75rem;
      color: var(--text-dim);
      text-align: center;
      width: 80px;
    }
    .step-label.active { color: var(--arkeo); }
    
    /* Wizard Card */
    .wizard-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 1rem;
      padding: 2rem;
    }
    .wizard-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    .wizard-subtitle {
      color: var(--text-dim);
      margin-bottom: 2rem;
    }
    
    /* Form Elements */
    .form-group {
      margin-bottom: 1.5rem;
    }
    .form-label {
      display: block;
      font-weight: 500;
      margin-bottom: 0.5rem;
    }
    .form-input {
      width: 100%;
      padding: 0.875rem 1rem;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      color: var(--text);
      font-size: 1rem;
      transition: border-color 0.2s;
    }
    .form-input:focus {
      outline: none;
      border-color: var(--arkeo);
    }
    
    /* Chain Selector */
    .chain-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.75rem;
      margin-bottom: 1rem;
      max-height: 520px;
      overflow-y: auto;
    }
    .chain-option {
      padding: 1rem 1.25rem;
      background: var(--bg-input);
      border: 2px solid var(--border);
      border-radius: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .chain-option:hover {
      border-color: var(--text-dim);
    }
    .chain-option.selected {
      border-color: var(--arkeo);
      background: var(--arkeo-dim);
    }
    .chain-option .chain-info {
      flex: 1;
      min-width: 0;
    }
    .chain-option .chain-name {
      font-weight: 600;
      font-size: 0.95rem;
    }
    .chain-option .chain-meta {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-top: 0.25rem;
      font-size: 0.8rem;
      color: var(--text-dim);
    }
    .chain-demand {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.8rem;
    }
    .demand-high { color: #f97316; }
    .demand-growing { color: var(--arkeo); }
    .demand-some { color: var(--text-dim); }
    .demand-none { color: #4b5563; }
    
    /* Provider Cards */
    .provider-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .provider-card {
      background: var(--bg-input);
      border: 2px solid var(--border);
      border-radius: 0.75rem;
      padding: 1.25rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .provider-card:hover {
      border-color: var(--text-dim);
    }
    .provider-card.selected {
      border-color: var(--arkeo);
      background: var(--arkeo-dim);
    }
    .provider-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.75rem;
    }
    .provider-name {
      font-weight: 600;
      font-size: 1.1rem;
    }
    .provider-rate {
      background: var(--arkeo-dim);
      color: var(--arkeo);
      padding: 0.25rem 0.75rem;
      border-radius: 1rem;
      font-size: 0.875rem;
      font-weight: 600;
    }
    .provider-stats {
      display: flex;
      gap: 1.5rem;
      font-size: 0.875rem;
      color: var(--text-dim);
    }
    .provider-stat {
      display: flex;
      align-items: center;
      gap: 0.35rem;
    }
    .stat-good { color: var(--success); }
    .provider-description {
      margin-top: 0.75rem;
      font-size: 0.9rem;
      color: var(--text-dim);
    }
    
    /* Buttons */
    .btn-group {
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
    }
    .btn {
      padding: 0.875rem 1.5rem;
      border-radius: 0.5rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }
    .btn-primary {
      background: var(--arkeo);
      color: #000;
      flex: 1;
    }
    .btn-primary:hover {
      background: #5ce8ff;
    }
    .btn-primary:disabled {
      background: var(--border);
      color: var(--text-dim);
      cursor: not-allowed;
    }
    .btn-secondary {
      background: transparent;
      color: var(--text-dim);
      border: 1px solid var(--border);
    }
    .btn-secondary:hover {
      border-color: var(--text-dim);
      color: var(--text);
    }
    
    /* Contract Summary */
    .contract-summary {
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 0.75rem;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    .summary-row {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--border);
    }
    .summary-row:last-child {
      border-bottom: none;
      font-weight: 600;
      font-size: 1.1rem;
      padding-top: 1rem;
    }
    .summary-label {
      color: var(--text-dim);
    }
    .summary-value {
      font-weight: 500;
    }
    
    /* Deposit Input */
    .deposit-input-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .deposit-input {
      width: 120px;
      padding: 0.75rem 1rem;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      color: var(--text);
      font-size: 1.25rem;
      font-weight: 600;
      text-align: right;
    }
    .deposit-input:focus {
      outline: none;
      border-color: var(--arkeo);
    }
    .deposit-suffix {
      font-size: 1.1rem;
      color: var(--text-dim);
    }
    .deposit-estimate {
      margin-top: 0.75rem;
      padding: 0.75rem;
      background: var(--arkeo-dim);
      border-radius: 0.5rem;
      font-size: 0.9rem;
    }

    .duration-preset {
      padding: 0.4rem 0.8rem;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      color: var(--text-dim);
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .duration-preset:hover {
      border-color: var(--arkeo);
      color: var(--text);
    }
    .duration-preset.active {
      background: var(--arkeo-dim);
      border-color: var(--arkeo);
      color: var(--arkeo);
      font-weight: 600;
    }

    /* Wallet Section */
    .wallet-section {
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 0.75rem;
      padding: 1.5rem;
      text-align: center;
      margin: 1.5rem 0;
    }
    .wallet-label {
      color: var(--text-dim);
      margin-bottom: 0.5rem;
    }
    .connect-wallet-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.875rem 1.5rem;
      background: linear-gradient(135deg, #8b5cf6, #3b82f6);
      border: none;
      border-radius: 0.5rem;
      color: white;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .connect-wallet-btn:hover {
      transform: scale(1.02);
    }
    
    /* Status */
    .status-box {
      padding: 1rem;
      border-radius: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-top: 1rem;
    }
    .status-box.success {
      background: var(--success-dim);
      border: 1px solid var(--success);
    }
    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid var(--arkeo);
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Success State */
    .success-container {
      text-align: center;
      padding: 2rem 0;
    }
    .success-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
    }
    .success-title {
      font-size: 1.75rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }
    .success-subtitle {
      color: var(--text-dim);
      margin-bottom: 2rem;
    }
    
    /* Endpoint Display */
    .endpoint-display {
      background: #0d1117;
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      padding: 1rem;
      margin: 1.5rem 0;
      font-family: monospace;
      font-size: 0.95rem;
      word-break: break-all;
      text-align: left;
    }
    .endpoint-label {
      color: var(--text-dim);
      font-size: 0.8rem;
      margin-bottom: 0.5rem;
      font-family: sans-serif;
    }
    .endpoint-url {
      color: var(--arkeo);
    }
    .copy-btn {
      margin-top: 0.75rem;
      padding: 0.5rem 1rem;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 0.25rem;
      color: var(--text);
      font-size: 0.85rem;
      cursor: pointer;
    }
    .copy-btn:hover {
      background: var(--arkeo);
      color: #000;
      border-color: var(--arkeo);
    }
    
    .listing-link {
      display: inline-block;
      padding: 0.75rem 1.5rem;
      background: var(--arkeo);
      color: #000;
      text-decoration: none;
      border-radius: 0.5rem;
      font-weight: 600;
      margin: 0.5rem;
    }
    .listing-link.secondary {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
    }
    
    /* Hidden */
    .hidden { display: none !important; }
    
    /* Mobile */
    @media (max-width: 600px) {
      .chain-grid { grid-template-columns: 1fr; }
      .btn-group { flex-direction: column; }
      .container { padding: 1rem; }
      .provider-stats { flex-wrap: wrap; gap: 0.75rem; }
      .nav { padding: 0.75rem 1rem; flex-wrap: wrap; gap: 0.5rem; }
      .logo { font-size: 1rem; }
      .logo img { height: 28px; }
      .wizard-card { padding: 1.25rem; }
      .wizard-title { font-size: 1.25rem; }
      .deposit-input-group { flex-wrap: wrap; }
    }
  
    /* Mobile Nav - Hamburger Menu */
    .nav-inner {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .nav-links {
      display: flex;
      align-items: center;
      gap: 2rem;
    }
    .nav-link { color: var(--text-dim, #9ca3af); text-decoration: none; font-weight: 500; transition: color 0.2s; }
    .nav-link:hover { color: var(--arkeo, #3BE0FF); }
    .hamburger {
      display: none;
      align-items: center;
      justify-content: center;
      background: none;
      border: 1px solid var(--border, #252a36);
      border-radius: 0.375rem;
      color: var(--text, #fff);
      font-size: 1.4rem;
      padding: 0.4rem 0.6rem;
      cursor: pointer;
    }
    .hamburger:hover { border-color: var(--arkeo, #3BE0FF); color: var(--arkeo, #3BE0FF); }
    .mobile-menu { display: none; }
    .nav-buttons {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }
    .nav-btn {
      padding: 0.45rem 0.9rem;
      border-radius: 0.375rem;
      font-weight: 500;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid var(--border, #252a36);
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      color: var(--text, #fff);
      background: transparent;
    }
    .nav-btn:hover {
      color: var(--arkeo, #3BE0FF);
      border-color: var(--arkeo, #3BE0FF);
      background: rgba(59, 224, 255, 0.05);
    }
    .nav-btn-accent {
      border-color: rgba(59, 224, 255, 0.3);
      color: var(--arkeo, #3BE0FF);
    }
    .nav-btn-accent:hover {
      background: rgba(59, 224, 255, 0.1);
      border-color: var(--arkeo, #3BE0FF);
    }
    @media (max-width: 768px) {
      .nav { padding: 0.75rem 1rem; }
      .nav-links { display: none; }
      .nav-buttons { display: none; }
      .hamburger { display: flex !important; }
      .mobile-menu { display: none !important; flex-direction: column; width: 100%; padding: 0.5rem 0; gap: 0.25rem; }
      .mobile-menu.open { display: flex !important; }
      .mobile-menu a { color: var(--text-dim, #8b92a5); text-decoration: none; padding: 0.6rem 0.5rem; border-radius: 0.375rem; font-size: 0.9rem; }
      .mobile-menu a:hover { color: var(--arkeo, #3BE0FF); background: rgba(59, 224, 255, 0.1); }
      .nav-inner { flex-wrap: wrap; gap: 0.5rem; }
      .logo { font-size: 1rem; }
      .logo img { height: 32px; }
    }
  </style>
  <!-- Arkeo transaction helper -->
  <script src="js/arkeo-tx.js?v=20260208"></script>
  <!-- secp256k1 for key generation ‚Äî inline minimal implementation -->
  <script>
    // Minimal secp256k1 key derivation using SubtleCrypto + manual EC math
    // We only need: privateKey -> compressedPublicKey, sha256, ripemd160
    (function() {
      // secp256k1 curve parameters
      const P = 0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFC2Fn;
      const N = 0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEBAAEDCE6AF48A03BBFD25E8CD0364141n;
      const Gx = 0x79BE667EF9DCBBAC55A06295CE870B07029BFCDB2DCE28D959F2815B16F81798n;
      const Gy = 0x483ADA7726A3C4655DA4FBFC0E1108A8FD17B448A68554199C47D08FFB10D4B8n;

      function mod(a, m = P) { let r = a % m; return r >= 0n ? r : r + m; }
      function modInv(a, m = P) {
        let [old_r, r] = [mod(a, m), m];
        let [old_s, s] = [1n, 0n];
        while (r !== 0n) {
          const q = old_r / r;
          [old_r, r] = [r, old_r - q * r];
          [old_s, s] = [s, old_s - q * s];
        }
        return mod(old_s, m);
      }

      function pointAdd(x1, y1, x2, y2) {
        if (x1 === 0n && y1 === 0n) return [x2, y2];
        if (x2 === 0n && y2 === 0n) return [x1, y1];
        let slope;
        if (x1 === x2 && y1 === y2) {
          slope = mod(3n * x1 * x1 * modInv(2n * y1));
        } else {
          slope = mod((y2 - y1) * modInv(x2 - x1));
        }
        const x3 = mod(slope * slope - x1 - x2);
        const y3 = mod(slope * (x1 - x3) - y1);
        return [x3, y3];
      }

      function pointMul(k, px = Gx, py = Gy) {
        let [rx, ry] = [0n, 0n];
        let [qx, qy] = [px, py];
        while (k > 0n) {
          if (k & 1n) [rx, ry] = pointAdd(rx, ry, qx, qy);
          [qx, qy] = pointAdd(qx, qy, qx, qy);
          k >>= 1n;
        }
        return [rx, ry];
      }

      function bytesToBigInt(bytes) {
        let hex = '';
        for (const b of bytes) hex += b.toString(16).padStart(2, '0');
        return BigInt('0x' + hex);
      }

      function bigIntToBytes(n, len = 32) {
        const hex = n.toString(16).padStart(len * 2, '0');
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) bytes[i] = parseInt(hex.slice(i * 2, i * 2 + 2), 16);
        return bytes;
      }

      window.nobleSecp256k1 = {
        getPublicKey: function(privateKeyBytes, compressed = true) {
          const k = bytesToBigInt(privateKeyBytes);
          const [px, py] = pointMul(k);
          if (compressed) {
            const prefix = (py % 2n === 0n) ? 0x02 : 0x03;
            const xBytes = bigIntToBytes(px, 32);
            const result = new Uint8Array(33);
            result[0] = prefix;
            result.set(xBytes, 1);
            return result;
          }
          const result = new Uint8Array(65);
          result[0] = 0x04;
          result.set(bigIntToBytes(px, 32), 1);
          result.set(bigIntToBytes(py, 32), 33);
          return result;
        }
      };

      // SHA-256 using SubtleCrypto
      window.nobleSha256 = async function(data) {
        const buffer = await crypto.subtle.digest('SHA-256', data);
        return new Uint8Array(buffer);
      };

      // RIPEMD-160 ‚Äî minimal implementation
      window.nobleRipemd160 = (function() {
        function ripemd160(msg) {
          const H = [0x67452301, 0xEFCDAB89, 0x98BADCFE, 0x10325476, 0xC3D2E1F0];
          const KL = [0, 0x5A827999, 0x6ED9EBA1, 0x8F1BBCDC, 0xA953FD4E];
          const KR = [0x50A28BE6, 0x5C4DD124, 0x6D703EF3, 0x7A6D76E9, 0];
          const RL = [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,7,4,13,1,10,6,15,3,12,0,9,5,2,14,11,8,3,10,14,4,9,15,8,1,2,7,0,6,13,11,5,12,1,9,11,10,0,8,12,4,13,3,7,15,14,5,6,2,4,0,5,9,7,12,2,10,14,1,3,8,11,6,15,13];
          const RR = [5,14,7,0,9,2,11,4,13,6,15,8,1,10,3,12,6,11,3,7,0,13,5,10,14,15,8,12,4,9,1,2,15,5,1,3,7,14,6,9,11,8,12,2,10,0,4,13,8,6,4,1,3,11,15,0,5,12,2,13,9,7,10,14,12,15,10,4,1,5,8,7,6,2,13,14,0,3,9,11];
          const SL = [11,14,15,12,5,8,7,9,11,13,14,15,6,7,9,8,7,6,8,13,11,9,7,15,7,12,15,9,11,7,13,12,11,13,6,7,14,9,13,15,14,8,13,6,5,12,7,5,11,12,14,15,14,15,9,8,9,14,5,6,8,6,5,12,9,15,5,11,6,8,13,12,5,12,13,14,11,8,5,6];
          const SR = [8,9,9,11,13,15,15,5,7,7,8,11,14,14,12,6,9,13,15,7,12,8,9,11,7,7,12,7,6,15,13,11,9,7,15,11,8,6,6,14,12,13,5,14,13,13,7,5,15,5,8,11,14,14,6,14,6,9,12,9,12,5,15,8,8,5,12,9,12,5,14,6,8,13,6,5,15,13,11,11];
          
          // Pad message
          const len = msg.length;
          const bitLen = len * 8;
          const padLen = (len % 64 < 56) ? 56 - len % 64 : 120 - len % 64;
          const padded = new Uint8Array(len + padLen + 8);
          padded.set(msg);
          padded[len] = 0x80;
          // Little-endian bit length
          for (let i = 0; i < 8; i++) padded[len + padLen + i] = Number((BigInt(bitLen) >> BigInt(8 * i)) & 0xFFn);
          
          const view = new DataView(padded.buffer);
          const rotl = (x, n) => ((x << n) | (x >>> (32 - n))) >>> 0;
          
          for (let offset = 0; offset < padded.length; offset += 64) {
            const W = [];
            for (let i = 0; i < 16; i++) W.push(view.getUint32(offset + i * 4, true));
            
            let [al, bl, cl, dl, el] = H;
            let [ar, br, cr, dr, er] = H;
            
            for (let j = 0; j < 80; j++) {
              let tl, tr;
              const round = j >> 4;
              // Left
              if (round === 0) tl = (al ^ bl ^ cl) >>> 0;
              else if (round === 1) tl = ((al & bl) | (~al & cl)) >>> 0;
              else if (round === 2) tl = ((al | ~bl) ^ cl) >>> 0;
              else if (round === 3) tl = ((al & cl) | (bl & ~cl)) >>> 0;
              else tl = (al ^ (bl | ~cl)) >>> 0;
              
              tl = (tl + W[RL[j]] + KL[round]) >>> 0;
              tl = (rotl(tl, SL[j]) + el) >>> 0;
              al = el; el = dl; dl = rotl(cl, 10); cl = bl; bl = tl;
              
              // Right
              if (round === 0) tr = (ar ^ (br | ~cr)) >>> 0;
              else if (round === 1) tr = ((ar & cr) | (br & ~cr)) >>> 0;
              else if (round === 2) tr = ((ar | ~br) ^ cr) >>> 0;
              else if (round === 3) tr = ((ar & br) | (~ar & cr)) >>> 0;
              else tr = (ar ^ br ^ cr) >>> 0;
              
              tr = (tr + W[RR[j]] + KR[round]) >>> 0;
              tr = (rotl(tr, SR[j]) + er) >>> 0;
              ar = er; er = dr; dr = rotl(cr, 10); cr = br; br = tr;
            }
            
            const t = (H[1] + cl + dr) >>> 0;
            H[1] = (H[2] + dl + er) >>> 0;
            H[2] = (H[3] + el + ar) >>> 0;
            H[3] = (H[4] + al + br) >>> 0;
            H[4] = (H[0] + bl + cr) >>> 0;
            H[0] = t;
          }
          
          const result = new Uint8Array(20);
          const outView = new DataView(result.buffer);
          for (let i = 0; i < 5; i++) outView.setUint32(i * 4, H[i], true);
          return result;
        }
        return ripemd160;
      })();
    })();
  </script>
</head>
<body>
  <!-- Navigation -->
  <nav class="nav">
    <div class="nav-inner">
      <a href="index.html" class="logo">
        <img src="images/arkeo-logo-200px_1.png" alt="Arkeo">
        <span class="logo-text">Arkeo <span>Marketplace</span></span>
      </a>
      <div class="nav-links">
        <a href="analytics.html" class="nav-link">üìä Analytics</a>
        <a href="request-chain.html" class="nav-link">üó≥Ô∏è Request Chain</a>
        <a href="https://racing.builtonarkeo.com/" target="_blank" class="nav-link">üèá Racing</a>
        <a href="https://docs.arkeo.network" target="_blank" class="nav-link">Docs</a>
        <a href="x402-setup.html" class="nav-link">‚ö° x402</a>
      </div>
      <div class="nav-buttons">
        <a href="my-contracts.html" class="nav-btn">My Contracts</a>
        <a href="become-provider.html" class="nav-btn">Provide Data</a>
        <a href="subscribe.html" class="nav-btn">Use Data</a>
        <a href="https://app.osmosis.zone/pool/2977" target="_blank" rel="noopener" class="nav-btn nav-btn-accent">Buy ARKEO</a>
      </div>
      <button class="hamburger" onclick="document.getElementById('mobileMenu').classList.toggle('open')" aria-label="Menu">‚ò∞</button>
    </div>
    <div class="mobile-menu" id="mobileMenu">
      <a href="index.html">üè† Home</a>
      <a href="analytics.html">üìä Analytics</a>
      <a href="request-chain.html">üó≥Ô∏è Request Chain</a>
      <a href="x402-setup.html">‚ö° x402</a>
      <a href="https://docs.arkeo.network" target="_blank">üìÑ Docs</a>
      <a href="my-contracts.html">üìã My Contracts</a>
      <a href="become-provider.html">üöÄ Provide Data</a>
      <a href="subscribe.html">üì° Use Data</a>
      <a href="https://app.osmosis.zone/pool/2977" target="_blank">üí∞ Buy ARKEO</a>
      <a href="https://racing.builtonarkeo.com/" target="_blank">üèá Racing</a>
    </div>
  </nav>

  <div class="container">
    <!-- Start Over Link -->
    <div style="text-align: right; margin-bottom: 0.5rem;">
      <a href="#" onclick="event.preventDefault(); if(confirm('Clear all progress and start over?')) { clearState(); findAnother(); }" style="font-size: 0.85rem; color: var(--text-dim); text-decoration: none;">
        üîÑ Start Over
      </a>
    </div>
    
    <!-- Progress Bar -->
    <div class="progress-container">
      <div class="progress-steps">
        <div class="progress-line" id="progressLine" style="width: 0%"></div>
        <div class="step-dot active" id="dot1">1</div>
        <div class="step-dot" id="dot2">2</div>
        <div class="step-dot" id="dot3">3</div>
      </div>
      <div class="step-labels">
        <span class="step-label active" id="label1">Chain</span>
        <span class="step-label" id="label2">Provider</span>
        <span class="step-label" id="label3">Connect</span>
      </div>
    </div>

    <!-- Step 1: Select Chain -->
    <div class="wizard-card" id="step1">
      <h2 class="wizard-title">What data do you need?</h2>
      <p class="wizard-subtitle">Select the blockchain you want to access.</p>
      
      <div class="form-group">
        <input type="text" class="form-input" placeholder="üîç Search chains..." id="chainSearch" oninput="filterChains()">
      </div>
      
      <div class="chain-grid" id="chainGrid">
        <!-- Chains populated by JS -->
      </div>
      
      <div class="btn-group">
        <button class="btn btn-primary" id="nextBtn1" disabled onclick="goToStep(2)">
          Find Providers ‚Üí
        </button>
      </div>
    </div>

    <!-- Step 2: Choose Provider -->
    <div class="wizard-card hidden" id="step2">
      <h2 class="wizard-title">Choose a Provider</h2>
      <p class="wizard-subtitle">Select from available <span id="selectedChainName">Ethereum</span> providers.</p>
      
      <div class="provider-list" id="providerList">
        <!-- Providers populated by JS -->
      </div>
      
      <div class="btn-group">
        <button class="btn btn-secondary" onclick="goToStep(1)">‚Üê Back</button>
        <button class="btn btn-primary" id="nextBtn2" disabled onclick="goToStep(3)">
          Continue ‚Üí
        </button>
      </div>
    </div>

    <!-- Step 3: Open Contract -->
    <div class="wizard-card hidden" id="step3">
      <h2 class="wizard-title">Open Contract</h2>
      <p class="wizard-subtitle">Fund your contract and get instant access.</p>
      
      <div class="contract-summary">
        <div class="summary-row">
          <span class="summary-label">Chain</span>
          <span class="summary-value" id="summaryChain">Ethereum Mainnet</span>
        </div>
        <div class="summary-row">
          <span class="summary-label">Provider</span>
          <span class="summary-value" id="summaryProvider">FastNode Pro</span>
        </div>
        <div class="summary-row">
          <span class="summary-label">Rate</span>
          <span class="summary-value" id="summaryRate">0.001 ARKEO/request</span>
        </div>
      </div>
      
      <div class="form-group">
        <label class="form-label">Payment Method</label>
        <div style="display: flex; gap: 0.75rem; margin-bottom: 1rem;">
          <button class="btn btn-primary" id="payArkeoBtn" onclick="selectPayment('arkeo')" style="flex: 1; position: relative;">
            üíé Pay with ARKEO
          </button>
          <button class="btn btn-secondary" id="payUsdcBtn" onclick="selectPayment('usdc')" style="flex: 1;">
            üíµ Pay with USDC
          </button>
          <button class="btn btn-secondary" id="payX402Btn" onclick="selectPayment('x402')" style="flex: 1; position: relative;">
            ‚ö° Pay with x402
            <span style="position: absolute; top: -10px; right: -10px; background: linear-gradient(135deg, #8b5cf6, #3b82f6); color: #fff; font-size: 0.65rem; padding: 3px 8px; border-radius: 10px; font-weight: 700;">NEW</span>
          </button>
        </div>
        <!-- ARKEO payment info (shown by default) -->
        <div id="arkeoPaymentInfo" style="background: rgba(16, 185, 129, 0.1); border: 1px solid #10b981; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem; font-size: 0.85rem;">
          <div style="font-weight: 700; margin-bottom: 0.5rem; color: #10b981;">üíé Pay with ARKEO</div>
          <div style="color: var(--text-dim); line-height: 1.5;">Pay directly with ARKEO ‚Äî no conversion fees, instant settlement. 2% burn proposed (subject to DAO vote) to increase token scarcity.</div>
          <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.75rem; padding: 0.5rem; background: rgba(16,185,129,0.1); border-radius: 0.375rem; font-size: 0.8rem;">
            <span style="font-weight: 600;">Wallet</span>
            <span style="color: var(--arkeo);">‚Üí</span>
            <span style="font-weight: 600;">Contract</span>
            <span style="margin-left: auto; color: #10b981; font-weight: 600;">Instant</span>
          </div>
        </div>
        <!-- USDC payment info (hidden by default) -->
        <div id="usdcPaymentInfo" style="display: none; background: rgba(59,224,255,0.05); border: 1px solid var(--border); border-radius: 0.5rem; padding: 1.25rem; margin-bottom: 1rem; font-size: 0.85rem;">
          <div style="font-weight: 700; margin-bottom: 0.75rem; font-size: 1rem;">üíµ Buy ARKEO with USDC</div>
          
          <!-- Skip Go Swap Panel -->
          <div id="skipGoSwapPanel" style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem;">
            <div style="font-weight: 600; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
              <span>‚ö° Instant Swap</span>
              <span style="background: linear-gradient(135deg, #10b981, #059669); color: #fff; font-size: 0.65rem; padding: 3px 8px; border-radius: 10px; font-weight: 700;">POWERED BY SKIP GO</span>
            </div>
            
            <!-- Swap Input -->
            <div style="margin-bottom: 1rem;">
              <label style="display: block; margin-bottom: 0.5rem; font-size: 0.85rem; color: var(--text-dim);">You pay</label>
              <div style="display: flex; gap: 0.5rem; align-items: center;">
                <input type="number" id="swapUsdcInput" placeholder="0.00" min="1" step="0.01" 
                  oninput="updateSkipGoQuote()" 
                  style="flex: 1; padding: 0.875rem 1rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 0.5rem; color: var(--text); font-size: 1.25rem; font-weight: 600;">
                <span style="font-size: 1rem; font-weight: 600; color: var(--text-dim); min-width: 60px;">USDC</span>
              </div>
              <div style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-dim);">
                On Noble chain ¬∑ <span id="nobleBalanceDisplay">Connect wallet to see balance</span>
              </div>
            </div>
            
            <!-- Route Arrow -->
            <div style="text-align: center; margin: 0.75rem 0; color: var(--arkeo); font-size: 1.5rem;">‚Üì</div>
            
            <!-- Swap Output -->
            <div style="margin-bottom: 1rem;">
              <label style="display: block; margin-bottom: 0.5rem; font-size: 0.85rem; color: var(--text-dim);">You receive (estimated)</label>
              <div style="padding: 0.875rem 1rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
                <span id="swapArkeoOutput" style="font-size: 1.25rem; font-weight: 600; color: var(--arkeo);">‚Äî</span>
                <span style="font-size: 1rem; font-weight: 600; color: var(--text-dim);">ARKEO</span>
              </div>
              <div style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-dim);">
                On Arkeo chain ¬∑ <span id="arkeoBalanceDisplay">‚Äî</span>
              </div>
            </div>
            
            <!-- Quote Details -->
            <div id="skipGoQuoteDetails" style="display: none; background: rgba(59,224,255,0.05); border-radius: 0.5rem; padding: 0.75rem; margin-bottom: 1rem; font-size: 0.8rem;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                <span style="color: var(--text-dim);">Exchange rate:</span>
                <span id="swapRate" style="font-weight: 600;">‚Äî</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                <span style="color: var(--text-dim);">Route:</span>
                <span id="swapRoute" style="font-weight: 600; font-size: 0.75rem;">Noble ‚Üí Osmosis ‚Üí Arkeo</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--text-dim);">Estimated time:</span>
                <span style="font-weight: 600;">~30 seconds</span>
              </div>
            </div>
            
            <!-- Swap Status -->
            <div id="skipGoSwapStatus"></div>
            
            <!-- Swap Button -->
            <button id="executeSwapBtn" onclick="executeSkipGoSwap()" disabled
              style="width: 100%; padding: 0.875rem; background: var(--arkeo); color: #000; border: none; border-radius: 0.5rem; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">
              Connect Wallet to Swap
            </button>
          </div>
          
          <!-- Manual Flow (Alternative) -->
          <details style="margin-bottom: 1rem; border: 1px solid var(--border); border-radius: 0.5rem; overflow: hidden;">
            <summary style="padding: 0.75rem 1rem; cursor: pointer; font-size: 0.85rem; font-weight: 600; color: var(--text-dim); background: var(--bg-input); user-select: none;">
              üîß Manual swap (alternative method)
            </summary>
            <div style="padding: 1rem; font-size: 0.85rem;">
              <!-- Step-by-step guide -->
              <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                <!-- Step 1 -->
                <div style="display: flex; gap: 0.75rem; align-items: flex-start; padding: 0.75rem; background: var(--bg-input); border-radius: 0.5rem;">
                  <span style="background: var(--arkeo); color: #000; min-width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 700; margin-top: 2px;">1</span>
                  <div style="flex: 1;">
                    <div style="font-weight: 600; margin-bottom: 0.25rem;">Swap USDC ‚Üí ARKEO on Osmosis</div>
                    <div style="color: var(--text-dim); font-size: 0.8rem; margin-bottom: 0.5rem;">Use Osmosis DEX to convert your USDC to ARKEO tokens.</div>
                    <a id="osmosisSwapLink" href="https://app.osmosis.zone/?from=USDC&to=ARKEO" target="_blank" rel="noopener" style="display: inline-flex; align-items: center; gap: 0.4rem; padding: 0.4rem 0.8rem; background: linear-gradient(135deg, #5604a8, #462ad8); color: #fff; border-radius: 0.375rem; font-size: 0.8rem; font-weight: 600; text-decoration: none; transition: opacity 0.2s;">
                      üåä Swap on Osmosis ‚Üí
                    </a>
                  </div>
                </div>
                <!-- Step 2 -->
                <div style="display: flex; gap: 0.75rem; align-items: flex-start; padding: 0.75rem; background: var(--bg-input); border-radius: 0.5rem;">
                  <span style="background: var(--arkeo); color: #000; min-width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 700; margin-top: 2px;">2</span>
                  <div style="flex: 1;">
                    <div style="font-weight: 600; margin-bottom: 0.25rem;">IBC Transfer ARKEO to Arkeo Chain</div>
                    <div style="color: var(--text-dim); font-size: 0.8rem;">In Keplr, send ARKEO from Osmosis to your Arkeo wallet.</div>
                  </div>
                </div>
                <!-- Step 3 -->
                <div style="display: flex; gap: 0.75rem; align-items: flex-start; padding: 0.75rem; background: var(--bg-input); border-radius: 0.5rem;">
                  <span style="background: var(--arkeo); color: #000; min-width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 700; margin-top: 2px;">3</span>
                  <div style="flex: 1;">
                    <div style="font-weight: 600; margin-bottom: 0.25rem;">Come Back & Pay with ARKEO</div>
                    <div style="color: var(--text-dim); font-size: 0.8rem; margin-bottom: 0.5rem;">Once you have ARKEO in your wallet, switch to direct ARKEO payment.</div>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                      <button onclick="selectPayment('arkeo')" style="display: inline-flex; align-items: center; gap: 0.4rem; padding: 0.4rem 0.8rem; background: #10b981; color: #fff; border: none; border-radius: 0.375rem; font-size: 0.8rem; font-weight: 600; cursor: pointer;">
                        üíé Switch to ARKEO Payment
                      </button>
                      <button onclick="recheckBalance()" id="recheckBalanceBtn" style="display: inline-flex; align-items: center; gap: 0.4rem; padding: 0.4rem 0.8rem; background: var(--bg-card); color: var(--text); border: 1px solid var(--border); border-radius: 0.375rem; font-size: 0.8rem; font-weight: 600; cursor: pointer;">
                        üîÑ Check My Balance
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </details>
          
          <div style="padding: 0.5rem 0.75rem; background: rgba(249,115,22,0.1); border-radius: 0.375rem; font-size: 0.8rem;">
            <span style="color: #f97316;">üî• 2% burn proposed</span> ‚Äî subject to DAO vote ¬∑ Every swap creates ARKEO buy pressure
          </div>
        </div>
        <!-- x402 payment info (hidden by default) -->
        <div id="x402PaymentInfo" style="display: none; background: rgba(139,92,246,0.08); border: 1px solid rgba(139,92,246,0.4); border-radius: 0.5rem; padding: 1.25rem; margin-bottom: 1rem; font-size: 0.85rem;">
          <div style="font-weight: 700; margin-bottom: 0.75rem; font-size: 1rem;">‚ö° x402 ‚Äî HTTP-Native Payments</div>
          <div style="color: var(--text-dim); line-height: 1.6; margin-bottom: 1rem;">
            No contract needed. Pay per request with USDC using the <a href="https://x402.org" target="_blank" style="color: var(--arkeo);">x402 protocol</a> ‚Äî Coinbase's open HTTP payment standard. Perfect for <strong>AI agents</strong> and programmatic access.
          </div>

          <!-- Provider x402 support check -->
          <div id="x402CheckStatus" style="margin-bottom: 1rem; padding: 0.75rem; background: var(--bg-input); border-radius: 0.5rem;">
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div>
              <span style="color: var(--text-dim); font-size: 0.85rem;">Checking if provider supports x402...</span>
            </div>
          </div>

          <div id="x402Content" style="display: none;">
            <div style="margin-bottom: 1rem; padding: 0.75rem; background: rgba(139,92,246,0.1); border-radius: 0.5rem;">
              <div style="font-weight: 600; margin-bottom: 0.5rem;">üí∞ Estimated Cost</div>
              <div style="color: var(--text-dim); font-size: 0.85rem;">~$0.0001 per request (paid in USDC on Base network)</div>
            </div>

            <div style="margin-bottom: 1rem;">
              <div style="font-weight: 600; margin-bottom: 0.5rem;">üåê Provider x402 Endpoint</div>
              <div style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 0.5rem; padding: 0.75rem; font-family: 'SF Mono', Monaco, monospace; font-size: 0.85rem; word-break: break-all;">
                <span id="x402Endpoint" style="color: var(--arkeo);">Detecting provider endpoint...</span>
              </div>
            </div>

            <div style="margin-bottom: 1rem;">
              <div style="font-weight: 600; margin-bottom: 0.5rem;">üì¶ Quick Start (Node.js)</div>
              <div style="background: #0d1117; border: 1px solid var(--border); border-radius: 0.5rem; padding: 1rem; font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace; font-size: 0.8rem; overflow-x: auto; position: relative;">
                <button onclick="copyX402Code()" id="x402CopyBtn"
                  style="position: absolute; top: 0.5rem; right: 0.5rem; background: var(--bg-card); border: 1px solid var(--border); color: var(--text-dim); padding: 0.25rem 0.5rem; border-radius: 0.25rem; cursor: pointer; font-size: 0.75rem;">üìã</button>
<pre id="x402CodeBlock" style="color: #e6edf3; margin: 0; white-space: pre-wrap;"><span style="color: #7ee787;">import</span> { wrapFetch } <span style="color: #7ee787;">from</span> <span style="color: #a5d6ff;">"@anthropic-ai/x402-fetch"</span>;

<span style="color: #8b949e;">// Wrap fetch with x402 payment support</span>
<span style="color: #7ee787;">const</span> paidFetch = wrapFetch(fetch, {
  <span style="color: #79c0ff;">walletPrivateKey</span>: process.env.WALLET_KEY,
  <span style="color: #79c0ff;">network</span>: <span style="color: #a5d6ff;">"base"</span>,
});

<span style="color: #8b949e;">// Make a paid RPC request ‚Äî payment happens automatically</span>
<span style="color: #7ee787;">const</span> response = <span style="color: #7ee787;">await</span> paidFetch(
  <span style="color: #a5d6ff;">"<span id="x402CodeUrl">PROVIDER_X402_URL</span>"</span>,
  {
    <span style="color: #79c0ff;">method</span>: <span style="color: #a5d6ff;">"POST"</span>,
    <span style="color: #79c0ff;">body</span>: JSON.stringify({
      <span style="color: #79c0ff;">jsonrpc</span>: <span style="color: #a5d6ff;">"2.0"</span>,
      <span style="color: #79c0ff;">method</span>: <span style="color: #a5d6ff;">"eth_blockNumber"</span>,
      <span style="color: #79c0ff;">params</span>: [],
      <span style="color: #79c0ff;">id</span>: <span style="color: #79c0ff;">1</span>
    })
  }
);

<span style="color: #7ee787;">const</span> data = <span style="color: #7ee787;">await</span> response.json();
console.log(data);</pre>
              </div>
            </div>

            <!-- Test Request Section -->
            <div style="margin-bottom: 1rem;">
              <div style="font-weight: 600; margin-bottom: 0.5rem;">üß™ Test the x402 Endpoint</div>
              <div style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 0.5rem; padding: 1rem;">
                <p style="color: var(--text-dim); font-size: 0.85rem; margin-bottom: 0.75rem;">
                  Click below to make a test request. You'll see the 402 Payment Required response with payment details.
                </p>
                <button onclick="testX402Request()" id="testX402Btn" style="background: var(--arkeo); color: #000; border: none; padding: 0.65rem 1.25rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; font-size: 0.9rem; width: 100%;">
                  üöÄ Send Test Request
                </button>
                <div id="x402TestResult" style="margin-top: 0.75rem; display: none;"></div>
              </div>
            </div>

            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.75rem;">
              <span style="padding: 0.35rem 0.75rem; background: rgba(139,92,246,0.15); border-radius: 1rem; font-size: 0.75rem; color: #a78bfa;">ü§ñ AI Agent Ready</span>
              <span style="padding: 0.35rem 0.75rem; background: rgba(139,92,246,0.15); border-radius: 1rem; font-size: 0.75rem; color: #a78bfa;">üîó No Account Needed</span>
              <span style="padding: 0.35rem 0.75rem; background: rgba(139,92,246,0.15); border-radius: 1rem; font-size: 0.75rem; color: #a78bfa;">üí∏ Pay Per Request</span>
              <span style="padding: 0.35rem 0.75rem; background: rgba(139,92,246,0.15); border-radius: 1rem; font-size: 0.75rem; color: #a78bfa;">üîµ Base Network</span>
            </div>

            <div style="font-size: 0.8rem; color: var(--text-dim);">
              <a href="https://x402.org" target="_blank" style="color: var(--arkeo);">Learn more about x402 ‚Üí</a> ¬∑ 
              <a href="https://www.npmjs.com/package/@anthropic-ai/x402-fetch" target="_blank" style="color: var(--arkeo);">npm package ‚Üí</a>
            </div>
          </div>
        </div>
        <!-- How payments work (collapsible) -->
        <details style="margin-bottom: 1rem; border: 1px solid var(--border); border-radius: 0.5rem; overflow: hidden;">
          <summary style="padding: 0.75rem 1rem; cursor: pointer; font-size: 0.85rem; font-weight: 600; color: var(--text-dim); background: var(--bg-input); user-select: none;">‚ÑπÔ∏è How payments work</summary>
          <div style="padding: 1rem; font-size: 0.8rem; color: var(--text-dim); line-height: 1.6;">
            <div style="margin-bottom: 0.75rem;">
              <div style="font-weight: 600; color: #10b981; margin-bottom: 0.25rem;">üíé Direct ARKEO</div>
              Wallet ‚Üí Contract ¬∑ Instant settlement ¬∑ Native chain payments
            </div>
            <div style="margin-bottom: 0.75rem;">
              <div style="font-weight: 600; color: var(--text); margin-bottom: 0.25rem;">üíµ Via USDC</div>
              Wallet ‚Üí Osmosis Swap ‚Üí ARKEO ‚Üí Contract ¬∑ Market rate ¬∑ ~30 seconds
            </div>
            <div style="padding-top: 0.5rem; border-top: 1px solid var(--border);">
              üî• 2% burn proposed (subject to DAO vote) ‚Äî would reduce supply with every transaction.
            </div>
          </div>
        </details>
      </div>
      
      <div class="form-group">
        <label class="form-label">Contract Duration</label>
        <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem; flex-wrap: wrap;">
          <button type="button" class="duration-preset" data-blocks="900" onclick="setDuration(1, 'hours')">1 Hour</button>
          <button type="button" class="duration-preset" data-blocks="21600" onclick="setDuration(1, 'days')">1 Day</button>
          <button type="button" class="duration-preset" data-blocks="151200" onclick="setDuration(1, 'weeks')">1 Week</button>
          <button type="button" class="duration-preset active" data-blocks="648000" onclick="setDuration(1, 'months')">1 Month</button>
          <button type="button" class="duration-preset" data-blocks="5256000" onclick="setDuration(5256000, 'blocks')">Max (~8 Months)</button>
        </div>
        <div style="display: flex; align-items: center; gap: 0.5rem;">
          <input type="number" class="deposit-input" id="durationValue" value="1" min="1" style="width: 80px;" oninput="updateDuration()">
          <select id="durationUnit" style="padding: 0.6rem 0.75rem; background: var(--bg-input); border: 1px solid var(--border); border-radius: 0.5rem; color: var(--text); font-size: 0.95rem; outline: none;" onchange="updateDuration()">
            <option value="hours">Hours</option>
            <option value="days">Days</option>
            <option value="weeks">Weeks</option>
            <option value="months">Months</option>
            <option value="years" selected>Years</option>
          </select>
        </div>
        <div class="deposit-estimate" id="durationEstimate">
          ‚âà <strong>7,884,000</strong> blocks (~1 year at ~4s/block)
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Deposit Amount</label>
        <div class="deposit-input-group">
          <input type="number" class="deposit-input" id="depositAmount" value="10" min="1" oninput="updateEstimate()">
          <span class="deposit-suffix" id="depositSuffix">ARKEO</span>
        </div>
        <div class="deposit-estimate" id="depositEstimate">
          ‚âà <strong>10,000</strong> requests
        </div>
      </div>
      
      <!-- Failover Protection -->
      <div class="form-group">
        <label class="form-label">Uptime Protection</label>
        <div style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 0.5rem; padding: 1rem;">
          <label style="display: flex; align-items: flex-start; gap: 0.75rem; cursor: pointer;">
            <input type="checkbox" id="enableFailover" checked onchange="failoverEnabled = this.checked; saveState();" style="margin-top: 0.25rem; width: 18px; height: 18px; accent-color: var(--arkeo);">
            <div>
              <div style="font-weight: 600; margin-bottom: 0.25rem;">üõ°Ô∏è Enable Auto-Failover</div>
              <div style="font-size: 0.85rem; color: var(--text-dim); line-height: 1.4;">
                Automatically creates overlapping backup contracts and routes to best available providers.
              </div>
            </div>
          </label>
          
          <div id="failoverDetails" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
            <div style="font-size: 0.85rem; margin-bottom: 0.75rem;">
              <strong>How providers are ranked:</strong>
            </div>
            <div style="display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.85rem;">
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <span style="background: var(--arkeo); color: #000; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: 700;">1</span>
                <span><strong>Location match</strong> ‚Äî Providers in your region first</span>
              </div>
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <span style="background: var(--arkeo); color: #000; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: 700;">2</span>
                <span><strong>Lowest rate</strong> ‚Äî Cheapest pay-as-you-go rate</span>
              </div>
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <span style="background: var(--arkeo); color: #000; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: 700;">3</span>
                <span><strong>Top 5 queued</strong> ‚Äî Best alternatives ready to switch</span>
              </div>
            </div>
            <div style="margin-top: 1rem; display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; font-size: 0.85rem;">
              <div style="background: rgba(59, 224, 255, 0.1); padding: 0.75rem; border-radius: 0.5rem;">
                <div style="color: var(--text-dim); margin-bottom: 0.25rem;">Overlap Threshold</div>
                <div style="font-weight: 600; color: var(--arkeo);">20% remaining</div>
              </div>
              <div style="background: rgba(16, 185, 129, 0.1); padding: 0.75rem; border-radius: 0.5rem;">
                <div style="color: var(--text-dim); margin-bottom: 0.25rem;">Backup Contracts</div>
                <div style="font-weight: 600; color: #10b981;">Auto-created</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- API Signing Key Section -->
      <div class="form-group" style="margin-top: 2rem;">
        <label class="form-label">üîë API Signing Key</label>
        <div style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1.25rem;">
          
          <!-- Generate Key Flow (default) -->
          <div id="generateKeyFlow">
            <div style="color: var(--text-dim); font-size: 0.85rem; line-height: 1.5; margin-bottom: 1rem;">
              This creates a dedicated API key for making queries. It can only access your contract ‚Äî it can't touch your wallet or funds.
            </div>
            <button type="button" class="btn btn-primary" onclick="generateSigningKey()" style="width: 100%; font-size: 1rem; padding: 0.75rem;">
              üîë Generate API Key
            </button>
            <div style="text-align: center; margin-top: 0.75rem;">
              <a href="#" onclick="selectKeyMode('existing'); return false;" style="color: var(--arkeo); font-size: 0.9rem; text-decoration: underline;">Already have a key? Import it instead</a>
            </div>
            
            <!-- Key Display (hidden until generated) -->
            <div id="generatedKeyDisplay" style="display: none; margin-top: 1rem;">
              <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid #ef4444; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem; font-weight: 600; margin-bottom: 0.5rem; color: #ef4444;">
                  ‚ö†Ô∏è Save your API key now!
                </div>
                <div style="font-size: 0.85rem; color: var(--text-dim); line-height: 1.4;">
                  Copy and save this somewhere safe. <strong>You won't see the private key again.</strong>
                </div>
              </div>
              
              <div style="background: #0d1117; border: 1px solid var(--border); border-radius: 0.5rem; padding: 1rem; font-family: monospace; font-size: 0.8rem; word-break: break-all; line-height: 2; position: relative;">
                <div><span style="color: var(--text-dim);">Private Key: </span><span id="privateKeyDisplay" style="color: #ff7b72;"></span></div>
                <div><span style="color: var(--text-dim);">Public Key:  </span><span id="publicKeyDisplay" style="color: var(--arkeo);"></span></div>
                <div><span style="color: var(--text-dim);">Address:     </span><span id="addressDisplay" style="color: var(--text);"></span></div>
              </div>
              
              <button onclick="copyAllKeys()" style="width: 100%; margin-top: 0.75rem; background: var(--bg-card); border: 1px solid var(--border); color: var(--text); padding: 0.6rem; border-radius: 0.5rem; cursor: pointer; font-size: 0.9rem; font-weight: 600;" id="copyAllKeysBtn">
                üìã Copy All to Clipboard
              </button>
              
              <div style="margin-top: 0.75rem; padding: 0.75rem; background: rgba(59, 224, 255, 0.05); border-radius: 0.5rem; font-size: 0.85rem; color: var(--text-dim);">
                ‚úÖ Key ready ‚Äî This will be set as the contract delegate
              </div>
            </div>
          </div>
          
          <!-- Existing Key Flow -->
          <div id="existingKeyFlow" style="display: none;">
            <div style="color: var(--text-dim); font-size: 0.85rem; line-height: 1.5; margin-bottom: 1rem;">
              Paste your existing private key (hex) or public key (arkeopub...). If you provide a public key, you must already have the private key stored securely.
            </div>
            <div style="margin-bottom: 0.75rem;">
              <a href="#" onclick="selectKeyMode('generate'); return false;" style="color: var(--text-dim); font-size: 0.8rem; text-decoration: underline;">‚Üê Back to generate new key</a>
            </div>
            <input type="text" id="existingKeyInput" class="form-input" placeholder="Private key (hex) or public key (arkeopub...)" oninput="parseExistingKey()" style="margin-bottom: 1rem;">
            
            <!-- Parsed Key Display -->
            <div id="parsedKeyDisplay" style="display: none;">
              <div style="margin-bottom: 1rem;">
                <div style="font-weight: 600; font-size: 0.85rem; margin-bottom: 0.5rem; color: var(--text-dim);">Public Key</div>
                <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 0.5rem; padding: 0.75rem; font-family: monospace; font-size: 0.8rem; word-break: break-all; color: var(--arkeo);" id="existingPubKeyDisplay"></div>
              </div>
              
              <div>
                <div style="font-weight: 600; font-size: 0.85rem; margin-bottom: 0.5rem; color: var(--text-dim);">Address</div>
                <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 0.5rem; padding: 0.75rem; font-family: monospace; font-size: 0.8rem; word-break: break-all; color: var(--text);" id="existingAddressDisplay"></div>
              </div>
              
              <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(59, 224, 255, 0.05); border-radius: 0.5rem; font-size: 0.8rem; color: var(--text-dim);">
                ‚úì Key imported ‚Äî This will be set as the contract delegate
              </div>
            </div>
          </div>
          
          <!-- Security Notes -->
          <details style="margin-top: 1rem; border-top: 1px solid var(--border); padding-top: 1rem;">
            <summary style="cursor: pointer; font-size: 0.85rem; font-weight: 600; color: var(--text-dim); user-select: none;">üîí Security Details</summary>
            <div style="padding: 0.75rem 0; font-size: 0.8rem; color: var(--text-dim); line-height: 1.6;">
              <ul style="margin: 0; padding-left: 1.5rem;">
                <li>Generated entirely in your browser ‚Äî never sent to any server</li>
                <li>This key can ONLY make RPC queries against your contract</li>
                <li>It cannot access your wallet or move funds</li>
                <li>Treat it like an API key ‚Äî store it securely on your server</li>
                <li>You can revoke access anytime by closing the contract</li>
              </ul>
              <div style="margin-top: 0.75rem; padding: 0.75rem; background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); border-radius: 0.5rem;">
                <strong style="color: #ef4444;">‚ö†Ô∏è IMPORTANT:</strong>
                <ul style="margin: 0.5rem 0 0 1rem; font-size: 0.82rem; line-height: 1.6;">
                  <li><strong>NEVER share your private key with anyone.</strong></li>
                  <li>Do not post it publicly, email it, or store it in plain text.</li>
                  <li>If compromised, close your contract immediately to revoke access.</li>
                  <li>Arkeo and this marketplace will <strong>never</strong> ask you for your private key.</li>
                </ul>
              </div>
            </div>
          </details>
        </div>
      </div>
      
      <div class="wallet-section" id="walletSection">
        <div class="wallet-label">Connect your wallet to open the contract</div>
        <button class="connect-wallet-btn" onclick="connectWallet()">
          üîó Connect Keplr Wallet
        </button>
      </div>
      
      <div id="contractStatus"></div>
      
      <div class="btn-group">
        <button class="btn btn-secondary" onclick="goToStep(2)">‚Üê Back</button>
        <button class="btn btn-primary hidden" id="openContractBtn" onclick="openContract()">
          Open Contract
        </button>
      </div>
    </div>

    <!-- Step 4: Success -->
    <div class="wizard-card hidden" id="step4">
      <div class="success-container">
        <div class="success-icon">üéâ</div>
        <h2 class="success-title">You're Connected!</h2>
        <p class="success-subtitle">Your contract is open and ready to use.</p>
        
        <div class="endpoint-display">
          <div class="endpoint-label">Your RPC Endpoint:</div>
          <div class="endpoint-url" id="finalEndpoint">https://sentinel.fastnode.io/eth?contract=12345</div>
          <button class="copy-btn" onclick="copyEndpoint()">üìã Copy Endpoint</button>
        </div>
        
        <div class="contract-summary" style="text-align: left;">
          <div class="summary-row">
            <span class="summary-label">Deposited</span>
            <span class="summary-value" id="finalDeposit">10 ARKEO</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Duration</span>
            <span class="summary-value" id="finalDuration">~1 year</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Available Requests</span>
            <span class="summary-value" id="finalRequests">~10,000</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Contract ID</span>
            <span class="summary-value" id="finalContractId">#12345</span>
          </div>
          <div class="summary-row" id="failoverStatus">
            <span class="summary-label">Auto-Failover</span>
            <span class="summary-value" style="color: #10b981;">üõ°Ô∏è Enabled</span>
          </div>
        </div>
        
        <div id="failoverInfo" style="background: rgba(16, 185, 129, 0.1); border: 1px solid #10b981; border-radius: 0.5rem; padding: 1rem; margin: 1rem 0; text-align: left;">
          <div style="font-weight: 600; margin-bottom: 0.5rem;">üõ°Ô∏è Failover Protection Active</div>
          <div style="font-size: 0.85rem; color: var(--text-dim); line-height: 1.5;">
            When your contract reaches 20% remaining, an overlapping backup contract is auto-created.
            If your provider goes down, traffic routes to the next best provider instantly.
          </div>
          <div style="margin-top: 0.75rem; font-size: 0.85rem;">
            <strong>Ranked backup providers:</strong>
          </div>
          <div id="backupProvidersList" style="margin-top: 0.5rem; display: flex; flex-direction: column; gap: 0.25rem; font-size: 0.85rem;">
            <!-- Populated by JS -->
          </div>
        </div>
        
        <!-- Developer Integration Section -->
        <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1.5rem; margin: 2rem 0; text-align: left;">
          <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem;">üöÄ Start Making Queries</h3>
          <p style="color: var(--text-dim); margin-bottom: 1.5rem;">Use our SDK to start making authenticated RPC calls from your application.</p>
          
          <!-- Language tabs -->
          <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; border-bottom: 1px solid var(--border);">
            <button class="sdk-tab active" data-lang="js" onclick="switchSDKTab('js')" style="padding: 0.75rem 1.5rem; background: none; border: none; border-bottom: 2px solid var(--arkeo); color: var(--arkeo); font-weight: 600; cursor: pointer; transition: all 0.2s;">
              JavaScript
            </button>
            <button class="sdk-tab" data-lang="python" onclick="switchSDKTab('python')" style="padding: 0.75rem 1.5rem; background: none; border: none; border-bottom: 2px solid transparent; color: var(--text-dim); font-weight: 600; cursor: pointer; transition: all 0.2s;">
              Python
            </button>
          </div>
          
          <!-- JavaScript content -->
          <div id="sdk-js" class="sdk-content">
            <!-- Step-by-step setup -->
            <div style="margin-bottom: 2rem;">
              <div style="font-weight: 600; margin-bottom: 1rem; font-size: 1rem;">üìã Setup Steps</div>
              
              <!-- Step 1 -->
              <div style="margin-bottom: 1.5rem;">
                <div style="font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--arkeo);">Step 1: Create a project folder</div>
                <div style="background: #0d1117; border: 1px solid var(--border); border-radius: 0.5rem; padding: 1rem; font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace; font-size: 0.85rem; position: relative;">
                  <button onclick="copyToClipboard(this, 'mkdir my-arkeo-app && cd my-arkeo-app')" style="position: absolute; top: 0.5rem; right: 0.5rem; background: var(--bg-card); border: 1px solid var(--border); color: var(--text-dim); padding: 0.25rem 0.5rem; border-radius: 0.25rem; cursor: pointer; font-size: 0.75rem;">üìã</button>
                  <code style="color: #e6edf3;">mkdir my-arkeo-app && cd my-arkeo-app</code>
                </div>
              </div>
              
              <!-- Step 2 -->
              <div style="margin-bottom: 1.5rem;">
                <div style="font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--arkeo);">Step 2: Install dependencies</div>
                <div style="background: #0d1117; border: 1px solid var(--border); border-radius: 0.5rem; padding: 1rem; font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace; font-size: 0.85rem; position: relative;">
                  <button onclick="copyToClipboard(this, 'npm init -y && npm install @noble/secp256k1@2.0.0 @noble/hashes@1.3.3')" style="position: absolute; top: 0.5rem; right: 0.5rem; background: var(--bg-card); border: 1px solid var(--border); color: var(--text-dim); padding: 0.25rem 0.5rem; border-radius: 0.25rem; cursor: pointer; font-size: 0.75rem;">üìã</button>
                  <code style="color: #e6edf3;">npm init -y && npm install @noble/secp256k1@2.0.0 @noble/hashes@1.3.3</code>
                </div>
              </div>
              
              <!-- Step 3 -->
              <div style="margin-bottom: 1.5rem;">
                <div style="font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--arkeo);">Step 3: Create your app file</div>
                <div style="color: var(--text-dim); font-size: 0.85rem; margin-bottom: 0.5rem;">Copy the code snippet below and save it as <code style="background: var(--bg-input); padding: 0.15rem 0.4rem; border-radius: 0.25rem;">app.mjs</code></div>
              </div>
            </div>
            
            <div style="margin-bottom: 1.5rem;">
              <div style="font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem;">üíª Code Example (app.mjs)</div>
              <div style="background: #0d1117; border: 1px solid var(--border); border-radius: 0.5rem; padding: 1rem; font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace; font-size: 0.85rem; position: relative; overflow-x: auto;">
                <button onclick="copyToClipboard(this, this.parentElement.querySelector('pre').textContent)" style="position: absolute; top: 0.5rem; right: 0.5rem; background: var(--bg-card); border: 1px solid var(--border); color: var(--text-dim); padding: 0.25rem 0.5rem; border-radius: 0.25rem; cursor: pointer; font-size: 0.75rem;">üìã</button>
<pre style="margin: 0; color: #e6edf3; line-height: 1.6;"><span style="color: #ff7b72;">import</span> { ArkeoClient } <span style="color: #ff7b72;">from</span> <span style="color: #a5d6ff;">'./arkeo-client.js'</span>;

<span style="color: #ff7b72;">const</span> <span style="color: #79c0ff;">client</span> <span style="color: #ff7b72;">=</span> <span style="color: #ff7b72;">new</span> <span style="color: #d2a8ff;">ArkeoClient</span>({
  <span style="color: #79c0ff;">sentinelUrl</span>: <span style="color: #a5d6ff;" id="js-endpoint">'ENDPOINT_URL'</span>,
  <span style="color: #79c0ff;">contractId</span>: <span style="color: #79c0ff;" id="js-contract-id">CONTRACT_ID</span>,
  <span style="color: #79c0ff;">privateKey</span>: <span style="color: #a5d6ff;">'YOUR_SIGNING_KEY_HEX'</span>,
  <span style="color: #79c0ff;">service</span>: <span style="color: #a5d6ff;" id="js-service">'SERVICE_NAME'</span>
});

<span style="color: #8b949e;">// Make authenticated RPC calls</span>
<span style="color: #ff7b72;">const</span> <span style="color: #79c0ff;">status</span> <span style="color: #ff7b72;">=</span> <span style="color: #ff7b72;">await</span> client.<span style="color: #d2a8ff;">rpcJson</span>(<span style="color: #a5d6ff;">'/status'</span>);
<span style="color: #79c0ff;">console</span>.<span style="color: #d2a8ff;">log</span>(status);</pre>
              </div>
            </div>
            
            <!-- Step 4 -->
            <div style="margin-bottom: 1rem;">
              <div style="font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--arkeo);">Step 4: Run it</div>
              <div style="background: #0d1117; border: 1px solid var(--border); border-radius: 0.5rem; padding: 1rem; font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace; font-size: 0.85rem; position: relative;">
                <button onclick="copyToClipboard(this, 'node app.mjs')" style="position: absolute; top: 0.5rem; right: 0.5rem; background: var(--bg-card); border: 1px solid var(--border); color: var(--text-dim); padding: 0.25rem 0.5rem; border-radius: 0.25rem; cursor: pointer; font-size: 0.75rem;">üìã</button>
                <code style="color: #e6edf3;">node app.mjs</code>
              </div>
            </div>
          </div>
          
          <!-- Python content -->
          <div id="sdk-python" class="sdk-content" style="display: none;">
            <!-- Step-by-step setup -->
            <div style="margin-bottom: 2rem;">
              <div style="font-weight: 600; margin-bottom: 1rem; font-size: 1rem;">üìã Setup Steps</div>
              
              <!-- Step 1 -->
              <div style="margin-bottom: 1.5rem;">
                <div style="font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--arkeo);">Step 1: Install dependencies</div>
                <div style="background: #0d1117; border: 1px solid var(--border); border-radius: 0.5rem; padding: 1rem; font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace; font-size: 0.85rem; position: relative;">
                  <button onclick="copyToClipboard(this, 'pip install ecdsa requests')" style="position: absolute; top: 0.5rem; right: 0.5rem; background: var(--bg-card); border: 1px solid var(--border); color: var(--text-dim); padding: 0.25rem 0.5rem; border-radius: 0.25rem; cursor: pointer; font-size: 0.75rem;">üìã</button>
                  <code style="color: #e6edf3;">pip install ecdsa requests</code>
                </div>
              </div>
              
              <!-- Step 2 -->
              <div style="margin-bottom: 1.5rem;">
                <div style="font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--arkeo);">Step 2: Create your app file</div>
                <div style="color: var(--text-dim); font-size: 0.85rem; margin-bottom: 0.5rem;">Copy the code snippet below and save it as <code style="background: var(--bg-input); padding: 0.15rem 0.4rem; border-radius: 0.25rem;">app.py</code></div>
              </div>
            </div>
            
            <div style="margin-bottom: 1.5rem;">
              <div style="font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem;">üíª Code Example (app.py)</div>
              <div style="background: #0d1117; border: 1px solid var(--border); border-radius: 0.5rem; padding: 1rem; font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace; font-size: 0.85rem; position: relative; overflow-x: auto;">
                <button onclick="copyToClipboard(this, this.parentElement.querySelector('pre').textContent)" style="position: absolute; top: 0.5rem; right: 0.5rem; background: var(--bg-card); border: 1px solid var(--border); color: var(--text-dim); padding: 0.25rem 0.5rem; border-radius: 0.25rem; cursor: pointer; font-size: 0.75rem;">üìã</button>
<pre style="margin: 0; color: #e6edf3; line-height: 1.6;"><span style="color: #ff7b72;">from</span> arkeo_client <span style="color: #ff7b72;">import</span> ArkeoClient

<span style="color: #79c0ff;">client</span> <span style="color: #ff7b72;">=</span> <span style="color: #d2a8ff;">ArkeoClient</span>(
    <span style="color: #79c0ff;">sentinel_url</span><span style="color: #ff7b72;">=</span><span style="color: #a5d6ff;" id="py-endpoint">'ENDPOINT_URL'</span>,
    <span style="color: #79c0ff;">contract_id</span><span style="color: #ff7b72;">=</span><span style="color: #79c0ff;" id="py-contract-id">CONTRACT_ID</span>,
    <span style="color: #79c0ff;">private_key</span><span style="color: #ff7b72;">=</span><span style="color: #a5d6ff;">'YOUR_SIGNING_KEY_HEX'</span>,
    <span style="color: #79c0ff;">service</span><span style="color: #ff7b72;">=</span><span style="color: #a5d6ff;" id="py-service">'SERVICE_NAME'</span>
)

<span style="color: #8b949e;"># Make authenticated RPC calls</span>
<span style="color: #79c0ff;">status</span> <span style="color: #ff7b72;">=</span> client.<span style="color: #d2a8ff;">rpc_json</span>(<span style="color: #a5d6ff;">'/status'</span>)
<span style="color: #ff7b72;">print</span>(status)</pre>
              </div>
            </div>
            
            <!-- Step 3 -->
            <div style="margin-bottom: 1rem;">
              <div style="font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--arkeo);">Step 3: Run it</div>
              <div style="background: #0d1117; border: 1px solid var(--border); border-radius: 0.5rem; padding: 1rem; font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace; font-size: 0.85rem; position: relative;">
                <button onclick="copyToClipboard(this, 'python app.py')" style="position: absolute; top: 0.5rem; right: 0.5rem; background: var(--bg-card); border: 1px solid var(--border); color: var(--text-dim); padding: 0.25rem 0.5rem; border-radius: 0.25rem; cursor: pointer; font-size: 0.75rem;">üìã</button>
                <code style="color: #e6edf3;">python app.py</code>
              </div>
            </div>
          </div>
          
          <!-- Security warning -->
          <div id="sdkSecurityWarning" style="background: rgba(239, 68, 68, 0.1); border: 1px solid #ef4444; border-radius: 0.5rem; padding: 1rem; margin: 1rem 0;">
            <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
              <span style="font-size: 1.25rem;">‚ö†Ô∏è</span>
              <div>
                <div style="font-weight: 600; margin-bottom: 0.25rem;">Security Best Practice</div>
                <div style="font-size: 0.85rem; color: var(--text-dim); line-height: 1.5;">
                  <span id="sdkSecurityMessage">
                    Use a dedicated signing key for SDK calls, not your main wallet key. This limits exposure if your application is compromised.
                  </span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Link to full docs -->
          <div style="text-align: center; margin-top: 1.5rem;">
            <a href="sdk/README.md" target="_blank" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.5rem; background: var(--arkeo); color: #000; text-decoration: none; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s;">
              üìö View Full SDK Documentation ‚Üí
            </a>
          </div>
        </div>

        <a href="index.html" class="listing-link">Back to Marketplace</a>
        <a href="#" class="listing-link secondary" onclick="findAnother()">Find Another Provider</a>
      </div>
    </div>
  </div>

  <script src="js/providers.js"></script>
  <script>
    // API Configuration
    const API_BASE = 'https://rest-seed.arkeo.network';
    
    // KNOWN_PROVIDERS loaded from js/providers.js (included via script tag)
    
    // Helper to find known provider by pubkey (use canonical function from providers.js if available)
    const findKnown = typeof findKnownProvider === 'function' ? findKnownProvider : function(pk) {
      if (typeof KNOWN_PROVIDERS === 'undefined') return null;
      if (KNOWN_PROVIDERS[pk]) return KNOWN_PROVIDERS[pk];
      const match = Object.keys(KNOWN_PROVIDERS).find(k =>
        k.startsWith(pk.slice(0, 40)) || pk.startsWith(k.slice(0, 40)));
      return match ? KNOWN_PROVIDERS[match] : null;
    };
    
    // Display name mapping for services
    const CHAIN_DISPLAY_NAMES = {
      'arkeo-mainnet-rpc': 'Arkeo (RPC)',
      'arkeo-mainnet-fullnode': 'Arkeo',
      'btc-mainnet-fullnode': 'Bitcoin',
      'eth-mainnet-fullnode': 'Ethereum',
      'gaia-mainnet-rpc': 'Cosmos Hub (RPC)',
      'gaia-mainnet-fullnode': 'Cosmos Hub',
      'osmosis-mainnet-fullnode': 'Osmosis',
      'thorchain-mainnet-fullnode': 'THORChain',
      'thorchain-v1-fullnode': 'THORChain V1',
      'maya-mainnet-fullnode': 'Maya Protocol',
      'base-mainnet-fullnode': 'Base',
      'base-mainnet-archivenode': 'Base (Archive)',
      'avax-mainnet-fullnode': 'Avalanche',
      'bsc-mainnet-fullnode': 'BNB Chain',
      'sol-mainnet-fullnode': 'Solana',
      'dot-mainnet-fullnode': 'Polkadot',
      'matic-mainnet-fullnode': 'Polygon',
      'arb-mainnet-fullnode': 'Arbitrum',
      'arbitrum-mainnet-fullnode': 'Arbitrum',
      'op-mainnet-fullnode': 'Optimism',
      'aptos-mainnet-fullnode': 'Aptos',
      'etc-mainnet-fullnode': 'Ethereum Classic',
      'eth-mainnet-archivenode': 'Ethereum (Archive)',
      'eth-mainnet-lightnode': 'Ethereum (Light)',
      'eth-holesky-testnet-fullnode': 'ETH Holesky Testnet',
      'eth-sepolia-testnet-fullnode': 'ETH Sepolia Testnet',
      'inj-mainnet-fullnode': 'Injective',
      'near-mainnet-fullnode': 'NEAR',
      'tao-mainnet-archivenode': 'Bittensor (Archive)',
      'arkeo-mainnet-archivenode': 'Arkeo (Archive)',
      'arkeo-mainnet-rest': 'Arkeo (REST)',
    };
    
    // Search aliases ‚Äî maps common search terms to service name fragments
    const SEARCH_ALIASES = {
      'cosmos': 'gaia', 'atom': 'gaia', 'cosmoshub': 'gaia',
      'thor': 'thorchain', 'rune': 'thorchain',
      'btc': 'btc', 'bitcoin': 'btc',
      'eth': 'eth', 'ethereum': 'eth',
      'maya': 'maya', 'cacao': 'maya',
      'osmo': 'osmosis',
      'bnb': 'bsc', 'binance': 'bsc',
      'sol': 'sol', 'solana': 'sol',
      'dot': 'dot', 'polkadot': 'dot',
      'avax': 'avax', 'avalanche': 'avax',
      'matic': 'matic', 'polygon': 'matic',
      'arb': 'arb', 'arbitrum': 'arb',
      'op': 'op-', 'optimism': 'op-',
      'base': 'base',
    };
    
    // Service ID to actual service name (for API calls)
    const SERVICE_ID_TO_NAME = {
      1: 'arkeo-mainnet-rpc',
      2: 'arkeo-mainnet-fullnode',
    };
    
    // Demand data from contracts
    let serviceDemand = {};
    
    // Service ID to name lookup (built from API)
    let serviceIdToName = {};
    
    // Real chain and provider data (loaded from API)
    let chains = [];
    let providersByChain = {};
    let rawProviders = [];

    let selectedChain = null;
    let selectedProvider = null;
    let currentStep = 1;
    let paymentMethod = 'arkeo'; // Default to ARKEO
    let walletAddress = null;
    let walletPubkeyBytes = null;
    let failoverEnabled = true; // Default to enabled
    
    // State persistence constants
    const STATE_KEY = 'arkeo_subscribe_state';
    
    // ============================================================
    // STATE PERSISTENCE
    // ============================================================
    function saveState() {
      try {
        const state = {
          currentStep,
          selectedChain,
          selectedProvider,
          contractDurationBlocks,
          depositAmount: document.getElementById('depositAmount')?.value || '10',
          paymentMethod,
          signingKey: signingKey ? { publicKeyBech32: signingKey.publicKeyBech32, address: signingKey.address } : null, // Never persist private key
          walletAddress,
          walletPubkeyBytes: walletPubkeyBytes ? Array.from(walletPubkeyBytes) : null,
          failoverEnabled,
          timestamp: Date.now()
        };
        sessionStorage.setItem(STATE_KEY, JSON.stringify(state));
        console.log('State saved:', state);
      } catch (err) {
        console.error('Failed to save state:', err);
      }
    }
    
    function restoreState() {
      try {
        const savedState = sessionStorage.getItem(STATE_KEY);
        if (!savedState) return false;
        
        const state = JSON.parse(savedState);
        console.log('Restoring state:', state);
        
        // Check for URL provider override - if provider param exists AND differs from saved, don't restore
        const urlParams = new URLSearchParams(window.location.search);
        const urlProvider = urlParams.get('provider');
        if (urlProvider && state.selectedProvider?.pubkey !== urlProvider) {
          console.log('URL provider differs from saved state - clearing saved state');
          clearState();
          return false;
        }
        
        // Restore variables
        if (state.selectedChain) selectedChain = state.selectedChain;
        if (state.selectedProvider) selectedProvider = state.selectedProvider;
        if (state.contractDurationBlocks) contractDurationBlocks = state.contractDurationBlocks;
        if (state.paymentMethod) paymentMethod = state.paymentMethod;
        if (state.signingKey) {
          signingKey = state.signingKey;
          // Never restore private key from storage ‚Äî it should not have been saved,
          // but clean up any legacy data that might have it
          if (signingKey) delete signingKey.privateKeyHex;
        }
        if (state.walletAddress) walletAddress = state.walletAddress;
        if (state.walletPubkeyBytes) walletPubkeyBytes = new Uint8Array(state.walletPubkeyBytes);
        if (typeof state.failoverEnabled === 'boolean') failoverEnabled = state.failoverEnabled;
        
        // Restore deposit amount
        if (state.depositAmount) {
          const depositInput = document.getElementById('depositAmount');
          if (depositInput) depositInput.value = state.depositAmount;
        }
        
        // Restore payment method UI
        if (state.paymentMethod) {
          selectPayment(state.paymentMethod);
        }
        
        // Restore failover checkbox
        const failoverCheckbox = document.getElementById('enableFailover');
        if (failoverCheckbox) failoverCheckbox.checked = failoverEnabled;
        
        // Restore signing key display ‚Äî NEVER restore private key
        // Private key is only shown once at generation time, never persisted or restored
        if (signingKey && signingKey.publicKeyBech32) {
          const publicKeyDisplay = document.getElementById('publicKeyDisplay');
          const addressDisplay = document.getElementById('addressDisplay');
          const generatedKeyDisplay = document.getElementById('generatedKeyDisplay');
          const privateKeyDisplay = document.getElementById('privateKeyDisplay');
          
          if (privateKeyDisplay) privateKeyDisplay.textContent = '‚Ä¢‚Ä¢‚Ä¢ saved at generation time ‚Äî not stored ‚Ä¢‚Ä¢‚Ä¢';
          if (publicKeyDisplay) publicKeyDisplay.textContent = signingKey.publicKeyBech32;
          if (addressDisplay) addressDisplay.textContent = signingKey.address;
          if (generatedKeyDisplay) generatedKeyDisplay.style.display = 'block';
        } else if (signingKey && signingKey.publicKeyBech32) {
          // Existing key mode
          selectKeyMode('existing');
          const existingKeyInput = document.getElementById('existingKeyInput');
          if (existingKeyInput) existingKeyInput.value = signingKey.publicKeyBech32;
          
          const existingPubKeyDisplay = document.getElementById('existingPubKeyDisplay');
          const existingAddressDisplay = document.getElementById('existingAddressDisplay');
          const parsedKeyDisplay = document.getElementById('parsedKeyDisplay');
          
          if (existingPubKeyDisplay) existingPubKeyDisplay.textContent = signingKey.publicKeyBech32;
          if (existingAddressDisplay) existingAddressDisplay.textContent = signingKey.address;
          if (parsedKeyDisplay) parsedKeyDisplay.style.display = 'block';
        }
        
        // Restore wallet connection UI (but don't actually connect - Keplr needs user interaction)
        if (walletAddress) {
          const walletSection = document.getElementById('walletSection');
          const openBtn = document.getElementById('openContractBtn');
          
          walletSection.innerHTML = `
            <div style="text-align: center;">
              <div style="color: var(--warning);">
                <div>‚ö†Ô∏è Wallet was connected</div>
                <div style="font-weight: 600; margin-top: 0.25rem;">${walletAddress.slice(0, 12)}...${walletAddress.slice(-6)}</div>
                <div style="color: var(--text-dim); font-size: 0.85rem; margin-top: 0.5rem;">
                  Please reconnect to continue
                </div>
                <button class="connect-wallet-btn" style="margin-top: 0.75rem;" onclick="connectWallet()">
                  üîó Reconnect Keplr Wallet
                </button>
              </div>
            </div>
          `;
        }
        
        // Restore step-specific UI
        if (state.currentStep >= 2 && selectedChain) {
          // Highlight selected chain
          setTimeout(() => {
            document.querySelectorAll('.chain-option').forEach(el => {
              const chainName = el.querySelector('.chain-name')?.textContent;
              if (chainName === selectedChain.name) {
                el.classList.add('selected');
              }
            });
            document.getElementById('nextBtn1').disabled = false;
            document.getElementById('selectedChainName').textContent = selectedChain.name;
          }, 100);
        }
        
        if (state.currentStep >= 3 && selectedProvider) {
          // Highlight selected provider and update summary
          setTimeout(() => {
            document.querySelectorAll('.provider-card').forEach(el => {
              if (el.getAttribute('data-pubkey') === selectedProvider.pubkey) {
                el.classList.add('selected');
              }
            });
            document.getElementById('nextBtn2').disabled = false;
            document.getElementById('summaryChain').textContent = selectedChain?.name || 'Selected Chain';
            document.getElementById('summaryProvider').textContent = selectedProvider.name;
            document.getElementById('summaryRate').textContent = selectedProvider.rate + ' ARKEO/request';
          }, 100);
        }
        
        // Navigate to saved step
        if (state.currentStep && state.currentStep > 1) {
          currentStep = state.currentStep;
          setTimeout(() => goToStep(state.currentStep), 150);
        }
        
        return true;
      } catch (err) {
        console.error('Failed to restore state:', err);
        return false;
      }
    }
    
    function clearState() {
      try {
        sessionStorage.removeItem(STATE_KEY);
        console.log('State cleared');
      } catch (err) {
        console.error('Failed to clear state:', err);
      }
    }
    
    // Configuration
    const CONFIG = {
      REST_API: 'https://rest-seed.arkeo.network',
      RPC_API: 'https://rpc-seed.arkeo.network',
      CHAIN_ID: 'arkeo-main-v1',
      ARKEO_DENOM: 'uarkeo',
      ARKEO_DIVISOR: 100_000_000,
      EXPLORER_TX: 'https://explorer.arkeo.network/arkeo/tx/',
    };
    
    // Arkeo chain configuration for Keplr
    const ARKEO_CHAIN_CONFIG = {
      chainId: "arkeo-main-v1",
      chainName: "Arkeo Network",
      rpc: "https://rpc-seed.arkeo.network",
      rest: "https://rest-seed.arkeo.network",
      bip44: { coinType: 118 },
      bech32Config: {
        bech32PrefixAccAddr: "arkeo",
        bech32PrefixAccPub: "arkeopub",
        bech32PrefixValAddr: "arkeovaloper",
        bech32PrefixValPub: "arkeovaloperpub",
        bech32PrefixConsAddr: "arkeovalcons",
        bech32PrefixConsPub: "arkeovalconspub"
      },
      currencies: [{
        coinDenom: "ARKEO",
        coinMinimalDenom: "uarkeo",
        coinDecimals: 8,
        coinGeckoId: "arkeo"
      }],
      feeCurrencies: [{
        coinDenom: "ARKEO",
        coinMinimalDenom: "uarkeo",
        coinDecimals: 8,
        coinGeckoId: "arkeo",
        gasPriceStep: { low: 0.01, average: 0.025, high: 0.04 }
      }],
      stakeCurrency: {
        coinDenom: "ARKEO",
        coinMinimalDenom: "uarkeo",
        coinDecimals: 8,
        coinGeckoId: "arkeo"
      }
    };

    // Convert pubkey bytes to bech32 format (arkeopub1...)
    function pubkeyToBech32(pubkeyBytes, prefix) {
      const aminoPrefix = [0xeb, 0x5a, 0xe9, 0x87, 0x21];
      const pubkey = new Uint8Array(pubkeyBytes);
      const combined = new Uint8Array(aminoPrefix.length + pubkey.length);
      combined.set(aminoPrefix);
      combined.set(pubkey, aminoPrefix.length);
      const words = toWords(combined);
      return bech32Encode(prefix, words);
    }
    
    function toWords(bytes) {
      const words = [];
      let value = 0;
      let bits = 0;
      for (const byte of bytes) {
        value = (value << 8) | byte;
        bits += 8;
        while (bits >= 5) {
          bits -= 5;
          words.push((value >> bits) & 0x1f);
        }
      }
      if (bits > 0) {
        words.push((value << (5 - bits)) & 0x1f);
      }
      return words;
    }
    
    function bech32Encode(prefix, words) {
      const CHARSET = 'qpzry9x8gf2tvdw0s3jn54khce6mua7l';
      const GENERATOR = [0x3b6a57b2, 0x26508e6d, 0x1ea119fa, 0x3d4233dd, 0x2a1462b3];
      
      function polymod(values) {
        let chk = 1;
        for (const v of values) {
          const top = chk >> 25;
          chk = ((chk & 0x1ffffff) << 5) ^ v;
          for (let i = 0; i < 5; i++) {
            if ((top >> i) & 1) chk ^= GENERATOR[i];
          }
        }
        return chk;
      }
      
      function hrpExpand(hrp) {
        const result = [];
        for (const c of hrp) result.push(c.charCodeAt(0) >> 5);
        result.push(0);
        for (const c of hrp) result.push(c.charCodeAt(0) & 31);
        return result;
      }
      
      function createChecksum(hrp, data) {
        const values = hrpExpand(hrp).concat(data).concat([0, 0, 0, 0, 0, 0]);
        const mod = polymod(values) ^ 1;
        const result = [];
        for (let i = 0; i < 6; i++) result.push((mod >> (5 * (5 - i))) & 31);
        return result;
      }
      
      const checksum = createChecksum(prefix, words);
      const combined = words.concat(checksum);
      let result = prefix + '1';
      for (const w of combined) result += CHARSET[w];
      return result;
    }

    // HTML escaping to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }

    // Initialize
    async function init() {
      // Restore state first (before loading data)
      const stateRestored = restoreState();
      
      await loadRealData();
      checkKeplr();
      
      // If state was restored, re-render UI after data loads
      if (stateRestored) {
        console.log('State restored successfully');
      }
    }
    
    // Fetch all contracts with pagination
    async function fetchAllContracts() {
      let allContracts = [];
      let nextKey = null;
      let page = 0;
      do {
        page++;
        const params = nextKey ? `?pagination.key=${encodeURIComponent(nextKey)}&pagination.limit=100` : '?pagination.limit=100';
        try {
          const response = await fetch(`${API_BASE}/arkeo/contracts${params}`);
          const data = await response.json();
          const contracts = data.contract || data.contracts || [];
          allContracts = allContracts.concat(contracts);
          nextKey = data.pagination?.next_key || null;
        } catch (e) {
          console.warn('Contract fetch page', page, 'failed:', e);
          break;
        }
      } while (nextKey && page < 20);
      console.log(`Loaded ${allContracts.length} contracts across ${page} pages`);
      return allContracts;
    }
    
    function computeServiceDemand(contracts) {
      const demand = {};
      for (const c of contracts) {
        const svc = c.service || c.service_name;
        if (!svc) continue;
        if (!demand[svc]) demand[svc] = { active: 0, total: 0 };
        demand[svc].total++;
        const deposit = parseInt(c.deposit || '0');
        const paid = parseInt(c.paid || '0');
        if (deposit > paid) demand[svc].active++;
      }
      return demand;
    }
    
    function getDemandIndicator(active) {
      if (active >= 5) return { icon: 'üî•', label: 'High demand', cls: 'demand-high' };
      if (active >= 2) return { icon: '‚ö°', label: 'Growing', cls: 'demand-growing' };
      if (active >= 1) return { icon: 'üìä', label: 'Some activity', cls: 'demand-some' };
      return { icon: '‚Äî', label: 'No contracts yet', cls: 'demand-none' };
    }
    
    async function loadRealData() {
      try {
        // Load services, providers, and contracts in parallel
        const [servicesRes, providersRes, allContracts] = await Promise.all([
          fetch(`${API_BASE}/arkeo/services`).then(r => r.json()),
          fetch(`${API_BASE}/arkeo/providers`).then(r => r.json()),
          fetchAllContracts()
        ]);
        
        const services = servicesRes.services || [];
        rawProviders = (providersRes.provider || []).filter(p => {
          if (p.status !== 'ONLINE') return false;
          const bond = parseInt(p.bond || '0');
          if (bond <= 0) return false;
          const uri = p.metadata_uri || '';
          if (uri.includes('127.0.0.1') || uri.includes('localhost')) return false;
          // Show if: in KNOWN_PROVIDERS, has metadata URI, or has PAYG rate
          const isKnown = !!findKnown(p.pub_key);
          const hasRate = p.pay_as_you_go_rate && p.pay_as_you_go_rate.length > 0;
          if (!isKnown && (!uri || uri.trim() === '') && !hasRate) return false;
          return true;
        });
        serviceDemand = computeServiceDemand(allContracts);
        
        // Build service ID ‚Üí name lookup from API
        serviceIdToName = {};
        services.forEach(s => {
          const id = s.service_id || s.service;
          const name = s.name || s.service;
          if (id && name) {
            serviceIdToName[id] = name;
            SERVICE_ID_TO_NAME[id] = name; // Also update for contract opening
          }
        });
        
        // Build set of all known service IDs (from services API + providers)
        const allServiceIds = new Set();
        services.forEach(s => { allServiceIds.add(s.service_id || s.service); });
        rawProviders.forEach(p => { allServiceIds.add(p.service); });
        
        // Build chains list from ALL services that have ONLINE providers
        const activeServices = new Set();
        rawProviders.forEach(p => activeServices.add(p.service));
        
        // Only show services that have ONLINE providers
        // (394 total services exist, most without providers)
        
        chains = Array.from(activeServices).map(serviceId => {
          const displayName = getDisplayName(serviceId);
          const serviceName = serviceIdToName[serviceId] || '';
          return {
            id: serviceId,
            name: displayName,
            icon: getChainIcon(serviceId),
            searchTerms: (serviceId + ' ' + serviceName + ' ' + displayName).toLowerCase()
          };
        });
        
        // Group ALL ONLINE providers by chain
        providersByChain = {};
        
        // Collect unique metadata URIs to fetch provider names
        const metadataCache = {};
        const metadataFetches = [];
        const seenUris = new Set();
        
        rawProviders.forEach(p => {
          const uri = p.metadata_uri || '';
          if (uri && !seenUris.has(uri) && !uri.includes('127.0.0.1') && !uri.includes('localhost')) {
            seenUris.add(uri);
            metadataFetches.push(
              fetch(uri, { signal: AbortSignal.timeout(3000) })
                .then(r => r.json())
                .then(data => { metadataCache[uri] = data; })
                .catch(() => {})
            );
          }
        });
        
        // Fetch all metadata in parallel (with timeout)
        await Promise.allSettled(metadataFetches);
        
        rawProviders.forEach(p => {
          const pubkey = p.pub_key;
          const meta = findKnown(pubkey);
          const mdUri = p.metadata_uri || '';
          const metadata = metadataCache[mdUri];
          // Priority: known list > metadata moniker > fallback
          const providerName = meta?.name || metadata?.config?.moniker || 'Provider ' + pubkey.slice(-8);
          const providerDesc = meta?.description || metadata?.config?.description || 'Arkeo data provider';
          
          if (!providersByChain[p.service]) providersByChain[p.service] = [];
          
          const alreadyAdded = providersByChain[p.service].some(
            existing => existing.name === providerName
          );
          if (alreadyAdded) return;
          
          const rate = parseInt(p.pay_as_you_go_rate?.[0]?.amount || 0) / 100000000;
          providersByChain[p.service].push({
            id: pubkey,
            name: providerName,
            rate: rate || 0.001,
            uptime: 99.9,
            requests: formatNumber(Math.floor(parseInt(p.bond || 0) / 100000000 * 100)),
            description: providerDesc,
            pubkey: pubkey,
            verified: !!meta,
            metadataUri: mdUri,
            settlementDuration: p.settlement_duration || '10',
            minDuration: parseInt(p.min_contract_duration || 10),
            maxDuration: parseInt(p.max_contract_duration || 432000),
          });
        });
        
        // Sort chains by demand (active contracts desc), then provider count, then name
        chains.sort((a, b) => {
          const da = (serviceDemand[a.id]?.active || 0);
          const db = (serviceDemand[b.id]?.active || 0);
          if (db !== da) return db - da;
          const pa = (providersByChain[a.id]?.length || 0);
          const pb = (providersByChain[b.id]?.length || 0);
          if (pb !== pa) return pb - pa;
          return a.name.localeCompare(b.name);
        });
        
        renderChains(chains);
        
        // Handle URL parameter - pre-select provider if specified
        const urlParams = new URLSearchParams(window.location.search);
        const providerPubkey = urlParams.get('provider');
        if (providerPubkey) {
          // Find ALL chains this provider serves
          const providerChains = [];
          for (const [chainId, providers] of Object.entries(providersByChain)) {
            const provider = providers.find(p => 
              p.pubkey === providerPubkey || 
              providerPubkey.startsWith(p.pubkey.slice(0, 40)) ||
              p.pubkey.startsWith(providerPubkey.slice(0, 40))
            );
            if (provider) {
              const chain = chains.find(c => c.id == chainId);
              if (chain) providerChains.push({ chain, provider, chainId });
            }
          }
          
          if (providerChains.length === 1) {
            // Single chain ‚Äî skip straight to step 3 (duration/payment)
            const { chain, provider, chainId } = providerChains[0];
            selectChain(chain.id, chain.name);
            selectProvider(provider.id, provider.name, provider.rate, chainId);
            setTimeout(() => goToStep(3), 100);
          } else if (providerChains.length > 1) {
            // Multiple chains ‚Äî show only this provider's chains, skip provider selection
            const providerName = providerChains[0].provider.name;
            document.querySelector('.step-title')?.replaceWith(Object.assign(document.createElement('h2'), {
              className: 'step-title',
              textContent: `Select a chain from ${providerName}`
            }));
            const filteredChains = providerChains.map(pc => pc.chain);
            renderChains(filteredChains);
            
            // Override selectChain to auto-select provider and skip to step 3
            const origSelectChain = selectChain;
            selectChain = function(id, name) {
              origSelectChain(id, name);
              const match = providerChains.find(pc => pc.chain.id == id);
              if (match) {
                selectProvider(match.provider.id, match.provider.name, match.provider.rate, match.chainId);
                setTimeout(() => goToStep(3), 100);
              }
            };
          }
        }
        
      } catch (err) {
        console.error('Failed to load data:', err);
        document.getElementById('chainGrid').innerHTML = `
          <div style="text-align: center; padding: 2rem; color: var(--error);">
            Failed to load providers. <button onclick="loadRealData()" style="color: var(--arkeo);">Retry</button>
          </div>
        `;
      }
    }
    
    function getDisplayName(serviceId) {
      // First check direct match
      if (CHAIN_DISPLAY_NAMES[serviceId]) return CHAIN_DISPLAY_NAMES[serviceId];
      // Then look up the service name from API and check display names
      const serviceName = serviceIdToName[serviceId];
      if (serviceName && CHAIN_DISPLAY_NAMES[serviceName]) return CHAIN_DISPLAY_NAMES[serviceName];
      // Auto-format from service name or ID
      let name = serviceName || String(serviceId);
      name = name.replace(/-(mainnet|testnet)-(fullnode|archivenode|rpc|grpc|unchained)/gi, (_, net, type) => {
        let suffix = '';
        if (type === 'rpc') suffix = ' (RPC)';
        else if (type === 'grpc') suffix = ' (gRPC)';
        else if (type === 'archivenode') suffix = ' (Archive)';
        else if (type === 'unchained') suffix = ' (Unchained)';
        if (net === 'testnet') suffix = ' Testnet' + suffix;
        return suffix;
      });
      name = name.replace(/-/g, ' ').trim();
      return name.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
    }
    
    function getChainIcon(serviceId) {
      // Look up service name from API, fall back to string ID
      const serviceName = serviceIdToName[serviceId] || '';
      const id = (serviceName + ' ' + String(serviceId)).toLowerCase();
      const icons = {
        'eth': '‚ü†', 'btc': '‚Çø', 'gaia': '‚öõ', 'osmosis': 'üåä',
        'thorchain': '‚ö°', 'arkeo': 'üî∑', 'avax': 'üî∫', 'maya': 'üåô',
        'base': 'üîµ', 'bsc': 'üíõ', 'sol': '‚òÄÔ∏è', 'dot': '‚≠ï',
        'matic': 'üíú', 'arb': 'üî∑', 'op-': 'üî¥', 'aptos': 'üü¢',
        'sui': 'üíß', 'near': 'üåê', 'fantom': 'üëª', 'celo': 'üü°',
      };
      for (const [key, icon] of Object.entries(icons)) {
        if (id.includes(key)) return icon;
      }
      return 'üîó';
    }
    
    function formatNumber(num) {
      if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
      if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
      return num.toString();
    }
    
    async function checkKeplr() {
      if (window.keplr) {
        console.log('Keplr detected');
      } else {
        console.log('Keplr not installed');
      }
    }

    function renderChains(chainList) {
      const grid = document.getElementById('chainGrid');
      grid.innerHTML = chainList.map(chain => {
        const provCount = (providersByChain[chain.id] || []).length;
        const demand = serviceDemand[chain.id] || { active: 0, total: 0 };
        const d = getDemandIndicator(demand.active);
        const countText = demand.active > 0 ? `${demand.active} active` : (demand.total > 0 ? `${demand.total} total` : d.label);
        return `
        <div class="chain-option" onclick="selectChain('${escapeHtml(chain.id)}', '${escapeHtml(chain.name)}')">
          <span style="font-size: 1.75rem;">${chain.icon}</span>
          <div class="chain-info">
            <div class="chain-name">${escapeHtml(chain.name)}</div>
            <div class="chain-meta">
              <span>${provCount} provider${provCount !== 1 ? 's' : ''}</span>
              <span class="chain-demand ${d.cls}">${d.icon} ${countText}</span>
            </div>
          </div>
        </div>`;
      }).join('');
    }

    function filterChains() {
      const search = document.getElementById('chainSearch').value.toLowerCase().trim();
      if (!search) { renderChains(chains); return; }
      // Check aliases
      const aliasMatch = SEARCH_ALIASES[search];
      const filtered = chains.filter(c => {
        if (c.name.toLowerCase().includes(search)) return true;
        if (c.searchTerms.includes(search)) return true;
        if (aliasMatch && c.searchTerms.includes(aliasMatch)) return true;
        // Also check partial alias matches
        for (const [alias, target] of Object.entries(SEARCH_ALIASES)) {
          if (alias.startsWith(search) && c.searchTerms.includes(target)) return true;
        }
        return false;
      });
      renderChains(filtered);
    }

    function selectChain(id, name) {
      selectedChain = { id, name };
      
      document.querySelectorAll('.chain-option').forEach(el => {
        el.classList.remove('selected');
        if (el.querySelector('.chain-name').textContent === name) {
          el.classList.add('selected');
        }
      });
      
      document.getElementById('nextBtn1').disabled = false;
      document.getElementById('selectedChainName').textContent = name;
      
      // Save state after chain selection
      saveState();
    }

    function renderProviders() {
      const list = document.getElementById('providerList');
      const chainProviders = providersByChain[selectedChain.id] || [];
      
      if (chainProviders.length === 0) {
        list.innerHTML = `
          <div style="text-align: center; padding: 2rem; color: var(--text-dim);">
            <div style="font-size: 2rem; margin-bottom: 1rem;">üîç</div>
            <p>No verified providers available for ${selectedChain.name} yet.</p>
            <p style="margin-top: 0.5rem;"><a href="become-provider.html" style="color: var(--arkeo);">Become a provider ‚Üí</a></p>
          </div>
        `;
        return;
      }
      
      list.innerHTML = chainProviders.map(p => `
        <div class="provider-card" data-pubkey="${escapeHtml(p.pubkey)}" onclick="selectProvider('${escapeHtml(p.id)}', '${escapeHtml(p.name)}', ${p.rate}, '${escapeHtml(selectedChain.id)}')">
          <div class="provider-header">
            <span class="provider-name">${escapeHtml(p.name)}${p.verified ? ' ‚úì' : ''}</span>
            <span class="provider-rate">${p.rate.toFixed(4)} ARKEO/req</span>
          </div>
          <div class="provider-stats">
            <span class="provider-stat"><span class="stat-good">‚óè</span> Online</span>
            <span class="provider-stat">üìä ${p.requests} requests</span>
          </div>
          <div class="provider-description">${escapeHtml(p.description) || 'Arkeo data provider'}</div>
        </div>
      `).join('');
    }

    function selectProvider(pubkey, name, rate, serviceId = null) {
      // Find the provider's metadata URI from our loaded data
      const chainProviders = providersByChain[serviceId || selectedChain?.id] || [];
      const provInfo = chainProviders.find(p => p.pubkey === pubkey);
      const metadataUri = provInfo?.metadataUri || '';
      const settlementDuration = provInfo?.settlementDuration || '10';
      const CHAIN_MAX_DURATION = 5256000; // Arkeo governance limit
      const minDuration = provInfo?.minDuration || 10;
      const maxDuration = Math.min(provInfo?.maxDuration || CHAIN_MAX_DURATION, CHAIN_MAX_DURATION);
      selectedProvider = { id: pubkey, name, rate, pubkey, serviceId: serviceId || selectedChain?.id, metadataUri, settlementDuration, minDuration, maxDuration };
      
      // Update duration presets ‚Äî hide any that exceed provider's max
      document.querySelectorAll('.duration-preset').forEach(btn => {
        const blocks = parseInt(btn.getAttribute('data-blocks') || 0);
        btn.style.display = blocks > maxDuration ? 'none' : '';
      });
      // If current duration exceeds max, reset to largest visible preset
      if (contractDurationBlocks > maxDuration) {
        const presets = [648000, 151200, 21600, 900];
        for (const p of presets) {
          if (p <= maxDuration) { setDuration(p === 900 ? 1 : p === 21600 ? 1 : p === 151200 ? 1 : 1, p === 900 ? 'hours' : p === 21600 ? 'days' : p === 151200 ? 'weeks' : 'months'); break; }
        }
      }
      
      document.querySelectorAll('.provider-card').forEach((el) => {
        el.classList.remove('selected');
        // Find and highlight the matching card
        if (el.getAttribute('data-pubkey') === pubkey) {
          el.classList.add('selected');
        }
      });
      
      // Also highlight via event if available
      if (typeof event !== 'undefined' && event?.currentTarget) {
        event.currentTarget.classList.add('selected');
      }
      
      document.getElementById('nextBtn2').disabled = false;
      
      // Update summary
      document.getElementById('summaryChain').textContent = selectedChain?.name || 'Selected Chain';
      document.getElementById('summaryProvider').textContent = name;
      document.getElementById('summaryRate').textContent = rate + ' ARKEO/request';
      
      // Save state after provider selection
      saveState();
    }

    function goToStep(step) {
      // Hide all steps
      for (let i = 1; i <= 4; i++) {
        document.getElementById('step' + i).classList.add('hidden');
        if (i <= 3) {
          document.getElementById('dot' + i).classList.remove('active', 'complete');
          document.getElementById('label' + i).classList.remove('active');
        }
      }
      
      // Show current step
      document.getElementById('step' + step).classList.remove('hidden');
      
      // Update progress
      for (let i = 1; i <= Math.min(step, 3); i++) {
        const dot = document.getElementById('dot' + i);
        const label = document.getElementById('label' + i);
        if (i < step) {
          dot.classList.add('complete');
          dot.innerHTML = '‚úì';
        } else if (i === step) {
          dot.classList.add('active');
          dot.innerHTML = i;
          label.classList.add('active');
        }
      }
      
      // Progress line
      const progressPercent = ((Math.min(step, 3) - 1) / 2) * 100;
      document.getElementById('progressLine').style.width = progressPercent + '%';
      
      currentStep = step;
      
      // Render providers on step 2
      if (step === 2) {
        renderProviders();
      }
      
      // Update estimate on step 3
      if (step === 3) {
        updateEstimate();
      }
      
      // Save state after step change
      saveState();
    }

    function selectPayment(method) {
      paymentMethod = method;
      const arkeoBtn = document.getElementById('payArkeoBtn');
      const usdcBtn = document.getElementById('payUsdcBtn');
      const x402Btn = document.getElementById('payX402Btn');
      const suffix = document.getElementById('depositSuffix');
      const arkeoInfo = document.getElementById('arkeoPaymentInfo');
      const usdcInfo = document.getElementById('usdcPaymentInfo');
      const x402Info = document.getElementById('x402PaymentInfo');
      
      // Reset all buttons
      [arkeoBtn, usdcBtn, x402Btn].forEach(btn => {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-secondary');
        btn.style.border = '';
        btn.style.boxShadow = '';
      });
      arkeoInfo.style.display = 'none';
      usdcInfo.style.display = 'none';
      x402Info.style.display = 'none';
      
      if (method === 'arkeo') {
        arkeoBtn.classList.remove('btn-secondary');
        arkeoBtn.classList.add('btn-primary');
        arkeoBtn.style.border = '2px solid #10b981';
        arkeoBtn.style.boxShadow = '0 0 15px rgba(16,185,129,0.2)';
        suffix.textContent = 'ARKEO';
        arkeoInfo.style.display = 'block';
      } else if (method === 'usdc') {
        usdcBtn.classList.remove('btn-secondary');
        usdcBtn.classList.add('btn-primary');
        suffix.textContent = 'USDC';
        usdcInfo.style.display = 'block';
        // Initialize Noble wallet and balances if Arkeo wallet is connected
        if (walletAddress) {
          initializeNobleWallet().catch(e => console.warn('Noble wallet init failed:', e));
        }
      } else if (method === 'x402') {
        x402Btn.classList.remove('btn-secondary');
        x402Btn.classList.add('btn-primary');
        x402Btn.style.border = '2px solid #8b5cf6';
        x402Btn.style.boxShadow = '0 0 15px rgba(139,92,246,0.2)';
        suffix.textContent = 'USDC';
        x402Info.style.display = 'block';
        // Check x402 support when this payment method is selected
        checkX402Support();
      }
      updateEstimate();
      
      // Save state after payment method change
      saveState();
    }
    
    // ============================================================
    // X402 SUPPORT
    // ============================================================
    async function checkX402Support() {
      const checkStatus = document.getElementById('x402CheckStatus');
      const content = document.getElementById('x402Content');
      
      if (!selectedProvider) {
        checkStatus.innerHTML = `
          <div style="padding: 0.75rem; background: rgba(245,158,11,0.1); border: 1px solid var(--warning); border-radius: 0.5rem;">
            <span style="color: var(--warning);">‚ö†Ô∏è Please select a provider first</span>
          </div>
        `;
        return;
      }
      
      try {
        // Build x402 endpoint URL from provider's sentinel URL + /x402/ path
        const serviceName = selectedChain?.name || 'eth';
        // Get provider's sentinel base URL from metadata or endpoint
        let providerBaseUrl = '';
        if (selectedProvider.metadata?.sentinel_url) {
          providerBaseUrl = selectedProvider.metadata.sentinel_url.replace(/\/+$/, '');
        } else if (selectedProvider.endpointUrl) {
          providerBaseUrl = selectedProvider.endpointUrl.replace(/\/[^\/]+$/, '');
        } else {
          providerBaseUrl = `https://${selectedProvider.pubkey.slice(0,12)}.arkeo.network`;
        }
        const x402Url = `${providerBaseUrl}/x402/${serviceName.toLowerCase()}`;
        
        checkStatus.innerHTML = `
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div>
            <span style="color: var(--text-dim); font-size: 0.85rem;">Testing x402 endpoint...</span>
          </div>
        `;
        
        // Update code example with actual URL
        document.getElementById('x402Endpoint').textContent = x402Url;
        document.getElementById('x402CodeUrl').textContent = x402Url;
        
        // Try to make a test request to see if x402 is supported
        const testResponse = await fetch(x402Url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ jsonrpc: '2.0', method: 'eth_blockNumber', params: [], id: 1 })
        }).catch(e => ({ status: 0, error: e.message }));
        
        if (testResponse.status === 402 || (testResponse.headers && testResponse.headers.get('www-authenticate')?.includes('x402'))) {
          // x402 is supported!
          checkStatus.innerHTML = `
            <div style="padding: 0.75rem; background: var(--success-dim); border: 1px solid var(--success); border-radius: 0.5rem;">
              <span style="color: var(--success);">‚úÖ This provider supports x402 payments!</span>
            </div>
          `;
          content.style.display = 'block';
        } else {
          // Provider doesn't support x402
          checkStatus.innerHTML = `
            <div style="padding: 0.75rem; background: rgba(245,158,11,0.1); border: 1px solid var(--warning); border-radius: 0.5rem;">
              <div style="color: var(--warning); font-weight: 600; margin-bottom: 0.25rem;">‚ö†Ô∏è x402 Not Supported</div>
              <div style="color: var(--text-dim); font-size: 0.85rem;">
                This provider hasn't enabled x402 payments yet. Try selecting a different provider or use ARKEO payment instead.
              </div>
            </div>
          `;
          content.style.display = 'none';
        }
      } catch (error) {
        console.error('x402 check failed:', error);
        checkStatus.innerHTML = `
          <div style="padding: 0.75rem; background: rgba(239,68,68,0.1); border: 1px solid var(--error); border-radius: 0.5rem;">
            <div style="color: var(--error); font-weight: 600; margin-bottom: 0.25rem;">‚ùå Check Failed</div>
            <div style="color: var(--text-dim); font-size: 0.85rem;">
              Could not verify x402 support. Error: ${error.message}
            </div>
          </div>
        `;
        content.style.display = 'none';
      }
    }
    
    async function testX402Request() {
      const btn = document.getElementById('testX402Btn');
      const result = document.getElementById('x402TestResult');
      
      btn.disabled = true;
      btn.textContent = '‚è≥ Sending request...';
      
      result.style.display = 'block';
      result.innerHTML = `
        <div style="padding: 0.75rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 0.5rem;">
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <div class="spinner" style="width: 14px; height: 14px; border-width: 2px;"></div>
            <span style="color: var(--text-dim); font-size: 0.85rem;">Making test request...</span>
          </div>
        </div>
      `;
      
      try {
        const serviceName = selectedChain?.name || 'eth';
        // Reuse same URL logic as checkX402Support
        let providerBaseUrl = '';
        if (selectedProvider.metadata?.sentinel_url) {
          providerBaseUrl = selectedProvider.metadata.sentinel_url.replace(/\/+$/, '');
        } else if (selectedProvider.endpointUrl) {
          providerBaseUrl = selectedProvider.endpointUrl.replace(/\/[^\/]+$/, '');
        } else {
          providerBaseUrl = `https://${selectedProvider.pubkey.slice(0,12)}.arkeo.network`;
        }
        const x402Url = `${providerBaseUrl}/x402/${serviceName.toLowerCase()}`;
        
        const response = await fetch(x402Url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ jsonrpc: '2.0', method: 'eth_blockNumber', params: [], id: 1 })
        });
        
        const headers = {};
        response.headers.forEach((value, key) => { headers[key] = value; });
        
        if (response.status === 402) {
          // Parse payment details from headers
          const authHeader = headers['www-authenticate'] || '';
          const paymentInfo = {
            price: authHeader.match(/price="([^"]+)"/)?.[1] || 'N/A',
            network: authHeader.match(/network="([^"]+)"/)?.[1] || 'base',
            payTo: authHeader.match(/payto="([^"]+)"/)?.[1] || 'N/A',
          };
          
          result.innerHTML = `
            <div style="padding: 0.75rem; background: var(--success-dim); border: 1px solid var(--success); border-radius: 0.5rem;">
              <div style="color: var(--success); font-weight: 600; margin-bottom: 0.5rem;">‚úÖ 402 Payment Required (Success!)</div>
              <div style="color: var(--text-dim); font-size: 0.85rem; margin-bottom: 0.5rem;">
                The endpoint returned a valid 402 response. Here's how to pay:
              </div>
              <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 0.375rem; padding: 0.5rem; font-family: monospace; font-size: 0.75rem; margin-bottom: 0.5rem;">
                <div><strong>Price:</strong> $${paymentInfo.price}</div>
                <div><strong>Network:</strong> ${paymentInfo.network}</div>
                <div><strong>Pay to:</strong> ${paymentInfo.payTo.slice(0, 16)}...</div>
              </div>
              <div style="color: var(--text-dim); font-size: 0.75rem;">
                Use the @anthropic-ai/x402-fetch package to handle payments automatically.
              </div>
            </div>
          `;
        } else {
          result.innerHTML = `
            <div style="padding: 0.75rem; background: rgba(245,158,11,0.1); border: 1px solid var(--warning); border-radius: 0.5rem;">
              <div style="color: var(--warning); font-weight: 600; margin-bottom: 0.25rem;">‚ö†Ô∏è Unexpected Response</div>
              <div style="color: var(--text-dim); font-size: 0.85rem;">
                Expected HTTP 402, got ${response.status}. This provider may not support x402.
              </div>
            </div>
          `;
        }
      } catch (error) {
        console.error('Test request failed:', error);
        result.innerHTML = `
          <div style="padding: 0.75rem; background: rgba(239,68,68,0.1); border: 1px solid var(--error); border-radius: 0.5rem;">
            <div style="color: var(--error); font-weight: 600; margin-bottom: 0.25rem;">‚ùå Request Failed</div>
            <div style="color: var(--text-dim); font-size: 0.85rem;">
              ${error.message}
            </div>
          </div>
        `;
      } finally {
        btn.disabled = false;
        btn.textContent = 'üöÄ Send Test Request';
      }
    }
    
    function copyX402Code() {
      const codeBlock = document.getElementById('x402CodeBlock');
      const btn = document.getElementById('x402CopyBtn');
      navigator.clipboard.writeText(codeBlock.textContent).then(() => {
        btn.textContent = '‚úì Copied!';
        setTimeout(() => btn.textContent = 'üìã', 2000);
      });
    }
    
    // Duration picker
    const BLOCK_TIME_SECONDS = 4;
    let contractDurationBlocks = 648000; // default 1 month (~30 days)

    function durationToBlocks(value, unit) {
      const seconds = {
        hours: value * 3600,
        days: value * 86400,
        weeks: value * 604800,
        months: value * 2592000, // 30 days
        years: value * 31536000, // 365 days
      };
      if (unit === 'blocks') return value;
      return Math.round((seconds[unit] || 0) / BLOCK_TIME_SECONDS);
    }

    function blocksToHumanTime(blocks) {
      const totalSeconds = blocks * BLOCK_TIME_SECONDS;
      if (totalSeconds >= 31536000) return `~${(totalSeconds / 31536000).toFixed(1)} year${totalSeconds >= 63072000 ? 's' : ''}`;
      if (totalSeconds >= 2592000) return `~${(totalSeconds / 2592000).toFixed(1)} month${totalSeconds >= 5184000 ? 's' : ''}`;
      if (totalSeconds >= 604800) return `~${(totalSeconds / 604800).toFixed(1)} week${totalSeconds >= 1209600 ? 's' : ''}`;
      if (totalSeconds >= 86400) return `~${(totalSeconds / 86400).toFixed(1)} day${totalSeconds >= 172800 ? 's' : ''}`;
      return `~${(totalSeconds / 3600).toFixed(1)} hour${totalSeconds >= 7200 ? 's' : ''}`;
    }

    function setDuration(value, unit) {
      document.getElementById('durationValue').value = value;
      document.getElementById('durationUnit').value = unit;
      document.querySelectorAll('.duration-preset').forEach(b => b.classList.remove('active'));
      event.target.classList.add('active');
      updateDuration();
      
      // Save state after duration preset selection
      saveState();
    }

    function updateDuration() {
      const value = parseFloat(document.getElementById('durationValue').value) || 1;
      const unit = document.getElementById('durationUnit').value;
      contractDurationBlocks = durationToBlocks(value, unit);
      const humanTime = blocksToHumanTime(contractDurationBlocks);
      const maxDur = selectedProvider?.maxDuration || 432000;
      const overMax = contractDurationBlocks > maxDur;
      document.getElementById('durationEstimate').innerHTML = 
        `‚âà <strong>${contractDurationBlocks.toLocaleString()}</strong> blocks (${humanTime} at ~${BLOCK_TIME_SECONDS}s/block)` +
        (overMax ? `<br><span style="color:var(--error);">‚ö†Ô∏è Exceeds provider max of ${maxDur.toLocaleString()} blocks (${blocksToHumanTime(maxDur)})</span>` : '');
      // Clear active preset if custom
      document.querySelectorAll('.duration-preset').forEach(b => b.classList.remove('active'));
      
      // Save state after duration change
      saveState();
    }

    function updateEstimate() {
      const amount = parseFloat(document.getElementById('depositAmount').value) || 0;
      let rate = selectedProvider ? selectedProvider.rate : 0.001;
      
      if (paymentMethod === 'usdc') {
        // USDC mode: convert USDC to ARKEO equivalent for request estimate
        if (arkeoPrice && amount > 0) {
          const arkeoEquiv = amount / arkeoPrice;
          const requests = Math.floor(arkeoEquiv / rate);
          document.getElementById('depositEstimate').innerHTML = `‚âà <strong>${arkeoEquiv.toFixed(2)}</strong> ARKEO ‚Üí <strong>${requests.toLocaleString()}</strong> requests`;
        } else {
          document.getElementById('depositEstimate').innerHTML = `Enter USDC amount ‚Äî price loading...`;
        }
        updateUsdcEstimate();
      } else {
        // ARKEO payment
        const requests = Math.floor(amount / rate);
        document.getElementById('depositEstimate').innerHTML = `‚âà <strong>${requests.toLocaleString()}</strong> requests`;
      }
      
      // Save state after deposit amount changes
      saveState();
    }

    // ============================================================
    // KEPLR WALLET INTEGRATION
    // ============================================================
    async function connectWallet() {
      const walletSection = document.getElementById('walletSection');
      const openBtn = document.getElementById('openContractBtn');
      
      if (!window.keplr) {
        walletSection.innerHTML = `
          <div style="color: var(--error); text-align: center;">
            <p>‚ùå Keplr wallet not detected</p>
            <p style="margin-top: 0.5rem; font-size: 0.85rem;">
              <a href="https://www.keplr.app/download" target="_blank" style="color: var(--arkeo);">
                Install Keplr ‚Üí
              </a>
            </p>
          </div>
        `;
        return;
      }
      
      walletSection.innerHTML = `
        <div style="display: flex; align-items: center; justify-content: center; gap: 0.75rem;">
          <div class="spinner"></div>
          <span>Connecting to Keplr...</span>
        </div>
      `;
      
      try {
        // Suggest chains to Keplr
        await suggestArkeoChain();
        await suggestNobleChain();
        
        // Enable Arkeo chain
        await window.keplr.enable(CONFIG.CHAIN_ID);
        
        // Get Arkeo account
        const arkeoSigner = window.keplr.getOfflineSigner(CONFIG.CHAIN_ID);
        const arkeoAccounts = await arkeoSigner.getAccounts();
        
        if (arkeoAccounts.length === 0) throw new Error('No accounts found');
        
        walletAddress = arkeoAccounts[0].address;
        walletPubkeyBytes = arkeoAccounts[0].pubkey;
        
        // Get Arkeo balance
        const balanceResp = await fetch(`${CONFIG.REST_API}/cosmos/bank/v1beta1/balances/${walletAddress}`);
        const balanceData = await balanceResp.json();
        const arkeoBalance = balanceData.balances?.find(b => b.denom === CONFIG.ARKEO_DENOM);
        const balanceFormatted = arkeoBalance ? (parseInt(arkeoBalance.amount) / CONFIG.ARKEO_DIVISOR).toFixed(2) : '0.00';
        
        walletSection.innerHTML = `
          <div style="text-align: center;">
            <div style="color: var(--success);">
              <div>‚úÖ Wallet Connected</div>
              <div style="font-weight: 600; margin-top: 0.25rem;">${walletAddress.slice(0, 12)}...${walletAddress.slice(-6)}</div>
              <div style="color: var(--text-dim); font-size: 0.85rem; margin-top: 0.25rem;">
                Balance: ${balanceFormatted} ARKEO
              </div>
            </div>
          </div>
        `;
        openBtn.classList.remove('hidden');
        
        // Also enable Noble chain for USDC swaps
        try {
          await window.keplr.enable('noble-1');
          const nobleSigner = window.keplr.getOfflineSigner('noble-1');
          const nobleAccounts = await nobleSigner.getAccounts();
          nobleAddress = nobleAccounts[0].address;
          
          // Update Skip Go balances
          await updateSkipGoBalances();
        } catch (e) {
          console.warn('Noble connection failed (optional):', e);
        }
        
        // Save state after wallet connection
        saveState();
        
      } catch (err) {
        console.error('Wallet connection failed:', err);
        walletSection.innerHTML = `
          <div style="color: var(--error); text-align: center;">
            <p>‚ùå Connection failed: ${err.message}</p>
            <button class="btn btn-secondary" style="margin-top: 0.5rem;" onclick="connectWallet()">
              Try Again
            </button>
          </div>
        `;
      }
    }
    
    async function suggestArkeoChain() {
      await window.keplr.experimentalSuggestChain({
        chainId: CONFIG.CHAIN_ID,
        chainName: 'Arkeo Network',
        rpc: CONFIG.RPC_API,
        rest: CONFIG.REST_API,
        bip44: { coinType: 118 },
        bech32Config: {
          bech32PrefixAccAddr: 'arkeo',
          bech32PrefixAccPub: 'arkeopub',
          bech32PrefixValAddr: 'arkeovaloper',
          bech32PrefixValPub: 'arkeovaloperpub',
          bech32PrefixConsAddr: 'arkeovalcons',
          bech32PrefixConsPub: 'arkeovalconspub',
        },
        currencies: [{ coinDenom: 'ARKEO', coinMinimalDenom: CONFIG.ARKEO_DENOM, coinDecimals: 8 }],
        feeCurrencies: [{ coinDenom: 'ARKEO', coinMinimalDenom: CONFIG.ARKEO_DENOM, coinDecimals: 8, gasPriceStep: { low: 0.001, average: 0.005, high: 0.01 } }],
        stakeCurrency: { coinDenom: 'ARKEO', coinMinimalDenom: CONFIG.ARKEO_DENOM, coinDecimals: 8 },
      });
    }

    // ============================================================
    // OPEN CONTRACT (ON-CHAIN)
    // ============================================================
    async function openContract() {
      const statusDiv = document.getElementById('contractStatus');
      const btn = document.getElementById('openContractBtn');
      
      // Warn if no signing key is set
      if (!signingKey) {
        const proceed = confirm(
          '‚ö†Ô∏è No API signing key configured.\n\n' +
          'Without a signing key, your SDK code will need to use Keplr for every request.\n\n' +
          'It\'s highly recommended to generate a signing key first.\n\n' +
          'Continue anyway?'
        );
        if (!proceed) return;
      }
      
      btn.disabled = true;
      btn.textContent = 'Opening Contract...';
      
      // Check failover setting
      failoverEnabled = document.getElementById('enableFailover')?.checked ?? true;
      
      statusDiv.innerHTML = `
        <div class="status-box" style="background: var(--arkeo-dim); border: 1px solid var(--arkeo);">
          <div class="spinner"></div>
          <span>Preparing transaction...</span>
        </div>
      `;
      
      try {
        // Initialize arkeo tx helper
        await window.arkeoTx.init();
        
        const depositAmount = document.getElementById('depositAmount').value;
        const depositUarkeo = String(Math.floor(parseFloat(depositAmount) * CONFIG.ARKEO_DIVISOR));
        
        // Get account info
        const accountResp = await fetch(`${CONFIG.REST_API}/cosmos/auth/v1beta1/accounts/${walletAddress}`);
        const accountData = await accountResp.json();
        const account = accountData.account?.base_account || accountData.account || {};
        const accountInfo = {
          accountNumber: account.account_number || '0',
          sequence: account.sequence || '0'
        };
        
        // Get wallet pubkey for signing
        const offlineSigner = window.keplr.getOfflineSigner(CONFIG.CHAIN_ID);
        const accounts = await offlineSigner.getAccounts();
        const walletPubkeyBytes = accounts[0].pubkey;
        
        // Convert pubkey to arkeopub bech32 format (needed for client field)
        const clientPubkey = pubkeyToBech32(walletPubkeyBytes, 'arkeopub');
        console.log('Client pubkey:', clientPubkey);
        
        // Validate duration against provider's min/max
        const minDur = parseInt(selectedProvider.minDuration || 5);
        const maxDur = parseInt(selectedProvider.maxDuration || 432000);
        if (contractDurationBlocks < minDur || contractDurationBlocks > maxDur) {
          throw new Error(`Duration must be between ${minDur.toLocaleString()} and ${maxDur.toLocaleString()} blocks (${blocksToHumanTime(minDur)} to ${blocksToHumanTime(maxDur)}). You selected ${contractDurationBlocks.toLocaleString()} blocks.`);
        }

        // Calculate rate in uarkeo (provider rate is in ARKEO, convert to uarkeo)
        const rateUarkeo = Math.max(1, Math.floor((selectedProvider.rate || 0.00000001) * CONFIG.ARKEO_DIVISOR));
        
        // Get service name - the API requires the service NAME not ID
        const serviceId = selectedProvider.serviceId || selectedChain.id;
        // Look up the actual service name from ID, or use the ID if it's already a name
        const serviceName = SERVICE_ID_TO_NAME[serviceId] || (isNaN(serviceId) ? serviceId : null);
        console.log('Service ID:', serviceId, 'Service Name:', serviceName, 'Chain:', selectedChain);
        
        if (!serviceName) {
          throw new Error('No service name found. Please select a provider again.');
        }
        
        // Use signing key as delegate if available, otherwise use client pubkey
        const delegatePubkey = signingKey ? signingKey.publicKeyBech32 : clientPubkey;
        
        // Build MsgOpenContract with proper format
        const msg = {
          typeUrl: '/arkeo.arkeo.MsgOpenContract',
          value: {
            creator: walletAddress,
            provider: selectedProvider.pubkey,
            service: serviceName,
            client: clientPubkey,
            delegate: delegatePubkey,
            contractType: 1, // PAY_AS_YOU_GO = 1
            duration: String(contractDurationBlocks),
            rate: { denom: CONFIG.ARKEO_DENOM, amount: String(rateUarkeo) },
            deposit: depositUarkeo,
            settlementDuration: String(selectedProvider.settlementDuration || '10'),
            authorization: 0, // STRICT = 0
            queriesPerMinute: '100',
          }
        };
        
        console.log('Opening contract:', msg);
        
        statusDiv.innerHTML = `
          <div class="status-box" style="background: var(--arkeo-dim); border: 1px solid var(--arkeo);">
            <div class="spinner"></div>
            <span>Awaiting signature in Keplr...</span>
          </div>
        `;
        
        // Build and sign transaction with proper protobuf encoding
        const bodyBytes = window.arkeoTx.buildTxBody([msg], 'Contract opened via Arkeo Marketplace');
        const authInfoBytes = window.arkeoTx.buildAuthInfo(walletPubkeyBytes, parseInt(accountInfo.sequence), '10000', 300000);
        
        const signDoc = {
          bodyBytes: bodyBytes,
          authInfoBytes: authInfoBytes,
          chainId: CONFIG.CHAIN_ID,
          accountNumber: accountInfo.accountNumber
        };
        
        const signResponse = await window.keplr.signDirect(CONFIG.CHAIN_ID, walletAddress, signDoc);
        
        statusDiv.innerHTML = `
          <div class="status-box" style="background: var(--arkeo-dim); border: 1px solid var(--arkeo);">
            <div class="spinner"></div>
            <span>Broadcasting transaction...</span>
          </div>
        `;
        
        // Build TxRaw and broadcast
        const signatureBytes = window.arkeoTx.base64ToBytes(signResponse.signature.signature);
        const txRawBytes = window.arkeoTx.buildTxRaw(
          signResponse.signed.bodyBytes,
          signResponse.signed.authInfoBytes,
          [signatureBytes]
        );
        const txBytesBase64 = window.arkeoTx.bytesToBase64(txRawBytes);
        
        const broadcastResponse = await fetch(`${CONFIG.REST_API}/cosmos/tx/v1beta1/txs`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            tx_bytes: txBytesBase64,
            mode: 'BROADCAST_MODE_SYNC',
          }),
        });
        
        const result = await broadcastResponse.json();
        console.log('Broadcast result:', result);
        
        if (result.tx_response?.code !== 0) {
          throw new Error(result.tx_response?.raw_log || 'Transaction failed');
        }
        
        const txHash = result.tx_response.txhash;
        
        statusDiv.innerHTML = `
          <div class="status-box" style="background: var(--arkeo-dim); border: 1px solid var(--arkeo);">
            <div class="spinner"></div>
            <span>TX submitted, waiting for confirmation...</span>
          </div>
        `;

        // Poll for TX confirmation (up to 30 seconds)
        let confirmed = false;
        for (let i = 0; i < 10; i++) {
          await new Promise(r => setTimeout(r, 3000));
          try {
            const txRes = await fetch(`${CONFIG.REST_API}/cosmos/tx/v1beta1/txs/${txHash}`);
            const txData = await txRes.json();
            if (txData.tx_response) {
              if (txData.tx_response.code !== 0) {
                throw new Error(txData.tx_response.raw_log || 'Transaction failed on-chain');
              }
              confirmed = true;
              break;
            }
          } catch (e) {
            if (e.message.includes('failed on-chain')) throw e;
            // TX not found yet, keep polling
          }
        }

        if (!confirmed) {
          statusDiv.innerHTML = `
            <div class="status-box" style="background: rgba(245,158,11,0.1); border: 1px solid var(--warning);">
              <span>‚ö†Ô∏è</span>
              <span>TX submitted but not yet confirmed. Check TX: ${txHash.slice(0, 16)}...</span>
            </div>
          `;
          return;
        }

        statusDiv.innerHTML = `
          <div class="status-box success">
            <span>‚úÖ</span>
            <span>Contract confirmed! TX: ${txHash.slice(0, 12)}...</span>
          </div>
        `;
        
        // Show signing key reminder if one was generated
        if (signingKey && signingKey.privateKeyHex) {
          statusDiv.innerHTML += `
            <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid #ef4444; border-radius: 0.5rem; padding: 1rem; margin-top: 1rem;">
              <div style="font-weight: 600; margin-bottom: 0.5rem; color: #ef4444;">‚ö†Ô∏è Don't Forget Your Signing Key!</div>
              <div style="font-size: 0.85rem; color: var(--text-dim); margin-bottom: 0.5rem;">
                Your contract is configured with a dedicated signing key. Make sure you've saved the private key ‚Äî it's shown in the SDK examples below.
              </div>
              <button onclick="navigator.clipboard.writeText('${signingKey.privateKeyHex}'); event.target.textContent='‚úì Copied!'; setTimeout(() => event.target.textContent='üìã Copy Private Key Again', 2000);" 
                style="padding: 0.5rem 1rem; background: var(--arkeo); color: #000; border: none; border-radius: 0.375rem; font-weight: 600; cursor: pointer;">
                üìã Copy Private Key Again
              </button>
            </div>
          `;
        }
        
        // Update final values
        const rate = selectedProvider.rate || 1;
        const requests = Math.floor((parseFloat(depositAmount) * CONFIG.ARKEO_DIVISOR) / rate);
        
        document.getElementById('finalDeposit').textContent = depositAmount + ' ARKEO';
        document.getElementById('finalDuration').textContent = blocksToHumanTime(contractDurationBlocks);
        document.getElementById('finalRequests').textContent = '~' + requests.toLocaleString();
        // Contract ID will come from tx response in production
        document.getElementById('finalContractId').textContent = txHash ? txHash.slice(0, 12) + '...' : 'Pending...';
        
        // Build the actual RPC endpoint from provider's metadata URI or known website
        const providerInfo = Object.values(providersByChain).flat().find(p => p.pubkey === selectedProvider.pubkey);
        let sentinelBaseUrl = '';
        // Try metadata URI first
        const mdUri = providerInfo?.metadataUri || selectedProvider.metadataUri || '';
        if (mdUri) {
          sentinelBaseUrl = mdUri.replace(/\/metadata\.json$/, '');
        }
        // Fallback: use KNOWN_PROVIDERS website (sentinel typically runs on same domain)
        if (!sentinelBaseUrl && typeof findKnownProvider === 'function') {
          const known = findKnownProvider(selectedProvider.pubkey);
          if (known?.website) {
            sentinelBaseUrl = known.website.replace(/\/$/, '');
          }
        }
        const svcName = serviceName || SERVICE_ID_TO_NAME[selectedProvider.serviceId] || selectedProvider.serviceId || '';
        const endpointUrl = sentinelBaseUrl ? `${sentinelBaseUrl}/${svcName}` : `Provider sentinel URL not found`;
        document.getElementById('finalEndpoint').textContent = endpointUrl;
        
        // Update failover status
        const failoverStatus = document.getElementById('failoverStatus');
        const failoverInfo = document.getElementById('failoverInfo');
        if (failoverEnabled) {
          failoverStatus.querySelector('.summary-value').innerHTML = 'üõ°Ô∏è Enabled';
          failoverStatus.querySelector('.summary-value').style.color = '#10b981';
          failoverInfo.style.display = 'block';
          
          // Show ranked backup providers (sorted by rate, excluding selected)
          const backupList = document.getElementById('backupProvidersList');
          const otherProviders = Object.values(KNOWN_PROVIDERS)
            .filter(p => p.name !== selectedProvider.name)
            .slice(0, 4);
          
          backupList.innerHTML = otherProviders.map((p, i) => `
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <span style="background: ${i === 0 ? '#10b981' : 'var(--border)'}; color: ${i === 0 ? '#000' : 'var(--text-dim)'}; 
                          width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; 
                          justify-content: center; font-size: 0.7rem; font-weight: 600;">${i + 1}</span>
              <span style="color: ${i === 0 ? 'var(--arkeo)' : 'var(--text-dim)'};">${p.name}</span>
              ${i === 0 ? '<span style="font-size: 0.75rem; color: #10b981;">‚Üê Next in queue</span>' : ''}
            </div>
          `).join('');
        } else {
          failoverStatus.querySelector('.summary-value').innerHTML = '‚óã Disabled';
          failoverStatus.querySelector('.summary-value').style.color = 'var(--text-dim)';
          failoverInfo.style.display = 'none';
        }
        
        // Populate SDK integration section with dynamic values
        // Extract base sentinel URL (remove service path if present)
        const sentinelUrl = sentinelBaseUrl || endpointUrl.replace(/\/[^\/]+$/, '');
        const contractId = txHash ? txHash.slice(0, 12) : 'CONTRACT_ID';
        
        // Use the actual signing key if available
        const privateKeyForSDK = signingKey?.privateKeyHex || 'YOUR_SIGNING_KEY_HEX';
        
        // Populate JavaScript example
        document.getElementById('js-endpoint').textContent = `'${sentinelUrl}'`;
        document.getElementById('js-contract-id').textContent = contractId;
        document.getElementById('js-service').textContent = `'${svcName}'`;
        
        // Update the JavaScript code block to include the private key
        const jsCodeBlock = document.querySelector('#sdk-js pre');
        if (jsCodeBlock && signingKey?.privateKeyHex) {
          jsCodeBlock.innerHTML = jsCodeBlock.innerHTML.replace(
            /'YOUR_SIGNING_KEY_HEX'/g,
            `'${privateKeyForSDK}'`
          );
        }
        
        // Populate Python example
        document.getElementById('py-endpoint').textContent = `'${sentinelUrl}'`;
        document.getElementById('py-contract-id').textContent = contractId;
        document.getElementById('py-service').textContent = `'${svcName}'`;
        
        // Update the Python code block to include the private key
        const pyCodeBlock = document.querySelector('#sdk-python pre');
        if (pyCodeBlock && signingKey?.privateKeyHex) {
          pyCodeBlock.innerHTML = pyCodeBlock.innerHTML.replace(
            /'YOUR_SIGNING_KEY_HEX'/g,
            `'${privateKeyForSDK}'`
          );
        }
        
        // Update security message if signing key is used
        const securityMsg = document.getElementById('sdkSecurityMessage');
        const securityWarning = document.getElementById('sdkSecurityWarning');
        if (signingKey && securityMsg && securityWarning) {
          securityMsg.innerHTML = `
            ‚úÖ Your contract uses a dedicated signing key (set as delegate). 
            This key can ONLY make RPC queries against your contract ‚Äî it cannot access your wallet or move funds. 
            Store the private key securely on your server.
          `;
          securityWarning.style.background = 'rgba(16, 185, 129, 0.1)';
          securityWarning.style.borderColor = '#10b981';
          securityWarning.querySelector('span').textContent = 'üîí';
        }
        
        // Clear state after successful contract opening
        setTimeout(() => {
          clearState();
          goToStep(4);
          // Scroll to top so user sees the success page
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }, 1000);
      } catch (err) {
        console.error('Contract error:', err);
        document.getElementById('contractStatus').innerHTML = `
          <div class="status-box error">
            <span>‚ùå</span>
            <span>Failed: ${err.message}</span>
          </div>
        `;
        btn.disabled = false;
        btn.textContent = 'Open Contract';
      }
    }

    function copyEndpoint() {
      const endpoint = document.getElementById('finalEndpoint').textContent;
      navigator.clipboard.writeText(endpoint);
      
      const btn = event.target;
      btn.textContent = '‚úì Copied!';
      setTimeout(() => btn.textContent = 'üìã Copy Endpoint', 2000);
    }

    function findAnother() {
      // Clear state when finding another provider
      clearState();
      
      selectedChain = null;
      selectedProvider = null;
      document.querySelectorAll('.chain-option').forEach(el => el.classList.remove('selected'));
      document.querySelectorAll('.provider-card').forEach(el => el.classList.remove('selected'));
      document.getElementById('nextBtn1').disabled = true;
      document.getElementById('nextBtn2').disabled = true;
      document.getElementById('contractStatus').innerHTML = '';
      document.getElementById('walletSection').innerHTML = `
        <div class="wallet-label">Connect your wallet to open the contract</div>
        <button class="connect-wallet-btn" onclick="connectWallet()">
          üîó Connect Keplr Wallet
        </button>
      `;
      document.getElementById('openContractBtn').classList.add('hidden');
      document.getElementById('openContractBtn').disabled = false;
      document.getElementById('openContractBtn').textContent = 'Open Contract';
      goToStep(1);
    }

    // ============================================================
    // ARKEO PRICE & USDC FLOW
    // ============================================================
    let arkeoPrice = null; // USD price

    async function fetchArkeoPrice() {
      try {
        const resp = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=arkeo&vs_currencies=usd');
        const data = await resp.json();
        if (data.arkeo?.usd) {
          arkeoPrice = data.arkeo.usd;
          updatePriceDisplay();
          return;
        }
      } catch (e) { console.warn('CoinGecko price fetch failed:', e); }
      // Fallback: try Osmosis pool
      try {
        const resp = await fetch('https://lcd.osmosis.zone/osmosis/poolmanager/v2/pools/2977');
        const data = await resp.json();
        // Parse pool assets to derive price if possible
        console.log('Osmosis pool data:', data);
      } catch (e) { console.warn('Osmosis price fetch also failed:', e); }
      // Hard fallback
      arkeoPrice = null;
      updatePriceDisplay();
    }

    function updatePriceDisplay() {
      const priceEl = document.getElementById('arkeoPriceValue');
      const neededEl = document.getElementById('arkeoNeeded');
      if (!priceEl) return;
      
      if (arkeoPrice) {
        priceEl.textContent = '$' + arkeoPrice.toFixed(6);
        priceEl.style.color = 'var(--arkeo)';
        updateUsdcEstimate();
      } else {
        priceEl.textContent = 'Unavailable';
        priceEl.style.color = 'var(--warning)';
        neededEl.textContent = 'Enter USDC amount above';
      }
    }

    function updateUsdcEstimate() {
      const neededEl = document.getElementById('arkeoNeeded');
      if (!neededEl || !arkeoPrice) return;
      
      const usdcAmount = parseFloat(document.getElementById('depositAmount').value) || 0;
      if (paymentMethod !== 'usdc' || usdcAmount <= 0) {
        neededEl.textContent = '‚Äî';
        return;
      }
      const arkeoAmount = usdcAmount / arkeoPrice;
      neededEl.textContent = `~${arkeoAmount.toFixed(2)} ARKEO (‚âà $${usdcAmount.toFixed(2)})`;
    }

    async function recheckBalance() {
      const btn = document.getElementById('recheckBalanceBtn');
      if (!walletAddress) {
        alert('Please connect your Keplr wallet first.');
        return;
      }
      btn.textContent = '‚è≥ Checking...';
      btn.disabled = true;
      try {
        const resp = await fetch(`${CONFIG.REST_API}/cosmos/bank/v1beta1/balances/${walletAddress}`);
        const data = await resp.json();
        const arkeoBalance = data.balances?.find(b => b.denom === CONFIG.ARKEO_DENOM);
        const bal = arkeoBalance ? (parseInt(arkeoBalance.amount) / CONFIG.ARKEO_DIVISOR).toFixed(2) : '0.00';
        
        // Update wallet display
        const walletSection = document.getElementById('walletSection');
        walletSection.innerHTML = `
          <div style="text-align: center;">
            <div style="color: var(--success);">
              <div>‚úÖ Wallet Connected</div>
              <div style="font-weight: 600; margin-top: 0.25rem;">${walletAddress.slice(0, 12)}...${walletAddress.slice(-6)}</div>
              <div style="color: var(--text-dim); font-size: 0.85rem; margin-top: 0.25rem;">
                Balance: <strong style="color: var(--arkeo);">${bal} ARKEO</strong> <span style="font-size: 0.75rem; color: var(--text-dim);">(just refreshed)</span>
              </div>
            </div>
          </div>
        `;
        btn.textContent = '‚úÖ Balance: ' + bal + ' ARKEO';
        setTimeout(() => { btn.textContent = 'üîÑ Check My Balance'; btn.disabled = false; }, 3000);
        
        // Also update Skip Go balances
        await updateSkipGoBalances();
      } catch (e) {
        btn.textContent = '‚ùå Failed to check';
        setTimeout(() => { btn.textContent = 'üîÑ Check My Balance'; btn.disabled = false; }, 2000);
      }
    }

    // ============================================================
    // SKIP GO INTEGRATION
    // ============================================================
    const SKIP_GO_API = 'https://api.skip.build';
    
    // Noble chain configuration for Keplr
    const NOBLE_CHAIN_CONFIG = {
      chainId: 'noble-1',
      chainName: 'Noble',
      rpc: 'https://noble-rpc.polkachu.com',
      rest: 'https://noble-api.polkachu.com',
      bip44: { coinType: 118 },
      bech32Config: {
        bech32PrefixAccAddr: 'noble',
        bech32PrefixAccPub: 'noblepub',
        bech32PrefixValAddr: 'noblevaloper',
        bech32PrefixValPub: 'noblevaloperpub',
        bech32PrefixConsAddr: 'noblevalcons',
        bech32PrefixConsPub: 'noblevalconspub',
      },
      currencies: [{
        coinDenom: 'USDC',
        coinMinimalDenom: 'uusdc',
        coinDecimals: 6,
      }],
      feeCurrencies: [{
        coinDenom: 'USDC',
        coinMinimalDenom: 'uusdc',
        coinDecimals: 6,
        gasPriceStep: { low: 0.0, average: 0.0, high: 0.0 }
      }],
      stakeCurrency: {
        coinDenom: 'USDC',
        coinMinimalDenom: 'uusdc',
        coinDecimals: 6,
      },
    };

    let skipGoQuote = null;
    let nobleAddress = null;
    let quoteTimeout = null;

    async function initializeNobleWallet() {
      if (!window.keplr) {
        console.warn('Keplr not available');
        return;
      }
      
      try {
        // Suggest Noble chain to Keplr
        await suggestNobleChain();
        
        // Enable Noble chain
        await window.keplr.enable('noble-1');
        
        // Get Noble address
        const offlineSigner = window.keplr.getOfflineSigner('noble-1');
        const accounts = await offlineSigner.getAccounts();
        nobleAddress = accounts[0].address;
        
        console.log('Noble wallet initialized:', nobleAddress);
        
        // Update balances
        await updateSkipGoBalances();
      } catch (e) {
        console.error('Failed to initialize Noble wallet:', e);
        // Show error in UI
        document.getElementById('nobleBalanceDisplay').textContent = 'Failed to connect Noble wallet';
      }
    }

    async function updateSkipGoBalances() {
      if (!walletAddress || !nobleAddress) return;
      
      try {
        // Get Noble USDC balance
        const nobleResp = await fetch(`https://noble-api.polkachu.com/cosmos/bank/v1beta1/balances/${nobleAddress}`);
        const nobleData = await nobleResp.json();
        const usdcBalance = nobleData.balances?.find(b => b.denom === 'uusdc');
        const usdcFormatted = usdcBalance ? (parseInt(usdcBalance.amount) / 1_000_000).toFixed(2) : '0.00';
        
        document.getElementById('nobleBalanceDisplay').textContent = `Balance: ${usdcFormatted} USDC`;
        
        // Get Arkeo balance
        const arkeoResp = await fetch(`${CONFIG.REST_API}/cosmos/bank/v1beta1/balances/${walletAddress}`);
        const arkeoData = await arkeoResp.json();
        const arkeoBalance = arkeoData.balances?.find(b => b.denom === CONFIG.ARKEO_DENOM);
        const arkeoFormatted = arkeoBalance ? (parseInt(arkeoBalance.amount) / CONFIG.ARKEO_DIVISOR).toFixed(2) : '0.00';
        
        document.getElementById('arkeoBalanceDisplay').textContent = `Balance: ${arkeoFormatted} ARKEO`;
        
        // Enable swap button if we have USDC
        const swapBtn = document.getElementById('executeSwapBtn');
        if (parseFloat(usdcFormatted) > 0) {
          swapBtn.disabled = false;
          swapBtn.textContent = 'Get Quote to Swap';
        }
      } catch (e) {
        console.error('Failed to fetch balances:', e);
      }
    }

    async function updateSkipGoQuote() {
      const usdcInput = document.getElementById('swapUsdcInput');
      const usdcAmount = parseFloat(usdcInput.value);
      
      if (!usdcAmount || usdcAmount <= 0) {
        document.getElementById('swapArkeoOutput').textContent = '‚Äî';
        document.getElementById('skipGoQuoteDetails').style.display = 'none';
        document.getElementById('executeSwapBtn').textContent = walletAddress ? 'Enter USDC amount' : 'Connect Wallet to Swap';
        document.getElementById('executeSwapBtn').disabled = true;
        return;
      }
      
      // Debounce quote fetching
      clearTimeout(quoteTimeout);
      quoteTimeout = setTimeout(async () => {
        await fetchSkipGoQuote(usdcAmount);
      }, 500);
    }

    async function fetchSkipGoQuote(usdcAmount) {
      const outputEl = document.getElementById('swapArkeoOutput');
      const detailsEl = document.getElementById('skipGoQuoteDetails');
      const rateEl = document.getElementById('swapRate');
      const swapBtn = document.getElementById('executeSwapBtn');
      
      outputEl.textContent = 'Loading...';
      swapBtn.disabled = true;
      swapBtn.textContent = 'Fetching quote...';
      
      try {
        // Convert USDC to uusdc (6 decimals)
        const amountIn = String(Math.floor(usdcAmount * 1_000_000));
        
        const routeReq = {
          amount_in: amountIn,
          source_asset_denom: 'uusdc',
          source_asset_chain_id: 'noble-1',
          dest_asset_denom: 'uarkeo',
          dest_asset_chain_id: 'arkeo-main-v1',
          cumulative_affiliate_fee_bps: '0',
        };
        
        console.log('Requesting Skip Go route:', routeReq);
        
        const resp = await fetch(`${SKIP_GO_API}/v2/fungible/route`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(routeReq),
        });
        
        if (!resp.ok) {
          const errorText = await resp.text();
          throw new Error(`Skip Go API error: ${errorText}`);
        }
        
        const quote = await resp.json();
        console.log('Skip Go quote:', quote);
        
        if (!quote.amount_out) {
          throw new Error('No route found. ARKEO may not be available on Skip Go yet.');
        }
        
        // Store quote
        skipGoQuote = quote;
        
        // Convert uarkeo to ARKEO (8 decimals)
        const arkeoOut = parseInt(quote.amount_out) / CONFIG.ARKEO_DIVISOR;
        const exchangeRate = arkeoOut / usdcAmount;
        
        outputEl.textContent = arkeoOut.toFixed(2);
        rateEl.textContent = `1 USDC = ${exchangeRate.toFixed(2)} ARKEO`;
        detailsEl.style.display = 'block';
        
        swapBtn.disabled = false;
        swapBtn.textContent = `Swap ${usdcAmount.toFixed(2)} USDC ‚Üí ${arkeoOut.toFixed(2)} ARKEO`;
        
      } catch (err) {
        console.error('Quote fetch failed:', err);
        outputEl.textContent = 'Error';
        outputEl.style.color = 'var(--error)';
        detailsEl.style.display = 'none';
        
        swapBtn.disabled = true;
        swapBtn.textContent = err.message.includes('not be available') ? '‚ö†Ô∏è ARKEO not in Skip Go registry yet' : '‚ùå Quote failed';
        
        // Show error message
        document.getElementById('skipGoSwapStatus').innerHTML = `
          <div style="background: rgba(239,68,68,0.1); border: 1px solid #ef4444; border-radius: 0.5rem; padding: 0.75rem; margin-top: 0.75rem;">
            <div style="color: #ef4444; font-weight: 600; margin-bottom: 0.25rem;">‚ö†Ô∏è Quote Error</div>
            <div style="font-size: 0.8rem; color: var(--text-dim);">${err.message}</div>
          </div>
        `;
      }
    }

    async function executeSkipGoSwap() {
      if (!skipGoQuote || !walletAddress || !nobleAddress) {
        alert('Please connect your wallet and get a quote first.');
        return;
      }
      
      const statusDiv = document.getElementById('skipGoSwapStatus');
      const swapBtn = document.getElementById('executeSwapBtn');
      
      swapBtn.disabled = true;
      swapBtn.textContent = 'Processing...';
      
      statusDiv.innerHTML = `
        <div style="background: var(--arkeo-dim); border: 1px solid var(--arkeo); border-radius: 0.5rem; padding: 0.75rem; margin-top: 0.75rem;">
          <div style="display: flex; align-items: center; gap: 0.75rem;">
            <div class="spinner"></div>
            <span>Requesting transaction messages from Skip Go...</span>
          </div>
        </div>
      `;
      
      try {
        // Ensure chains are enabled
        await suggestNobleChain();
        await window.keplr.enable('noble-1');
        await window.keplr.enable(CONFIG.CHAIN_ID);
        
        // Get addresses
        const nobleSigner = window.keplr.getOfflineSigner('noble-1');
        const nobleAccounts = await nobleSigner.getAccounts();
        nobleAddress = nobleAccounts[0].address;
        
        const arkeoSigner = window.keplr.getOfflineSigner(CONFIG.CHAIN_ID);
        const arkeoAccounts = await arkeoSigner.getAccounts();
        const arkeoAddress = arkeoAccounts[0].address;
        
        // Request transaction messages from Skip Go
        const msgsReq = {
          source_asset_denom: 'uusdc',
          source_asset_chain_id: 'noble-1',
          dest_asset_denom: 'uarkeo',
          dest_asset_chain_id: CONFIG.CHAIN_ID,
          amount_in: skipGoQuote.amount_in,
          amount_out: skipGoQuote.amount_out,
          address_list: [nobleAddress, arkeoAddress],
          operations: skipGoQuote.operations || skipGoQuote.required_chain_addresses,
        };
        
        console.log('Requesting Skip Go messages:', msgsReq);
        
        const msgsResp = await fetch(`${SKIP_GO_API}/v2/fungible/msgs`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(msgsReq),
        });
        
        if (!msgsResp.ok) {
          const errorText = await msgsResp.text();
          throw new Error(`Skip Go msgs API error: ${errorText}`);
        }
        
        const msgsData = await msgsResp.json();
        console.log('Skip Go messages response:', msgsData);
        
        if (!msgsData.msgs || msgsData.msgs.length === 0) {
          throw new Error('No transaction messages received from Skip Go');
        }
        
        // Execute each transaction in the route
        let txHashes = [];
        
        for (let i = 0; i < msgsData.msgs.length; i++) {
          const msgGroup = msgsData.msgs[i];
          const chainId = msgGroup.chain_id;
          const evmTx = msgGroup.evm_tx;
          
          if (evmTx) {
            throw new Error('EVM chains not supported in this wizard yet. Please use the manual swap method.');
          }
          
          // Cosmos transaction
          const msgs = msgGroup.msgs || [];
          const memo = msgGroup.memo || 'Skip Go swap via Arkeo Marketplace';
          
          statusDiv.innerHTML = `
            <div style="background: var(--arkeo-dim); border: 1px solid var(--arkeo); border-radius: 0.5rem; padding: 0.75rem; margin-top: 0.75rem;">
              <div style="display: flex; align-items: center; gap: 0.75rem;">
                <div class="spinner"></div>
                <span>Please sign transaction ${i + 1}/${msgsData.msgs.length} in Keplr (${chainId})...</span>
              </div>
            </div>
          `;
          
          // Get signer for this chain
          const chainSigner = window.keplr.getOfflineSigner(chainId);
          const chainAccounts = await chainSigner.getAccounts();
          const chainAddress = chainAccounts[0].address;
          
          // Get account number and sequence
          const restUrl = chainId === 'noble-1' ? 'https://noble-api.polkachu.com' : 
                          chainId === 'osmosis-1' ? 'https://lcd.osmosis.zone' : CONFIG.REST_API;
          
          const accountResp = await fetch(`${restUrl}/cosmos/auth/v1beta1/accounts/${chainAddress}`);
          const accountData = await accountResp.json();
          const account = accountData.account?.base_account || accountData.account || {};
          
          // Build amino sign doc
          const fee = {
            amount: [{ 
              denom: chainId === 'noble-1' ? 'uusdc' : 
                     chainId === 'osmosis-1' ? 'uosmo' : CONFIG.ARKEO_DENOM,
              amount: '10000' 
            }],
            gas: '500000',
          };
          
          const signDoc = {
            chain_id: chainId,
            account_number: String(account.account_number || '0'),
            sequence: String(account.sequence || '0'),
            fee: fee,
            msgs: msgs,
            memo: memo,
          };
          
          console.log('Signing doc:', signDoc);
          
          // Sign with Keplr
          const signResponse = await window.keplr.signAmino(chainId, chainAddress, signDoc);
          
          console.log('Signed transaction:', signResponse);
          
          statusDiv.innerHTML = `
            <div style="background: var(--arkeo-dim); border: 1px solid var(--arkeo); border-radius: 0.5rem; padding: 0.75rem; margin-top: 0.75rem;">
              <div style="display: flex; align-items: center; gap: 0.75rem;">
                <div class="spinner"></div>
                <span>Broadcasting transaction ${i + 1}/${msgsData.msgs.length}...</span>
              </div>
            </div>
          `;
          
          // Encode and broadcast
          const txBytes = encodeAminoTx(signResponse);
          const txBytesBase64 = btoa(String.fromCharCode(...txBytes));
          
          const broadcastResp = await fetch(`${restUrl}/cosmos/tx/v1beta1/txs`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              tx_bytes: txBytesBase64,
              mode: 'BROADCAST_MODE_SYNC',
            }),
          });
          
          const broadcastData = await broadcastResp.json();
          console.log('Broadcast response:', broadcastData);
          
          if (broadcastData.tx_response?.code !== 0) {
            throw new Error(broadcastData.tx_response?.raw_log || 'Transaction broadcast failed');
          }
          
          txHashes.push(broadcastData.tx_response.txhash);
        }
        
        // Wait for completion
        statusDiv.innerHTML = `
          <div style="background: var(--success-dim); border: 1px solid var(--success); border-radius: 0.5rem; padding: 0.75rem; margin-top: 0.75rem;">
            <div style="display: flex; align-items: center; gap: 0.75rem;">
              <div class="spinner"></div>
              <span>Swap in progress... This may take up to 1 minute</span>
            </div>
            <div style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-dim);">
              TX: ${txHashes[0]?.slice(0, 16)}...
            </div>
          </div>
        `;
        
        // Wait a bit for the swap to complete (IBC takes time)
        await new Promise(r => setTimeout(r, 45000)); // 45 seconds
        
        // Success!
        statusDiv.innerHTML = `
          <div style="background: var(--success-dim); border: 1px solid var(--success); border-radius: 0.5rem; padding: 0.75rem; margin-top: 0.75rem;">
            <div style="color: var(--success); font-weight: 600; margin-bottom: 0.25rem;">‚úÖ Swap Complete!</div>
            <div style="font-size: 0.8rem; color: var(--text-dim); margin-bottom: 0.75rem;">ARKEO should arrive in your wallet shortly. Check your balance below.</div>
            <button onclick="selectPayment('arkeo'); recheckBalance();" 
              style="padding: 0.5rem 1rem; background: #10b981; color: #fff; border: none; border-radius: 0.375rem; font-weight: 600; cursor: pointer;">
              üíé Switch to ARKEO Payment
            </button>
          </div>
        `;
        
        // Update balances
        await updateSkipGoBalances();
        
        swapBtn.textContent = 'Swap Complete ‚úÖ';
        
      } catch (err) {
        console.error('Swap failed:', err);
        statusDiv.innerHTML = `
          <div style="background: rgba(239,68,68,0.1); border: 1px solid #ef4444; border-radius: 0.5rem; padding: 0.75rem; margin-top: 0.75rem;">
            <div style="color: #ef4444; font-weight: 600; margin-bottom: 0.25rem;">‚ùå Swap Failed</div>
            <div style="font-size: 0.8rem; color: var(--text-dim); margin-bottom: 0.5rem;">${err.message}</div>
            ${err.message.includes('not in Skip Go') || err.message.includes('not supported') ? `
              <div style="padding: 0.75rem; background: rgba(249,158,11,0.1); border-radius: 0.375rem; margin-top: 0.75rem;">
                <div style="font-weight: 600; margin-bottom: 0.25rem;">üí° Try the manual method instead:</div>
                <ol style="margin: 0.5rem 0 0 1.25rem; font-size: 0.8rem; line-height: 1.6;">
                  <li>Open the "Manual swap" section above</li>
                  <li>Use Osmosis DEX to swap USDC ‚Üí ARKEO</li>
                  <li>Transfer ARKEO to Arkeo chain via IBC</li>
                  <li>Come back and pay with ARKEO</li>
                </ol>
              </div>
            ` : ''}
          </div>
        `;
        swapBtn.disabled = false;
        swapBtn.textContent = 'Try Again';
      }
    }
    
    // Helper to encode Amino transaction for broadcasting
    function encodeAminoTx(signResponse) {
      // This is a simplified version - in production you'd use proper protobuf encoding
      // For now, we'll rely on Keplr's encoding or use the existing arkeo-tx.js helper
      const { signed, signature } = signResponse;
      
      // Use arkeo-tx helper if available
      if (window.arkeoTx) {
        try {
          const bodyBytes = window.arkeoTx.buildTxBody(signed.msgs.map(m => ({
            typeUrl: m.type || '/cosmos.bank.v1beta1.MsgSend',
            value: m.value || m
          })), signed.memo || '');
          
          // For amino, we need to convert the pubkey format
          const pubkeyBytes = new Uint8Array(33); // Compressed secp256k1
          const authInfoBytes = window.arkeoTx.buildAuthInfo(pubkeyBytes, parseInt(signed.sequence), signed.fee.amount[0].amount, parseInt(signed.fee.gas));
          
          const sigBytes = window.arkeoTx.base64ToBytes(signature.signature);
          const txRawBytes = window.arkeoTx.buildTxRaw(bodyBytes, authInfoBytes, [sigBytes]);
          
          return txRawBytes;
        } catch (e) {
          console.warn('Failed to use arkeo-tx helper for encoding:', e);
        }
      }
      
      // Fallback: return empty (will cause broadcast to fail, but we show manual option)
      throw new Error('Transaction encoding failed. Please try the manual swap method.');
    }

    async function suggestNobleChain() {
      try {
        await window.keplr.experimentalSuggestChain(NOBLE_CHAIN_CONFIG);
      } catch (e) {
        console.warn('Noble chain suggestion failed (may already be added):', e);
      }
    }

    // ============================================================
    // SDK INTEGRATION HELPERS
    // ============================================================
    function switchSDKTab(lang) {
      // Update tab styles
      document.querySelectorAll('.sdk-tab').forEach(tab => {
        const isActive = tab.getAttribute('data-lang') === lang;
        tab.style.borderBottomColor = isActive ? 'var(--arkeo)' : 'transparent';
        tab.style.color = isActive ? 'var(--arkeo)' : 'var(--text-dim)';
        if (isActive) tab.classList.add('active');
        else tab.classList.remove('active');
      });
      
      // Show/hide content
      document.getElementById('sdk-js').style.display = lang === 'js' ? 'block' : 'none';
      document.getElementById('sdk-python').style.display = lang === 'python' ? 'block' : 'none';
    }
    
    function copyToClipboard(button, text) {
      navigator.clipboard.writeText(text).then(() => {
        const originalText = button.textContent;
        button.textContent = '‚úì Copied!';
        button.style.background = 'var(--success)';
        button.style.color = '#fff';
        setTimeout(() => {
          button.textContent = originalText;
          button.style.background = 'var(--bg-card)';
          button.style.color = 'var(--text-dim)';
        }, 2000);
      }).catch(err => {
        console.error('Copy failed:', err);
        button.textContent = '‚ùå Failed';
        setTimeout(() => button.textContent = 'üìã', 2000);
      });
    }

    // ============================================================
    // SIGNING KEY GENERATION
    // ============================================================
    let signingKey = null; // { privateKeyHex, publicKeyHex, publicKeyBech32, address }
    
    function selectKeyMode(mode) {
      const generateFlow = document.getElementById('generateKeyFlow');
      const existingFlow = document.getElementById('existingKeyFlow');
      
      if (mode === 'generate') {
        generateFlow.style.display = 'block';
        existingFlow.style.display = 'none';
      } else {
        existingFlow.style.display = 'block';
        generateFlow.style.display = 'none';
      }
    }
    
    async function generateSigningKey() {
      try {
        // Wait for noble libraries to load (async module imports)
        if (!window.nobleSecp256k1) {
          for (let i = 0; i < 50; i++) {
            await new Promise(r => setTimeout(r, 100));
            if (window.nobleSecp256k1) break;
          }
          if (!window.nobleSecp256k1) throw new Error('Crypto libraries failed to load. Please refresh and try again.');
        }

        // Generate 32 random bytes as private key
        const privateKeyBytes = crypto.getRandomValues(new Uint8Array(32));
        const privateKeyHex = Array.from(privateKeyBytes, b => b.toString(16).padStart(2, '0')).join('');
        
        // Derive public key using secp256k1
        const publicKeyBytes = await nobleSecp256k1.getPublicKey(privateKeyBytes, true); // compressed (33 bytes)
        const publicKeyHex = Array.from(publicKeyBytes, b => b.toString(16).padStart(2, '0')).join('');
        
        // Encode public key as arkeopub bech32
        const publicKeyBech32 = pubkeyToBech32(publicKeyBytes, 'arkeopub');
        
        // Derive address (arkeo1...)
        const address = await deriveAddress(publicKeyBytes);
        
        // Store signing key
        signingKey = { privateKeyHex, publicKeyHex, publicKeyBech32, address, publicKeyBytes };
        
        // Display
        document.getElementById('privateKeyDisplay').textContent = privateKeyHex;
        document.getElementById('publicKeyDisplay').textContent = publicKeyBech32;
        document.getElementById('addressDisplay').textContent = address;
        document.getElementById('generatedKeyDisplay').style.display = 'block';
        
        console.log('Generated signing key:', signingKey);
        
        // Save state after signing key generation
        saveState();
      } catch (err) {
        console.error('Key generation failed:', err);
        alert('Failed to generate key: ' + err.message);
      }
    }
    
    async function parseExistingKey() {
      // Wait for noble libraries
      if (!window.nobleSecp256k1) {
        for (let i = 0; i < 50; i++) {
          await new Promise(r => setTimeout(r, 100));
          if (window.nobleSecp256k1) break;
        }
      }
      const input = document.getElementById('existingKeyInput').value.trim();
      const display = document.getElementById('parsedKeyDisplay');
      
      if (!input) {
        display.style.display = 'none';
        signingKey = null;
        return;
      }
      
      try {
        let publicKeyBytes, publicKeyBech32, address;
        
        if (input.startsWith('arkeopub')) {
          // Bech32 public key provided
          publicKeyBech32 = input;
          // Decode bech32 to get raw pubkey bytes
          const decoded = bech32Decode(input);
          // Remove amino prefix (first 5 bytes: eb5ae98721)
          publicKeyBytes = decoded.slice(5);
        } else if (input.length === 64 || input.length === 66) {
          // Hex private or public key
          const keyBytes = hexToBytes(input);
          
          if (keyBytes.length === 32) {
            // Private key ‚Äî derive public key
            publicKeyBytes = await nobleSecp256k1.getPublicKey(keyBytes, true);
          } else if (keyBytes.length === 33) {
            // Compressed public key
            publicKeyBytes = keyBytes;
          } else {
            throw new Error('Invalid key length');
          }
          
          publicKeyBech32 = pubkeyToBech32(publicKeyBytes, 'arkeopub');
        } else {
          throw new Error('Invalid key format. Expected hex (64/66 chars) or arkeopub bech32.');
        }
        
        // Derive address
        address = await deriveAddress(publicKeyBytes);
        
        // Store
        signingKey = { 
          privateKeyHex: input.length === 64 && !input.startsWith('arkeopub') ? input : null,
          publicKeyBech32, 
          address, 
          publicKeyBytes 
        };
        
        // Display
        document.getElementById('existingPubKeyDisplay').textContent = publicKeyBech32;
        document.getElementById('existingAddressDisplay').textContent = address;
        display.style.display = 'block';
        
        console.log('Parsed existing key:', signingKey);
        
        // Save state after parsing existing key
        saveState();
      } catch (err) {
        console.error('Key parsing failed:', err);
        display.style.display = 'none';
        signingKey = null;
      }
    }
    
    function hexToBytes(hex) {
      const bytes = new Uint8Array(hex.length / 2);
      for (let i = 0; i < bytes.length; i++) {
        bytes[i] = parseInt(hex.substr(i * 2, 2), 16);
      }
      return bytes;
    }
    
    function bech32Decode(bech32Str) {
      const CHARSET = 'qpzry9x8gf2tvdw0s3jn54khce6mua7l';
      const parts = bech32Str.split('1');
      if (parts.length !== 2) throw new Error('Invalid bech32');
      
      const data = [];
      for (const c of parts[1]) {
        const idx = CHARSET.indexOf(c);
        if (idx === -1) throw new Error('Invalid bech32 character');
        data.push(idx);
      }
      
      // Remove checksum (last 6 values)
      const payload = data.slice(0, -6);
      
      // Convert from 5-bit to 8-bit
      const bytes = [];
      let acc = 0, bits = 0;
      for (const val of payload) {
        acc = (acc << 5) | val;
        bits += 5;
        while (bits >= 8) {
          bits -= 8;
          bytes.push((acc >> bits) & 0xff);
        }
      }
      
      return new Uint8Array(bytes);
    }
    
    async function deriveAddress(publicKeyBytes) {
      // SHA-256 hash of public key
      const sha256Hash = await window.nobleSha256(publicKeyBytes);
      
      // RIPEMD160 of SHA-256 hash
      const hash160 = window.nobleRipemd160(sha256Hash);
      
      // Encode as bech32 with 'arkeo' prefix
      return bech32EncodeAddress('arkeo', hash160);
    }
    
    function bech32EncodeAddress(prefix, data) {
      const words = toWords(data);
      return bech32Encode(prefix, words);
    }
    
    function copyAllKeys() {
      const priv = document.getElementById('privateKeyDisplay')?.textContent || '';
      const pub = document.getElementById('publicKeyDisplay')?.textContent || '';
      const addr = document.getElementById('addressDisplay')?.textContent || '';
      const text = `Private Key: ${priv}\nPublic Key: ${pub}\nAddress: ${addr}`;
      navigator.clipboard.writeText(text).then(() => {
        const btn = document.getElementById('copyAllKeysBtn');
        btn.textContent = '‚úÖ Copied! Save this somewhere safe.';
        btn.style.background = 'var(--success)';
        btn.style.color = '#fff';
        setTimeout(() => {
          btn.textContent = 'üìã Copy All to Clipboard';
          btn.style.background = 'var(--bg-card)';
          btn.style.color = 'var(--text)';
        }, 3000);
      });
    }

    function copyKey(type) {
      const elMap = { private: 'privateKeyDisplay', public: 'publicKeyDisplay', address: 'addressDisplay' };
      const text = document.getElementById(elMap[type])?.textContent || '';
      
      navigator.clipboard.writeText(text).then(() => {
        const btn = event.target;
        const orig = btn.textContent;
        btn.textContent = '‚úì Copied!';
        btn.style.background = 'var(--success)';
        btn.style.color = '#fff';
        setTimeout(() => {
          btn.textContent = orig;
          btn.style.background = 'var(--bg-card)';
          btn.style.color = 'var(--text)';
        }, 2000);
      });
    }

    // Initialize on load
    init();
    fetchArkeoPrice();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Contracts | Arkeo Marketplace</title>
  <link rel="icon" type="image/png" href="images/arkeo-logo-200px_1.png">
  <script src="js/config.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/arkeo-tx.js"></script>
  <script src="js/arkauth.js"></script>
  <script src="js/providers.js"></script>
  <style>
    :root {
      --bg-main: #0C0E14;
      --bg-card: #151820;
      --bg-input: #1a1f2e;
      --border: #2a2f3c;
      --border-focus: #3BE0FF;
      --arkeo: #3BE0FF;
      --arkeo-dim: rgba(59, 224, 255, 0.1);
      --success: #10b981;
      --success-dim: rgba(16, 185, 129, 0.1);
      --warning: #f59e0b;
      --error: #ef4444;
      --text: #ffffff;
      --text-dim: #9ca3af;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: var(--bg-main);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      min-height: 100vh;
      line-height: 1.6;
    }
    .nav {
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 1.25rem;
      font-weight: 700;
      text-decoration: none;
      color: var(--text);
    }
    .logo img { height: 36px; }
    .logo span { color: var(--arkeo); }
    .nav-links { display: flex; align-items: center; gap: 1.5rem; }
    .nav-link { color: var(--text-dim); text-decoration: none; font-weight: 500; transition: color 0.2s; }
    .nav-link:hover { color: var(--arkeo); }
    .wallet-btn {
      background: var(--arkeo);
      color: #000;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.2s;
    }
    .wallet-btn:hover { opacity: 0.9; }
    .wallet-btn.connected { background: var(--success); color: white; }
    .container { max-width: 1100px; margin: 0 auto; padding: 2rem; }
    h1 { font-size: 1.75rem; margin-bottom: 0.5rem; }
    .subtitle { color: var(--text-dim); margin-bottom: 2rem; }
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 0.75rem;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    .connect-prompt {
      text-align: center;
      padding: 4rem 2rem;
    }
    .connect-prompt p { color: var(--text-dim); margin-bottom: 1.5rem; font-size: 1.1rem; }
    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 0.75rem;
      padding: 1.25rem;
      text-align: center;
    }
    .stat-value { font-size: 1.75rem; font-weight: 700; color: var(--arkeo); }
    .stat-label { color: var(--text-dim); font-size: 0.85rem; margin-top: 0.25rem; }
    .filter-row {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }
    .filter-btn {
      background: var(--bg-input);
      border: 1px solid var(--border);
      color: var(--text-dim);
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
    }
    .filter-btn:hover { border-color: var(--arkeo); color: var(--arkeo); }
    .filter-btn.active { background: var(--arkeo-dim); border-color: var(--arkeo); color: var(--arkeo); }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th {
      text-align: left;
      padding: 0.75rem 1rem;
      color: var(--text-dim);
      font-weight: 600;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 1px solid var(--border);
    }
    td {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border);
      font-size: 0.9rem;
    }
    tr:hover td { background: rgba(59, 224, 255, 0.03); }
    .badge {
      display: inline-block;
      padding: 0.2rem 0.6rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .badge-active { background: var(--success-dim); color: var(--success); }
    .badge-expired { background: rgba(239, 68, 68, 0.1); color: var(--error); }
    .badge-client { background: rgba(99, 102, 241, 0.1); color: #818cf8; }
    .badge-provider { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
    .action-btn {
      padding: 0.4rem 0.8rem;
      border-radius: 0.4rem;
      border: 1px solid;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      background: transparent;
    }
    .action-btn.close-btn { border-color: var(--error); color: var(--error); }
    .action-btn.close-btn:hover { background: var(--error); color: white; }
    .action-btn.claim-btn { border-color: var(--warning); color: var(--warning); }
    .action-btn.claim-btn:hover { background: var(--warning); color: #000; }
    .action-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .empty-state { text-align: center; padding: 3rem; color: var(--text-dim); }
    .loading { text-align: center; padding: 3rem; color: var(--text-dim); }
    .loading::after { content: '...'; animation: dots 1.5s infinite; }
    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }
    .toast {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      padding: 1rem 1.5rem;
      border-radius: 0.5rem;
      font-weight: 500;
      z-index: 1000;
      animation: slideIn 0.3s ease;
      max-width: 400px;
    }
    .toast-success { background: var(--success); color: white; }
    .toast-error { background: var(--error); color: white; }
    @keyframes slideIn { from { transform: translateY(1rem); opacity: 0; } }
    .addr { font-family: monospace; font-size: 0.8rem; }
    .truncate { max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: inline-block; vertical-align: middle; }
    @media (max-width: 768px) {
      .container { padding: 1rem; }
      .nav { padding: 0.75rem 1rem; }
      .nav-links { display: none; }
      table { font-size: 0.8rem; }
      th, td { padding: 0.5rem; }
    }
  </style>
</head>
<body>
  <nav class="nav">
    <a href="index.html" class="logo">
      <img src="images/arkeo-logo-200px_1.png" alt="Arkeo">
      Arkeo <span>Marketplace</span>
    </a>
    <div class="nav-links">
      <a href="index.html" class="nav-link">Home</a>
      <a href="analytics.html" class="nav-link">Analytics</a>
      <a href="become-provider.html" class="nav-link">Provide Data</a>
      <a href="subscribe.html" class="nav-link">Use Data</a>
    </div>
    <div style="position: relative;">
      <button class="wallet-btn" id="walletBtn" onclick="toggleWalletMenu()">ðŸ”— Connect Keplr</button>
      <div id="walletMenu" style="display:none; position:absolute; right:0; top:calc(100% + 0.5rem); background:var(--bg-card); border:1px solid var(--border); border-radius:0.75rem; padding:0.75rem; min-width:280px; z-index:100; box-shadow: 0 8px 24px rgba(0,0,0,0.4);">
        <div style="font-size:0.75rem; color:var(--text-dim); margin-bottom:0.25rem;">Connected Wallet</div>
        <div id="menuAddress" style="font-size:0.85rem; font-family:monospace; word-break:break-all; margin-bottom:0.75rem; color:var(--text);"></div>
        <div style="display:flex; gap:0.5rem; margin-bottom:0.5rem;">
          <button onclick="copyAddress()" style="flex:1; padding:0.5rem; background:var(--bg-input); border:1px solid var(--border); border-radius:0.5rem; color:var(--text); font-size:0.8rem; cursor:pointer;">ðŸ“‹ Copy Address</button>
          <button onclick="viewOnExplorer()" style="flex:1; padding:0.5rem; background:var(--bg-input); border:1px solid var(--border); border-radius:0.5rem; color:var(--text); font-size:0.8rem; cursor:pointer;">ðŸ”— Explorer</button>
        </div>
        <div id="menuBalance" style="font-size:0.85rem; color:var(--arkeo); margin-bottom:0.75rem; padding:0.5rem; background:var(--arkeo-dim); border-radius:0.5rem; text-align:center;"></div>
        <button onclick="disconnectWallet()" style="width:100%; padding:0.5rem; background:rgba(239,68,68,0.1); border:1px solid var(--error); border-radius:0.5rem; color:var(--error); font-size:0.85rem; cursor:pointer; font-weight:600;">Sign Out</button>
      </div>
    </div>
  </nav>

  <div class="container">
    <h1>ðŸ“‹ My Contracts</h1>
    <p class="subtitle">View and manage your Arkeo data contracts</p>

    <!-- Before wallet connect -->
    <div id="connectPrompt" class="card connect-prompt">
      <p>Connect your Keplr wallet to view your contracts</p>
      <button class="wallet-btn" onclick="connectWallet()">ðŸ”— Connect Keplr</button>
    </div>

    <!-- After wallet connect -->
    <div id="contractsSection" style="display:none;">
      <div class="stats-row" id="statsRow">
        <div class="stat-card"><div class="stat-value" id="totalContracts">-</div><div class="stat-label">Total Contracts</div></div>
        <div class="stat-card"><div class="stat-value" id="activeContracts">-</div><div class="stat-label">Active</div></div>
        <div class="stat-card"><div class="stat-value" id="asClient">-</div><div class="stat-label">As Client</div></div>
        <div class="stat-card"><div class="stat-value" id="asProvider">-</div><div class="stat-label">As Provider</div></div>
      </div>

      <div class="filter-row">
        <button class="filter-btn active" onclick="setFilter('all', this)">All</button>
        <button class="filter-btn" onclick="setFilter('active', this)">Active</button>
        <button class="filter-btn" onclick="setFilter('expired', this)">Expired</button>
        <button class="filter-btn" onclick="setFilter('client', this)">As Client</button>
        <button class="filter-btn" onclick="setFilter('provider', this)">As Provider</button>
      </div>

      <div class="card" style="padding:0; overflow-x:auto;">
        <div id="loadingState" class="loading">Loading contracts</div>
        <div id="emptyState" class="empty-state" style="display:none;">No contracts found for this wallet</div>
        <table id="contractsTable" style="display:none;">
          <thead>
            <tr>
              <th>ID</th>
              <th>Role</th>
              <th>Provider / Client</th>
              <th>Service</th>
              <th>Type</th>
              <th>Deposit</th>
              <th>Paid</th>
              <th>Rate</th>
              <th>Time Left</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="contractsBody"></tbody>
        </table>
      </div>

      <!-- Provider Bonds Section -->
      <div style="margin-top: 2rem;">
        <h2 style="font-size: 1.2rem; margin-bottom: 1rem;">ðŸ”’ My Provider Bonds</h2>
        <div id="bondsLoading" style="color: var(--text-dim); font-size: 0.9rem;">Loading bonds...</div>
        <div id="bondsEmpty" style="display:none; color: var(--text-dim); font-size: 0.9rem; padding: 1rem; background: var(--bg-card); border-radius: 0.75rem; border: 1px solid var(--border);">
          You don't have any provider bonds.
        </div>
        <div id="bondsTable" style="display:none; overflow-x: auto;">
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="border-bottom: 1px solid var(--border);">
                <th style="padding: 0.75rem; text-align: left; color: var(--text-dim); font-size: 0.8rem;">Service</th>
                <th style="padding: 0.75rem; text-align: right; color: var(--text-dim); font-size: 0.8rem;">Bond</th>
                <th style="padding: 0.75rem; text-align: right; color: var(--text-dim); font-size: 0.8rem;">Status</th>
                <th style="padding: 0.75rem; text-align: right; color: var(--text-dim); font-size: 0.8rem;">Action</th>
              </tr>
            </thead>
            <tbody id="bondsBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    // State
    const state = {
      walletAddress: null,
      walletPubkey: null,     // arkeopub bech32
      walletPubkeyBytes: null,
      contracts: [],
      currentFilter: 'all',
      currentHeight: 0,
    };

    // Toast notification
    function showToast(msg, type = 'success') {
      const t = document.createElement('div');
      t.className = `toast toast-${type}`;
      t.textContent = msg;
      document.body.appendChild(t);
      setTimeout(() => t.remove(), 5000);
    }

    // Wallet menu
    let walletMenuOpen = false;

    function toggleWalletMenu() {
      if (!state.walletAddress) { connectWallet(); return; }
      walletMenuOpen = !walletMenuOpen;
      document.getElementById('walletMenu').style.display = walletMenuOpen ? 'block' : 'none';
    }

    // Close menu when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('#walletBtn') && !e.target.closest('#walletMenu')) {
        walletMenuOpen = false;
        document.getElementById('walletMenu').style.display = 'none';
      }
    });

    function copyAddress() {
      navigator.clipboard.writeText(state.walletAddress);
      showToast('Address copied!');
    }

    function viewOnExplorer() {
      window.open(`https://explorer.arkeo.network/arkeo/account/${state.walletAddress}`, '_blank');
    }

    async function fetchBalance() {
      try {
        const res = await fetch(`${CONFIG.REST_API}/cosmos/bank/v1beta1/balances/${state.walletAddress}`);
        const data = await res.json();
        const uarkeo = (data.balances || []).find(b => b.denom === 'uarkeo');
        const balance = uarkeo ? (parseInt(uarkeo.amount) / CONFIG.ARKEO_DIVISOR).toFixed(2) : '0.00';
        document.getElementById('menuBalance').textContent = `ðŸ’° ${balance} ARKEO`;
      } catch (e) {
        document.getElementById('menuBalance').textContent = 'Balance unavailable';
      }
    }

    function disconnectWallet() {
      state.walletAddress = null;
      state.walletPubkey = null;
      state.walletPubkeyBytes = null;
      state.contracts = [];
      const btn = document.getElementById('walletBtn');
      btn.className = 'wallet-btn';
      btn.textContent = 'ðŸ”— Connect Keplr';
      document.getElementById('walletMenu').style.display = 'none';
      document.getElementById('contractsSection').style.display = 'none';
      document.getElementById('connectPrompt').style.display = 'block';
      walletMenuOpen = false;
    }

    // Connect Keplr
    async function connectWallet() {
      if (!window.keplr) { showToast('Please install Keplr wallet extension', 'error'); return; }
      try {
        await window.keplr.enable(CONFIG.CHAIN_ID);
        const offlineSigner = window.keplr.getOfflineSigner(CONFIG.CHAIN_ID);
        const accounts = await offlineSigner.getAccounts();
        state.walletAddress = accounts[0].address;
        state.walletPubkeyBytes = accounts[0].pubkey;

        // Build arkeopub address from pubkey (amino-encoded secp256k1)
        const aminoPrefix = new Uint8Array([0xeb, 0x5a, 0xe9, 0x87, 0x21]);
        const pubWithPrefix = new Uint8Array(aminoPrefix.length + accounts[0].pubkey.length);
        pubWithPrefix.set(aminoPrefix);
        pubWithPrefix.set(accounts[0].pubkey, aminoPrefix.length);
        state.walletPubkey = ArkAuth.bech32Encode('arkeopub', pubWithPrefix);

        const btn = document.getElementById('walletBtn');
        btn.className = 'wallet-btn connected';
        btn.textContent = `âœ“ ${state.walletAddress.slice(0, 10)}...${state.walletAddress.slice(-4)}`;
        document.getElementById('menuAddress').textContent = state.walletAddress;
        fetchBalance();

        document.getElementById('connectPrompt').style.display = 'none';
        document.getElementById('contractsSection').style.display = 'block';

        await loadContracts();
        await loadBonds();
      } catch (e) {
        console.error(e);
        showToast('Failed to connect wallet: ' + e.message, 'error');
      }
    }

    // Fetch current block height
    async function fetchCurrentHeight() {
      try {
        const res = await fetch(`${CONFIG.REST_API}/cosmos/base/tendermint/v1beta1/blocks/latest`);
        const data = await res.json();
        state.currentHeight = parseInt(data.block.header.height);
      } catch (e) {
        console.error('Failed to fetch height:', e);
      }
    }

    // Load all contracts and filter for user
    async function loadContracts() {
      document.getElementById('loadingState').style.display = 'block';
      document.getElementById('contractsTable').style.display = 'none';
      document.getElementById('emptyState').style.display = 'none';

      await fetchCurrentHeight();

      // Fetch services for name resolution
      try {
        const svcRes = await fetch(`${CONFIG.REST_API}/arkeo/services`);
        const svcData = await svcRes.json();
        state.services = {};
        (svcData.services || []).forEach(s => { state.services[s.service_id] = s.name; });
      } catch (e) { state.services = {}; }

      // Fetch all contracts (paginated)
      let allContracts = [];
      let nextKey = null;
      do {
        let url = `${CONFIG.REST_API}/arkeo/contracts?pagination.limit=100`;
        if (nextKey) url += `&pagination.key=${encodeURIComponent(nextKey)}`;
        try {
          const res = await fetch(url);
          const data = await res.json();
          if (data.contract) allContracts = allContracts.concat(data.contract);
          nextKey = data.pagination?.next_key || null;
        } catch (e) {
          console.error('Failed to fetch contracts:', e);
          nextKey = null;
        }
      } while (nextKey);

      // Filter for user's contracts
      state.contracts = allContracts.filter(c => {
        const isClient = c.client === state.walletPubkey;
        const isDelegate = c.delegate === state.walletPubkey;
        const isProvider = c.delegate === state.walletAddress || c.provider === state.walletAddress;
        return isClient || isDelegate || isProvider;
      }).map(c => {
        const isClient = c.client === state.walletPubkey;
        const height = parseInt(c.height) || 0;
        const duration = parseInt(c.duration) || 0;
        const deposit = parseInt(c.deposit) || 0;
        const paid = parseInt(c.paid) || 0;
        const active = state.currentHeight < (height + duration) && deposit > paid;
        return { ...c, isClient, active };
      });

      document.getElementById('loadingState').style.display = 'none';
      renderContracts();
    }

    // Filter
    function setFilter(filter, btn) {
      state.currentFilter = filter;
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      renderContracts();
    }

    // Render
    function renderContracts() {
      let filtered = state.contracts;
      if (state.currentFilter === 'active') filtered = filtered.filter(c => c.active);
      else if (state.currentFilter === 'expired') filtered = filtered.filter(c => !c.active);
      else if (state.currentFilter === 'client') filtered = filtered.filter(c => c.isClient);
      else if (state.currentFilter === 'provider') filtered = filtered.filter(c => !c.isClient);

      // Stats
      const active = state.contracts.filter(c => c.active);
      const clientCount = state.contracts.filter(c => c.isClient);
      const providerCount = state.contracts.filter(c => !c.isClient);
      document.getElementById('totalContracts').textContent = state.contracts.length;
      document.getElementById('activeContracts').textContent = active.length;
      document.getElementById('asClient').textContent = clientCount.length;
      document.getElementById('asProvider').textContent = providerCount.length;

      if (filtered.length === 0) {
        document.getElementById('contractsTable').style.display = 'none';
        document.getElementById('emptyState').style.display = 'block';
        return;
      }

      document.getElementById('emptyState').style.display = 'none';
      document.getElementById('contractsTable').style.display = 'table';

      const tbody = document.getElementById('contractsBody');
      tbody.innerHTML = filtered.map(c => {
        const deposit = parseInt(c.deposit) || 0;
        const paid = parseInt(c.paid) || 0;
        const rate = c.rate ? `${(parseInt(c.rate.amount) / CONFIG.ARKEO_DIVISOR).toFixed(4)}` : '-';
        const contractType = parseInt(c.contract_type) === 0 ? 'Sub' : 'PAYG';
        const service = state.services?.[c.service] || c.service || '-';
        // Resolve pubkeys to names
        function resolveName(pubkey) {
          if (pubkey === state.walletPubkey) return 'ðŸŸ¢ You';
          if (typeof KNOWN_PROVIDERS !== 'undefined' && KNOWN_PROVIDERS[pubkey]) return KNOWN_PROVIDERS[pubkey].name;
          return pubkey?.slice(0, 20) + '...';
        }
        const counterparty = c.isClient
          ? `<span title="${c.provider}">${resolveName(c.provider)}</span>`
          : `<span title="${c.client}">${resolveName(c.client)}</span>`;
        
        // Calculate time remaining
        const height = parseInt(c.height) || 0;
        const duration = parseInt(c.duration) || 0;
        const expiryBlock = height + duration;
        const blocksLeft = Math.max(0, expiryBlock - state.currentHeight);
        const secondsLeft = blocksLeft * 4;
        let timeLeft = '-';
        if (c.active) {
          if (secondsLeft >= 86400) timeLeft = `~${Math.round(secondsLeft / 86400)}d`;
          else if (secondsLeft >= 3600) timeLeft = `~${Math.round(secondsLeft / 3600)}h`;
          else if (secondsLeft >= 60) timeLeft = `~${Math.round(secondsLeft / 60)}m`;
          else timeLeft = '< 1m';
        }
        const roleLabel = c.isClient
          ? '<span class="badge badge-client">Client</span>'
          : '<span class="badge badge-provider">Provider</span>';
        const statusBadge = c.active
          ? '<span class="badge badge-active">Active</span>'
          : '<span class="badge badge-expired">Expired</span>';

        let actionBtn = '';
        if (c.active && c.isClient) {
          actionBtn = `<button class="action-btn close-btn" onclick="closeContract(${c.id})">Close</button>`;
        } else if (c.active && !c.isClient) {
          actionBtn = `<button class="action-btn claim-btn" onclick="claimEarnings(${c.id})" title="Earnings are claimed automatically by your sentinel. Manual claiming coming soon.">Claim</button>`;
        }

        return `<tr>
          <td>${c.id}</td>
          <td>${roleLabel}</td>
          <td>${counterparty}</td>
          <td>${service}</td>
          <td>${contractType}</td>
          <td>${(deposit / CONFIG.ARKEO_DIVISOR).toFixed(2)}</td>
          <td>${(paid / CONFIG.ARKEO_DIVISOR).toFixed(2)}</td>
          <td>${rate}</td>
          <td>${timeLeft}</td>
          <td>${statusBadge}</td>
          <td>${actionBtn}</td>
        </tr>`;
      }).join('');
    }

    // Get account info for signing
    async function getAccountInfo() {
      const res = await fetch(`${CONFIG.REST_API}/cosmos/auth/v1beta1/accounts/${state.walletAddress}`);
      const data = await res.json();
      const account = data.account;
      return {
        accountNumber: account.account_number,
        sequence: account.sequence || '0'
      };
    }

    // Sign and broadcast (same pattern as become-provider.html)
    async function signAndBroadcastDirect(msg) {
      await window.arkeoTx.init();
      const pubkeyBytes = state.walletPubkeyBytes;
      if (!pubkeyBytes) throw new Error('No wallet pubkey bytes available');

      const accountInfo = await getAccountInfo();
      const bodyBytes = window.arkeoTx.buildTxBody([msg], 'via Arkeo Marketplace');
      const authInfoBytes = window.arkeoTx.buildAuthInfo(
        pubkeyBytes, parseInt(accountInfo.sequence), '10000', 300000
      );

      const signDoc = {
        bodyBytes, authInfoBytes,
        chainId: CONFIG.CHAIN_ID,
        accountNumber: accountInfo.accountNumber
      };

      const signResponse = await window.keplr.signDirect(CONFIG.CHAIN_ID, state.walletAddress, signDoc);
      const signatureBytes = window.arkeoTx.base64ToBytes(signResponse.signature.signature);
      const txRawBytes = window.arkeoTx.buildTxRaw(
        signResponse.signed.bodyBytes,
        signResponse.signed.authInfoBytes,
        [signatureBytes]
      );
      const txBytesBase64 = window.arkeoTx.bytesToBase64(txRawBytes);

      const broadcastRes = await fetch(`${CONFIG.REST_API}/cosmos/tx/v1beta1/txs`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ tx_bytes: txBytesBase64, mode: 'BROADCAST_MODE_SYNC' })
      });
      const result = await broadcastRes.json();
      if (result.tx_response?.code !== 0) {
        throw new Error(`TX failed: ${result.tx_response?.raw_log || 'Unknown error'}`);
      }
      return result.tx_response;
    }

    // Close Contract
    async function closeContract(contractId) {
      const contract = state.contracts.find(c => c.id == contractId);
      if (!contract) return;
      if (!confirm(`Close contract #${contractId}? This will end the contract and return remaining deposit.`)) return;

      try {
        const msg = {
          typeUrl: '/arkeo.arkeo.MsgCloseContract',
          value: {
            creator: state.walletAddress,
            contractId: contractId,
            client: contract.client,
            delegate: contract.delegate || ''
          }
        };
        const result = await signAndBroadcastDirect(msg);
        showToast(`Contract #${contractId} closed! TX: ${result.txhash.slice(0, 12)}...`);
        setTimeout(loadContracts, 3000);
      } catch (e) {
        console.error(e);
        showToast('Failed to close contract: ' + e.message, 'error');
      }
    }

    // Claim Earnings
    async function claimEarnings(contractId) {
      const contract = state.contracts.find(c => c.id == contractId);
      if (!contract) return;

      const deposit = parseInt(contract.deposit) || 0;
      const paid = parseInt(contract.paid) || 0;
      const nonce = parseInt(contract.nonce) || 0;
      const unclaimed = deposit - paid;

      if (unclaimed <= 0) {
        showToast('No unclaimed earnings on this contract.', 'error');
        return;
      }

      // For PAYG contracts, the claim TX requires an arkauth signature from the client
      // that proves N requests were served. The sentinel handles this automatically
      // because it collects these signatures as it proxies requests.
      //
      // For manual claiming, we use ADR-036 signing via Keplr to generate
      // the arkauth signature for the current nonce.
      if (!confirm(`Claim earnings from contract #${contractId}?\n\nDeposit: ${(deposit / CONFIG.ARKEO_DIVISOR).toFixed(4)} ARKEO\nAlready paid: ${(paid / CONFIG.ARKEO_DIVISOR).toFixed(4)} ARKEO\nCurrent nonce: ${nonce}\n\nThis will claim any unclaimed income up to the current nonce.`)) return;

      try {
        // Get the arkauth signature for the current nonce using Keplr
        // The preimage is "{contractId}:{nonce}:" â€” same format sentinel uses
        const preimage = `${contractId}:${nonce}:`;
        
        // Sign via Keplr's signArbitrary (ADR-036)
        const signResult = await window.keplr.signArbitrary(CONFIG.CHAIN_ID, state.walletAddress, preimage);
        
        // Convert base64 signature to bytes
        const sigBytes = Uint8Array.from(atob(signResult.signature), c => c.charCodeAt(0));

        const msg = {
          typeUrl: '/arkeo.arkeo.MsgClaimContractIncome',
          value: {
            creator: state.walletAddress,
            contractId: contractId,
            signature: sigBytes,
            nonce: nonce
          }
        };

        const result = await signAndBroadcastDirect(msg);
        showToast(`Earnings claimed! TX: ${result.txhash.slice(0, 12)}...`);
        setTimeout(loadContracts, 3000);
      } catch (e) {
        console.error(e);
        showToast('Failed to claim: ' + e.message, 'error');
      }
    }
    // Load provider bonds
    async function loadBonds() {
      document.getElementById('bondsLoading').style.display = 'block';
      document.getElementById('bondsTable').style.display = 'none';
      document.getElementById('bondsEmpty').style.display = 'none';

      try {
        const res = await fetch(`${CONFIG.REST_API}/arkeo/providers`);
        const data = await res.json();
        const providers = data.provider || [];

        // Filter for providers matching this wallet's pubkey
        const myBonds = providers.filter(p => p.pub_key === state.walletPubkey);

        document.getElementById('bondsLoading').style.display = 'none';

        if (myBonds.length === 0) {
          document.getElementById('bondsEmpty').style.display = 'block';
          return;
        }

        // Fetch services for name resolution
        if (!state.services || Object.keys(state.services).length === 0) {
          try {
            const svcRes = await fetch(`${CONFIG.REST_API}/arkeo/services`);
            const svcData = await svcRes.json();
            state.services = {};
            (svcData.services || []).forEach(s => { state.services[s.service_id] = s.name; });
          } catch (e) { state.services = {}; }
        }

        document.getElementById('bondsTable').style.display = 'block';
        const tbody = document.getElementById('bondsBody');
        tbody.innerHTML = myBonds.map(p => {
          const bond = parseInt(p.bond) || 0;
          const serviceName = state.services?.[p.service] || p.service;
          const statusColor = p.status === 'ONLINE' ? 'var(--success)' : 'var(--error)';
          return `<tr style="border-bottom: 1px solid var(--border);">
            <td style="padding: 0.75rem; font-size: 0.9rem;">${serviceName}</td>
            <td style="padding: 0.75rem; text-align: right; font-size: 0.9rem;">${(bond / CONFIG.ARKEO_DIVISOR).toFixed(2)} ARKEO</td>
            <td style="padding: 0.75rem; text-align: right;"><span style="color: ${statusColor}; font-size: 0.85rem; font-weight: 600;">${p.status}</span></td>
            <td style="padding: 0.75rem; text-align: right;">
              <button onclick="unbondProvider('${p.pub_key}', '${serviceName}', ${bond})" 
                style="padding: 0.4rem 0.8rem; background: rgba(239,68,68,0.1); border: 1px solid var(--error); border-radius: 0.5rem; color: var(--error); font-size: 0.8rem; cursor: pointer; font-weight: 600;">
                Unbond
              </button>
            </td>
          </tr>`;
        }).join('');
      } catch (e) {
        console.error(e);
        document.getElementById('bondsLoading').textContent = 'Failed to load bonds.';
      }
    }

    // Unbond provider
    async function unbondProvider(pubkey, serviceName, currentBond) {
      const bondArkeo = (currentBond / CONFIG.ARKEO_DIVISOR).toFixed(2);
      if (!confirm(`Unbond ${bondArkeo} ARKEO from service "${serviceName}"?\n\nThis will remove your provider bond and return the ARKEO to your wallet.`)) return;

      try {
        const msg = {
          typeUrl: '/arkeo.arkeo.MsgBondProvider',
          value: {
            creator: state.walletAddress,
            provider: pubkey,
            service: serviceName,
            bond: '-' + String(currentBond)
          }
        };
        const result = await signAndBroadcastDirect(msg);
        showToast(`Unbonded! TX: ${result.txhash.slice(0, 12)}...`);
        setTimeout(loadBonds, 3000);
      } catch (e) {
        console.error(e);
        showToast('Failed to unbond: ' + e.message, 'error');
      }
    }
  </script>
</body>
</html>

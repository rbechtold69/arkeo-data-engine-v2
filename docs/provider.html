<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' cdn.jsdelivr.net; connect-src *; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:;">
  <title>Provider Details ‚Äî Arkeo Marketplace</title>
  <link rel="icon" type="image/png" href="images/arkeo-logo-200px_1.png">
  <meta name="description" content="View provider details, services, contracts, and reputation on the Arkeo Data Marketplace.">
  <meta name="theme-color" content="#0a0c10">
  <script src="js/config.js"></script>
  <script src="js/utils.js"></script>
  <style>
    :root {
      --bg-main: #0a0c10;
      --bg-card: #12151c;
      --bg-card-hover: #181c25;
      --bg-input: #1a1f2a;
      --border: #252a36;
      --border-hover: #3BE0FF;
      --arkeo: #3BE0FF;
      --arkeo-dim: rgba(59, 224, 255, 0.1);
      --arkeo-glow: rgba(59, 224, 255, 0.3);
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      --text: #ffffff;
      --text-dim: #8b92a5;
      --text-muted: #5a6278;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: var(--bg-main);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;
      line-height: 1.6;
      min-height: 100vh;
    }
    .nav {
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      padding: 1rem 2rem;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .nav-inner {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 1.25rem;
      font-weight: 700;
      text-decoration: none;
      color: var(--text);
    }
    .logo img { height: 40px; }
    .logo-text span { color: var(--arkeo); }
    .btn {
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
    }
    .btn-primary { background: var(--arkeo); color: #000; }
    .btn-primary:hover { box-shadow: 0 0 20px var(--arkeo-glow); }
    .btn-secondary { background: var(--bg-input); color: var(--text); border: 1px solid var(--border); }
    .btn-secondary:hover { border-color: var(--arkeo); color: var(--arkeo); }
    .btn-outline { background: transparent; color: var(--arkeo); border: 1px solid var(--arkeo); }
    .btn-outline:hover { background: var(--arkeo-dim); }

    .main { max-width: 1200px; margin: 0 auto; padding: 2rem; }

    .loading { text-align: center; padding: 3rem; color: var(--text-dim); }
    .spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--arkeo); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 1rem; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Provider Header */
    .provider-hero {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 1rem;
      padding: 2rem;
      margin-bottom: 1.5rem;
    }
    .provider-hero-top {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 1.5rem;
      flex-wrap: wrap;
    }
    .provider-hero-info { flex: 1; min-width: 250px; }
    .provider-hero-name {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 0.25rem;
    }
    .provider-hero-pubkey {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.85rem;
      color: var(--text-dim);
      background: var(--bg-input);
      padding: 0.35rem 0.75rem;
      border-radius: 0.5rem;
      cursor: pointer;
      margin-bottom: 0.75rem;
    }
    .provider-hero-pubkey:hover { color: var(--arkeo); }
    .provider-hero-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-top: 0.75rem;
      font-size: 0.9rem;
      color: var(--text-dim);
    }
    .provider-hero-meta a { color: var(--arkeo); text-decoration: none; }
    .provider-hero-meta a:hover { text-decoration: underline; }
    .provider-hero-desc {
      margin-top: 1rem;
      color: var(--text-dim);
      font-size: 0.95rem;
      max-width: 700px;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.25rem 0.75rem;
      border-radius: 1rem;
      font-size: 0.8rem;
      font-weight: 600;
    }
    .badge-online { background: rgba(16,185,129,0.15); color: var(--success); }
    .badge-offline { background: rgba(239,68,68,0.15); color: var(--error); }

    .rep-hero {
      text-align: center;
      min-width: 140px;
    }
    .rep-hero-score {
      font-size: 3rem;
      font-weight: 800;
      line-height: 1;
    }
    .rep-hero-label {
      font-size: 0.75rem;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .rep-gold { color: #fbbf24; }
    .rep-silver { color: #cbd5e1; }
    .rep-bronze { color: #d97706; }
    .rep-none { color: var(--text-dim); }

    /* Section Cards */
    .section-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 1rem;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    .section-card h3 {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    /* Tables */
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }
    .data-table th {
      text-align: left;
      padding: 0.75rem 1rem;
      background: var(--bg-input);
      color: var(--text-dim);
      font-weight: 600;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid var(--border);
    }
    .data-table td {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border);
      vertical-align: middle;
    }
    .data-table tr:last-child td { border-bottom: none; }
    .data-table tr:hover { background: var(--bg-card-hover); }

    /* Reputation Bars */
    .rep-breakdown { display: flex; flex-direction: column; gap: 1rem; }
    .rep-row { display: flex; align-items: center; gap: 1rem; }
    .rep-row-label { min-width: 160px; font-size: 0.9rem; color: var(--text-dim); }
    .rep-row-bar {
      flex: 1;
      height: 10px;
      background: var(--bg-input);
      border-radius: 5px;
      overflow: hidden;
      position: relative;
    }
    .rep-row-fill {
      height: 100%;
      border-radius: 5px;
      transition: width 0.6s ease;
    }
    .rep-row-value { min-width: 70px; text-align: right; font-weight: 600; font-size: 0.9rem; }

    /* Stats grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }
    .stat-box {
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 0.75rem;
      padding: 1rem;
      text-align: center;
    }
    .stat-box-value { font-size: 1.5rem; font-weight: 700; color: var(--arkeo); }
    .stat-box-label { font-size: 0.75rem; color: var(--text-dim); margin-top: 0.25rem; }

    /* Chain icons */
    .chain-icon { font-size: 1.1rem; margin-right: 0.25rem; }

    /* Action bar */
    .action-bar {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      margin-top: 1.5rem;
    }

    /* Footer */
    .footer {
      background: var(--bg-card);
      border-top: 1px solid var(--border);
      padding: 2rem;
      margin-top: 4rem;
    }
    .footer-inner {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .footer-link { color: var(--text-dim); text-decoration: none; font-size: 0.875rem; }
    .footer-link:hover { color: var(--arkeo); }

    @media (max-width: 768px) {
      .nav { padding: 0.75rem 1rem; }
      .main { padding: 1rem; }
      .provider-hero { padding: 1.25rem; }
      .provider-hero-name { font-size: 1.5rem; }
      .provider-hero-top { flex-direction: column; }
      .rep-hero { text-align: left; display: flex; align-items: center; gap: 1rem; }
      .rep-hero-score { font-size: 2rem; }
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .rep-row { flex-direction: column; align-items: stretch; gap: 0.25rem; }
      .rep-row-label { min-width: unset; }
      .rep-row-value { text-align: left; }
      .action-bar { flex-direction: column; }
      .action-bar .btn { width: 100%; justify-content: center; }
    }
  
    /* Mobile Nav - Hamburger Menu */
    .nav-inner {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .nav-links {
      display: flex;
      align-items: center;
      gap: 2rem;
    }
    .nav-link { color: var(--text-dim, #9ca3af); text-decoration: none; font-weight: 500; transition: color 0.2s; }
    .nav-link:hover { color: var(--arkeo, #3BE0FF); }
    .hamburger {
      display: none;
      align-items: center;
      justify-content: center;
      background: none;
      border: 1px solid var(--border, #252a36);
      border-radius: 0.375rem;
      color: var(--text, #fff);
      font-size: 1.4rem;
      padding: 0.4rem 0.6rem;
      cursor: pointer;
    }
    .hamburger:hover { border-color: var(--arkeo, #3BE0FF); color: var(--arkeo, #3BE0FF); }
    .mobile-menu { display: none; }
    .nav-buttons {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }
    .nav-btn {
      padding: 0.45rem 0.9rem;
      border-radius: 0.375rem;
      font-weight: 500;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid var(--border, #252a36);
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      color: var(--text, #fff);
      background: transparent;
    }
    .nav-btn:hover {
      color: var(--arkeo, #3BE0FF);
      border-color: var(--arkeo, #3BE0FF);
      background: rgba(59, 224, 255, 0.05);
    }
    .nav-btn-accent {
      border-color: rgba(245, 158, 11, 0.5);
      color: #f59e0b;
      font-weight: 600;
    }
    .nav-btn-accent:hover {
      background: rgba(245, 158, 11, 0.12);
      border-color: #f59e0b;
      box-shadow: 0 0 10px rgba(245, 158, 11, 0.2);
    }

    .nav-btn-highlight {
      background: rgba(59, 224, 255, 0.12);
      border-color: rgba(59, 224, 255, 0.5);
      color: var(--arkeo);
      font-weight: 600;
    }
    .nav-btn-highlight:hover {
      background: rgba(59, 224, 255, 0.22);
      border-color: var(--arkeo);
      box-shadow: 0 0 10px rgba(59, 224, 255, 0.2);
    }
    @media (max-width: 768px) {
      .nav { padding: 0.75rem 1rem; }
      .nav-links { display: none; }
      .nav-buttons { display: none; }
      .hamburger { display: flex !important; }
      .mobile-menu { display: none !important; flex-direction: column; width: 100%; padding: 0.5rem 0; gap: 0.25rem; }
      .mobile-menu.open { display: flex !important; }
      .mobile-menu a { color: var(--text-dim, #8b92a5); text-decoration: none; padding: 0.6rem 0.5rem; border-radius: 0.375rem; font-size: 0.9rem; }
      .mobile-menu a:hover { color: var(--arkeo, #3BE0FF); background: rgba(59, 224, 255, 0.1); }
      .nav-inner { flex-wrap: wrap; gap: 0.5rem; }
      .logo { font-size: 1rem; }
      .logo img { height: 32px; }
    }
  </style>
</head>
<body>
  <nav class="nav">
    <div class="nav-inner">
      <a href="index.html" class="logo">
        <img src="images/arkeo-logo-200px_1.png" alt="Arkeo">
        <span class="logo-text">Arkeo <span>Marketplace</span></span>
      </a>
            <div class="nav-links">
        <a href="analytics.html" class="nav-link">üìä Analytics</a>
        <a href="request-chain.html" class="nav-link">üó≥Ô∏è Request Chain</a>
        <a href="agents.html" class="nav-link">ü§ñ AI Agents</a>
        <a href="x402-setup.html" class="nav-link">‚ö° x402</a>
        <a href="cli-reference.html" class="nav-link">‚å®Ô∏è CLI</a><a href="x402-provider-guide.html" class="nav-link">‚ö° x402 Guide</a>
        <a href="https://docs.arkeo.network" target="_blank" rel="noopener" class="nav-link">Docs</a>
        <a href="become-provider.html" class="nav-btn nav-btn-highlight">Sell Data</a>
        <a href="subscribe.html" class="nav-btn nav-btn-highlight">Buy Data</a>
        <a href="my-contracts.html" class="nav-btn">My Contracts</a>
        <a href="https://app.osmosis.zone/pool/2977" target="_blank" rel="noopener" class="nav-btn nav-btn-accent">Buy ARKEO</a>
      </div>
      <button class="hamburger" onclick="document.getElementById('mobileMenu').classList.toggle('open')" aria-label="Menu">‚ò∞</button>
    </div>
    <div class="mobile-menu" id="mobileMenu">
      <a href="index.html">üè† Home</a>
      <a href="analytics.html">üìä Analytics</a>
      <a href="request-chain.html">üó≥Ô∏è Request Chain</a>
      <a href="x402-setup.html">‚ö° x402</a>
      <a href="https://docs.arkeo.network" target="_blank">üìÑ Docs</a>
      <a href="my-contracts.html">üìã My Contracts</a>
      <a href="become-provider.html">üöÄ Sell Data</a>
      <a href="subscribe.html">üì° Buy Data</a>
      <a href="https://app.osmosis.zone/pool/2977" target="_blank">üí∞ Buy ARKEO</a>
    </div>
  </nav>

  <main class="main">
    <div id="loading" class="loading">
      <div class="spinner"></div>
      <p>Loading provider details...</p>
    </div>
    <div id="content" style="display:none;"></div>
    <div id="error" style="display:none; text-align:center; padding:3rem;">
      <p style="color: var(--error); font-size: 1.2rem; margin-bottom: 1rem;">Provider not found</p>
      <a href="index.html" class="btn btn-primary">‚Üê Back to Marketplace</a>
    </div>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      <div style="color: var(--text-dim); font-size: 0.875rem;">¬© 2026 Arkeo Network. Decentralized data infrastructure.</div>
      <div style="display: flex; gap: 2rem;">
        <a href="https://docs.arkeo.network" target="_blank" class="footer-link">Docs</a>
        <a href="https://discord.gg/f3cKq2bPPF" target="_blank" class="footer-link">Discord</a>
        <a href="https://twitter.com/arkaboreal" target="_blank" class="footer-link">Twitter</a>
        <a href="https://github.com/arkeonetwork" target="_blank" class="footer-link">GitHub</a>
        <a href="https://racing.builtonarkeo.com/" target="_blank" rel="noopener" class="footer-link">üèá Racing</a>
      </div>
    </div>
  </footer>

  <script src="js/providers.js"></script>
  <script>
    // KNOWN_PROVIDERS loaded from js/providers.js
    
    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }
    
    function findKnown(pk) {
      if (typeof KNOWN_PROVIDERS === 'undefined') return null;
      if (KNOWN_PROVIDERS[pk]) return KNOWN_PROVIDERS[pk];
      const match = Object.keys(KNOWN_PROVIDERS).find(k =>
        k.startsWith(pk.slice(0, 40)) || pk.startsWith(k.slice(0, 40)));
      return match ? KNOWN_PROVIDERS[match] : null;
    }

    const CHAIN_ICONS = {
      'eth': '‚ü†', 'ethereum': '‚ü†', 'btc': '‚Çø', 'bitcoin': '‚Çø',
      'cosmos': '‚öõ', 'atom': '‚öõ', 'gaia': '‚öõ',
      'thorchain': '‚ö°', 'osmosis': 'üß™', 'arkeo': 'üî∑',
      'base': 'üîµ', 'avax': 'üî∫', 'avalanche': 'üî∫',
      'bsc': 'üíõ', 'binance': 'üíõ', 'polygon': 'üíú',
    };

    function getChainIcon(serviceName) {
      const lower = String(serviceName || '').toLowerCase();
      for (const [key, icon] of Object.entries(CHAIN_ICONS)) {
        if (lower.includes(key)) return icon;
      }
      return 'üîó';
    }

    function getChainDisplayName(serviceName) {
      if (!serviceName && serviceName !== 0) return 'Unknown';
      const str = String(serviceName);
      return str.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
    }

    function formatArkeo(uarkeo, decimals = 2) {
      if (typeof Format !== 'undefined') return Format.arkeo(uarkeo, decimals);
      const val = parseInt(uarkeo || 0) / CONFIG.ARKEO_DIVISOR;
      if (val >= 1000000) return (val / 1000000).toFixed(1) + 'M';
      if (val >= 1000) return (val / 1000).toFixed(1) + 'K';
      // Use enough decimals to show small values (e.g. rate 25000 uarkeo = 0.00025)
      if (val > 0 && val < 0.01) {
        // Show up to 6 significant decimals for small values
        const s = val.toFixed(6).replace(/0+$/, '').replace(/\.$/, '');
        return s;
      }
      return val.toFixed(decimals);
    }

    function getRepClass(score) {
      if (score >= 80) return 'rep-gold';
      if (score >= 60) return 'rep-silver';
      if (score >= 40) return 'rep-bronze';
      return 'rep-none';
    }
    function getRepBadge(score) {
      if (score >= 80) return 'üèÜ';
      if (score >= 60) return 'ü•à';
      if (score >= 40) return 'ü•â';
      return '';
    }

    function copyPubkey(text) {
      navigator.clipboard.writeText(text).then(() => {
        const el = document.getElementById('copyBtn');
        if (el) { el.textContent = '‚úì Copied!'; setTimeout(() => el.textContent = 'üìã Copy', 1500); }
      });
    }

    // Main loader
    async function loadProvider() {
      const params = new URLSearchParams(window.location.search);
      const pubkey = params.get('pubkey');
      if (!pubkey) { showError('No pubkey in URL'); return; }

      try {
        const [providers, contracts, servicesList] = await Promise.all([
          API.getProviders(),
          API.getContracts().catch(() => []),
          API.getServices().catch(() => []),
        ]);

        // Build service ID ‚Üí name map
        const serviceMap = {};
        servicesList.forEach(s => { serviceMap[s.service_id] = s.name || s.description || ('Service ' + s.service_id); });

        // Find all entries for this provider
        const providerEntries = providers.filter(p => p.pub_key === pubkey);
        if (providerEntries.length === 0) { showError('Provider not found in ' + providers.length + ' providers. Pubkey: ' + pubkey.slice(0,20) + '...'); return; }

        // Aggregate info
        const info = {
          pubkey,
          name: null, description: null, website: null, location: null,
          services: [], totalBond: 0, status: 'OFFLINE', metadataUri: null,
        };

        providerEntries.forEach(p => {
          info.totalBond += parseInt(p.bond || 0);
          if (p.status === 'ONLINE') info.status = 'ONLINE';
          info.metadataUri = info.metadataUri || p.metadata_uri;
          const svcId = p.service;
          const svcName = serviceMap[svcId] || ('Service ' + svcId);
          info.services.push({
            id: svcId,
            name: svcName,
            displayName: getChainDisplayName(svcName),
            icon: getChainIcon(svcName),
            bond: parseInt(p.bond || 0),
            rate: p.pay_as_you_go_rate?.[0]?.amount || '0',
            rateDenom: p.pay_as_you_go_rate?.[0]?.denom || 'uarkeo',
            status: p.status,
          });
        });

        // Apply known metadata
        const meta = findKnown(pubkey);
        if (meta) {
          info.name = meta.name;
          info.description = meta.description;
          info.website = meta.website;
          info.location = meta.location;
          info.x402Url = meta.x402Url || null;
        }

        // Try fetching metadata_uri
        if (info.metadataUri) {
          // Upgrade HTTP to HTTPS for known providers with SSL
          info.metadataUri = info.metadataUri.replace('http://161.35.97.215:3636', 'https://red5-arkeo.duckdns.org');
        }
        if (info.metadataUri && !info.metadataUri.includes('127.0.0.1') && !info.metadataUri.includes('localhost')) {
          try {
            // Route through proxy to avoid mixed-content blocks (HTTPS page, HTTP sentinels)
            const proxyUrl = `/health-check?url=${encodeURIComponent(info.metadataUri)}`;
            const resp = await fetch(proxyUrl, { signal: AbortSignal.timeout(8000) });
            if (resp.ok) {
              const result = await resp.json();
              const md = result?.data;
              if (md) {
                const moniker = md.config?.moniker || md.moniker;
                if (moniker) {
                  info.name = info.name || moniker;
                  info.description = info.description || md.config?.description || md.description || '';
                  info.website = info.website || md.config?.website || md.website || '';
                  info.location = info.location || md.config?.location || md.location || '';
                }
              }
            }
          } catch (e) { /* ignore */ }
        }

        if (!info.name) info.name = 'Provider ' + pubkey.slice(-8);

        // Process contracts for this provider
        // Get current block height for expiry checks
        let currentHeight = 0;
        try {
          const statusResp = await fetch(CONFIG.RPC_API + '/status');
          const statusData = await statusResp.json();
          currentHeight = parseInt(statusData.result?.sync_info?.latest_block_height || 0);
        } catch (e) { console.warn('Could not fetch block height'); }

        const provContracts = contracts.filter(c => c.provider === pubkey);
        let totalPaid = 0, totalNonce = 0, activeContracts = 0;
        provContracts.forEach(c => {
          totalPaid += parseInt(c.paid || 0);
          totalNonce += parseInt(c.nonce || 0);
          const deposit = parseInt(c.deposit || 0);
          const paid = parseInt(c.paid || 0);
          const height = parseInt(c.height || 0);
          const duration = parseInt(c.duration || 0);
          const expiry = height + duration;
          const notExpired = currentHeight === 0 || expiry > currentHeight;
          if (deposit > paid && notExpired) activeContracts++;
        });

        // Calculate reputation (relative to all providers)
        const allProviderInfos = {};
        providers.forEach(p => {
          const pk = p.pub_key;
          if (!pk) return;
          if (!allProviderInfos[pk]) allProviderInfos[pk] = { totalBond: 0, serviceCount: 0 };
          allProviderInfos[pk].totalBond += parseInt(p.bond || 0);
          allProviderInfos[pk].serviceCount++;
        });
        const allMetrics = {};
        Object.keys(allProviderInfos).forEach(pk => {
          allMetrics[pk] = { totalNonce: 0, totalPaid: 0, bond: allProviderInfos[pk].totalBond, activeContracts: 0, serviceCount: allProviderInfos[pk].serviceCount };
        });
        contracts.forEach(c => {
          const pk = c.provider;
          if (!allMetrics[pk]) return;
          allMetrics[pk].totalNonce += parseInt(c.nonce || 0);
          allMetrics[pk].totalPaid += parseInt(c.paid || 0);
          const dep = parseInt(c.deposit || 0), pd = parseInt(c.paid || 0);
          if (dep > pd) allMetrics[pk].activeContracts++;
        });
        const maxN = Math.max(1, ...Object.values(allMetrics).map(m => m.totalNonce));
        const maxP = Math.max(1, ...Object.values(allMetrics).map(m => m.totalPaid));
        const maxB = Math.max(1, ...Object.values(allMetrics).map(m => m.bond));
        const maxC = Math.max(1, ...Object.values(allMetrics).map(m => m.activeContracts));
        const maxS = Math.max(1, ...Object.values(allMetrics).map(m => m.serviceCount));

        const m = allMetrics[pubkey] || { totalNonce: 0, totalPaid: 0, bond: 0, activeContracts: 0, serviceCount: 0 };
        const repBreakdown = {
          requests: Math.round((m.totalNonce / maxN) * 100),
          revenue: Math.round((m.totalPaid / maxP) * 100),
          bond: Math.round((m.bond / maxB) * 100),
          contracts: Math.round((m.activeContracts / maxC) * 100),
          services: Math.round((m.serviceCount / maxS) * 100),
        };
        const repTotal = Math.round(
          repBreakdown.requests * 0.35 + repBreakdown.revenue * 0.25 +
          repBreakdown.bond * 0.20 + repBreakdown.contracts * 0.10 + repBreakdown.services * 0.10
        );

        // Render
        renderProvider(info, provContracts, { totalPaid, totalNonce, activeContracts, total: provContracts.length }, repTotal, repBreakdown, currentHeight);

      } catch (err) {
        console.error('Provider load error:', err);
        showError(err.message || String(err));
      }
    }

    function showError(detail) {
      document.getElementById('loading').style.display = 'none';
      const errorEl = document.getElementById('error');
      if (detail) {
        errorEl.querySelector('p').textContent = 'Error loading provider: ' + detail;
      }
      errorEl.style.display = 'block';
    }

    function renderProvider(info, contracts, contractStats, repTotal, repBreakdown, currentHeight) {
      document.getElementById('loading').style.display = 'none';
      const content = document.getElementById('content');
      content.style.display = 'block';
      document.title = `${info.name} ‚Äî Arkeo Marketplace`;

      const isOnline = info.status === 'ONLINE';
      const repClass = getRepClass(repTotal);
      const repBadge = getRepBadge(repTotal);
      const pubkeyShort = info.pubkey.slice(0, 14) + '...' + info.pubkey.slice(-6);

      // Sort contracts by ID desc
      const sortedContracts = [...contracts].sort((a, b) => parseInt(b.id || 0) - parseInt(a.id || 0));
      const recentContracts = sortedContracts.slice(0, 20);

      const barColor = repTotal >= 80 ? 'linear-gradient(90deg, #f59e0b, #fbbf24)' :
                        repTotal >= 60 ? 'linear-gradient(90deg, #94a3b8, #cbd5e1)' :
                        repTotal >= 40 ? 'linear-gradient(90deg, #b45309, #d97706)' : 'var(--text-muted)';

      content.innerHTML = `
        <!-- Provider Header -->
        <div class="provider-hero">
          <div class="provider-hero-top">
            <div class="provider-hero-info">
              <h1 class="provider-hero-name">${escapeHtml(info.name)}</h1>
              <div class="provider-hero-pubkey" onclick="copyPubkey('${escapeHtml(info.pubkey)}')" title="Click to copy full pubkey">
                <span>${pubkeyShort}</span>
                <span id="copyBtn" style="font-size:0.8rem;">üìã Copy</span>
              </div>
              <div style="margin-bottom:0.5rem;">
                <span class="badge ${isOnline ? 'badge-online' : 'badge-offline'}">${isOnline ? '‚óè Online' : '‚óã Offline'}</span>
              </div>
              <div class="provider-hero-meta">
                ${info.location ? `<span>üìç ${escapeHtml(info.location)}</span>` : ''}
                ${info.website ? `<a href="${escapeHtml(info.website)}" target="_blank" rel="noopener">üåê ${escapeHtml(info.website)}</a>` : ''}
              </div>
              ${info.description ? `<p class="provider-hero-desc">${escapeHtml(info.description)}</p>` : ''}
            </div>
            <div class="rep-hero">
              <div class="rep-hero-score ${repClass}">${repBadge} ${repTotal}</div>
              <div class="rep-hero-label">Reputation Score</div>
            </div>
          </div>
        </div>

        <!-- x402 Payment Section -->
        ${info.x402Url ? `
        <div class="section-card" style="border:1px solid rgba(99,102,241,0.3);background:rgba(99,102,241,0.05);">
          <h3 style="color:#818cf8;">‚ö° x402 Payments Supported</h3>
          <p style="color:var(--text-dim);margin-bottom:1rem;">This provider accepts HTTP-native micropayments via the <a href="https://x402.org" target="_blank" rel="noopener" style="color:#818cf8;">x402 standard</a>. Pay per request in USDC on Base ‚Äî no account, no KYC, no ARKEO required.</p>
          <div style="display:flex;align-items:center;gap:0.75rem;flex-wrap:wrap;">
            <div style="flex:1;min-width:0;background:var(--bg-input,#0d1117);border:1px solid var(--border);border-radius:0.5rem;padding:0.6rem 1rem;font-family:monospace;font-size:0.85rem;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(info.x402Url)}</div>
            <button onclick="navigator.clipboard.writeText('${escapeHtml(info.x402Url)}').then(()=>{this.textContent='Copied!';setTimeout(()=>this.textContent='Copy',1500)})" class="btn btn-secondary btn-sm" style="white-space:nowrap;">Copy</button>
            <a href="${escapeHtml(info.x402Url)}" target="_blank" rel="noopener" class="btn btn-sm" style="background:rgba(99,102,241,0.15);color:#818cf8;border:1px solid rgba(99,102,241,0.3);white-space:nowrap;">Test Endpoint ‚Üó</a>
          </div>
          <p style="color:var(--text-dim);font-size:0.8rem;margin-top:0.75rem;">Price: <strong style="color:var(--text);">$0.0001 USDC</strong> per request &nbsp;¬∑&nbsp; Network: <strong style="color:var(--text);">Base (eip155:8453)</strong> &nbsp;¬∑&nbsp; <a href="x402-setup.html" style="color:#818cf8;">Set up x402 on your node ‚Üí</a></p>
        </div>
        ` : ''}

        <!-- Services Offered -->
        <div class="section-card">
          <h3>üîó Services Offered (${info.services.length})</h3>
          <div style="overflow-x:auto; border-radius:0.75rem; border:1px solid var(--border);">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Chain</th>
                  <th>Service ID</th>
                  <th>Rate (per request)</th>
                  <th>Bond</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                ${info.services.map(s => `
                  <tr>
                    <td><span class="chain-icon">${s.icon}</span> ${escapeHtml(s.displayName)}</td>
                    <td style="color:var(--text-dim); font-size:0.8rem;">${escapeHtml(s.name)}</td>
                    <td style="color:var(--arkeo); font-weight:600;">${parseInt(s.rate).toLocaleString()} uarkeo <span style="color:var(--text-dim); font-size:0.8rem;">(${formatArkeo(s.rate)} ARKEO)</span></td>
                    <td>${formatArkeo(s.bond)} ARKEO</td>
                    <td><span class="badge ${s.status === 'ONLINE' ? 'badge-online' : 'badge-offline'}">${s.status === 'ONLINE' ? '‚óè Online' : '‚óã Offline'}</span></td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Contract History -->
        <div class="section-card">
          <h3>üìú Contract History</h3>
          <div class="stats-grid">
            <div class="stat-box">
              <div class="stat-box-value">${contractStats.total}</div>
              <div class="stat-box-label">Total Contracts</div>
            </div>
            <div class="stat-box">
              <div class="stat-box-value" style="color:var(--success);">${contractStats.activeContracts}</div>
              <div class="stat-box-label">Active Contracts</div>
            </div>
            <div class="stat-box">
              <div class="stat-box-value">${formatArkeo(contractStats.totalPaid)}</div>
              <div class="stat-box-label">ARKEO Earned</div>
            </div>
            <div class="stat-box">
              <div class="stat-box-value">${contractStats.totalNonce.toLocaleString()}</div>
              <div class="stat-box-label">Requests Served</div>
            </div>
          </div>
          ${recentContracts.length > 0 ? `
          <div style="overflow-x:auto; border-radius:0.75rem; border:1px solid var(--border);">
            <table class="data-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Service</th>
                  <th>Deposit</th>
                  <th>Paid</th>
                  <th>Nonce</th>
                  <th>Status</th>
                  <th>Duration</th>
                </tr>
              </thead>
              <tbody>
                ${recentContracts.map(c => {
                  const deposit = parseInt(c.deposit || 0);
                  const paid = parseInt(c.paid || 0);
                  const height = parseInt(c.height || 0);
                  const duration = parseInt(c.duration || 0);
                  const expiry = height + duration;
                  const notExpired = currentHeight === 0 || expiry > currentHeight;
                  const isActive = deposit > paid && notExpired;
                  const durationBlocks = duration;
                  const durationSecs = durationBlocks * 4; // ~4s per block
                  const durationStr = durationSecs > 0 ? (durationSecs >= 86400 ? Math.floor(durationSecs/86400) + 'd' : durationSecs >= 3600 ? Math.floor(durationSecs/3600) + 'h' : durationSecs + 's') : '‚Äî';
                  return `<tr>
                    <td style="font-weight:600;">#${c.id || '?'}</td>
                    <td><span class="chain-icon">${getChainIcon(c.service)}</span> ${getChainDisplayName(c.service)}</td>
                    <td>${formatArkeo(deposit)}</td>
                    <td style="color:var(--success); font-weight:600;">${formatArkeo(paid)}</td>
                    <td>${parseInt(c.nonce || 0).toLocaleString()}</td>
                    <td><span class="badge ${isActive ? 'badge-online' : 'badge-offline'}">${isActive ? 'Active' : 'Expired'}</span></td>
                    <td>${durationStr}</td>
                  </tr>`;
                }).join('')}
              </tbody>
            </table>
          </div>
          ` : '<p style="color:var(--text-dim); text-align:center; padding:1rem;">No contracts found for this provider.</p>'}
        </div>

        <!-- Reputation Breakdown -->
        <div class="section-card">
          <h3>‚≠ê Reputation Breakdown</h3>
          <div style="text-align:center; margin-bottom:1.5rem;">
            <div style="font-size:3.5rem; font-weight:800;" class="${repClass}">${repBadge} ${repTotal}<span style="font-size:1.5rem; color:var(--text-dim);">/100</span></div>
          </div>
          <div class="rep-breakdown">
            ${[
              { label: 'Requests Served', value: repBreakdown.requests, weight: '35%' },
              { label: 'Revenue Earned', value: repBreakdown.revenue, weight: '25%' },
              { label: 'Bond Committed', value: repBreakdown.bond, weight: '20%' },
              { label: 'Active Contracts', value: repBreakdown.contracts, weight: '10%' },
              { label: 'Service Breadth', value: repBreakdown.services, weight: '10%' },
            ].map(r => `
              <div class="rep-row">
                <div class="rep-row-label">${r.label} <span style="color:var(--text-muted); font-size:0.75rem;">(${r.weight})</span></div>
                <div class="rep-row-bar"><div class="rep-row-fill" style="width:${r.value}%; background:${barColor};"></div></div>
                <div class="rep-row-value">${r.value}/100</div>
              </div>
            `).join('')}
          </div>
        </div>

        <!-- Bond Information -->
        <div class="section-card">
          <h3>üîí Bond Information</h3>
          <div class="stats-grid" style="margin-bottom:1.5rem;">
            <div class="stat-box">
              <div class="stat-box-value">${formatArkeo(info.totalBond)}</div>
              <div class="stat-box-label">Total ARKEO Bonded</div>
            </div>
          </div>
          <div style="overflow-x:auto; border-radius:0.75rem; border:1px solid var(--border);">
            <table class="data-table">
              <thead><tr><th>Service</th><th>Bond</th><th>% of Total</th></tr></thead>
              <tbody>
                ${info.services.map(s => {
                  const pct = info.totalBond > 0 ? ((s.bond / info.totalBond) * 100).toFixed(1) : '0.0';
                  return `<tr>
                    <td><span class="chain-icon">${s.icon}</span> ${escapeHtml(s.displayName)}</td>
                    <td style="font-weight:600;">${formatArkeo(s.bond)} ARKEO</td>
                    <td>
                      <div style="display:flex; align-items:center; gap:0.5rem;">
                        <div style="width:80px; height:6px; background:var(--bg-input); border-radius:3px; overflow:hidden;">
                          <div style="width:${pct}%; height:100%; background:var(--arkeo); border-radius:3px;"></div>
                        </div>
                        <span style="font-size:0.85rem; color:var(--text-dim);">${pct}%</span>
                      </div>
                    </td>
                  </tr>`;
                }).join('')}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-bar">
          <a href="subscribe.html?provider=${encodeURIComponent(info.pubkey)}" class="btn btn-primary" style="font-size:1rem; padding:0.875rem 2rem;">üîó Subscribe to this Provider</a>
          <a href="index.html" class="btn btn-secondary" style="font-size:1rem; padding:0.875rem 2rem;">‚Üê Back to Marketplace</a>
        </div>
      `;
    }

    document.addEventListener('DOMContentLoaded', loadProvider);
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Become a Provider | Arkeo Marketplace v2</title>
  <link rel="icon" type="image/png" href="images/arkeo-logo-200px_1.png">
  <!-- Arkeo transaction helper with protobuf encoding -->
  <script src="js/arkeo-tx.js"></script>
  <style>
    :root {
      --bg-main: #0C0E14;
      --bg-card: #151820;
      --bg-input: #1a1f2e;
      --border: #2a2f3c;
      --border-focus: #3BE0FF;
      --arkeo: #3BE0FF;
      --arkeo-dim: rgba(59, 224, 255, 0.1);
      --success: #10b981;
      --success-dim: rgba(16, 185, 129, 0.1);
      --warning: #f59e0b;
      --error: #ef4444;
      --text: #ffffff;
      --text-dim: #9ca3af;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      background: var(--bg-main);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      min-height: 100vh;
      line-height: 1.6;
    }
    
    /* Navigation */
    .nav {
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 1.25rem;
      font-weight: 700;
      text-decoration: none;
      color: var(--text);
    }
    .logo img { height: 36px; }
    .logo span { color: var(--arkeo); }
    
    .wallet-btn {
      background: var(--arkeo);
      color: #000;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.2s;
    }
    .wallet-btn:hover { opacity: 0.9; }
    .wallet-btn.connected {
      background: var(--success);
      color: white;
    }
    .wallet-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* Main Container */
    .container {
      max-width: 700px;
      margin: 0 auto;
      padding: 2rem;
    }
    
    /* Progress Bar */
    .progress-container { margin-bottom: 2rem; }
    .progress-steps {
      display: flex;
      justify-content: space-between;
      position: relative;
      margin-bottom: 0.5rem;
    }
    .progress-steps::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--border);
      transform: translateY(-50%);
      z-index: 0;
    }
    .progress-line {
      position: absolute;
      top: 50%;
      left: 0;
      height: 2px;
      background: var(--arkeo);
      transform: translateY(-50%);
      z-index: 1;
      transition: width 0.3s ease;
    }
    .step-dot {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--bg-card);
      border: 2px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.875rem;
      font-weight: 600;
      position: relative;
      z-index: 2;
      transition: all 0.3s;
    }
    .step-dot.active {
      border-color: var(--arkeo);
      background: var(--arkeo-dim);
      color: var(--arkeo);
    }
    .step-dot.complete {
      border-color: var(--success);
      background: var(--success);
      color: white;
    }
    .step-labels {
      display: flex;
      justify-content: space-between;
    }
    .step-label {
      font-size: 0.75rem;
      color: var(--text-dim);
      text-align: center;
      width: 80px;
    }
    .step-label.active { color: var(--arkeo); }
    
    /* Wizard Card */
    .wizard-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 1rem;
      padding: 2rem;
    }
    .wizard-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    .wizard-subtitle {
      color: var(--text-dim);
      margin-bottom: 1.5rem;
    }
    .hidden { display: none !important; }
    
    /* Chain Selection */
    .chain-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 0.75rem;
      margin-bottom: 1.5rem;
      max-height: 350px;
      overflow-y: auto;
    }
    .chain-option {
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 0.75rem;
      padding: 1rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    .chain-option:hover {
      border-color: var(--arkeo);
      background: var(--arkeo-dim);
    }
    .chain-option.selected {
      border-color: var(--arkeo);
      background: var(--arkeo-dim);
    }
    .chain-option img {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      margin-bottom: 0.5rem;
    }
    .chain-name {
      font-size: 0.875rem;
      font-weight: 500;
    }
    .chain-id {
      font-size: 0.7rem;
      color: var(--text-dim);
    }
    .chain-demand {
      font-size: 0.7rem;
      margin-top: 0.35rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.25rem;
    }
    .demand-text { opacity: 0.85; }
    .demand-high { color: #f97316; }
    .demand-growing { color: var(--arkeo); }
    .demand-some { color: var(--text-dim); }
    .demand-none { color: #4b5563; }
    
    /* Search */
    .search-box {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      background: var(--bg-input);
      color: var(--text);
      margin-bottom: 1rem;
    }
    .search-box:focus {
      outline: none;
      border-color: var(--arkeo);
    }
    
    /* Form Elements */
    .form-group { margin-bottom: 1.5rem; }
    .form-label {
      display: block;
      font-weight: 500;
      margin-bottom: 0.5rem;
    }
    .form-input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      background: var(--bg-input);
      color: var(--text);
      font-size: 1rem;
    }
    .form-input:focus {
      outline: none;
      border-color: var(--arkeo);
    }
    .form-hint {
      font-size: 0.8rem;
      color: var(--text-dim);
      margin-top: 0.25rem;
    }
    
    /* Buttons */
    .btn {
      padding: 0.875rem 1.5rem;
      border-radius: 0.5rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      font-size: 1rem;
    }
    .btn-primary {
      background: var(--arkeo);
      color: #000;
    }
    .btn-primary:hover { opacity: 0.9; }
    .btn-primary:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    .btn-secondary {
      background: var(--bg-input);
      color: var(--text);
      border: 1px solid var(--border);
    }
    .btn-secondary:hover {
      border-color: var(--arkeo);
    }
    .btn-group {
      display: flex;
      gap: 1rem;
      margin-top: 1.5rem;
    }
    
    /* Status Box */
    .status-box {
      padding: 1rem;
      border-radius: 0.5rem;
      margin: 1rem 0;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .status-box.success {
      background: var(--success-dim);
      border: 1px solid var(--success);
      color: var(--success);
    }
    .status-box.error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid var(--error);
      color: var(--error);
    }
    .status-box.testing {
      background: var(--arkeo-dim);
      border: 1px solid var(--arkeo);
      color: var(--arkeo);
    }
    .status-box.warning {
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid var(--warning);
      color: var(--warning);
    }
    
    /* Spinner */
    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid transparent;
      border-top-color: currentColor;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* Summary Card */
    .summary-card {
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 0.75rem;
      padding: 1.5rem;
      margin: 1rem 0;
    }
    .summary-row {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--border);
    }
    .summary-row:last-child { border-bottom: none; }
    .summary-label { color: var(--text-dim); }
    .summary-value { font-weight: 600; }
    
    /* TX Link */
    .tx-link {
      color: var(--arkeo);
      text-decoration: none;
      word-break: break-all;
    }
    .tx-link:hover { text-decoration: underline; }
    
    /* Success */
    .success-container { text-align: center; padding: 2rem 0; }
    .success-icon { font-size: 4rem; margin-bottom: 1rem; }
    .success-title { font-size: 1.75rem; margin-bottom: 0.5rem; }
    .success-subtitle { color: var(--text-dim); margin-bottom: 2rem; }
    
    /* Alerts */
    .alert {
      padding: 1rem;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
    }
    .alert-info {
      background: var(--arkeo-dim);
      border: 1px solid var(--arkeo);
      color: var(--arkeo);
    }
    .alert-warning {
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid var(--warning);
      color: var(--warning);
    }
    
    /* Duration Preset Buttons */
    .duration-preset {
      padding: 0.5rem 1rem;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      color: var(--text-dim);
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    .duration-preset:hover {
      border-color: var(--arkeo);
      color: var(--text);
    }
    .duration-preset.active {
      background: var(--arkeo-dim);
      border-color: var(--arkeo);
      color: var(--arkeo);
      font-weight: 600;
    }
    
    /* Mobile */
    @media (max-width: 600px) {
      .nav { padding: 0.75rem 1rem; flex-wrap: wrap; gap: 0.5rem; }
      .logo { font-size: 1rem; }
      .logo img { height: 28px; }
      .container { padding: 1rem; }
      .wizard-card { padding: 1.25rem; }
      .wizard-title { font-size: 1.25rem; }
      .chain-grid { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); }
      .btn-group { flex-direction: column; }
      .summary-row { flex-direction: column; gap: 0.25rem; }
      .form-input { font-size: 0.9rem; }
    }

    /* Loading overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .loading-text {
      margin-top: 1rem;
      font-size: 1.25rem;
    }
    .loading-subtext {
      margin-top: 0.5rem;
      color: var(--text-dim);
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="nav">
    <a href="index.html" class="logo">
      <img src="images/arkeo-logo-200px_1.png" alt="Arkeo">
      <span>Arkeo</span> Marketplace
    </a>
    <div style="display: flex; align-items: center; gap: 1rem;">
      <button id="walletBtn" class="wallet-btn" onclick="connectWallet()" style="cursor: pointer;">
        üîó Connect Wallet
      </button>
      <a href="index.html" style="text-decoration: none; color: var(--text-dim); font-size: 0.85rem;">
        ‚Üê Marketplace
      </a>
    </div>
  </nav>

  <div class="container">
    <!-- Start Over Link -->
    <div style="text-align: right; margin-bottom: 0.5rem;">
      <a href="#" onclick="event.preventDefault(); if(confirm('Clear all progress and start over?')) { clearState(); location.reload(); }" style="font-size: 0.85rem; color: var(--text-dim); text-decoration: none;">
        üîÑ Start Over
      </a>
    </div>
    
    <!-- Progress Bar -->
    <div class="progress-container">
      <div class="progress-steps">
        <div class="progress-line" id="progressLine" style="width: 0%"></div>
        <div class="step-dot active" id="dot1">1</div>
        <div class="step-dot" id="dot2">2</div>
        <div class="step-dot" id="dot3">3</div>
        <div class="step-dot" id="dot4">4</div>
      </div>
      <div class="step-labels">
        <span class="step-label active" id="label1">Select Chain</span>
        <span class="step-label" id="label2">RPC Endpoint</span>
        <span class="step-label" id="label3">Set Rate</span>
        <span class="step-label" id="label4">Register</span>
      </div>
    </div>

    <!-- Step 1: Select Chain -->
    <div class="wizard-card" id="step1">
      <h2 class="wizard-title">Select Your Chain</h2>
      <p class="wizard-subtitle">Choose which blockchain data you want to provide.</p>
      
      <input type="text" class="search-box" id="chainSearch" 
             placeholder="Search chains..." oninput="filterChains()">
      
      <div id="loadingChains" class="status-box testing">
        <div class="spinner"></div>
        <span>Loading available chains from Arkeo network...</span>
      </div>
      
      <div class="chain-grid" id="chainGrid"></div>
      
      <div class="btn-group">
        <a href="index.html" class="btn btn-secondary">Cancel</a>
        <button class="btn btn-primary" id="nextBtn1" disabled onclick="goToStep(2)">
          Continue ‚Üí
        </button>
      </div>
      <p style="text-align: center; margin-top: 1rem; font-size: 0.9rem; color: var(--text-muted);">
        Already registered as a provider? <a href="#" onclick="goToStep(6); return false;" style="color: var(--accent);">Skip to Sentinel Setup ‚Üí</a>
      </p>
    </div>

    <!-- Step 2: Infrastructure Setup -->
    <div class="wizard-card hidden" id="step2">
      <h2 class="wizard-title">Infrastructure Setup</h2>
      <p class="wizard-subtitle">Configure your <span id="selectedChainName">blockchain</span> node and sentinel.</p>

      <!-- Arkeo Network Connection -->
      <div style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.5rem;">
        <h3 style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
          üåê Arkeo Network Connection
        </h3>
        <p style="color: var(--text-dim); font-size: 0.9rem; margin-bottom: 1rem;">
          Your sentinel needs access to the Arkeo blockchain to verify subscriber contracts and process payments. Choose how to connect:
        </p>
        
        <div style="display: flex; flex-direction: column; gap: 0.75rem; margin-bottom: 1rem;">
          <!-- Option A: Own node (promoted) -->
          <label style="display: flex; align-items: flex-start; gap: 0.75rem; padding: 1rem; background: var(--bg-card); border: 2px solid var(--arkeo); border-radius: 0.5rem; cursor: pointer;" id="arkeoOptionA">
            <input type="radio" name="arkeoConnection" value="custom" 
                   onchange="updateArkeoConnection()" style="margin-top: 0.25rem; accent-color: var(--arkeo);">
            <div>
              <div style="font-weight: 600; color: var(--text);">Use your own Arkeo node <span style="font-size: 0.75rem; background: var(--arkeo); color: #000; padding: 0.15rem 0.5rem; border-radius: 0.25rem; margin-left: 0.5rem;">Best for Decentralization</span></div>
              <div style="font-size: 0.85rem; color: var(--text-dim); margin-top: 0.25rem;">Run your own Arkeo node for maximum independence. No reliance on third-party infrastructure. <strong>Recommended for serious providers.</strong></div>
            </div>
          </label>
          
          <!-- Option B: Community endpoint -->
          <label style="display: flex; align-items: flex-start; gap: 0.75rem; padding: 1rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 0.5rem; cursor: pointer;" id="arkeoOptionB">
            <input type="radio" name="arkeoConnection" value="public" checked
                   onchange="updateArkeoConnection()" style="margin-top: 0.25rem; accent-color: var(--arkeo);">
            <div>
              <div style="font-weight: 600; color: var(--text);">Use a community endpoint</div>
              <div style="font-size: 0.85rem; color: var(--text-dim); margin-top: 0.25rem;">Connect to a free public Arkeo node run by community validators. Quick start, but you depend on their uptime. Automatic failover if your selected endpoint goes down.</div>
            </div>
          </label>
        </div>
        
        <!-- Custom URL input (hidden by default) -->
        <div id="arkeoCustomUrl" class="hidden">
          <div class="form-group" style="margin-bottom: 0;">
            <label class="form-label">Your Arkeo Node REST API URL</label>
            <input type="url" class="form-input" id="arkeoNodeUrl" 
                   placeholder="https://your-arkeo-node:1317" oninput="validateArkeoUrl()">
            <p class="form-hint">REST API endpoint of your Arkeo node (typically port 1317). A pruned node works fine.</p>
          </div>
          <div id="arkeoUrlStatus"></div>
        </div>
        
        <!-- Public endpoint selector (shown by default) -->
        <div id="arkeoPublicSelect">
          <div class="form-group" style="margin-bottom: 0;">
            <label class="form-label">Select Primary Endpoint</label>
            <div id="arkeoEndpointList" style="display: flex; flex-direction: column; gap: 0.5rem;">
              <!-- Populated by JS on load -->
              <div style="color: var(--text-dim); font-size: 0.85rem; padding: 0.5rem;">
                <div class="spinner" style="display: inline-block; width: 14px; height: 14px; border-width: 2px; vertical-align: middle; margin-right: 0.5rem;"></div>
                Checking available endpoints...
              </div>
            </div>
            <p class="form-hint" style="margin-top: 0.75rem;">
              üîÑ <strong>Automatic failover:</strong> If your selected endpoint goes down, your sentinel config will include all healthy endpoints as fallbacks.
            </p>
          </div>
        </div>
        
        <div id="arkeoConnectionStatus" class="status-box" style="margin-top: 0.75rem; background: var(--arkeo-dim); border: 1px solid var(--arkeo); border-radius: 0.5rem; padding: 0.75rem; font-size: 0.85rem;">
          ‚è≥ Checking community endpoints...
        </div>
        
        <!-- Decentralization callout -->
        <div style="margin-top: 1rem; padding: 0.75rem 1rem; background: rgba(245, 158, 11, 0.1); border: 1px solid var(--warning); border-radius: 0.5rem; font-size: 0.85rem;">
          ‚ö†Ô∏è <strong>Why this matters:</strong> Arkeo currently has very few public endpoints. If they go down, your sentinel can't verify contracts. Running your own Arkeo node (even pruned) makes you fully independent and strengthens the entire network.
        </div>
      </div>
      
      <!-- Node RPC -->
      <div class="form-group">
        <label class="form-label">Your Node's RPC URL (internal)</label>
        <input type="url" class="form-input" id="rpcUrl" 
               placeholder="http://localhost:26657" oninput="validateRpcUrl()">
        <p class="form-hint" id="rpcHint">This is your node's RPC endpoint ‚Äî where the sentinel sends requests to get blockchain data.</p>
        
        <!-- Expandable help -->
        <details style="margin-top: 0.5rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 0.5rem; padding: 0.75rem;">
          <summary style="cursor: pointer; color: var(--arkeo); font-size: 0.85rem; font-weight: 600;">
            ü§î How do I find my RPC URL?
          </summary>
          <div style="margin-top: 0.75rem; color: var(--text-dim); font-size: 0.85rem; line-height: 1.8;">
            <p style="margin-bottom: 0.5rem;">Your RPC URL depends on where your node runs relative to the sentinel:</p>
            <table style="width: 100%; border-collapse: collapse; font-size: 0.8rem; margin-bottom: 0.75rem;">
              <tr style="border-bottom: 1px solid var(--border);">
                <td style="padding: 0.4rem; font-weight: 600; color: var(--text);">Same server</td>
                <td style="padding: 0.4rem; font-family: monospace;">http://localhost:PORT</td>
                <td style="padding: 0.4rem;">Most common setup</td>
              </tr>
              <tr style="border-bottom: 1px solid var(--border);">
                <td style="padding: 0.4rem; font-weight: 600; color: var(--text);">Different server</td>
                <td style="padding: 0.4rem; font-family: monospace;">http://INTERNAL_IP:PORT</td>
                <td style="padding: 0.4rem;">Use your node's internal/private IP</td>
              </tr>
              <tr>
                <td style="padding: 0.4rem; font-weight: 600; color: var(--text);">Docker</td>
                <td style="padding: 0.4rem; font-family: monospace;">http://host.docker.internal:PORT</td>
                <td style="padding: 0.4rem;">If sentinel runs in Docker</td>
              </tr>
            </table>
            <p style="margin-bottom: 0.5rem;"><strong>Common default ports by chain:</strong></p>
            <div style="display: flex; flex-wrap: wrap; gap: 0.4rem;">
              <span style="background: var(--bg-input); padding: 0.2rem 0.5rem; border-radius: 0.25rem; font-family: monospace; font-size: 0.75rem;">Cosmos/Arkeo: 26657</span>
              <span style="background: var(--bg-input); padding: 0.2rem 0.5rem; border-radius: 0.25rem; font-family: monospace; font-size: 0.75rem;">Ethereum: 8545</span>
              <span style="background: var(--bg-input); padding: 0.2rem 0.5rem; border-radius: 0.25rem; font-family: monospace; font-size: 0.75rem;">Bitcoin: 8332</span>
              <span style="background: var(--bg-input); padding: 0.2rem 0.5rem; border-radius: 0.25rem; font-family: monospace; font-size: 0.75rem;">Solana: 8899</span>
            </div>
            <p style="margin-top: 0.75rem;">
              üìÇ <strong>Check your node's config:</strong> For Cosmos chains, look in <code style="background: var(--bg-input); padding: 0.1rem 0.3rem; border-radius: 0.2rem;">config.toml</code> under <code style="background: var(--bg-input); padding: 0.1rem 0.3rem; border-radius: 0.2rem;">[rpc] ‚Üí laddr</code>
            </p>
          </div>
        </details>
      </div>
      
      <div id="rpcStatus"></div>
      
      <!-- Sentinel info (setup happens after registration in Step 6) -->
      <div style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1.25rem; margin: 1.5rem 0;">
        <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
          <span style="font-size: 1.5rem;">üõ°Ô∏è</span>
          <div>
            <div style="font-weight: 600; margin-bottom: 0.25rem;">What about the Sentinel?</div>
            <p style="color: var(--text-dim); font-size: 0.9rem; margin: 0;">
              The sentinel is a lightweight proxy that handles authentication and payments. You'll set it up <strong>after registration</strong> ‚Äî we'll generate a ready-to-use config and walk you through the install in a later step.
            </p>
          </div>
        </div>
      </div>
      
      <div class="btn-group">
        <button class="btn btn-secondary" onclick="goToStep(1)">‚Üê Back</button>
        <button class="btn btn-primary" id="nextBtn2" disabled onclick="testEndpoints()">
          Continue ‚Üí
        </button>
      </div>
    </div>

    <!-- Step 3: Service Configuration -->
    <div class="wizard-card hidden" id="step3">
      <h2 class="wizard-title">Service Configuration</h2>
      <p class="wizard-subtitle">Set your pricing and provider metadata.</p>
      
      <!-- Pricing -->
      <div style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.5rem;">
        <h3 style="margin-bottom: 0.5rem;">üí∞ Pricing</h3>
        <p style="color: var(--text-dim); font-size: 0.9rem; margin-bottom: 1rem;">
          Set your pay-as-you-go rate. This is what subscribers pay per request to your node.
        </p>
        
        <div class="form-group" style="margin-bottom: 0.75rem;">
          <label class="form-label">Rate (uarkeo per request)</label>
          <input type="number" class="form-input" id="paygRate" 
                 value="25000" min="1" step="1" oninput="updateSummary()">
        </div>
        
        <!-- Price calculator -->
        <div id="priceCalc" style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 0.5rem; padding: 1rem; font-size: 0.85rem;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
            <span style="color: var(--text-dim);">Per request:</span>
            <span id="calcPerRequest" style="color: var(--text);">0.00025 ARKEO</span>
          </div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
            <span style="color: var(--text-dim);">Per 1,000 requests:</span>
            <span id="calcPer1k" style="color: var(--text);">0.25 ARKEO</span>
          </div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
            <span style="color: var(--text-dim);">Per 1M requests:</span>
            <span id="calcPer1m" style="color: var(--arkeo); font-weight: 600;">250 ARKEO</span>
          </div>
          <div style="display: flex; justify-content: space-between; border-top: 1px solid var(--border); padding-top: 0.5rem;">
            <span style="color: var(--text-dim);">USD per 1M requests:</span>
            <span id="calcUsd" style="color: var(--success); font-weight: 600;">~$3.47</span>
          </div>
        </div>
        
        <details style="margin-top: 0.75rem;">
          <summary style="cursor: pointer; color: var(--arkeo); font-size: 0.85rem; font-weight: 600;">
            üìä How should I price my service?
          </summary>
          <div style="margin-top: 0.5rem; color: var(--text-dim); font-size: 0.85rem; line-height: 1.8;">
            <p style="margin-bottom: 0.5rem;"><strong>Competitor pricing for reference:</strong></p>
            <table style="width: 100%; border-collapse: collapse; font-size: 0.8rem; margin-bottom: 0.75rem;">
              <tr style="border-bottom: 1px solid var(--border);">
                <td style="padding: 0.3rem;">Infura</td>
                <td style="padding: 0.3rem;">Free tier + $50/mo for 100k req/day</td>
              </tr>
              <tr style="border-bottom: 1px solid var(--border);">
                <td style="padding: 0.3rem;">Alchemy</td>
                <td style="padding: 0.3rem;">Free tier + $49/mo for 50M compute units</td>
              </tr>
              <tr style="border-bottom: 1px solid var(--border);">
                <td style="padding: 0.3rem;">QuickNode</td>
                <td style="padding: 0.3rem;">$49/mo for 15M API credits</td>
              </tr>
            </table>
            <p><strong>Tips:</strong> Start competitive to attract subscribers. You can adjust your rate anytime by updating your provider config on-chain.</p>
          </div>
        </details>
      </div>
      
      <!-- Node Protection -->
      <div style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.5rem;">
        <h3 style="margin-bottom: 0.5rem;">üõ°Ô∏è Node Protection</h3>
        <p style="color: var(--text-dim); font-size: 0.9rem; margin-bottom: 1rem;">
          Protect your node from being overwhelmed. Your sentinel will automatically reject requests that exceed these limits.
        </p>
        
        <div class="form-group" style="margin-bottom: 1rem;">
          <label class="form-label">Max requests per minute <span style="color: var(--text-dim); font-weight: 400;">(per subscriber)</span></label>
          <input type="number" class="form-input" id="maxQpm" 
                 value="100" min="1" step="10" oninput="updateProtectionSummary()">
          <p class="form-hint">Each subscriber's contract is capped at this rate. Prevents any single user from hogging your resources.</p>
        </div>
        
        <!-- Visual summary -->
        <div id="protectionSummary" style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 0.5rem; padding: 1rem; font-size: 0.85rem;">
          <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
            <span style="color: var(--success); font-size: 1.1rem;">‚úÖ</span>
            <span>Each subscriber limited to <strong id="protQpm">100</strong> requests/min</span>
          </div>
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <span style="color: var(--success); font-size: 1.1rem;">‚úÖ</span>
            <span>With 10 subscribers: max <strong id="protTotal">1,000</strong> requests/min to your node</span>
          </div>
        </div>
      </div>
      
      <!-- Contract Duration Limits -->
      <div style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.5rem;">
        <h3 style="margin-bottom: 0.5rem;">‚è±Ô∏è Contract Duration Limits</h3>
        <p style="color: var(--text-dim); font-size: 0.9rem; margin-bottom: 1rem;">
          Set how long subscribers can open contracts with you. ~4 seconds per block.
        </p>
        
        <!-- Max Contract Duration -->
        <div class="form-group" style="margin-bottom: 1.5rem;">
          <label class="form-label">Max Contract Duration</label>
          <p style="color: var(--text-dim); font-size: 0.85rem; margin-bottom: 0.5rem;">
            The maximum length of time a subscriber can lock in a contract with you.
          </p>
          <div style="background: rgba(59,224,255,0.08); border: 1px solid rgba(59,224,255,0.2); border-radius: 0.5rem; padding: 0.6rem 0.75rem; margin-bottom: 0.75rem; font-size: 0.82rem; color: var(--text-dim);">
            ‚ÑπÔ∏è <strong style="color: var(--arkeo);">Arkeo chain limit:</strong> Max contract duration cannot exceed <strong>5,256,000 blocks (~8 months)</strong>. This is a network-wide parameter set by governance.
          </div>
          <div style="display: flex; gap: 0.5rem; margin-bottom: 0.75rem; flex-wrap: wrap;">
            <button type="button" class="duration-preset" data-blocks="151200" onclick="setMaxDuration(151200, '1 Week')">1 Week</button>
            <button type="button" class="duration-preset" data-blocks="648000" onclick="setMaxDuration(648000, '1 Month')">1 Month</button>
            <button type="button" class="duration-preset" data-blocks="1944000" onclick="setMaxDuration(1944000, '3 Months')">3 Months</button>
            <button type="button" class="duration-preset" data-blocks="3888000" onclick="setMaxDuration(3888000, '6 Months')">6 Months</button>
            <button type="button" class="duration-preset active" data-blocks="5256000" onclick="setMaxDuration(5256000, '~8 Months (chain max)')">Max (~8 Months)</button>
            <button type="button" class="duration-preset" onclick="setMaxDurationCustom()">Custom</button>
          </div>
          <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
            <input type="number" class="form-input" id="maxContractDuration" 
                   value="5256000" min="10" step="1000" max="5256000" 
                   style="width: 180px; padding: 0.6rem 1rem; font-size: 0.95rem;"
                   oninput="updateMaxDurationDisplay()">
            <span style="color: var(--text-dim); font-size: 0.9rem;">blocks</span>
          </div>
          <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 0.5rem; padding: 0.75rem; font-size: 0.85rem;">
            <span style="color: var(--text-dim);">‚âà </span>
            <strong id="maxDurationHuman" style="color: var(--arkeo);">1 year</strong>
            <span style="color: var(--text-dim);"> at ~4s/block</span>
          </div>
        </div>
        
        <!-- Min Contract Duration -->
        <div class="form-group" style="margin-bottom: 0;">
          <label class="form-label">Min Contract Duration</label>
          <p style="color: var(--text-dim); font-size: 0.85rem; margin-bottom: 0.5rem;">
            The minimum commitment required for subscribers. Prevents spam contracts.
          </p>
          <div style="display: flex; gap: 0.5rem; margin-bottom: 0.75rem; flex-wrap: wrap;">
            <button type="button" class="duration-preset active" data-blocks="10" onclick="setMinDuration(10, '10 blocks')">10 blocks</button>
            <button type="button" class="duration-preset" data-blocks="900" onclick="setMinDuration(900, '1 Hour')">1 Hour</button>
            <button type="button" class="duration-preset" data-blocks="21600" onclick="setMinDuration(21600, '1 Day')">1 Day</button>
            <button type="button" class="duration-preset" onclick="setMinDurationCustom()">Custom</button>
          </div>
          <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
            <input type="number" class="form-input" id="minContractDuration" 
                   value="10" min="1" step="10"
                   style="width: 180px; padding: 0.6rem 1rem; font-size: 0.95rem;"
                   oninput="updateMinDurationDisplay()">
            <span style="color: var(--text-dim); font-size: 0.9rem;">blocks</span>
          </div>
          <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 0.5rem; padding: 0.75rem; font-size: 0.85rem;">
            <span style="color: var(--text-dim);">‚âà </span>
            <strong id="minDurationHuman" style="color: var(--arkeo);">~40 seconds</strong>
            <span style="color: var(--text-dim);"> at ~4s/block</span>
          </div>
        </div>
      </div>
      
      <!-- Provider Profile -->
      <div style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.5rem;">
        <h3 style="margin-bottom: 0.5rem;">üìÑ Your Provider Profile</h3>
        <p style="color: var(--text-dim); font-size: 0.9rem; margin-bottom: 1rem;">
          This is how you'll appear in the marketplace. Your sentinel will serve this info automatically.
        </p>
        
        <div class="form-group">
          <label class="form-label">Provider Name</label>
          <input type="text" class="form-input" id="providerName" 
                 placeholder="e.g. Red_5, Polkachu, My Node" oninput="updateMetadataPreview()">
        </div>
        
        <div class="form-group">
          <label class="form-label">Description <span style="color: var(--text-dim); font-weight: 400;">(optional)</span></label>
          <input type="text" class="form-input" id="providerDesc" 
                 placeholder="e.g. High-performance Cosmos RPC with 99.9% uptime" oninput="updateMetadataPreview()">
        </div>
        
        <div class="form-group">
          <label class="form-label">Region <span style="color: var(--text-dim); font-weight: 400;">(optional)</span></label>
          <select class="form-input" id="providerLocation" onchange="updateMetadataPreview()">
            <option value="">Select region...</option>
            <option value="NA">North America</option>
            <option value="EU">Europe</option>
            <option value="ASIA">Asia Pacific</option>
            <option value="SA">South America</option>
            <option value="AF">Africa</option>
            <option value="OC">Oceania</option>
          </select>
        </div>
      </div>
      
      <!-- Summary -->
      <div class="summary-card">
        <div class="summary-row">
          <span class="summary-label">Chain</span>
          <span class="summary-value" id="summaryChain">-</span>
        </div>
        <div class="summary-row">
          <span class="summary-label">Node RPC</span>
          <span class="summary-value" id="summarySentinel">-</span>
        </div>
        <div class="summary-row">
          <span class="summary-label">Rate</span>
          <span class="summary-value" id="summaryRate">1 uarkeo/req</span>
        </div>
        <div class="summary-row">
          <span class="summary-label">Bond Required</span>
          <span class="summary-value">1 ARKEO</span>
        </div>
      </div>
      
      <div class="alert alert-info">
        üí° You need at least <strong>1 ARKEO</strong> in your wallet for the provider bond, plus gas fees (~0.001 ARKEO).
      </div>
      
      <div class="btn-group">
        <button class="btn btn-secondary" onclick="goToStep(2)">‚Üê Back</button>
        <button class="btn btn-primary" id="nextBtn3" onclick="goToStep(4)">
          Continue ‚Üí
        </button>
      </div>
    </div>

    <!-- Step 4: Register On-Chain -->
    <div class="wizard-card hidden" id="step4">
      <h2 class="wizard-title">Register On-Chain</h2>
      <p class="wizard-subtitle">Sign two transactions to bond and configure your provider.</p>
      
      <div id="walletRequired" class="alert alert-warning">
        ‚ö†Ô∏è Please connect your Keplr wallet to continue.
      </div>
      
      <div id="registrationSteps" class="hidden">
        <!-- Transaction Overview -->
        <div style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.5rem;">
          <h3 style="margin-bottom: 1rem;">üìã Two Transactions Required</h3>
          
          <div style="display: flex; flex-direction: column; gap: 1rem;">
            <!-- TX 1: Bond -->
            <div id="tx1Status" style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: var(--arkeo-dim); border: 1px solid var(--arkeo); border-radius: 0.5rem;">
              <span style="font-size: 1.5rem;">1Ô∏è‚É£</span>
              <div style="flex: 1;">
                <div style="font-weight: 600;">Bond Provider</div>
                <div style="font-size: 0.85rem; color: var(--text-dim);">Lock 1 ARKEO as provider collateral</div>
              </div>
              <span id="tx1Icon" style="font-size: 1.25rem;">‚è≥</span>
            </div>
            
            <!-- TX 2: ModProvider -->
            <div id="tx2Status" style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 0.5rem;">
              <span style="font-size: 1.5rem;">2Ô∏è‚É£</span>
              <div style="flex: 1;">
                <div style="font-weight: 600;">Configure Service</div>
                <div style="font-size: 0.85rem; color: var(--text-dim);">Set rates, metadata, and activate provider</div>
              </div>
              <span id="tx2Icon" style="font-size: 1.25rem;">‚è≥</span>
            </div>
          </div>
        </div>
        
        <!-- Summary -->
        <div class="summary-card">
          <div class="summary-row">
            <span class="summary-label">Service</span>
            <span class="summary-value" id="regChain">-</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Wallet</span>
            <span class="summary-value" id="regWallet" style="font-size: 0.8rem;">-</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Sentinel URL</span>
            <span class="summary-value" id="regSentinel" style="font-size: 0.8rem;">-</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">PAYG Rate</span>
            <span class="summary-value" id="regRate">-</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Total Cost</span>
            <span class="summary-value">~1.001 ARKEO</span>
          </div>
        </div>
        
        <div class="alert alert-warning" style="font-size: 0.9rem;">
          ‚ÑπÔ∏è <strong>What happens here:</strong> Two transactions will register you as a provider on the Arkeo blockchain. This bonds 1 ARKEO as collateral and sets your pricing. You'll set up your sentinel in the next step ‚Äî your provider won't be live until that's done.
          <br><br>
          üí∞ <strong>You'll need at least ~1.01 ARKEO</strong> in your Keplr wallet ‚Äî 1 ARKEO for the bond plus a small amount for gas fees. 
          Don't have any? <a href="https://app.osmosis.zone/?from=USDC&to=ARKEO" target="_blank" style="color: var(--arkeo);">Buy ARKEO on Osmosis ‚Üí</a>
        </div>
        
        <div id="txStatus"></div>
        
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="goToStep(3)">‚Üê Back</button>
          <button class="btn btn-primary" id="registerBtn" onclick="registerProvider()">
            Sign Transactions ‚Üí
          </button>
        </div>
      </div>
    </div>

    <!-- Step 5: Success -->
    <div class="wizard-card hidden" id="step5">
      <div class="success-container">
        <div class="success-icon">üéâ</div>
        <h2 class="success-title">You're Live!</h2>
        <p class="success-subtitle">Your provider is now registered on the Arkeo network.</p>
        
        <div class="summary-card" style="text-align: left;">
          <div class="summary-row">
            <span class="summary-label">Service</span>
            <span class="summary-value" id="finalService">-</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Provider Address</span>
            <span class="summary-value" id="finalPubkey" style="font-size: 0.75rem; word-break: break-all;">-</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Bond TX</span>
            <span class="summary-value" id="finalBondTx">-</span>
          </div>
        </div>
        
        <div class="alert alert-info" style="text-align: left;">
          <strong>‚úÖ Your provider should now appear in the marketplace!</strong><br>
          <span style="color: var(--text-dim);">
            Make sure your sentinel is running and accessible. Users can now open contracts with you.
          </span>
        </div>
        
        <div style="margin-top: 2rem; display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
          <button class="btn btn-primary" onclick="goToStep(6)">Next: Configure Sentinel ‚Üí</button>
          <button class="btn btn-secondary" onclick="goToStep(7)" style="border: 2px solid #8b5cf6; color: #a78bfa;">
            ‚ö° Enable x402 Payments (Optional)
          </button>
          <a href="index.html" class="btn btn-secondary">View Marketplace</a>
        </div>
      </div>
    </div>

    <!-- Step 6: Configure Sentinel -->
    <div class="wizard-card hidden" id="step6">
      <h2 class="wizard-title">üõ°Ô∏è Set Up Your Sentinel</h2>
      <p class="wizard-subtitle">One command installs everything. Then come back here to verify.</p>

      <!-- Hidden inputs for config generation -->
      <input type="hidden" id="sentinelConfigRpcUrl" value="">

      <!-- Sub-step 1: Domain (optional) -->
      <div style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.5rem;">
        <h3 style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
          <span style="background: var(--arkeo); color: #000; width: 1.5rem; height: 1.5rem; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 700;">1</span>
          Do you have a domain name for your sentinel?
        </h3>
        <p style="color: var(--text-dim); font-size: 0.9rem; margin-bottom: 1rem;">
          A domain gives you free HTTPS. No domain? No problem ‚Äî the installer will use your server's IP address.
        </p>
        
        <div class="form-group" style="margin-bottom: 0.5rem;">
          <input type="text" class="form-input" id="sentinelDomain"
                 placeholder="e.g. my-node.duckdns.org (leave empty to skip)" oninput="updateInstallScript()">
        </div>
        
        <details style="margin-top: 0.5rem;">
          <summary style="cursor: pointer; color: var(--arkeo); font-size: 0.85rem; font-weight: 600;">
            ü§î How do I get a free domain?
          </summary>
          <div style="margin-top: 0.5rem; color: var(--text-dim); font-size: 0.85rem; line-height: 1.8;">
            <ol style="padding-left: 1.25rem;">
              <li>Go to <a href="https://www.duckdns.org" target="_blank" style="color: var(--arkeo);">duckdns.org</a> and sign in with Google/GitHub</li>
              <li>Create a subdomain (e.g. <code style="background: var(--bg-card); padding: 0.1rem 0.3rem; border-radius: 0.2rem;">my-arkeo-node</code>)</li>
              <li>Point it to your server's IP address</li>
              <li>Enter it above (e.g. <code style="background: var(--bg-card); padding: 0.1rem 0.3rem; border-radius: 0.2rem;">my-arkeo-node.duckdns.org</code>)</li>
            </ol>
            <p style="margin-top: 0.25rem;">The installer handles SSL/HTTPS automatically. Total cost: $0.</p>
          </div>
        </details>
      </div>

      <!-- Sub-step 2: One-click install -->
      <div style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.5rem;">
        <h3 style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
          <span style="background: var(--arkeo); color: #000; width: 1.5rem; height: 1.5rem; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 700;">2</span>
          Run This Command On Your Server
        </h3>
        <p style="color: var(--text-dim); font-size: 0.9rem; margin-bottom: 1rem;">
          SSH into your server and paste this single command. It installs Docker, configures your sentinel, sets up HTTPS, and starts everything.
        </p>
        
        <div style="background: #0d1117; border: 2px solid var(--arkeo); border-radius: 0.75rem; padding: 1.25rem; font-family: 'SF Mono', Monaco, monospace; font-size: 0.8rem; overflow-x: auto; position: relative;">
          <button onclick="copyInstallScript()" id="copyInstallBtn"
            style="position: absolute; top: 0.75rem; right: 0.75rem; background: var(--arkeo); color: #000; border: none; padding: 0.4rem 0.75rem; border-radius: 0.25rem; cursor: pointer; font-size: 0.8rem; font-weight: 600;">üìã Copy</button>
          <pre id="installCommand" style="color: #10b981; margin: 0; white-space: pre-wrap; padding-right: 5rem;"></pre>
        </div>
        
        <div style="margin-top: 1rem; display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.85rem; color: var(--text-dim);">
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <span style="color: var(--success);">‚úì</span> Installs Docker (if not already installed)
          </div>
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <span style="color: var(--success);">‚úì</span> Writes your config with your provider key and pricing
          </div>
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <span style="color: var(--success);">‚úì</span> Sets up HTTPS with nginx + Let's Encrypt (if domain provided)
          </div>
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <span style="color: var(--success);">‚úì</span> Starts the sentinel and verifies it's working
          </div>
        </div>
      </div>

      <!-- Sub-step 3: Test -->
      <div style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.5rem;">
        <h3 style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
          <span style="background: var(--arkeo); color: #000; width: 1.5rem; height: 1.5rem; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 700;">3</span>
          Verify From Here
        </h3>
        <p style="color: var(--text-dim); font-size: 0.9rem; margin-bottom: 1rem;">
          After the installer finishes, enter your sentinel URL below and we'll confirm it's working.
        </p>
        
        <div class="form-group" style="margin-bottom: 1rem;">
          <label class="form-label">Your Sentinel URL</label>
          <input type="url" class="form-input" id="sentinelPublicUrl"
                 placeholder="https://my-node.duckdns.org" oninput="onSentinelPublicUrlChange()">
          <p class="form-hint">The installer will show this URL when it finishes.</p>
        </div>
        
        <button class="btn btn-primary" id="selfTestBtn" onclick="runSelfTest()" style="width: 100%;">
          üîç Test My Sentinel
        </button>
        <div id="selfTestResults" style="margin-top: 1rem;"></div>
      </div>

      <!-- Advanced: Manual config (collapsible) -->
      <details style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 0.75rem; margin-bottom: 1.5rem;">
        <summary style="padding: 1.25rem 1.5rem; cursor: pointer; color: var(--text-dim); font-weight: 600; font-size: 0.9rem;">
          üîß Advanced: View raw config files
        </summary>
        <div style="padding: 0 1.5rem 1.5rem;">
          <div style="margin-bottom: 1rem;">
            <label class="form-label" style="font-size: 0.85rem;">config.yaml</label>
            <div style="background: #0d1117; border: 1px solid var(--border); border-radius: 0.5rem; padding: 1rem; font-family: monospace; font-size: 0.75rem; overflow-x: auto;">
              <pre id="sentinelConfigYaml" style="color: #e6edf3; margin: 0; white-space: pre-wrap;"></pre>
            </div>
            <button class="btn btn-secondary" style="margin-top: 0.5rem; width: 100%; font-size: 0.85rem;" onclick="copySentinelConfig()">
              üìã Copy config.yaml
            </button>
          </div>
          <div>
            <label class="form-label" style="font-size: 0.85rem;">metadata.json</label>
            <div style="background: #0d1117; border: 1px solid var(--border); border-radius: 0.5rem; padding: 1rem; font-family: monospace; font-size: 0.75rem; overflow-x: auto;">
              <pre id="metadataJsonPreview" style="color: #e6edf3; margin: 0; white-space: pre-wrap;"></pre>
            </div>
            <button class="btn btn-secondary" style="margin-top: 0.5rem; width: 100%; font-size: 0.85rem;" onclick="copyMetadataJson()">
              üìã Copy metadata.json
            </button>
          </div>
        </div>
      </details>

      <!-- Optional: Failover monitor -->
      <details style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 0.75rem; margin-bottom: 1.5rem;">
        <summary style="padding: 1.25rem 1.5rem; cursor: pointer; color: var(--text-dim); font-weight: 600; font-size: 0.9rem;">
          üîÑ Optional: Automatic Endpoint Failover
        </summary>
        <div style="padding: 0 1.5rem 1.5rem;">
          <p style="color: var(--text-dim); font-size: 0.9rem; margin-bottom: 1rem;">
            If you're using a community Arkeo endpoint, this script auto-switches to a backup if it goes down.
          </p>
          <div style="background: #0d1117; border-radius: 0.5rem; padding: 1rem; font-family: monospace; font-size: 0.8rem; overflow-x: auto; position: relative;">
            <button onclick="navigator.clipboard.writeText(this.parentElement.querySelector('pre').textContent); this.textContent='‚úì Copied!'; setTimeout(()=>this.textContent='üìã Copy',2000);"
              style="position: absolute; top: 0.5rem; right: 0.5rem; background: var(--bg-card); border: 1px solid var(--border); color: var(--text-dim); padding: 0.25rem 0.5rem; border-radius: 0.25rem; cursor: pointer; font-size: 0.75rem;">üìã Copy</button>
<pre style="color: #10b981; margin: 0; white-space: pre-wrap;"># Download and install the failover monitor
curl -o /usr/local/bin/arkeo-failover.sh \
  https://raw.githubusercontent.com/rbechtold69/arkeo-data-engine-v2/main/docs/scripts/arkeo-endpoint-monitor.sh
chmod +x /usr/local/bin/arkeo-failover.sh

# Run every 2 minutes via cron
(crontab -l 2>/dev/null; echo "*/2 * * * * /usr/local/bin/arkeo-failover.sh ~/.arkeo/config.yaml >> /var/log/arkeo-failover.log 2>&1") | crontab -</pre>
          </div>
          <p style="color: var(--text-dim); font-size: 0.8rem; margin-top: 0.75rem;">
            ‚ÑπÔ∏è Not needed if you run your own Arkeo node.
          </p>
        </div>
      </details>

      <!-- Done -->
      <div style="background: var(--success-dim); border: 1px solid var(--success); border-radius: 0.75rem; padding: 1.5rem; text-align: center; margin-bottom: 1.5rem;">
        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üöÄ</div>
        <h3 style="margin-bottom: 0.5rem;">Once your sentinel passes the test, you're live!</h3>
        <p style="color: var(--text-dim); font-size: 0.9rem;">Subscribers can now find you in the marketplace and open contracts to query your node.</p>
      </div>

      <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
        <a href="index.html" class="btn btn-primary">View Marketplace</a>
        <a href="subscribe.html" class="btn btn-secondary">Test Your Provider</a>
      </div>
    </div>
  </div>

    <!-- Infrastructure Best Practices (collapsible) -->
    <div style="margin-top: 2rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 1rem; overflow: hidden;">
      <button onclick="this.parentElement.querySelector('.infra-body').classList.toggle('hidden'); this.querySelector('.infra-arrow').textContent = this.querySelector('.infra-arrow').textContent === '‚ñ∏' ? '‚ñæ' : '‚ñ∏';"
        style="width: 100%; padding: 1.25rem 1.5rem; background: none; border: none; color: var(--arkeo); font-size: 1.1rem; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 0.75rem; text-align: left;">
        <span class="infra-arrow">‚ñ∏</span> üõ°Ô∏è Infrastructure Best Practices
      </button>
      <div class="infra-body hidden" style="padding: 0 1.5rem 1.5rem; color: var(--text-dim); font-size: 0.9rem; line-height: 1.7;">

        <!-- Sentinel Rate Limiting -->
        <div style="margin-bottom: 1.5rem;">
          <h3 style="color: var(--text); margin-bottom: 0.5rem;">‚ö° Sentinel Rate Limiting</h3>
          <p>The Arkeo <strong>sentinel</strong> automatically enforces QPM (Queries Per Minute) limits per contract. Each contract has a <code style="background: var(--bg-input); padding: 0.15rem 0.4rem; border-radius: 0.25rem; font-size: 0.85rem;">queries_per_minute</code> field ‚Äî the sentinel will reject requests that exceed the contracted rate. No extra configuration needed on your end for per-contract enforcement.</p>
        </div>

        <!-- Recommended Infrastructure -->
        <div style="margin-bottom: 1.5rem;">
          <h3 style="color: var(--text); margin-bottom: 0.5rem;">üîß Recommended Infrastructure: Nginx Reverse Proxy</h3>
          <p style="margin-bottom: 0.75rem;">Place Nginx in front of your sentinel for additional rate limiting, TLS termination, and DDoS mitigation:</p>
          <div style="background: var(--bg-input); border-radius: 0.5rem; padding: 1rem; font-family: monospace; font-size: 0.8rem; overflow-x: auto; margin-bottom: 0.75rem; position: relative;">
            <button onclick="navigator.clipboard.writeText(this.parentElement.querySelector('pre').textContent); this.textContent='‚úì Copied!'; setTimeout(()=>this.textContent='üìã Copy',2000);"
              style="position: absolute; top: 0.5rem; right: 0.5rem; background: var(--bg-card); border: 1px solid var(--border); color: var(--text-dim); padding: 0.25rem 0.5rem; border-radius: 0.25rem; cursor: pointer; font-size: 0.75rem;">üìã Copy</button>
<pre style="color: #10b981; margin: 0; white-space: pre-wrap;"># /etc/nginx/conf.d/arkeo-sentinel.conf

# Rate limit zone: 100 requests/min per IP
limit_req_zone $binary_remote_addr zone=sentinel:10m rate=100r/m;

server {
    listen 443 ssl http2;
    server_name your-provider.example.com;

    ssl_certificate     /etc/letsencrypt/live/your-provider.example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-provider.example.com/privkey.pem;

    location / {
        limit_req zone=sentinel burst=20 nodelay;
        limit_req_status 429;

        proxy_pass http://127.0.0.1:3636;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}</pre>
          </div>
        </div>

        <!-- Hardware Guidelines -->
        <div style="margin-bottom: 1.5rem;">
          <h3 style="color: var(--text); margin-bottom: 0.75rem;">üíª Hardware Guidelines</h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem;">
            <div style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1rem;">
              <div style="font-weight: 600; color: var(--text); margin-bottom: 0.25rem;">üü¢ Light (&lt;100 QPM)</div>
              <div>2 CPU, 4 GB RAM</div>
              <div style="font-size: 0.8rem; color: var(--text-muted);">Suitable for low-traffic chains</div>
            </div>
            <div style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1rem;">
              <div style="font-weight: 600; color: var(--text); margin-bottom: 0.25rem;">üü° Medium (100‚Äì1000 QPM)</div>
              <div>4 CPU, 8 GB RAM</div>
              <div style="font-size: 0.8rem; color: var(--text-muted);">Most providers start here</div>
            </div>
            <div style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1rem;">
              <div style="font-weight: 600; color: var(--text); margin-bottom: 0.25rem;">üî¥ Heavy (1000+ QPM)</div>
              <div>8+ CPU, 16+ GB RAM, SSD</div>
              <div style="font-size: 0.8rem; color: var(--text-muted);">High-demand or archive nodes</div>
            </div>
          </div>
        </div>

        <!-- DDoS Protection -->
        <div style="margin-bottom: 1.5rem;">
          <h3 style="color: var(--text); margin-bottom: 0.5rem;">üõ°Ô∏è DDoS Protection</h3>
          <ul style="padding-left: 1.5rem; margin-bottom: 0.75rem;">
            <li><strong>Cloudflare (free tier)</strong> ‚Äî Proxy your domain through Cloudflare for automatic DDoS mitigation and TLS.</li>
            <li><strong>UFW firewall</strong> ‚Äî Allow only necessary ports:</li>
          </ul>
          <div style="background: var(--bg-input); border-radius: 0.5rem; padding: 1rem; font-family: monospace; font-size: 0.8rem; overflow-x: auto; margin-bottom: 0.75rem;">
<pre style="color: #10b981; margin: 0; white-space: pre-wrap;">sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow ssh
sudo ufw allow 443/tcp    # HTTPS (Nginx)
sudo ufw allow 3636/tcp   # Sentinel (if no Nginx proxy)
sudo ufw enable</pre>
          </div>
          <ul style="padding-left: 1.5rem;">
            <li><strong>fail2ban</strong> ‚Äî Auto-ban repeat offenders:</li>
          </ul>
          <div style="background: var(--bg-input); border-radius: 0.5rem; padding: 1rem; font-family: monospace; font-size: 0.8rem; overflow-x: auto;">
<pre style="color: #10b981; margin: 0; white-space: pre-wrap;">sudo apt install fail2ban
sudo systemctl enable fail2ban
# Default config bans after 5 failed SSH attempts</pre>
          </div>
        </div>

        <!-- Setting Your Max QPM -->
        <div>
          <h3 style="color: var(--text); margin-bottom: 0.5rem;">üìä Setting Your Max QPM</h3>
          <p style="margin-bottom: 0.5rem;">QPM is set <strong>per contract</strong> when a user opens a contract with you. To decide your per-contract QPM limit:</p>
          <div style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1rem; margin-bottom: 0.75rem; text-align: center;">
            <div style="color: var(--arkeo); font-weight: 700; font-size: 1.1rem;">Per-Contract QPM = Total Hardware Capacity √∑ Max Expected Contracts</div>
            <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem;">Example: 500 QPM capacity with up to 10 contracts ‚Üí set 50 QPM per contract</div>
          </div>
          <ul style="padding-left: 1.5rem;">
            <li>Benchmark your node under load to find your actual capacity.</li>
            <li>Leave 20‚Äì30% headroom for spikes.</li>
            <li>You can update QPM settings by modifying your provider configuration on-chain.</li>
          </ul>
        </div>

      </div>
    </div>

    <!-- Step 7: Enable x402 Payments (Optional) -->
    <div class="wizard-card hidden" id="step7">
      <h2 class="wizard-title">‚ö° Enable x402 Payments</h2>
      <p class="wizard-subtitle">Accept USDC micropayments via Arkeo's centralized x402 proxy (optional)</p>

      <div style="background: rgba(139,92,246,0.08); border: 1px solid rgba(139,92,246,0.4); border-radius: 0.75rem; padding: 1.25rem; margin-bottom: 1.5rem;">
        <div style="font-weight: 600; margin-bottom: 0.5rem; color: #a78bfa;">What is x402?</div>
        <div style="color: var(--text-dim); font-size: 0.9rem; line-height: 1.7;">
          x402 is Coinbase's open standard for HTTP-native payments. It lets clients pay per request with USDC on Base (low fees) ‚Äî no accounts, no API keys. Perfect for AI agents. 
          <a href="https://x402.org" target="_blank" style="color: var(--arkeo);">Learn more ‚Üí</a>
        </div>
      </div>

      <div id="x402SetupFlow">
        <!-- Prerequisites Check -->
        <div id="x402Prerequisites">
          <div style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.5rem;">
            <h3 style="margin-bottom: 0.75rem;">‚úÖ Prerequisites</h3>
            <div id="x402PrereqCheck" style="font-size: 0.9rem; color: var(--text-dim);">
              <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                <div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div>
                <span>Checking provider registration...</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 1: Create Backing Contract -->
        <div id="x402Step1" style="display: none;">
          <div style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.5rem;">
            <h3 style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
              <span style="background: var(--arkeo); color: #000; width: 1.5rem; height: 1.5rem; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 700;">1</span>
              Create Backing ARKEO Contract
            </h3>
            <p style="color: var(--text-dim); font-size: 0.9rem; margin-bottom: 1rem;">
              The x402 proxy needs an active ARKEO contract to bill against. This contract backs your x402 endpoint.
            </p>

            <div class="form-group" style="margin-bottom: 1rem;">
              <label class="form-label">Deposit Amount (ARKEO)</label>
              <input type="number" class="form-input" id="x402DepositAmount" value="10" min="0.01" step="0.01">
              <p class="form-hint">Minimum 0.01 ARKEO. This will be consumed as clients make requests via x402.</p>
            </div>

            <div class="form-group" style="margin-bottom: 1rem;">
              <label class="form-label">Contract Duration</label>
              <select class="form-input" id="x402Duration">
                <option value="900">1 Hour</option>
                <option value="21600">1 Day</option>
                <option value="151200">1 Week</option>
                <option value="648000" selected>1 Month</option>
                <option value="5256000">Max (~8 Months)</option>
              </select>
            </div>

            <button class="btn btn-primary" id="x402CreateContractBtn" onclick="createX402BackingContract()" style="width: 100%;">
              üîó Connect Keplr & Create Contract
            </button>
            <div id="x402ContractStatus" style="margin-top: 1rem;"></div>
          </div>
        </div>

        <!-- Step 2: Generate Delegate Key -->
        <div id="x402Step2" style="display: none;">
          <div style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.5rem;">
            <h3 style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
              <span style="background: var(--arkeo); color: #000; width: 1.5rem; height: 1.5rem; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 700;">2</span>
              Generate x402 Signing Key
            </h3>
            <p style="color: var(--text-dim); font-size: 0.9rem; margin-bottom: 1rem;">
              This delegate key allows the x402 proxy to sign requests on your behalf.
            </p>

            <button class="btn btn-primary" id="x402GenerateKeyBtn" onclick="generateX402Key()" style="width: 100%; margin-bottom: 1rem;">
              üîë Generate New Signing Key
            </button>

            <div id="x402KeyDisplay" style="display: none;">
              <div style="background: var(--bg-card); border: 2px solid var(--success); border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem;">
                <div style="font-weight: 600; color: var(--success); margin-bottom: 0.75rem;">‚úÖ Key Generated!</div>
                
                <div style="margin-bottom: 0.75rem;">
                  <div style="font-weight: 500; font-size: 0.85rem; margin-bottom: 0.25rem;">Public Key (Bech32):</div>
                  <div style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 0.375rem; padding: 0.5rem; font-family: monospace; font-size: 0.75rem; word-break: break-all;">
                    <span id="x402PublicKey">-</span>
                  </div>
                </div>

                <div style="margin-bottom: 0.75rem;">
                  <div style="font-weight: 500; font-size: 0.85rem; margin-bottom: 0.25rem;">Address:</div>
                  <div style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 0.375rem; padding: 0.5rem; font-family: monospace; font-size: 0.75rem; word-break: break-all;">
                    <span id="x402Address">-</span>
                  </div>
                </div>

                <div style="background: rgba(239,68,68,0.1); border: 1px solid var(--error); border-radius: 0.5rem; padding: 0.75rem; margin-top: 0.75rem;">
                  <div style="color: var(--error); font-weight: 600; font-size: 0.85rem; margin-bottom: 0.25rem;">‚ö†Ô∏è Private Key (Save This!)</div>
                  <div style="background: #0d1117; border: 1px solid var(--border); border-radius: 0.375rem; padding: 0.5rem; font-family: monospace; font-size: 0.7rem; word-break: break-all; color: #ff7b72;">
                    <span id="x402PrivateKey">-</span>
                  </div>
                  <div style="font-size: 0.75rem; color: var(--text-dim); margin-top: 0.5rem;">
                    Copy this private key and store it securely. You'll need to provide it to the Arkeo admin to enable your x402 endpoint.
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 3: Endpoint Info & Test -->
        <div id="x402Step3" style="display: none;">
          <div style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.5rem;">
            <h3 style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
              <span style="background: var(--arkeo); color: #000; width: 1.5rem; height: 1.5rem; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 700;">3</span>
              Your x402 Endpoint
            </h3>
            <p style="color: var(--text-dim); font-size: 0.9rem; margin-bottom: 1rem;">
              Share this endpoint with clients. The centralized x402 proxy handles payments automatically.
            </p>

            <div style="margin-bottom: 1rem;">
              <div style="font-weight: 500; font-size: 0.85rem; margin-bottom: 0.5rem;">x402 Endpoint URL:</div>
              <div style="background: var(--bg-card); border: 2px solid var(--arkeo); border-radius: 0.5rem; padding: 0.75rem; font-family: monospace; font-size: 0.85rem; word-break: break-all; display: flex; align-items: center; gap: 0.5rem;">
                <span id="x402EndpointUrl" style="flex: 1; color: var(--arkeo);">YOUR_SENTINEL_URL/x402/SERVICE</span>
                <button onclick="copyX402Endpoint()" style="background: var(--arkeo); color: #000; border: none; padding: 0.35rem 0.75rem; border-radius: 0.375rem; cursor: pointer; font-size: 0.8rem; font-weight: 600; white-space: nowrap;">
                  üìã Copy
                </button>
              </div>
            </div>

            <div style="background: rgba(139,92,246,0.08); border: 1px solid rgba(139,92,246,0.4); border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem;">
              <div style="color: #a78bfa; font-weight: 600; margin-bottom: 0.5rem;">üìã Server Setup</div>
              <div style="font-size: 0.85rem; color: var(--text-dim);">
                Install the x402 proxy on your sentinel server with the signing key above and the contract ID from Step 1. 
                The proxy intercepts requests at <code>/x402/</code>, collects USDC via the x402 protocol, then routes authenticated queries through your ARKEO contract.
              </div>
            </div>

            <button class="btn btn-secondary" id="x402TestBtn" onclick="testX402Endpoint()" style="width: 100%;">
              üß™ Test Endpoint
            </button>
            <div id="x402TestResult" style="margin-top: 1rem;"></div>
          </div>
        </div>
      </div>

      <div class="btn-group" style="margin-top: 2rem;">
        <button class="btn btn-secondary" onclick="goToStep(6)">‚Üê Back to Sentinel Setup</button>
        <a href="index.html" class="btn btn-primary">Done - View Marketplace ‚Üí</a>
      </div>
    </div>
  </div>

    <!-- Accept x402 Payments (collapsible) -->
    <div style="margin-top: 2rem; background: var(--bg-card); border: 1px solid rgba(139,92,246,0.4); border-radius: 1rem; overflow: hidden;">
      <button onclick="this.parentElement.querySelector('.x402-body').classList.toggle('hidden'); this.querySelector('.x402-arrow').textContent = this.querySelector('.x402-arrow').textContent === '‚ñ∏' ? '‚ñæ' : '‚ñ∏';"
        style="width: 100%; padding: 1.25rem 1.5rem; background: none; border: none; color: #a78bfa; font-size: 1.1rem; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 0.75rem; text-align: left;">
        <span class="x402-arrow">‚ñ∏</span> ‚ö° Accept x402 Payments (USDC Micropayments)
        <span style="font-size: 0.7rem; background: linear-gradient(135deg, #8b5cf6, #3b82f6); color: #fff; padding: 0.2rem 0.6rem; border-radius: 0.25rem; font-weight: 600; margin-left: 0.5rem;">NEW</span>
      </button>
      <div class="x402-body hidden" style="padding: 0 1.5rem 1.5rem; color: var(--text-dim); font-size: 0.9rem; line-height: 1.7;">

        <p style="margin-bottom: 1rem;">
          <a href="https://x402.org" target="_blank" style="color: var(--arkeo);">x402</a> is Coinbase's open HTTP payment standard. It lets clients pay per request with USDC ‚Äî no accounts, no KYC. 
          Add x402 middleware to your sentinel to accept micropayments from AI agents and developers on <strong>Base network</strong> (low fees).
        </p>

        <!-- Step 1: Install -->
        <div style="margin-bottom: 1.5rem;">
          <h3 style="color: var(--text); margin-bottom: 0.5rem;">1. Install x402 packages</h3>
          <div style="background: var(--bg-input); border-radius: 0.5rem; padding: 1rem; font-family: monospace; font-size: 0.85rem; overflow-x: auto; position: relative;">
            <button onclick="navigator.clipboard.writeText('npm install @x402/express @x402/core @x402/evm'); this.textContent='‚úì Copied!'; setTimeout(()=>this.textContent='üìã Copy',2000);"
              style="position: absolute; top: 0.5rem; right: 0.5rem; background: var(--bg-card); border: 1px solid var(--border); color: var(--text-dim); padding: 0.25rem 0.5rem; border-radius: 0.25rem; cursor: pointer; font-size: 0.75rem;">üìã Copy</button>
            <pre style="color: #10b981; margin: 0;">npm install @x402/express @x402/core @x402/evm</pre>
          </div>
        </div>

        <!-- Step 2: Add Middleware -->
        <div style="margin-bottom: 1.5rem;">
          <h3 style="color: var(--text); margin-bottom: 0.5rem;">2. Add x402 middleware to your sentinel</h3>
          <div style="background: #0d1117; border: 1px solid var(--border); border-radius: 0.5rem; padding: 1rem; font-family: 'SF Mono', Monaco, monospace; font-size: 0.8rem; overflow-x: auto; position: relative;">
            <button onclick="navigator.clipboard.writeText(this.parentElement.querySelector('pre').textContent); this.textContent='‚úì Copied!'; setTimeout(()=>this.textContent='üìã Copy',2000);"
              style="position: absolute; top: 0.5rem; right: 0.5rem; background: var(--bg-card); border: 1px solid var(--border); color: var(--text-dim); padding: 0.25rem 0.5rem; border-radius: 0.25rem; cursor: pointer; font-size: 0.75rem;">üìã Copy</button>
<pre style="color: #e6edf3; margin: 0; white-space: pre-wrap;"><span style="color: #7ee787;">import</span> express <span style="color: #7ee787;">from</span> <span style="color: #a5d6ff;">"express"</span>;
<span style="color: #7ee787;">import</span> { paymentMiddleware } <span style="color: #7ee787;">from</span> <span style="color: #a5d6ff;">"@x402/express"</span>;
<span style="color: #7ee787;">import</span> { createVerifier } <span style="color: #7ee787;">from</span> <span style="color: #a5d6ff;">"@x402/evm"</span>;

<span style="color: #7ee787;">const</span> app = express();

<span style="color: #8b949e;">// Your wallet address to receive USDC payments</span>
<span style="color: #7ee787;">const</span> WALLET_ADDRESS = <span style="color: #a5d6ff;">"0xYourWalletAddress"</span>;

<span style="color: #8b949e;">// Configure x402 payment verification</span>
<span style="color: #7ee787;">const</span> verifier = createVerifier({
  <span style="color: #79c0ff;">network</span>: <span style="color: #a5d6ff;">"base"</span>,  <span style="color: #8b949e;">// Base network for low fees</span>
});

<span style="color: #8b949e;">// Protect your RPC endpoint with x402</span>
app.use(<span style="color: #a5d6ff;">"/rpc"</span>, paymentMiddleware(verifier, {
  <span style="color: #79c0ff;">recipient</span>: WALLET_ADDRESS,
  <span style="color: #79c0ff;">amount</span>: <span style="color: #a5d6ff;">"0.0001"</span>,  <span style="color: #8b949e;">// $0.0001 USDC per request</span>
  <span style="color: #79c0ff;">asset</span>: <span style="color: #a5d6ff;">"USDC"</span>,
}));

<span style="color: #8b949e;">// Proxy to your node</span>
app.post(<span style="color: #a5d6ff;">"/rpc"</span>, <span style="color: #7ee787;">async</span> (req, res) => {
  <span style="color: #7ee787;">const</span> response = <span style="color: #7ee787;">await</span> fetch(<span style="color: #a5d6ff;">"http://localhost:26657"</span>, {
    <span style="color: #79c0ff;">method</span>: <span style="color: #a5d6ff;">"POST"</span>,
    <span style="color: #79c0ff;">body</span>: JSON.stringify(req.body),
  });
  res.json(<span style="color: #7ee787;">await</span> response.json());
});

app.listen(<span style="color: #79c0ff;">3637</span>);</pre>
          </div>
        </div>

        <!-- Requirements -->
        <div style="margin-bottom: 1rem;">
          <h3 style="color: var(--text); margin-bottom: 0.5rem;">3. Requirements</h3>
          <ul style="padding-left: 1.5rem; margin-bottom: 0.75rem;">
            <li>An EVM wallet address to receive USDC payments</li>
            <li>Runs on <strong>Base network</strong> ‚Äî transaction fees are fractions of a cent</li>
            <li>Works alongside your existing Arkeo sentinel ‚Äî run on a different port</li>
            <li>Set your own per-request price in USDC</li>
          </ul>
        </div>

        <!-- Benefits -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem; margin-bottom: 1rem;">
          <div style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1rem;">
            <div style="font-weight: 600; color: var(--text); margin-bottom: 0.25rem;">ü§ñ AI Agent Revenue</div>
            <div style="font-size: 0.8rem;">Agents can't sign up for accounts ‚Äî x402 lets them pay automatically.</div>
          </div>
          <div style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1rem;">
            <div style="font-weight: 600; color: var(--text); margin-bottom: 0.25rem;">üí∏ Instant Settlement</div>
            <div style="font-size: 0.8rem;">USDC payments settle on Base ‚Äî no waiting for on-chain contract claims.</div>
          </div>
          <div style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1rem;">
            <div style="font-weight: 600; color: var(--text); margin-bottom: 0.25rem;">üåê HTTP Standard</div>
            <div style="font-size: 0.8rem;">Uses HTTP 402 status code ‚Äî works with any HTTP client.</div>
          </div>
        </div>

        <p>
          <a href="https://x402.org/docs/sellers" target="_blank" style="color: var(--arkeo);">Full x402 seller documentation ‚Üí</a>
        </p>

      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div class="loading-overlay hidden" id="loadingOverlay">
    <div class="spinner" style="width: 48px; height: 48px; border-width: 3px;"></div>
    <div class="loading-text" id="loadingText">Processing...</div>
    <div class="loading-subtext" id="loadingSubtext"></div>
  </div>

  <script>
    // ============================================================
    // CONFIGURATION
    // ============================================================
    const CONFIG = {
      REST_API: 'https://rest-seed.arkeo.network',
      RPC_API: 'https://rpc-seed.arkeo.network',
      CHAIN_ID: 'arkeo-main-v1',
      ARKEO_DENOM: 'uarkeo',
      ARKEO_DIVISOR: 100_000_000,
      MIN_BOND: '100000000', // 1 ARKEO in uarkeo
      DEFAULT_GAS: '200000',
      GAS_PRICE: '0.001uarkeo',
      EXPLORER_TX: 'https://explorer.arkeo.network/arkeo/tx/',
    };

    // ============================================================
    // DISPLAY NAME & ICON MAPS
    // ============================================================
    const CHAIN_DISPLAY_NAMES = {
      'gaia-mainnet-rpc': 'Cosmos Hub (RPC)',
      'gaia-mainnet-fullnode': 'Cosmos Hub',
      'eth-mainnet-fullnode': 'Ethereum',
      'eth-mainnet-archive': 'Ethereum (Archive)',
      'btc-mainnet-fullnode': 'Bitcoin',
      'arkeo-mainnet-fullnode': 'Arkeo',
      'arkeo-mainnet-rest': 'Arkeo (REST)',
      'osmosis-mainnet-fullnode': 'Osmosis',
      'thorchain-mainnet-fullnode': 'THORChain',
      'maya-mainnet-fullnode': 'Maya Protocol',
      'base-mainnet-fullnode': 'Base',
      'cosmos-mainnet-fullnode': 'Cosmos Hub',
    };

    const CHAIN_ICONS = {
      'eth': '‚ü†',
      'btc': '‚Çø',
      'gaia': '‚öõ',
      'cosmos': '‚öõ',
      'thorchain': '‚ö°',
      'osmosis': 'üåä',
      'arkeo': 'üî∑',
      'base': 'üîµ',
      'maya': 'üèõ',
    };

    const SEARCH_ALIASES = {
      'cosmos': ['gaia', 'cosmos'],
      'thor': ['thorchain'],
      'btc': ['bitcoin', 'btc'],
      'bitcoin': ['btc'],
      'eth': ['ethereum', 'eth'],
      'ethereum': ['eth'],
      'atom': ['gaia', 'cosmos'],
      'rune': ['thorchain'],
      'osmo': ['osmosis'],
    };

    const KNOWN_PROVIDERS = [
      { pubkey: 'arkeopub1addwnpepq2ydhpj50hpfepq03d0sgatwj7srpjrqnc63vk0z5eaqfverv3rqzprl70', name: 'Arkeo Foundation', location: 'Global' },
      { pubkey: 'arkeopub1addwnpepqdvlra44yykhmmpwtfavs35a5w6h8xqtuceedkuxur6v0gs8yfxa59h7wnm', name: '0xFury', location: 'Europe' },
    ];

    function getChainDisplayName(rawName) {
      if (CHAIN_DISPLAY_NAMES[rawName]) return CHAIN_DISPLAY_NAMES[rawName];
      // Clean up: remove -mainnet-fullnode, capitalize
      return rawName
        .replace(/-mainnet-(fullnode|archive|rest|rpc)/g, '')
        .replace(/-/g, ' ')
        .replace(/\b\w/g, c => c.toUpperCase());
    }

    function getChainIcon(rawName) {
      const lower = rawName.toLowerCase();
      for (const [key, icon] of Object.entries(CHAIN_ICONS)) {
        if (lower.includes(key)) return icon;
      }
      return 'üîó';
    }

    // ============================================================
    // STATE
    // ============================================================
    let state = {
      walletConnected: false,
      walletAddress: null,
      walletPubkey: null,
      walletPubkeyBytes: null,
      selectedService: null,
      services: [],
      rpcUrl: null,
      sentinelUrl: null,
      metadataUrl: null,
      providerName: 'My Arkeo Provider',
      providerDesc: '',
      providerLocation: '',
      paygRate: 1,
      currentStep: 1,
      arkeoHubUri: 'https://rest-seed.arkeo.network',
      arkeoFallbacks: [],
      maxQpm: 100,
      maxContractDuration: 5256000,  // ~8 months in blocks (chain max)
      minContractDuration: 10,       // 10 blocks default
    };

    // ============================================================
    // ARKEO NETWORK CONNECTION
    // ============================================================
    
    // Known community Arkeo endpoints ‚Äî add new ones here as validators open up
    const ARKEO_COMMUNITY_ENDPOINTS = [
      { url: 'https://red5-arkeo.duckdns.org/api', name: 'Red_5', operator: 'Red_5 Validator' },
      { url: 'https://rest-seed.arkeo.network', name: 'Arkeo Seed', operator: 'Arkeo Foundation' },
      { url: 'https://arkeo-api.polkachu.com', name: 'Polkachu', operator: 'Polkachu' },
      { url: 'https://arkeo-api.noders.services', name: 'NODERS', operator: 'NODERS' },
      { url: 'https://arkeo.api.nodeshub.online', name: 'NodesHub', operator: 'NodesHub' },
      { url: 'https://api-arkeo.busurnode.com', name: 'Busurnode', operator: 'Busurnode' },
    ];
    
    // Track health status
    let arkeoEndpointHealth = [];
    
    async function checkArkeoEndpoints() {
      const listDiv = document.getElementById('arkeoEndpointList');
      const statusDiv = document.getElementById('arkeoConnectionStatus');
      arkeoEndpointHealth = [];
      
      const checks = ARKEO_COMMUNITY_ENDPOINTS.map(async (ep) => {
        const start = Date.now();
        try {
          const resp = await fetch(ep.url + '/cosmos/base/tendermint/v1beta1/node_info', 
            { signal: AbortSignal.timeout(5000) });
          if (resp.ok) {
            const data = await resp.json();
            const latency = Date.now() - start;
            const network = data?.default_node_info?.network || '';
            const height = data?.default_node_info?.other?.tx_index || '';
            return { ...ep, online: network === 'arkeo-main-v1', latency, network };
          }
          return { ...ep, online: false, latency: 0 };
        } catch {
          return { ...ep, online: false, latency: 0 };
        }
      });
      
      arkeoEndpointHealth = await Promise.all(checks);
      
      // Sort: online first, then by latency
      arkeoEndpointHealth.sort((a, b) => {
        if (a.online && !b.online) return -1;
        if (!a.online && b.online) return 1;
        return a.latency - b.latency;
      });
      
      // Render endpoint list
      const onlineCount = arkeoEndpointHealth.filter(e => e.online).length;
      
      listDiv.innerHTML = arkeoEndpointHealth.map((ep, i) => `
        <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; 
               background: var(--bg-card); border: 1px solid ${ep.online ? 'var(--border)' : 'var(--error)'}; 
               border-radius: 0.5rem; cursor: ${ep.online ? 'pointer' : 'not-allowed'}; 
               opacity: ${ep.online ? '1' : '0.5'};">
          <input type="radio" name="arkeoEndpoint" value="${ep.url}" 
                 ${i === 0 && ep.online ? 'checked' : ''} 
                 ${!ep.online ? 'disabled' : ''}
                 onchange="selectArkeoEndpoint('${ep.url}', '${ep.name}')"
                 style="accent-color: var(--arkeo);">
          <div style="flex: 1;">
            <div style="font-weight: 600; font-size: 0.9rem;">${ep.name} <span style="font-weight: 400; color: var(--text-dim); font-size: 0.8rem;">by ${ep.operator}</span></div>
            <div style="font-size: 0.75rem; color: var(--text-dim); font-family: monospace;">${ep.url}</div>
          </div>
          <div style="text-align: right; min-width: 80px;">
            ${ep.online 
              ? `<span style="color: var(--success); font-size: 0.8rem;">‚óè Online</span><br><span style="font-size: 0.75rem; color: var(--text-dim);">${ep.latency}ms</span>`
              : `<span style="color: var(--error); font-size: 0.8rem;">‚óè Offline</span>`
            }
          </div>
        </label>
      `).join('');
      
      // Auto-select first healthy endpoint
      if (onlineCount > 0) {
        const best = arkeoEndpointHealth.find(e => e.online);
        selectArkeoEndpoint(best.url, best.name);
      } else {
        statusDiv.style.background = 'rgba(239,68,68,0.1)';
        statusDiv.style.borderColor = 'var(--error)';
        statusDiv.innerHTML = '‚ùå No community endpoints available. We strongly recommend running your own Arkeo node.';
      }
      
      // Add "total healthy" note
      if (onlineCount > 0 && onlineCount <= 2) {
        statusDiv.innerHTML += `<br><span style="color: var(--warning); font-size: 0.8rem;">‚ö†Ô∏è Only ${onlineCount} community endpoint${onlineCount > 1 ? 's' : ''} available. Consider running your own node for reliability.</span>`;
      }
    }
    
    function selectArkeoEndpoint(url, name) {
      const statusDiv = document.getElementById('arkeoConnectionStatus');
      const healthyEndpoints = arkeoEndpointHealth.filter(e => e.online);
      
      // Primary = selected, fallbacks = all other healthy ones
      state.arkeoHubUri = url;
      state.arkeoFallbacks = healthyEndpoints.filter(e => e.url !== url).map(e => e.url);
      
      statusDiv.style.background = 'var(--success-dim)';
      statusDiv.style.borderColor = 'var(--success)';
      let html = `‚úÖ Primary: <strong>${name}</strong>`;
      if (state.arkeoFallbacks.length > 0) {
        html += `<br><span style="font-size: 0.8rem; color: var(--text-dim);">üîÑ Failover: ${state.arkeoFallbacks.length} backup endpoint${state.arkeoFallbacks.length > 1 ? 's' : ''} configured</span>`;
      }
      statusDiv.innerHTML = html;
    }
    
    function updateArkeoConnection() {
      const choice = document.querySelector('input[name="arkeoConnection"]:checked').value;
      const customDiv = document.getElementById('arkeoCustomUrl');
      const publicDiv = document.getElementById('arkeoPublicSelect');
      const statusDiv = document.getElementById('arkeoConnectionStatus');
      const optA = document.getElementById('arkeoOptionA');
      const optB = document.getElementById('arkeoOptionB');
      
      if (choice === 'public') {
        customDiv.classList.add('hidden');
        publicDiv.classList.remove('hidden');
        optA.style.borderColor = 'var(--border)';
        optB.style.borderColor = 'var(--arkeo)';
        // Re-select from list
        const selected = document.querySelector('input[name="arkeoEndpoint"]:checked');
        if (selected) {
          const ep = arkeoEndpointHealth.find(e => e.url === selected.value);
          if (ep) selectArkeoEndpoint(ep.url, ep.name);
        } else {
          checkArkeoEndpoints();
        }
      } else {
        customDiv.classList.remove('hidden');
        publicDiv.classList.add('hidden');
        optA.style.borderColor = 'var(--arkeo)';
        optB.style.borderColor = 'var(--border)';
        state.arkeoFallbacks = [];
        const url = document.getElementById('arkeoNodeUrl').value.trim();
        if (!url) {
          statusDiv.style.background = 'var(--arkeo-dim)';
          statusDiv.style.borderColor = 'var(--arkeo)';
          statusDiv.innerHTML = '‚è≥ Enter your Arkeo node URL above';
        }
      }
    }
    
    async function validateArkeoUrl() {
      const url = document.getElementById('arkeoNodeUrl').value.trim();
      const statusDiv = document.getElementById('arkeoConnectionStatus');
      
      if (!url) {
        statusDiv.style.background = 'var(--arkeo-dim)';
        statusDiv.style.borderColor = 'var(--arkeo)';
        statusDiv.innerHTML = '‚è≥ Enter your Arkeo node URL above';
        return;
      }
      
      statusDiv.style.background = 'var(--arkeo-dim)';
      statusDiv.style.borderColor = 'var(--arkeo)';
      statusDiv.innerHTML = 'üîç Testing connection...';
      
      try {
        const testUrl = url.replace(/\/$/, '') + '/cosmos/base/tendermint/v1beta1/node_info';
        const resp = await fetch(testUrl, { signal: AbortSignal.timeout(5000) });
        if (resp.ok) {
          const data = await resp.json();
          const moniker = data?.default_node_info?.moniker || 'Unknown';
          const network = data?.default_node_info?.network || '';
          if (network === 'arkeo-main-v1') {
            state.arkeoHubUri = url.replace(/\/$/, '');
            state.arkeoFallbacks = [];
            statusDiv.style.background = 'var(--success-dim)';
            statusDiv.style.borderColor = 'var(--success)';
            statusDiv.innerHTML = `‚úÖ Connected to <strong>${moniker}</strong> (${network})<br><span style="font-size: 0.8rem; color: var(--text-dim);">üîí Fully independent ‚Äî no third-party dependency</span>`;
          } else {
            statusDiv.style.background = 'rgba(239,68,68,0.1)';
            statusDiv.style.borderColor = 'var(--error)';
            statusDiv.innerHTML = `‚ùå Node is on network "${network}" ‚Äî expected "arkeo-main-v1"`;
          }
        } else {
          statusDiv.style.background = 'rgba(239,68,68,0.1)';
          statusDiv.style.borderColor = 'var(--error)';
          statusDiv.innerHTML = '‚ùå Could not connect. Check the URL and make sure CORS is enabled.';
        }
      } catch (e) {
        statusDiv.style.background = 'rgba(239,68,68,0.1)';
        statusDiv.style.borderColor = 'var(--error)';
        statusDiv.innerHTML = '‚ùå Connection failed. Check the URL and try again.';
      }
    }

    // ============================================================
    // KEPLR INTEGRATION
    // ============================================================
    async function connectWallet() {
      const btn = document.getElementById('walletBtn');
      
      if (!window.keplr) {
        alert('Keplr wallet not found. Please install the Keplr browser extension.');
        window.open('https://www.keplr.app/', '_blank');
        return;
      }
      
      btn.disabled = true;
      btn.textContent = 'Connecting...';
      
      try {
        // Suggest chain to Keplr if not already added
        await suggestArkeoChain();
        
        // Enable the chain
        await window.keplr.enable(CONFIG.CHAIN_ID);
        
        // Get account info
        const offlineSigner = window.keplr.getOfflineSigner(CONFIG.CHAIN_ID);
        const accounts = await offlineSigner.getAccounts();
        
        if (accounts.length === 0) {
          throw new Error('No accounts found');
        }
        
        state.walletAddress = accounts[0].address;
        state.walletPubkeyBytes = accounts[0].pubkey;
        state.walletPubkey = bufferToBase64(accounts[0].pubkey);
        state.walletConnected = true;
        
        // Get the key info from Keplr
        const keyInfo = await window.keplr.getKey(CONFIG.CHAIN_ID);
        
        // Convert pubkey to arkeopub1... format
        state.walletPubkeyBech32 = pubkeyToBech32(accounts[0].pubkey, 'arkeopub');
        
        console.log('Wallet pubkey (base64):', state.walletPubkey);
        console.log('Wallet pubkey (bech32):', state.walletPubkeyBech32);
        
        // Update UI
        btn.textContent = `${state.walletAddress.slice(0, 10)}...${state.walletAddress.slice(-6)}`;
        btn.classList.add('connected');
        
        // If on step 4, update the UI
        if (state.currentStep === 4) {
          updateStep4UI();
        }
        
        console.log('Wallet connected:', state.walletAddress);
        
      } catch (err) {
        console.error('Wallet connection failed:', err);
        alert('Failed to connect wallet: ' + err.message);
        btn.textContent = 'Connect Keplr';
      }
      
      btn.disabled = false;
    }
    
    async function suggestArkeoChain() {
      try {
        await window.keplr.experimentalSuggestChain({
          chainId: CONFIG.CHAIN_ID,
          chainName: 'Arkeo Network',
          rpc: CONFIG.RPC_API,
          rest: CONFIG.REST_API,
          bip44: { coinType: 118 },
          bech32Config: {
            bech32PrefixAccAddr: 'arkeo',
            bech32PrefixAccPub: 'arkeopub',
            bech32PrefixValAddr: 'arkeovaloper',
            bech32PrefixValPub: 'arkeovaloperpub',
            bech32PrefixConsAddr: 'arkeovalcons',
            bech32PrefixConsPub: 'arkeovalconspub',
          },
          currencies: [{
            coinDenom: 'ARKEO',
            coinMinimalDenom: 'uarkeo',
            coinDecimals: 8,
          }],
          feeCurrencies: [{
            coinDenom: 'ARKEO',
            coinMinimalDenom: 'uarkeo',
            coinDecimals: 8,
            gasPriceStep: { low: 0.001, average: 0.002, high: 0.003 },
          }],
          stakeCurrency: {
            coinDenom: 'ARKEO',
            coinMinimalDenom: 'uarkeo',
            coinDecimals: 8,
          },
        });
      } catch (err) {
        console.log('Chain suggestion failed (may already exist):', err.message);
      }
    }

    // ============================================================
    // LOAD SERVICES FROM BLOCKCHAIN (sorted by marketplace demand)
    // ============================================================
    async function fetchAllContracts() {
      let allContracts = [];
      let nextKey = null;
      let page = 0;
      const maxPages = 20;
      
      do {
        const params = nextKey ? `?pagination.key=${encodeURIComponent(nextKey)}` : '';
        const response = await fetch(`${CONFIG.REST_API}/arkeo/contracts${params}`);
        if (!response.ok) throw new Error(`Contracts API returned ${response.status}`);
        const data = await response.json();
        const contracts = data.contract || data.contracts || [];
        allContracts = allContracts.concat(contracts);
        nextKey = data.pagination?.next_key || null;
        page++;
      } while (nextKey && page < maxPages);
      
      console.log(`Loaded ${allContracts.length} contracts across ${page} pages`);
      return allContracts;
    }
    
    function computeServiceDemand(contracts) {
      // Count active (deposit > paid) and total contracts per service
      const demand = {};
      for (const c of contracts) {
        const svc = c.service || c.service_id || '';
        if (!svc) continue;
        if (!demand[svc]) demand[svc] = { active: 0, total: 0 };
        demand[svc].total++;
        const deposit = parseInt(c.deposit || '0');
        const paid = parseInt(c.paid || '0');
        if (deposit > paid) demand[svc].active++;
      }
      return demand;
    }
    
    function getDemandIndicator(active) {
      if (active >= 5) return { icon: 'üî•', label: 'High demand', cls: 'demand-high' };
      if (active >= 2) return { icon: '‚ö°', label: 'Growing', cls: 'demand-growing' };
      if (active >= 1) return { icon: 'üìä', label: 'Some activity', cls: 'demand-some' };
      return { icon: '‚Äî', label: 'No contracts yet', cls: 'demand-none' };
    }
    
    async function loadServices() {
      const loadingDiv = document.getElementById('loadingChains');
      
      try {
        // Fetch services, contracts, and providers in parallel
        const [servicesRes, contracts, providersRes] = await Promise.all([
          fetch(`${CONFIG.REST_API}/arkeo/services`).then(r => { if (!r.ok) throw new Error(`${r.status}`); return r.json(); }),
          fetchAllContracts().catch(err => { console.warn('Contract fetch failed:', err); return []; }),
          fetch(`${CONFIG.REST_API}/arkeo/providers`).then(r => r.ok ? r.json() : null).catch(() => null),
        ]);
        
        // Count providers per service
        const providerCounts = {};
        if (providersRes) {
          const providers = providersRes.provider || providersRes.providers || [];
          for (const p of providers) {
            const svc = p.service || '';
            if (svc) providerCounts[svc] = (providerCounts[svc] || 0) + 1;
          }
        }
        
        // Parse services
        let services = servicesRes.services || servicesRes.service || [];
        if (Array.isArray(servicesRes)) services = servicesRes;
        
        state.services = services.map(s => ({
          id: s.service_id || s.id || s.service,
          name: s.name || `Service ${s.service_id || s.id}`,
          description: s.description || '',
        }));
        
        if (state.services.length === 0) {
          state.services = getDefaultServices();
        }
        
        // Compute demand from contracts
        state.serviceDemand = computeServiceDemand(contracts);
        
        // Enrich services with demand data and provider counts
        for (const svc of state.services) {
          const d = state.serviceDemand[svc.name] || state.serviceDemand[svc.id] || { active: 0, total: 0 };
          svc.activeContracts = d.active;
          svc.totalContracts = d.total;
          svc.providerCount = providerCounts[svc.name] || providerCounts[svc.id] || 0;
        }
        
        // Sort by active contracts (desc), then total contracts (desc), then name (asc)
        state.services.sort((a, b) => {
          if (b.activeContracts !== a.activeContracts) return b.activeContracts - a.activeContracts;
          if (b.totalContracts !== a.totalContracts) return b.totalContracts - a.totalContracts;
          return a.name.localeCompare(b.name);
        });
        
        loadingDiv.classList.add('hidden');
        renderServices(state.services);
        
      } catch (err) {
        console.error('Failed to load services:', err);
        state.services = getDefaultServices();
        state.serviceDemand = {};
        for (const svc of state.services) { svc.activeContracts = 0; svc.totalContracts = 0; }
        loadingDiv.innerHTML = `
          <span style="color: var(--warning);">‚ö†Ô∏è Using cached chain list (API unavailable)</span>
        `;
        setTimeout(() => {
          loadingDiv.classList.add('hidden');
          renderServices(state.services);
        }, 2000);
      }
    }
    
    function getDefaultServices() {
      return [
        { id: 1, name: 'arkeo-mainnet-fullnode', description: 'Arkeo Mainnet Full Node' },
        { id: 2, name: 'arkeo-mainnet-rest', description: 'Arkeo Mainnet REST API' },
        { id: 20, name: 'eth-mainnet-fullnode', description: 'Ethereum Mainnet Full Node' },
        { id: 21, name: 'eth-mainnet-archive', description: 'Ethereum Mainnet Archive' },
        { id: 30, name: 'btc-mainnet-fullnode', description: 'Bitcoin Mainnet Full Node' },
        { id: 40, name: 'cosmos-mainnet-fullnode', description: 'Cosmos Hub Full Node' },
        { id: 50, name: 'osmosis-mainnet-fullnode', description: 'Osmosis Mainnet Full Node' },
        { id: 74, name: 'thorchain-mainnet-fullnode', description: 'THORChain Mainnet Full Node' },
        { id: 89, name: 'base-mainnet-fullnode', description: 'Base Mainnet Full Node' },
      ];
    }
    
    function renderServices(services) {
      const grid = document.getElementById('chainGrid');
      
      grid.innerHTML = services.map(s => {
        const active = s.activeContracts || 0;
        const total = s.totalContracts || 0;
        const providerCount = s.providerCount || 0;
        const d = getDemandIndicator(active);
        const countText = active > 0 ? `${active} active contract${active !== 1 ? 's' : ''}` : (total > 0 ? `${total} total` : '');
        const displayName = getChainDisplayName(s.name);
        const icon = getChainIcon(s.name);
        
        return `
        <div class="chain-option" onclick="selectService(${s.id}, '${escapeHtml(s.name)}')">
          <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">${icon}</div>
          <div class="chain-name">${escapeHtml(displayName)}</div>
          <div class="chain-id">${escapeHtml(s.name)}</div>
          <div class="chain-demand ${d.cls}" title="${d.label}">
            <span>${d.icon}</span>
            <span class="demand-text">${countText || d.label}</span>
          </div>
          <div style="font-size: 0.65rem; color: var(--text-dim); margin-top: 0.25rem;">
            ${providerCount > 0 ? `üë• ${providerCount} provider${providerCount !== 1 ? 's' : ''}` : 'üÜï No providers yet'}
          </div>
        </div>`;
      }).join('');
    }
    
    function filterChains() {
      const search = document.getElementById('chainSearch').value.toLowerCase().trim();
      if (!search) { renderServices(state.services); return; }
      
      // Expand search term via aliases
      const aliasMatches = SEARCH_ALIASES[search] || [];
      
      const filtered = state.services.filter(s => {
        const name = s.name.toLowerCase();
        const displayName = getChainDisplayName(s.name).toLowerCase();
        if (name.includes(search) || displayName.includes(search) || String(s.id).includes(search)) return true;
        // Check aliases
        for (const alias of aliasMatches) {
          if (name.includes(alias) || displayName.includes(alias)) return true;
        }
        return false;
      });
      renderServices(filtered);
    }
    
    function selectService(id, name) {
      state.selectedService = { id, name };
      
      // Update UI
      document.querySelectorAll('.chain-option').forEach(el => {
        el.classList.remove('selected');
      });
      event.currentTarget.classList.add('selected');
      
      document.getElementById('nextBtn1').disabled = false;
      document.getElementById('selectedChainName').textContent = getChainDisplayName(name);
      
      // Save state
      saveState();
    }

    // ============================================================
    // INFRASTRUCTURE VALIDATION
    // ============================================================
    function validateRpcUrl() {
      const url = document.getElementById('rpcUrl').value;
      state.rpcUrl = url;
      checkStep2Ready();
      saveState();
      
      // Update sentinel command preview
      try {
        const parsed = new URL(url);
        document.getElementById('sentinelRpcPlaceholder').textContent = parsed.host;
      } catch {}
    }
    
    function validateSentinelUrl() {
      // Now handled in Step 6, kept for compatibility
    }
    
    function checkStep2Ready() {
      const rpcUrl = document.getElementById('rpcUrl').value;
      const btn = document.getElementById('nextBtn2');
      
      let rpcValid = false;
      try {
        new URL(rpcUrl);
        rpcValid = true;
      } catch {}
      
      btn.disabled = !rpcValid;
    }
    
    async function testEndpoints() {
      const rpcUrl = document.getElementById('rpcUrl').value;
      const rpcStatus = document.getElementById('rpcStatus');
      const btn = document.getElementById('nextBtn2');
      
      btn.disabled = true;
      
      // RPC URL: Don't test from browser ‚Äî it's a local/internal URL that only the sentinel connects to.
      // Just validate format.
      rpcStatus.innerHTML = `
        <div class="status-box success">
          <span>‚úÖ</span>
          <span>RPC URL saved ‚Äî your sentinel will connect to this internally.</span>
        </div>
      `;
      
      state.rpcUrl = rpcUrl;
      setTimeout(() => goToStep(3), 1000);
    }
    
    function proceedWithoutSentinelTest() {
      state.rpcUrl = document.getElementById('rpcUrl').value;
      goToStep(3);
    }
    
    // ============================================================
    // METADATA & CONFIGURATION
    // ============================================================
    function updateMetadataPreview() {
      state.providerName = document.getElementById('providerName').value || 'My Arkeo Provider';
      state.providerDesc = document.getElementById('providerDesc').value || '';
      state.providerLocation = document.getElementById('providerLocation').value || '';
      saveState();
      
      const metadata = {
        moniker: state.providerName,
        description: state.providerDesc,
        location: state.providerLocation,
        website: '',
        sentinel_url: state.sentinelUrl || ''
      };
      
      document.getElementById('metadataPreview').textContent = JSON.stringify(metadata, null, 2);
    }
    
    function copyMetadata() {
      const metadata = {
        moniker: state.providerName,
        description: state.providerDesc,
        location: state.providerLocation,
        website: '',
        sentinel_url: state.sentinelUrl || ''
      };
      
      navigator.clipboard.writeText(JSON.stringify(metadata, null, 2));
      event.target.textContent = '‚úì Copied!';
      setTimeout(() => event.target.textContent = 'üìã Copy Metadata JSON', 2000);
    }
    
    function validateMetadataUrl() {
      // Metadata URL now auto-generated from sentinel URL in Step 6
      // Kept for compatibility
    }
    
    function updateProtectionSummary() {
      const qpm = parseInt(document.getElementById('maxQpm').value) || 100;
      state.maxQpm = qpm;
      saveState();
      document.getElementById('protQpm').textContent = qpm.toLocaleString();
      document.getElementById('protTotal').textContent = (qpm * 10).toLocaleString();
    }
    
    // ============================================================
    // CONTRACT DURATION FUNCTIONS
    // ============================================================
    function setMaxDuration(blocks, label) {
      state.maxContractDuration = blocks;
      document.getElementById('maxContractDuration').value = blocks;
      updateMaxDurationDisplay();
      
      // Update active button state
      document.querySelectorAll('.duration-preset[onclick^="setMaxDuration"]').forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('data-blocks') == blocks) {
          btn.classList.add('active');
        }
      });
    }
    
    function setMaxDurationCustom() {
      const input = document.getElementById('maxContractDuration');
      input.focus();
      document.querySelectorAll('.duration-preset[onclick^="setMaxDuration"]').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
    }
    
    function updateMaxDurationDisplay() {
      const blocks = parseInt(document.getElementById('maxContractDuration').value) || 0;
      state.maxContractDuration = blocks;
      saveState();
      const humanEl = document.getElementById('maxDurationHuman');
      if (humanEl) {
        humanEl.textContent = blocksToHuman(blocks);
      }
    }
    
    function setMinDuration(blocks, label) {
      state.minContractDuration = blocks;
      document.getElementById('minContractDuration').value = blocks;
      updateMinDurationDisplay();
      
      // Update active button state
      document.querySelectorAll('.duration-preset[onclick^="setMinDuration"]').forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('data-blocks') == blocks) {
          btn.classList.add('active');
        }
      });
    }
    
    function setMinDurationCustom() {
      const input = document.getElementById('minContractDuration');
      input.focus();
      document.querySelectorAll('.duration-preset[onclick^="setMinDuration"]').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
    }
    
    function updateMinDurationDisplay() {
      const blocks = parseInt(document.getElementById('minContractDuration').value) || 0;
      state.minContractDuration = blocks;
      saveState();
      const humanEl = document.getElementById('minDurationHuman');
      if (humanEl) {
        humanEl.textContent = blocksToHuman(blocks);
      }
    }
    
    function blocksToHuman(blocks) {
      const SECONDS_PER_BLOCK = 4;
      const seconds = blocks * SECONDS_PER_BLOCK;
      
      const years = Math.floor(seconds / (365.25 * 24 * 3600));
      const months = Math.floor(seconds / (30.44 * 24 * 3600));
      const weeks = Math.floor(seconds / (7 * 24 * 3600));
      const days = Math.floor(seconds / (24 * 3600));
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor(seconds / 60);
      
      if (years >= 1) return `${years} year${years > 1 ? 's' : ''}`;
      if (months >= 1) return `${months} month${months > 1 ? 's' : ''}`;
      if (weeks >= 1) return `${weeks} week${weeks > 1 ? 's' : ''}`;
      if (days >= 1) return `${days} day${days > 1 ? 's' : ''}`;
      if (hours >= 1) return `${hours} hour${hours > 1 ? 's' : ''}`;
      if (minutes >= 1) return `${minutes} minute${minutes > 1 ? 's' : ''}`;
      return `~${seconds} seconds`;
    }

    // First updateSummary removed ‚Äî see second definition below which includes price calculator

    // ============================================================
    // STEP NAVIGATION
    // ============================================================
    function goToStep(step) {
      // Hide all steps
      for (let i = 1; i <= 7; i++) {
        const el = document.getElementById('step' + i);
        if (el) el.classList.add('hidden');
        if (i <= 4) {
          const dot = document.getElementById('dot' + i);
          const label = document.getElementById('label' + i);
          if (dot) {
            dot.classList.remove('active', 'complete');
            dot.innerHTML = i;
          }
          if (label) {
            label.classList.remove('active');
          }
        }
      }
      
      // Show current step
      document.getElementById('step' + step).classList.remove('hidden');
      
      // Update progress
      for (let i = 1; i <= Math.min(step, 4); i++) {
        const dot = document.getElementById('dot' + i);
        const label = document.getElementById('label' + i);
        if (i < step) {
          dot.classList.add('complete');
          dot.innerHTML = '‚úì';
        } else if (i === step) {
          dot.classList.add('active');
          label.classList.add('active');
        }
      }
      
      // Progress line
      const progressPercent = ((Math.min(step, 4) - 1) / 3) * 100;
      document.getElementById('progressLine').style.width = progressPercent + '%';
      
      state.currentStep = step;
      
      // Save state on step change
      saveState();
      
      // Step-specific updates
      if (step === 3) {
        updateSummary();
      }
      if (step === 4) {
        // Auto-connect wallet if not already connected
        if (!state.walletConnected) {
          connectWallet().then(() => updateStep4UI()).catch(() => updateStep4UI());
        } else {
          updateStep4UI();
        }
      }
      if (step === 6) {
        // Pre-fill RPC URL from Step 2 if available
        if (state.rpcUrl) {
          document.getElementById('sentinelConfigRpcUrl').value = state.rpcUrl;
        }
        // Pre-fill sentinel URL if already set
        if (state.sentinelUrl) {
          document.getElementById('sentinelPublicUrl').value = state.sentinelUrl;
        }
        updateInstallScript();
        updateSentinelConfig();
        updateMetadataJson();
      }
      if (step === 7) {
        // Initialize x402 setup wizard
        checkX402Prerequisites();
      }
    }
    
    function updateSummary() {
      const rate = parseInt(document.getElementById('paygRate').value) || 25000;
      state.paygRate = rate;
      
      // Update summary card
      const chainEl = document.getElementById('summaryChain');
      if (chainEl) chainEl.textContent = state.selectedService?.name || '-';
      const rpcEl = document.getElementById('summarySentinel') || document.getElementById('summaryRpc');
      if (rpcEl) rpcEl.textContent = state.rpcUrl || '-';
      const rateEl = document.getElementById('summaryRate');
      if (rateEl) rateEl.textContent = `${rate.toLocaleString()} uarkeo/req`;
      
      // Update price calculator
      const arkeoPerReq = rate / 100000000;
      const arkeoPer1k = arkeoPerReq * 1000;
      const arkeoPer1m = arkeoPerReq * 1000000;
      const arkeoPrice = 0.0139; // approximate ARKEO price in USD
      const usdPer1m = arkeoPer1m * arkeoPrice;
      
      const calcPerReq = document.getElementById('calcPerRequest');
      const calcPer1k = document.getElementById('calcPer1k');
      const calcPer1m = document.getElementById('calcPer1m');
      const calcUsd = document.getElementById('calcUsd');
      
      if (calcPerReq) calcPerReq.textContent = `${arkeoPerReq.toFixed(8)} ARKEO`;
      if (calcPer1k) calcPer1k.textContent = `${arkeoPer1k < 0.01 ? arkeoPer1k.toFixed(6) : arkeoPer1k.toFixed(4)} ARKEO`;
      if (calcPer1m) calcPer1m.textContent = `${arkeoPer1m < 1 ? arkeoPer1m.toFixed(4) : arkeoPer1m.toFixed(2)} ARKEO`;
      if (calcUsd) calcUsd.textContent = `~$${usdPer1m < 0.01 ? usdPer1m.toFixed(4) : usdPer1m.toFixed(2)}`;
    }
    
    function updateStep4UI() {
      const walletRequired = document.getElementById('walletRequired');
      const registrationSteps = document.getElementById('registrationSteps');
      
      if (state.walletConnected) {
        walletRequired.classList.add('hidden');
        registrationSteps.classList.remove('hidden');
        
        document.getElementById('regChain').textContent = state.selectedService?.name || '-';
        document.getElementById('regWallet').textContent = state.walletAddress;
        document.getElementById('regSentinel').textContent = state.sentinelUrl || '-';
        document.getElementById('regRate').textContent = `${state.paygRate} uarkeo/req`;
      } else {
        walletRequired.classList.remove('hidden');
        registrationSteps.classList.add('hidden');
      }
    }
    
    // Helper to convert Uint8Array to base64
    function bufferToBase64(buffer) {
      let binary = '';
      const bytes = new Uint8Array(buffer);
      for (let i = 0; i < bytes.byteLength; i++) {
        binary += String.fromCharCode(bytes[i]);
      }
      return btoa(binary);
    }
    
    // Convert pubkey bytes to bech32 format (arkeopub1...)
    function pubkeyToBech32(pubkeyBytes, prefix) {
      // Amino prefix for secp256k1 pubkey: eb5ae98721
      const aminoPrefix = [0xeb, 0x5a, 0xe9, 0x87, 0x21];
      const pubkey = new Uint8Array(pubkeyBytes);
      
      // Combine amino prefix + pubkey
      const combined = new Uint8Array(aminoPrefix.length + pubkey.length);
      combined.set(aminoPrefix);
      combined.set(pubkey, aminoPrefix.length);
      
      // Convert to 5-bit groups for bech32
      const words = toWords(combined);
      
      // Encode as bech32
      return bech32Encode(prefix, words);
    }
    
    // Convert bytes to 5-bit words
    function toWords(bytes) {
      const words = [];
      let value = 0;
      let bits = 0;
      
      for (const byte of bytes) {
        value = (value << 8) | byte;
        bits += 8;
        while (bits >= 5) {
          bits -= 5;
          words.push((value >> bits) & 0x1f);
        }
      }
      
      if (bits > 0) {
        words.push((value << (5 - bits)) & 0x1f);
      }
      
      return words;
    }
    
    // Bech32 encoding
    function bech32Encode(prefix, words) {
      const CHARSET = 'qpzry9x8gf2tvdw0s3jn54khce6mua7l';
      const GENERATOR = [0x3b6a57b2, 0x26508e6d, 0x1ea119fa, 0x3d4233dd, 0x2a1462b3];
      
      function polymod(values) {
        let chk = 1;
        for (const v of values) {
          const top = chk >> 25;
          chk = ((chk & 0x1ffffff) << 5) ^ v;
          for (let i = 0; i < 5; i++) {
            if ((top >> i) & 1) chk ^= GENERATOR[i];
          }
        }
        return chk;
      }
      
      function hrpExpand(hrp) {
        const result = [];
        for (const c of hrp) {
          result.push(c.charCodeAt(0) >> 5);
        }
        result.push(0);
        for (const c of hrp) {
          result.push(c.charCodeAt(0) & 31);
        }
        return result;
      }
      
      function createChecksum(hrp, data) {
        const values = hrpExpand(hrp).concat(data).concat([0, 0, 0, 0, 0, 0]);
        const mod = polymod(values) ^ 1;
        const result = [];
        for (let i = 0; i < 6; i++) {
          result.push((mod >> (5 * (5 - i))) & 31);
        }
        return result;
      }
      
      const checksum = createChecksum(prefix, words);
      const combined = words.concat(checksum);
      let result = prefix + '1';
      for (const w of combined) {
        result += CHARSET[w];
      }
      return result;
    }

    // ============================================================
    // PROVIDER REGISTRATION (ON-CHAIN)
    // ============================================================
    async function registerProvider() {
      if (!state.walletConnected) {
        alert('Please connect your wallet first.');
        return;
      }
      
      const btn = document.getElementById('registerBtn');
      const statusDiv = document.getElementById('txStatus');
      const tx1Status = document.getElementById('tx1Status');
      const tx2Status = document.getElementById('tx2Status');
      const tx1Icon = document.getElementById('tx1Icon');
      const tx2Icon = document.getElementById('tx2Icon');
      
      btn.disabled = true;
      
      // Get pubkey bytes ‚Äî auto-reconnect wallet if needed
      if (!state.walletPubkeyBytes) {
        try {
          await connectWallet();
        } catch (e) {
          console.error('Auto-reconnect failed:', e);
        }
      }
      const pubkeyBytes = state.walletPubkeyBytes;
      if (!pubkeyBytes) {
        statusDiv.innerHTML = `
          <div class="status-box error">
            <span>‚ùå</span>
            <span>Could not get wallet public key. Please click the Connect Wallet button in the top right and try again.</span>
          </div>
        `;
        btn.disabled = false;
        return;
      }
      
      let bondTxHash = null;
      let modTxHash = null;
      
      try {
        // ============================================================
        // TRANSACTION 1: Bond Provider
        // ============================================================
        tx1Status.style.background = 'var(--arkeo-dim)';
        tx1Status.style.borderColor = 'var(--arkeo)';
        tx1Icon.textContent = 'üîÑ';
        
        showLoading('Transaction 1 of 2', 'Bond Provider - Approve in Keplr');
        
        const accountInfo1 = await getAccountInfo(state.walletAddress);
        
        // Use Direct signing with proper protobuf encoding
        const offlineSigner = window.keplr.getOfflineSignerOnlyAmino(CONFIG.CHAIN_ID);
        
        const bondMsg = {
          typeUrl: '/arkeo.arkeo.MsgBondProvider',
          value: {
            creator: state.walletAddress,
            provider: state.walletPubkeyBech32,
            service: state.selectedService.name,  // Use name not ID
            bond: "100000000",
          }
        };
        
        console.log('Bond message:', JSON.stringify(bondMsg, null, 2));
        
        const bondResult = await signAndBroadcastDirect(bondMsg, accountInfo1);
        
        if (bondResult.code !== 0) {
          throw new Error(`Bond failed: ${bondResult.rawLog || 'Unknown error'}`);
        }
        
        bondTxHash = bondResult.transactionHash;
        tx1Icon.textContent = '‚úÖ';
        tx1Status.style.background = 'var(--success-dim)';
        tx1Status.style.borderColor = 'var(--success)';
        
        // ============================================================
        // TRANSACTION 2: Mod Provider (configure service)
        // ============================================================
        tx2Status.style.background = 'var(--arkeo-dim)';
        tx2Status.style.borderColor = 'var(--arkeo)';
        tx2Icon.textContent = 'üîÑ';
        
        showLoading('Transaction 2 of 2', 'Waiting for chain to confirm bond...');
        
        // Wait for the bond TX to be confirmed and sequence to update
        // Poll until sequence increments (up to 30 seconds)
        const prevSeq = accountInfo1.sequence;
        let accountInfo2 = null;
        for (let i = 0; i < 15; i++) {
          await new Promise(r => setTimeout(r, 2000));
          accountInfo2 = await getAccountInfo(state.walletAddress);
          if (parseInt(accountInfo2.sequence) > parseInt(prevSeq)) break;
        }
        if (!accountInfo2 || parseInt(accountInfo2.sequence) <= parseInt(prevSeq)) {
          // Force increment as fallback
          accountInfo2 = { ...accountInfo, sequence: String(parseInt(prevSeq) + 1) };
        }
        
        showLoading('Transaction 2 of 2', 'Configure Service - Approve in Keplr');
        
        // Build metadata URL from sentinel URL
        const metadataUrl = state.sentinelUrl ? state.sentinelUrl.replace(/\/$/, '') + '/metadata.json' : '';
        
        const modMsg = {
          typeUrl: '/arkeo.arkeo.MsgModProvider',
          value: {
            creator: state.walletAddress,
            provider: state.walletPubkeyBech32,
            service: state.selectedService.name,
            metadataUri: metadataUrl,
            metadataNonce: '1',
            status: 1, // ONLINE = 1
            minContractDuration: String(state.minContractDuration || 10),
            maxContractDuration: String(Math.min(state.maxContractDuration || 5256000, 5256000)),
            subscriptionRate: [{ denom: CONFIG.ARKEO_DENOM, amount: '1' }],  // Must be positive
            payAsYouGoRate: [{ denom: CONFIG.ARKEO_DENOM, amount: String(state.paygRate || '1') }],
            settlementDuration: '10',
          }
        };
        
        console.log('Metadata URL:', metadataUrl);
        
        console.log('Mod message:', JSON.stringify(modMsg, null, 2));
        
        const modResult = await signAndBroadcastDirect(modMsg, accountInfo2);
        
        if (modResult.code !== 0) {
          throw new Error(`Configure failed: ${modResult.rawLog || 'Unknown error'}`);
        }
        
        modTxHash = modResult.transactionHash;
        tx2Icon.textContent = '‚úÖ';
        tx2Status.style.background = 'var(--success-dim)';
        tx2Status.style.borderColor = 'var(--success)';
        
        hideLoading();
        
        // Show success
        statusDiv.innerHTML = `
          <div class="status-box success">
            <span>‚úÖ</span>
            <span>Provider registered successfully!</span>
          </div>
        `;
        
        // Update final screen
        document.getElementById('finalService').textContent = state.selectedService.name;
        document.getElementById('finalPubkey').textContent = state.walletPubkeyBech32 || state.walletAddress;
        document.getElementById('finalBondTx').innerHTML = `
          <a href="${CONFIG.EXPLORER_TX}${bondTxHash}" target="_blank" class="tx-link">
            ${bondTxHash.slice(0, 16)}...
          </a>
        `;
        
        // Clear state on successful registration completion
        clearState();
        
        setTimeout(() => goToStep(5), 2000);
        
      } catch (err) {
        hideLoading();
        console.error('Registration failed:', err);
        
        if (bondTxHash && !modTxHash) {
          // Bond succeeded but mod failed
          statusDiv.innerHTML = `
            <div class="status-box warning">
              <span>‚ö†Ô∏è</span>
              <span>Bond succeeded but configuration failed. You can retry configuration.</span>
            </div>
            <div class="status-box error" style="margin-top: 0.5rem;">
              <span>‚ùå</span>
              <span>${err.message}</span>
            </div>
          `;
          tx2Icon.textContent = '‚ùå';
        } else {
          statusDiv.innerHTML = `
            <div class="status-box error">
              <span>‚ùå</span>
              <span>Registration failed: ${err.message}</span>
            </div>
          `;
          tx1Icon.textContent = '‚ùå';
        }
        
        btn.disabled = false;
      }
    }
    
    async function getAccountInfo(address) {
      const response = await fetch(`${CONFIG.REST_API}/cosmos/auth/v1beta1/accounts/${address}`);
      const data = await response.json();
      
      const account = data.account?.base_account || data.account || {};
      return {
        accountNumber: account.account_number || '0',
        sequence: account.sequence || '0',
      };
    }
    
    async function signAndBroadcastDirect(msg, accountInfo) {
      // Initialize the Arkeo TX helper
      await window.arkeoTx.init();
      
      console.log('Signing message:', msg);
      console.log('Account info:', accountInfo);
      
      // Get pubkey bytes from state
      const pubkeyBytes = state.walletPubkeyBytes;
      if (!pubkeyBytes) {
        throw new Error('No wallet pubkey bytes available');
      }
      
      // Build TxBody
      const bodyBytes = window.arkeoTx.buildTxBody([msg], 'Registered via Arkeo Marketplace');
      console.log('TxBody bytes:', bodyBytes);
      
      // Build AuthInfo
      const authInfoBytes = window.arkeoTx.buildAuthInfo(
        pubkeyBytes,
        parseInt(accountInfo.sequence),
        '10000',  // fee amount
        300000    // gas limit
      );
      console.log('AuthInfo bytes:', authInfoBytes);
      
      // Create SignDoc for Keplr
      const signDoc = {
        bodyBytes: bodyBytes,
        authInfoBytes: authInfoBytes,
        chainId: CONFIG.CHAIN_ID,
        accountNumber: accountInfo.accountNumber
      };
      
      console.log('SignDoc:', signDoc);
      
      // Sign with Keplr's signDirect
      const signResponse = await window.keplr.signDirect(
        CONFIG.CHAIN_ID,
        state.walletAddress,
        signDoc
      );
      
      console.log('Sign response:', signResponse);
      
      // Build TxRaw with signature
      const signatureBytes = window.arkeoTx.base64ToBytes(signResponse.signature.signature);
      const txRawBytes = window.arkeoTx.buildTxRaw(
        signResponse.signed.bodyBytes,
        signResponse.signed.authInfoBytes,
        [signatureBytes]
      );
      
      console.log('TxRaw bytes length:', txRawBytes.length);
      
      // Convert to base64 for broadcast
      const txBytesBase64 = window.arkeoTx.bytesToBase64(txRawBytes);
      console.log('TX bytes (base64):', txBytesBase64.substring(0, 100) + '...');
      
      // Broadcast via REST
      const broadcastResponse = await fetch(`${CONFIG.REST_API}/cosmos/tx/v1beta1/txs`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          tx_bytes: txBytesBase64,
          mode: 'BROADCAST_MODE_SYNC',
        }),
      });
      
      const result = await broadcastResponse.json();
      console.log('Broadcast result:', result);
      
      if (result.tx_response) {
        if (result.tx_response.code !== 0) {
          throw new Error(`TX failed: ${result.tx_response.raw_log}`);
        }
        return {
          code: result.tx_response.code || 0,
          transactionHash: result.tx_response.txhash,
          rawLog: result.tx_response.raw_log,
        };
      }
      
      throw new Error(result.message || JSON.stringify(result));
    }
    
    function bufferToHex(buffer) {
      return Array.from(new Uint8Array(buffer))
        .map(b => b.toString(16).padStart(2, '0'))
        .join('')
        .toUpperCase();
    }

    function makeSignedTxBytes(signResponse) {
      const combined = JSON.stringify({
        body: signResponse.signed,
        auth_info: {
          signer_infos: [{
            public_key: signResponse.signature.pub_key,
            mode_info: { single: { mode: 'SIGN_MODE_LEGACY_AMINO_JSON' } },
            sequence: signResponse.signed.sequence,
          }],
          fee: signResponse.signed.fee,
        },
        signatures: [signResponse.signature.signature],
      });
      return btoa(combined);
    }

    // ============================================================
    // UTILITIES
    // ============================================================
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function showLoading(text, subtext) {
      document.getElementById('loadingText').textContent = text;
      document.getElementById('loadingSubtext').textContent = subtext || '';
      document.getElementById('loadingOverlay').classList.remove('hidden');
    }
    
    function hideLoading() {
      document.getElementById('loadingOverlay').classList.add('hidden');
    }

    // ============================================================
    // SENTINEL CONFIG GENERATOR
    // ============================================================
    function generateSentinelConfig() {
      const rpcUrl = document.getElementById('sentinelConfigRpcUrl').value || 'http://YOUR_NODE_IP:26657';
      const serviceName = state.selectedService?.name || 'arkeo-mainnet-fullnode';
      const pubkey = state.walletPubkeyBech32 || state.walletAddress || '<your_arkeopub>';
      const address = state.walletAddress || '<your_arkeo_address>';
      const date = new Date().toISOString().split('T')[0];

      return `# Arkeo Sentinel Configuration
# Generated by Arkeo Marketplace - ${date}
# Provider: ${address}

host: 0.0.0.0
port: 3636
provider_pubkey: ${pubkey}
source_chain: ${CONFIG.CHAIN_ID}
hub_provider_uri: ${state.arkeoHubUri}${state.arkeoFallbacks && state.arkeoFallbacks.length > 0 ? '\nhub_provider_fallbacks:\n' + state.arkeoFallbacks.map(u => '  - ' + u).join('\n') : ''}
event_stream_host: wss://rpc-seed.arkeo.network/websocket
free_rate_limit: 10
free_rate_limit_duration: 1m
contract_rate_limit: ${state.maxQpm || 100}
contract_rate_limit_duration: 1m
claims_enabled: true
claim_check_interval: 30m

services:
  - name: ${serviceName}
    rpc_url: ${rpcUrl}`;
    }

    function generateInstallScript() {
      const pubkey = state.walletPubkey || 'YOUR_PUBKEY';
      const rpcUrl = state.rpcUrl || 'http://localhost:26657';
      const serviceName = state.selectedService?.name || 'arkeo-mainnet-fullnode';
      // Strip protocol from domain if user types full URL
      let domain = (document.getElementById('sentinelDomain')?.value || '').trim()
        .replace(/^https?:\/\//, '').replace(/\/+$/, '');
      const hubUri = state.arkeoHubUri || 'https://rest-seed.arkeo.network';
      const fallbacks = (state.arkeoFallbacks || []).join(',');
      const moniker = (state.providerName || 'My Arkeo Provider').replace(/'/g, "\\'");
      const desc = (state.providerDesc || '').replace(/'/g, "\\'");
      const location = state.providerLocation || '';
      const freeRate = 10;
      const contractRate = state.maxQpm || 100;
      
      // Build env vars for the install script
      const envVars = [
        `PROVIDER_PUBKEY='${pubkey}'`,
        `SOURCE_CHAIN='${CONFIG.CHAIN_ID}'`,
        `HUB_URI='${hubUri}'`,
        `HUB_FALLBACKS='${fallbacks}'`,
        `SERVICE_NAME='${serviceName}'`,
        `RPC_URL='${rpcUrl}'`,
        `FREE_RATE_LIMIT='${freeRate}'`,
        `CONTRACT_RATE_LIMIT='${contractRate}'`,
        `MONIKER='${moniker}'`,
        `DESCRIPTION='${desc}'`,
        `LOCATION='${location}'`,
        `DOMAIN='${domain}'`,
      ].join(' \\\n  ');
      
      const scriptUrl = 'https://raw.githubusercontent.com/rbechtold69/arkeo-data-engine-v2/main/docs/scripts/sentinel-install.sh';
      
      return `curl -sL ${scriptUrl} | \\\n  ${envVars} \\\n  bash`;
    }
    
    function updateInstallScript() {
      const el = document.getElementById('installCommand');
      if (el) el.textContent = generateInstallScript();
      
      // Auto-fill sentinel URL from domain
      const domain = (document.getElementById('sentinelDomain')?.value || '').trim();
      const urlInput = document.getElementById('sentinelPublicUrl');
      if (domain && urlInput) {
        const cleanDomain = domain.replace(/^https?:\/\//, '');
        urlInput.value = 'https://' + cleanDomain;
        state.sentinelUrl = 'https://' + cleanDomain;
      }
      
      updateSentinelConfig();
      updateMetadataJson();
      updateCurlTestCmd();
    }
    
    function copyInstallScript() {
      const script = generateInstallScript();
      navigator.clipboard.writeText(script);
      const btn = document.getElementById('copyInstallBtn');
      btn.textContent = '‚úì Copied!';
      setTimeout(() => btn.textContent = 'üìã Copy', 2000);
    }
    
    function onSentinelPublicUrlChange() {
      let url = document.getElementById('sentinelPublicUrl').value.trim();
      // Fix double protocol
      url = url.replace(/^https?:\/\/https?:\/\//, 'https://');
      state.sentinelUrl = url;
      saveState();
      updateSentinelConfig();
      updateMetadataJson();
      updateCurlTestCmd();
    }

    function updateMetadataJson() {
      const el = document.getElementById('metadataJsonPreview');
      if (!el) return;
      const meta = {
        moniker: state.providerName || 'My Arkeo Provider',
        description: state.providerDesc || '',
        location: state.providerLocation || '',
        website: '',
        sentinel_url: state.sentinelUrl || '',
        port: '3636',
        source_chain: CONFIG.CHAIN_ID,
        provider_pubkey: state.walletPubkey ? 
          'arkeopub1addwnpep' + state.walletPubkey : '',
        free_tier_rate_limit: 10,
        services: [{
          name: state.selectedService?.name || '',
          id: state.selectedService?.id || '',
          type: 'rpc'
        }]
      };
      el.textContent = JSON.stringify(meta, null, 2);
    }

    function copyMetadataJson() {
      const el = document.getElementById('metadataJsonPreview');
      navigator.clipboard.writeText(el.textContent);
      const btn = event.target.closest('button');
      const orig = btn.textContent;
      btn.textContent = '‚úì Copied!';
      setTimeout(() => btn.textContent = orig, 2000);
    }

    function updateSentinelConfig() {
      const yaml = generateSentinelConfig();
      document.getElementById('sentinelConfigYaml').textContent = yaml;
      updateCurlTestCmd();
    }

    function updateCurlTestCmd() {
      const sentinelUrl = state.sentinelUrl || 'http://YOUR_SERVER_IP:3636';
      const serviceName = state.selectedService?.name || 'arkeo-mainnet-fullnode';
      const baseUrl = sentinelUrl.replace(/\/+$/, '');
      const el = document.getElementById('curlTestCmd');
      if (el) {
        el.textContent = `curl ${baseUrl}/${serviceName} -d '{"jsonrpc":"2.0","method":"health","id":1}'`;
      }
    }

    function copySentinelConfig() {
      const yaml = generateSentinelConfig();
      navigator.clipboard.writeText(yaml);
      const btn = event.target.closest('button');
      const orig = btn.textContent;
      btn.textContent = '‚úì Copied!';
      setTimeout(() => btn.textContent = orig, 2000);
    }

    async function runSelfTest() {
      const resultsDiv = document.getElementById('selfTestResults');
      const btn = document.getElementById('selfTestBtn');
      btn.disabled = true;

      // Derive base URL from metadata URI or sentinel URL
      let baseUrl = '';
      if (state.metadataUrl) {
        baseUrl = state.metadataUrl.replace(/\/metadata\.json\/?$/, '');
      } else if (state.sentinelUrl) {
        baseUrl = state.sentinelUrl.replace(/\/+$/, '');
      }

      if (!baseUrl) {
        resultsDiv.innerHTML = `<div class="status-box error"><span>‚ùå</span><span>No sentinel URL available. Please go back and set one.</span></div>`;
        btn.disabled = false;
        return;
      }

      const serviceName = state.selectedService?.name || '';
      const metaUrl = baseUrl + '/metadata.json';

      // Test 1: metadata
      resultsDiv.innerHTML = `<div class="status-box testing"><div class="spinner"></div><span>Testing metadata endpoint...</span></div>`;

      let metaOk = false;
      try {
        console.log('Testing metadata URL:', metaUrl);
        const resp = await fetch(metaUrl, { signal: AbortSignal.timeout(10000) });
        if (resp.ok) {
          metaOk = true;
          resultsDiv.innerHTML = `<div class="status-box success"><span>‚úÖ</span><span>Metadata endpoint responding! (${metaUrl})</span></div>`;
        } else {
          const body = await resp.text().catch(() => '');
          resultsDiv.innerHTML = `<div class="status-box error"><span>‚ùå</span><span>Metadata returned HTTP ${resp.status}: ${body.slice(0, 100)}</span></div>`;
        }
      } catch (e) {
        console.error('Metadata fetch error:', e);
        resultsDiv.innerHTML = `<div class="status-box error"><span>‚ùå</span><span>Could not reach metadata endpoint (${metaUrl}). Error: ${e.message || 'Unknown'}. Check the URL and try again.</span></div>`;
      }

      // Show "Set Metadata URI On-Chain" button after metadata test passes
      if (metaOk) {
        resultsDiv.innerHTML += `
          <div style="margin-top: 1.5rem; padding: 1.25rem; background: var(--arkeo-dim); border: 1px solid var(--arkeo); border-radius: 0.75rem;">
            <div style="font-weight: 600; margin-bottom: 0.75rem; font-size: 1rem;">üîó Set Metadata URI On-Chain</div>
            <div style="font-size: 0.85rem; color: var(--text-dim); margin-bottom: 1rem; line-height: 1.5;">
              Your sentinel is working! Now update your provider record on-chain to set the metadata_uri. This tells subscribers where to find your provider info.
            </div>
            <button onclick="setMetadataUriOnChain()" id="setMetadataBtn" class="btn btn-primary" style="width: 100%;">
              üì° Set Metadata URI On-Chain
            </button>
            <div id="metadataUriStatus" style="margin-top: 1rem;"></div>
          </div>
        `;
      }

      // Test 2: service health
      if (metaOk && serviceName) {
        const serviceUrl = baseUrl + '/' + serviceName;
        resultsDiv.innerHTML += `<div class="status-box testing" id="serviceTestStatus"><div class="spinner"></div><span>Testing service endpoint...</span></div>`;
        try {
          const rpcResp = await fetch(serviceUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ jsonrpc: '2.0', method: 'health', id: 1 }),
            signal: AbortSignal.timeout(10000),
          });
          const el = document.getElementById('serviceTestStatus');
          if (rpcResp.ok) {
            el.className = 'status-box success';
            el.innerHTML = `<span>‚úÖ</span><span>Service endpoint responding!</span>`;
          } else {
            el.className = 'status-box warning';
            el.innerHTML = `<span>‚ö†Ô∏è</span><span>Service returned HTTP ${rpcResp.status} ‚Äî may still be starting up.</span>`;
          }
        } catch (e) {
          const el = document.getElementById('serviceTestStatus');
          if (el) {
            el.className = 'status-box warning';
            el.innerHTML = `<span>‚ö†Ô∏è</span><span>Could not reach service endpoint from browser ‚Äî try curl from your server.</span>`;
          }
        }
      }

      btn.disabled = false;
    }
    
    // ============================================================
    // SET METADATA URI ON-CHAIN (TASK 1)
    // ============================================================
    async function setMetadataUriOnChain() {
      if (!state.walletConnected) {
        alert('Please connect your Keplr wallet first (top right corner).');
        return;
      }
      
      const btn = document.getElementById('setMetadataBtn');
      const statusDiv = document.getElementById('metadataUriStatus');
      btn.disabled = true;
      
      try {
        // Build metadata URL from sentinel URL
        const sentinelUrl = document.getElementById('sentinelPublicUrl').value.trim();
        if (!sentinelUrl) {
          throw new Error('No sentinel URL set');
        }
        const metadataUri = sentinelUrl.replace(/\/+$/, '') + '/metadata.json';
        
        statusDiv.innerHTML = `
          <div class="status-box testing">
            <div class="spinner"></div>
            <span>Building transaction...</span>
          </div>
        `;
        
        // If user skipped to step 6, fetch provider info from chain
        let serviceName = state.selectedService?.name || '';
        let providerData = null;
        if (state.walletPubkeyBech32) {
          try {
            const provResp = await fetch(`${CONFIG.REST_API}/arkeo/provider/${state.walletPubkeyBech32}/arkeo-mainnet-fullnode`);
            if (provResp.ok) {
              providerData = (await provResp.json()).provider;
              if (!serviceName) serviceName = 'arkeo-mainnet-fullnode';
            }
          } catch (e) { console.warn('Could not fetch provider from chain:', e); }
        }
        if (!serviceName) serviceName = 'arkeo-mainnet-fullnode';

        const accountInfo = await getAccountInfo(state.walletAddress);
        
        const modMsg = {
          typeUrl: '/arkeo.arkeo.MsgModProvider',
          value: {
            creator: state.walletAddress,
            provider: state.walletPubkeyBech32,
            service: serviceName,
            metadataUri: metadataUri,
            metadataNonce: String(Date.now()), // Increment nonce to signal update
            status: 1, // ONLINE
            minContractDuration: String(providerData?.min_contract_duration || state.minContractDuration || 10),
            maxContractDuration: String(providerData?.max_contract_duration || Math.min(state.maxContractDuration || 5256000, 5256000)),
            subscriptionRate: providerData?.subscription_rate || [{ denom: CONFIG.ARKEO_DENOM, amount: '1' }],
            payAsYouGoRate: providerData?.pay_as_you_go_rate || [{ denom: CONFIG.ARKEO_DENOM, amount: String(state.paygRate || 25000) }],
            settlementDuration: providerData?.settlement_duration || '10',
          }
        };
        
        console.log('MsgModProvider (metadata update):', modMsg);
        
        statusDiv.innerHTML = `
          <div class="status-box testing">
            <div class="spinner"></div>
            <span>Please approve in Keplr...</span>
          </div>
        `;
        
        const result = await signAndBroadcastDirect(modMsg, accountInfo);
        
        if (result.code !== 0) {
          throw new Error(`TX failed: ${result.rawLog || 'Unknown error'}`);
        }
        
        statusDiv.innerHTML = `
          <div class="status-box success">
            <span>‚úÖ</span>
            <span>Metadata URI set successfully!</span>
          </div>
          <div style="margin-top: 0.75rem; font-size: 0.85rem; color: var(--text-dim);">
            TX: <a href="${CONFIG.EXPLORER_TX}${result.transactionHash}" target="_blank" class="tx-link" style="word-break: break-all;">${result.transactionHash.slice(0, 16)}...</a>
          </div>
          <div style="margin-top: 0.75rem; padding: 0.75rem; background: var(--success-dim); border-radius: 0.5rem; font-size: 0.85rem;">
            Your metadata_uri is now: <code style="background: var(--bg-input); padding: 0.15rem 0.4rem; border-radius: 0.25rem; word-break: break-all;">${metadataUri}</code>
          </div>
        `;
        
      } catch (err) {
        console.error('Metadata URI update failed:', err);
        statusDiv.innerHTML = `
          <div class="status-box error">
            <span>‚ùå</span>
            <span>Failed: ${err.message}</span>
          </div>
        `;
        btn.disabled = false;
      }
    }
    
    // ============================================================
    // STATE PERSISTENCE (TASK 3)
    // ============================================================
    const STATE_KEY = 'arkeo_provider_state';
    
    function saveState() {
      try {
        const savedState = {
          currentStep: state.currentStep,
          selectedService: state.selectedService,
          rpcUrl: state.rpcUrl,
          sentinelUrl: state.sentinelUrl,
          providerName: state.providerName,
          providerDesc: state.providerDesc,
          providerLocation: state.providerLocation,
          paygRate: state.paygRate,
          maxQpm: state.maxQpm,
          maxContractDuration: state.maxContractDuration,
          minContractDuration: state.minContractDuration,
          arkeoHubUri: state.arkeoHubUri,
          arkeoFallbacks: state.arkeoFallbacks,
          walletAddress: state.walletAddress,
          timestamp: Date.now()
        };
        sessionStorage.setItem(STATE_KEY, JSON.stringify(savedState));
        console.log('[State] Saved:', savedState.currentStep);
      } catch (err) {
        console.error('[State] Save failed:', err);
      }
    }
    
    function restoreState() {
      try {
        const saved = sessionStorage.getItem(STATE_KEY);
        if (!saved) return false;
        
        const savedState = JSON.parse(saved);
        console.log('[State] Restoring:', savedState);
        
        // Restore state variables
        if (savedState.selectedService) state.selectedService = savedState.selectedService;
        if (savedState.rpcUrl) state.rpcUrl = savedState.rpcUrl;
        if (savedState.sentinelUrl) state.sentinelUrl = savedState.sentinelUrl;
        if (savedState.providerName) state.providerName = savedState.providerName;
        if (savedState.providerDesc) state.providerDesc = savedState.providerDesc;
        if (savedState.providerLocation) state.providerLocation = savedState.providerLocation;
        if (savedState.paygRate) state.paygRate = savedState.paygRate;
        if (savedState.maxQpm) state.maxQpm = savedState.maxQpm;
        if (savedState.maxContractDuration) state.maxContractDuration = savedState.maxContractDuration;
        if (savedState.minContractDuration) state.minContractDuration = savedState.minContractDuration;
        if (savedState.arkeoHubUri) state.arkeoHubUri = savedState.arkeoHubUri;
        if (savedState.arkeoFallbacks) state.arkeoFallbacks = savedState.arkeoFallbacks;
        if (savedState.walletAddress) state.walletAddress = savedState.walletAddress;
        
        // Restore form inputs
        if (savedState.rpcUrl) {
          const rpcInput = document.getElementById('rpcUrl');
          if (rpcInput) rpcInput.value = savedState.rpcUrl;
        }
        if (savedState.providerName) {
          const nameInput = document.getElementById('providerName');
          if (nameInput) nameInput.value = savedState.providerName;
        }
        if (savedState.providerDesc) {
          const descInput = document.getElementById('providerDesc');
          if (descInput) descInput.value = savedState.providerDesc;
        }
        if (savedState.providerLocation) {
          const locInput = document.getElementById('providerLocation');
          if (locInput) locInput.value = savedState.providerLocation;
        }
        if (savedState.paygRate) {
          const rateInput = document.getElementById('paygRate');
          if (rateInput) rateInput.value = savedState.paygRate;
        }
        if (savedState.maxQpm) {
          const qpmInput = document.getElementById('maxQpm');
          if (qpmInput) qpmInput.value = savedState.maxQpm;
        }
        if (savedState.maxContractDuration) {
          const maxDurInput = document.getElementById('maxContractDuration');
          if (maxDurInput) maxDurInput.value = savedState.maxContractDuration;
        }
        if (savedState.minContractDuration) {
          const minDurInput = document.getElementById('minContractDuration');
          if (minDurInput) minDurInput.value = savedState.minContractDuration;
        }
        if (savedState.sentinelUrl) {
          const sentinelInput = document.getElementById('sentinelPublicUrl');
          if (sentinelInput) sentinelInput.value = savedState.sentinelUrl;
        }
        
        // Restore step-specific UI
        if (savedState.currentStep && savedState.currentStep > 1) {
          setTimeout(() => {
            goToStep(savedState.currentStep);
            
            // Re-select chain if step >= 2
            if (savedState.currentStep >= 2 && savedState.selectedService) {
              document.querySelectorAll('.chain-option').forEach(el => {
                const chainName = el.querySelector('.chain-name')?.textContent;
                const displayName = getChainDisplayName(savedState.selectedService.name);
                if (chainName === displayName) {
                  el.classList.add('selected');
                }
              });
              document.getElementById('nextBtn1').disabled = false;
              document.getElementById('selectedChainName').textContent = getChainDisplayName(savedState.selectedService.name);
            }
          }, 100);
        }
        
        return true;
      } catch (err) {
        console.error('[State] Restore failed:', err);
        return false;
      }
    }
    
    function clearState() {
      try {
        sessionStorage.removeItem(STATE_KEY);
        console.log('[State] Cleared');
      } catch (err) {
        console.error('[State] Clear failed:', err);
      }
    }
    
    // ============================================================
    // X402 SETUP WIZARD
    // ============================================================
    let x402ContractId = null;
    let x402SigningKey = null;
    
    async function checkX402Prerequisites() {
      const checkDiv = document.getElementById('x402PrereqCheck');
      
      try {
        checkDiv.innerHTML = `
          <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
            <div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div>
            <span>Checking provider registration...</span>
          </div>
        `;
        
        // Check if user has a registered provider
        if (!state.registeredPubkey) {
          checkDiv.innerHTML = `
            <div style="padding: 0.75rem; background: rgba(239,68,68,0.1); border: 1px solid var(--error); border-radius: 0.5rem;">
              <div style="color: var(--error); font-weight: 600; margin-bottom: 0.25rem;">‚ùå Not Registered</div>
              <div style="font-size: 0.85rem; color: var(--text-dim);">
                You must complete provider registration first. Go back to Step 1 and register as a provider.
              </div>
            </div>
          `;
          return;
        }
        
        checkDiv.innerHTML = `
          <div style="padding: 0.75rem; background: var(--success-dim); border: 1px solid var(--success); border-radius: 0.5rem; margin-bottom: 0.5rem;">
            <div style="color: var(--success); font-weight: 600; margin-bottom: 0.25rem;">‚úÖ Provider Registered</div>
            <div style="font-size: 0.85rem; color: var(--text-dim);">
              Provider: ${state.registeredPubkey.slice(0, 20)}...
            </div>
          </div>
          <div style="padding: 0.75rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 0.5rem;">
            <div style="font-weight: 500; margin-bottom: 0.25rem;">‚úÖ Wallet Connected</div>
            <div style="font-size: 0.85rem; color: var(--text-dim);">
              ${state.walletAddress ? state.walletAddress.slice(0, 20) + '...' : 'Ready'}
            </div>
          </div>
        `;
        
        // Show Step 1
        document.getElementById('x402Step1').style.display = 'block';
        
      } catch (error) {
        console.error('x402 prerequisite check failed:', error);
        checkDiv.innerHTML = `
          <div style="padding: 0.75rem; background: rgba(239,68,68,0.1); border: 1px solid var(--error); border-radius: 0.5rem;">
            <div style="color: var(--error); font-weight: 600; margin-bottom: 0.25rem;">‚ùå Check Failed</div>
            <div style="font-size: 0.85rem; color: var(--text-dim);">
              ${error.message}
            </div>
          </div>
        `;
      }
    }
    
    async function createX402BackingContract() {
      const btn = document.getElementById('x402CreateContractBtn');
      const statusDiv = document.getElementById('x402ContractStatus');
      
      btn.disabled = true;
      btn.textContent = 'Creating Contract...';
      
      statusDiv.innerHTML = `
        <div style="padding: 0.75rem; background: var(--arkeo-dim); border: 1px solid var(--arkeo); border-radius: 0.5rem;">
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div>
            <span>Connecting to Keplr...</span>
          </div>
        </div>
      `;
      
      try {
        // Connect wallet if not already connected
        if (!state.walletConnected) {
          await connectWallet();
        }
        
        const depositAmount = parseFloat(document.getElementById('x402DepositAmount').value) || 10;
        const depositUarkeo = String(Math.floor(depositAmount * 100000000));
        const durationBlocks = parseInt(document.getElementById('x402Duration').value) || 648000;
        
        statusDiv.innerHTML = `
          <div style="padding: 0.75rem; background: var(--arkeo-dim); border: 1px solid var(--arkeo); border-radius: 0.5rem;">
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div>
              <span>Preparing transaction...</span>
            </div>
          </div>
        `;
        
        // Initialize Keplr
        await window.arkeoTx.init();
        
        // Get account info
        const accountResp = await fetch(`${CONFIG.REST_API}/cosmos/auth/v1beta1/accounts/${state.walletAddress}`);
        const accountData = await accountResp.json();
        const account = accountData.account?.base_account || accountData.account || {};
        
        // Get wallet pubkey
        const offlineSigner = window.keplr.getOfflineSigner(CONFIG.CHAIN_ID);
        const accounts = await offlineSigner.getAccounts();
        const walletPubkeyBytes = accounts[0].pubkey;
        const clientPubkey = pubkeyToBech32(walletPubkeyBytes, 'arkeopub');
        
        // Build MsgOpenContract for x402 backing
        const msg = {
          typeUrl: '/arkeo.arkeo.MsgOpenContract',
          value: {
            creator: state.walletAddress,
            provider: state.registeredPubkey,
            service: state.selectedService?.name || 'eth-mainnet-fullnode',
            client: clientPubkey,
            delegate: clientPubkey, // Will be updated with x402 key later
            contractType: 1, // PAY_AS_YOU_GO
            duration: String(durationBlocks),
            rate: { denom: CONFIG.ARKEO_DENOM, amount: String(state.paygRate || 25000) },
            deposit: depositUarkeo,
            settlementDuration: '10',
            authorization: 0, // STRICT
            queriesPerMinute: '100',
          }
        };
        
        console.log('Creating x402 backing contract:', msg);
        
        statusDiv.innerHTML = `
          <div style="padding: 0.75rem; background: var(--arkeo-dim); border: 1px solid var(--arkeo); border-radius: 0.5rem;">
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div>
              <span>Awaiting signature in Keplr...</span>
            </div>
          </div>
        `;
        
        // Build and sign transaction
        const bodyBytes = window.arkeoTx.buildTxBody([msg], 'x402 backing contract');
        const authInfoBytes = window.arkeoTx.buildAuthInfo(walletPubkeyBytes, parseInt(account.sequence || 0), '10000', 300000);
        
        const signDoc = {
          bodyBytes: bodyBytes,
          authInfoBytes: authInfoBytes,
          chainId: CONFIG.CHAIN_ID,
          accountNumber: account.account_number || '0'
        };
        
        const signResponse = await window.keplr.signDirect(CONFIG.CHAIN_ID, state.walletAddress, signDoc);
        
        statusDiv.innerHTML = `
          <div style="padding: 0.75rem; background: var(--arkeo-dim); border: 1px solid var(--arkeo); border-radius: 0.5rem;">
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div>
              <span>Broadcasting transaction...</span>
            </div>
          </div>
        `;
        
        // Build TxRaw and broadcast
        const signatureBytes = window.arkeoTx.base64ToBytes(signResponse.signature.signature);
        const txRawBytes = window.arkeoTx.buildTxRaw(signResponse.signed.bodyBytes, signResponse.signed.authInfoBytes, [signatureBytes]);
        const txBytesBase64 = window.arkeoTx.bytesToBase64(txRawBytes);
        
        const broadcastResponse = await fetch(`${CONFIG.REST_API}/cosmos/tx/v1beta1/txs`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tx_bytes: txBytesBase64, mode: 'BROADCAST_MODE_SYNC' }),
        });
        
        const result = await broadcastResponse.json();
        console.log('Broadcast result:', result);
        
        if (result.tx_response?.code !== 0) {
          throw new Error(result.tx_response?.raw_log || 'Transaction failed');
        }
        
        const txHash = result.tx_response.txhash;
        
        // Wait for confirmation
        statusDiv.innerHTML = `
          <div style="padding: 0.75rem; background: var(--arkeo-dim); border: 1px solid var(--arkeo); border-radius: 0.5rem;">
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div>
              <span>Waiting for confirmation...</span>
            </div>
          </div>
        `;
        
        let confirmed = false;
        for (let i = 0; i < 10; i++) {
          await new Promise(r => setTimeout(r, 3000));
          try {
            const txRes = await fetch(`${CONFIG.REST_API}/cosmos/tx/v1beta1/txs/${txHash}`);
            const txData = await txRes.json();
            if (txData.tx_response) {
              if (txData.tx_response.code !== 0) {
                throw new Error(txData.tx_response.raw_log || 'Transaction failed on-chain');
              }
              confirmed = true;
              // Try to extract contract ID from logs
              const logs = JSON.parse(txData.tx_response.raw_log || '[]');
              for (const log of logs) {
                for (const event of (log.events || [])) {
                  if (event.type === 'arkeo.arkeo.EventOpenContract') {
                    const contractIdAttr = event.attributes.find(a => a.key === 'contract_id');
                    if (contractIdAttr) {
                      x402ContractId = contractIdAttr.value;
                    }
                  }
                }
              }
              break;
            }
          } catch (e) {
            if (e.message.includes('failed on-chain')) throw e;
          }
        }
        
        if (!confirmed) {
          throw new Error('Transaction not confirmed within expected time');
        }
        
        statusDiv.innerHTML = `
          <div style="padding: 0.75rem; background: var(--success-dim); border: 1px solid var(--success); border-radius: 0.5rem;">
            <div style="color: var(--success); font-weight: 600; margin-bottom: 0.5rem;">‚úÖ Contract Created!</div>
            <div style="font-size: 0.85rem; color: var(--text-dim);">
              TX: <a href="${CONFIG.EXPLORER_TX}${txHash}" target="_blank" style="color: var(--arkeo);">${txHash.slice(0, 16)}...</a>
              ${x402ContractId ? `<br>Contract ID: ${x402ContractId}` : ''}
            </div>
          </div>
        `;
        
        // Show Step 2
        document.getElementById('x402Step2').style.display = 'block';
        
      } catch (error) {
        console.error('x402 contract creation failed:', error);
        statusDiv.innerHTML = `
          <div style="padding: 0.75rem; background: rgba(239,68,68,0.1); border: 1px solid var(--error); border-radius: 0.5rem;">
            <div style="color: var(--error); font-weight: 600; margin-bottom: 0.25rem;">‚ùå Contract Creation Failed</div>
            <div style="font-size: 0.85rem; color: var(--text-dim);">
              ${error.message}
            </div>
          </div>
        `;
        btn.disabled = false;
        btn.textContent = 'üîó Connect Keplr & Create Contract';
      }
    }
    
    function generateX402Key() {
      try {
        // Generate a new random private key (32 bytes)
        const privateKeyBytes = new Uint8Array(32);
        crypto.getRandomValues(privateKeyBytes);
        const privateKeyHex = Array.from(privateKeyBytes).map(b => b.toString(16).padStart(2, '0')).join('');
        
        x402SigningKey = {
          privateKeyHex
        };
        
        // Display the key
        document.getElementById('x402PublicKey').textContent = '(derived by admin from private key)';
        document.getElementById('x402Address').textContent = '(derived by admin from private key)';
        document.getElementById('x402PrivateKey').textContent = privateKeyHex;
        document.getElementById('x402KeyDisplay').style.display = 'block';
        
        // Show Step 3
        document.getElementById('x402Step3').style.display = 'block';
        
        // Update endpoint URL
        const serviceName = (state.selectedService?.name || 'eth').replace(/-mainnet.*/, '');
        // Build x402 URL from sentinel URL configured in Step 6
        const sentinelBase = (state.sentinelUrl || 'https://YOUR_SENTINEL_URL').replace(/\/+$/, '');
        const endpointUrl = `${sentinelBase}/x402/${serviceName}`;
        document.getElementById('x402EndpointUrl').textContent = endpointUrl;
        
      } catch (error) {
        console.error('Key generation failed:', error);
        alert('Key generation failed: ' + error.message);
      }
    }
    
    function copyX402Endpoint() {
      const url = document.getElementById('x402EndpointUrl').textContent;
      navigator.clipboard.writeText(url).then(() => {
        alert('Endpoint URL copied to clipboard!');
      });
    }
    
    async function testX402Endpoint() {
      const btn = document.getElementById('x402TestBtn');
      const result = document.getElementById('x402TestResult');
      
      btn.disabled = true;
      btn.textContent = '‚è≥ Testing...';
      
      result.innerHTML = `
        <div style="padding: 0.75rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 0.5rem;">
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <div class="spinner" style="width: 14px; height: 14px; border-width: 2px;"></div>
            <span style="font-size: 0.85rem; color: var(--text-dim);">Testing endpoint...</span>
          </div>
        </div>
      `;
      
      try {
        const serviceName = (state.selectedService?.name || 'eth').replace(/-mainnet.*/, '');
        const sentinelBase = (state.sentinelUrl || 'https://YOUR_SENTINEL_URL').replace(/\/+$/, '');
        const url = `${sentinelBase}/x402/${serviceName}`;
        
        const response = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ jsonrpc: '2.0', method: 'eth_blockNumber', params: [], id: 1 })
        }).catch(e => ({ status: 0, error: e.message }));
        
        if (response.status === 402) {
          result.innerHTML = `
            <div style="padding: 0.75rem; background: var(--success-dim); border: 1px solid var(--success); border-radius: 0.5rem;">
              <div style="color: var(--success); font-weight: 600; margin-bottom: 0.25rem;">‚úÖ Endpoint is Live!</div>
              <div style="font-size: 0.85rem; color: var(--text-dim);">
                Received proper 402 Payment Required response. Your x402 endpoint is configured correctly!
              </div>
            </div>
          `;
        } else if (response.status === 0) {
          result.innerHTML = `
            <div style="padding: 0.75rem; background: rgba(245,158,11,0.1); border: 1px solid var(--warning); border-radius: 0.5rem;">
              <div style="color: var(--warning); font-weight: 600; margin-bottom: 0.25rem;">‚ö†Ô∏è Not Yet Configured</div>
              <div style="font-size: 0.85rem; color: var(--text-dim);">
                Endpoint not reachable. Contact Arkeo admin to complete x402 proxy setup with your delegate key.
              </div>
            </div>
          `;
        } else {
          result.innerHTML = `
            <div style="padding: 0.75rem; background: rgba(245,158,11,0.1); border: 1px solid var(--warning); border-radius: 0.5rem;">
              <div style="color: var(--warning); font-weight: 600; margin-bottom: 0.25rem;">‚ö†Ô∏è Unexpected Response</div>
              <div style="font-size: 0.85rem; color: var(--text-dim);">
                Expected HTTP 402, got ${response.status}. The endpoint may not be configured yet.
              </div>
            </div>
          `;
        }
      } catch (error) {
        console.error('Test failed:', error);
        result.innerHTML = `
          <div style="padding: 0.75rem; background: rgba(239,68,68,0.1); border: 1px solid var(--error); border-radius: 0.5rem;">
            <div style="color: var(--error); font-weight: 600; margin-bottom: 0.25rem;">‚ùå Test Failed</div>
            <div style="font-size: 0.85rem; color: var(--text-dim);">
              ${error.message}
            </div>
          </div>
        `;
      } finally {
        btn.disabled = false;
        btn.textContent = 'üß™ Test Endpoint';
      }
    }

    // ============================================================
    // INITIALIZE
    // ============================================================
    document.addEventListener('DOMContentLoaded', () => {
      // Restore state first
      restoreState();
      
      // Allow ?step=N URL param to jump directly
      const urlStep = new URLSearchParams(window.location.search).get('step');
      if (urlStep && parseInt(urlStep) >= 1 && parseInt(urlStep) <= 6) {
        setTimeout(() => goToStep(parseInt(urlStep)), 200);
      }
      
      loadServices();
      checkArkeoEndpoints();
      
      // Check if Keplr is already connected
      if (window.keplr) {
        window.keplr.getKey(CONFIG.CHAIN_ID).then(key => {
          if (key) {
            state.walletAddress = key.bech32Address;
            state.walletPubkeyBytes = key.pubKey;
            state.walletPubkey = Buffer.from(key.pubKey).toString('base64');
            state.walletPubkeyBech32 = pubkeyToBech32(key.pubKey, 'arkeopub');
            state.walletConnected = true;
            
            const btn = document.getElementById('walletBtn');
            btn.textContent = `${state.walletAddress.slice(0, 10)}...${state.walletAddress.slice(-6)}`;
            btn.classList.add('connected');
          }
        }).catch(() => {});
      }
    });
    
    // Buffer polyfill for browser
    if (typeof Buffer === 'undefined') {
      window.Buffer = {
        from: (arr) => ({
          toString: (enc) => {
            if (enc === 'base64') {
              return btoa(String.fromCharCode.apply(null, arr));
            }
            return Array.from(arr).map(b => b.toString(16).padStart(2, '0')).join('');
          }
        })
      };
    }
  </script>
</body>
</html>

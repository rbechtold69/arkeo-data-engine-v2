<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Become a Provider | Arkeo Marketplace</title>
  <link rel="icon" type="image/png" href="images/arkeo-logo-200px_1.png">
  <!-- Arkeo transaction helper with protobuf encoding -->
  <script src="js/arkeo-tx.js"></script>
  <style>
    :root {
      --bg-main: #0C0E14;
      --bg-card: #151820;
      --bg-input: #1a1f2e;
      --border: #2a2f3c;
      --border-focus: #3BE0FF;
      --arkeo: #3BE0FF;
      --arkeo-dim: rgba(59, 224, 255, 0.1);
      --success: #10b981;
      --success-dim: rgba(16, 185, 129, 0.1);
      --warning: #f59e0b;
      --error: #ef4444;
      --text: #ffffff;
      --text-dim: #9ca3af;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      background: var(--bg-main);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      min-height: 100vh;
      line-height: 1.6;
    }
    
    /* Navigation */
    .nav {
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 1.25rem;
      font-weight: 700;
      text-decoration: none;
      color: var(--text);
    }
    .logo img { height: 36px; }
    .logo span { color: var(--arkeo); }
    
    .wallet-btn {
      background: var(--arkeo);
      color: #000;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.2s;
    }
    .wallet-btn:hover { opacity: 0.9; }
    .wallet-btn.connected {
      background: var(--success);
      color: white;
    }
    .wallet-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* Main Container */
    .container {
      max-width: 700px;
      margin: 0 auto;
      padding: 2rem;
    }
    
    /* Progress Bar */
    .progress-container { margin-bottom: 2rem; }
    .progress-steps {
      display: flex;
      justify-content: space-between;
      position: relative;
      margin-bottom: 0.5rem;
    }
    .progress-steps::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--border);
      transform: translateY(-50%);
      z-index: 0;
    }
    .progress-line {
      position: absolute;
      top: 50%;
      left: 0;
      height: 2px;
      background: var(--arkeo);
      transform: translateY(-50%);
      z-index: 1;
      transition: width 0.3s ease;
    }
    .step-dot {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--bg-card);
      border: 2px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.875rem;
      font-weight: 600;
      position: relative;
      z-index: 2;
      transition: all 0.3s;
    }
    .step-dot.active {
      border-color: var(--arkeo);
      background: var(--arkeo-dim);
      color: var(--arkeo);
    }
    .step-dot.complete {
      border-color: var(--success);
      background: var(--success);
      color: white;
    }
    .step-labels {
      display: flex;
      justify-content: space-between;
    }
    .step-label {
      font-size: 0.75rem;
      color: var(--text-dim);
      text-align: center;
      width: 80px;
    }
    .step-label.active { color: var(--arkeo); }
    
    /* Wizard Card */
    .wizard-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 1rem;
      padding: 2rem;
    }
    .wizard-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    .wizard-subtitle {
      color: var(--text-dim);
      margin-bottom: 1.5rem;
    }
    .hidden { display: none !important; }
    
    /* Chain Selection */
    .chain-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 0.75rem;
      margin-bottom: 1.5rem;
      max-height: 350px;
      overflow-y: auto;
    }
    .chain-option {
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 0.75rem;
      padding: 1rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    .chain-option:hover {
      border-color: var(--arkeo);
      background: var(--arkeo-dim);
    }
    .chain-option.selected {
      border-color: var(--arkeo);
      background: var(--arkeo-dim);
    }
    .chain-option img {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      margin-bottom: 0.5rem;
    }
    .chain-name {
      font-size: 0.875rem;
      font-weight: 500;
    }
    .chain-id {
      font-size: 0.7rem;
      color: var(--text-dim);
    }
    .chain-demand {
      font-size: 0.7rem;
      margin-top: 0.35rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.25rem;
    }
    .demand-text { opacity: 0.85; }
    .demand-high { color: #f97316; }
    .demand-growing { color: var(--arkeo); }
    .demand-some { color: var(--text-dim); }
    .demand-none { color: #4b5563; }
    
    /* Search */
    .search-box {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      background: var(--bg-input);
      color: var(--text);
      margin-bottom: 1rem;
    }
    .search-box:focus {
      outline: none;
      border-color: var(--arkeo);
    }
    
    /* Form Elements */
    .form-group { margin-bottom: 1.5rem; }
    .form-label {
      display: block;
      font-weight: 500;
      margin-bottom: 0.5rem;
    }
    .form-input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      background: var(--bg-input);
      color: var(--text);
      font-size: 1rem;
    }
    .form-input:focus {
      outline: none;
      border-color: var(--arkeo);
    }
    .form-hint {
      font-size: 0.8rem;
      color: var(--text-dim);
      margin-top: 0.25rem;
    }
    
    /* Buttons */
    .btn {
      padding: 0.875rem 1.5rem;
      border-radius: 0.5rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      font-size: 1rem;
    }
    .btn-primary {
      background: var(--arkeo);
      color: #000;
    }
    .btn-primary:hover { opacity: 0.9; }
    .btn-primary:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    .btn-secondary {
      background: var(--bg-input);
      color: var(--text);
      border: 1px solid var(--border);
    }
    .btn-secondary:hover {
      border-color: var(--arkeo);
    }
    .btn-group {
      display: flex;
      gap: 1rem;
      margin-top: 1.5rem;
    }
    
    /* Status Box */
    .status-box {
      padding: 1rem;
      border-radius: 0.5rem;
      margin: 1rem 0;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .status-box.success {
      background: var(--success-dim);
      border: 1px solid var(--success);
      color: var(--success);
    }
    .status-box.error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid var(--error);
      color: var(--error);
    }
    .status-box.testing {
      background: var(--arkeo-dim);
      border: 1px solid var(--arkeo);
      color: var(--arkeo);
    }
    .status-box.warning {
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid var(--warning);
      color: var(--warning);
    }
    
    /* Spinner */
    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid transparent;
      border-top-color: currentColor;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* Summary Card */
    .summary-card {
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 0.75rem;
      padding: 1.5rem;
      margin: 1rem 0;
    }
    .summary-row {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--border);
    }
    .summary-row:last-child { border-bottom: none; }
    .summary-label { color: var(--text-dim); }
    .summary-value { font-weight: 600; }
    
    /* TX Link */
    .tx-link {
      color: var(--arkeo);
      text-decoration: none;
      word-break: break-all;
    }
    .tx-link:hover { text-decoration: underline; }
    
    /* Success */
    .success-container { text-align: center; padding: 2rem 0; }
    .success-icon { font-size: 4rem; margin-bottom: 1rem; }
    .success-title { font-size: 1.75rem; margin-bottom: 0.5rem; }
    .success-subtitle { color: var(--text-dim); margin-bottom: 2rem; }
    
    /* Alerts */
    .alert {
      padding: 1rem;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
    }
    .alert-info {
      background: var(--arkeo-dim);
      border: 1px solid var(--arkeo);
      color: var(--arkeo);
    }
    .alert-warning {
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid var(--warning);
      color: var(--warning);
    }
    
    /* Mobile */
    @media (max-width: 600px) {
      .nav { padding: 0.75rem 1rem; flex-wrap: wrap; gap: 0.5rem; }
      .logo { font-size: 1rem; }
      .logo img { height: 28px; }
      .container { padding: 1rem; }
      .wizard-card { padding: 1.25rem; }
      .wizard-title { font-size: 1.25rem; }
      .chain-grid { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); }
      .btn-group { flex-direction: column; }
      .summary-row { flex-direction: column; gap: 0.25rem; }
      .form-input { font-size: 0.9rem; }
    }

    /* Loading overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .loading-text {
      margin-top: 1rem;
      font-size: 1.25rem;
    }
    .loading-subtext {
      margin-top: 0.5rem;
      color: var(--text-dim);
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="nav">
    <a href="index.html" class="logo">
      <img src="images/arkeo-logo-200px_1.png" alt="Arkeo">
      <span>Arkeo</span> Marketplace
    </a>
    <a href="index.html" class="wallet-btn" style="text-decoration: none; display: inline-flex; align-items: center;">
      ‚Üê Return to Marketplace
    </a>
  </nav>

  <div class="container">
    <!-- Progress Bar -->
    <div class="progress-container">
      <div class="progress-steps">
        <div class="progress-line" id="progressLine" style="width: 0%"></div>
        <div class="step-dot active" id="dot1">1</div>
        <div class="step-dot" id="dot2">2</div>
        <div class="step-dot" id="dot3">3</div>
        <div class="step-dot" id="dot4">4</div>
      </div>
      <div class="step-labels">
        <span class="step-label active" id="label1">Select Chain</span>
        <span class="step-label" id="label2">RPC Endpoint</span>
        <span class="step-label" id="label3">Set Rate</span>
        <span class="step-label" id="label4">Register</span>
      </div>
    </div>

    <!-- Step 1: Select Chain -->
    <div class="wizard-card" id="step1">
      <h2 class="wizard-title">Select Your Chain</h2>
      <p class="wizard-subtitle">Choose which blockchain data you want to provide.</p>
      
      <input type="text" class="search-box" id="chainSearch" 
             placeholder="Search chains..." oninput="filterChains()">
      
      <div id="loadingChains" class="status-box testing">
        <div class="spinner"></div>
        <span>Loading available chains from Arkeo network...</span>
      </div>
      
      <div class="chain-grid" id="chainGrid"></div>
      
      <div class="btn-group">
        <a href="index.html" class="btn btn-secondary">Cancel</a>
        <button class="btn btn-primary" id="nextBtn1" disabled onclick="goToStep(2)">
          Continue ‚Üí
        </button>
      </div>
    </div>

    <!-- Step 2: Infrastructure Setup -->
    <div class="wizard-card hidden" id="step2">
      <h2 class="wizard-title">Infrastructure Setup</h2>
      <p class="wizard-subtitle">Configure your <span id="selectedChainName">blockchain</span> node and sentinel.</p>
      
      <!-- Node RPC -->
      <div class="form-group">
        <label class="form-label">Your Node's RPC URL (internal)</label>
        <input type="url" class="form-input" id="rpcUrl" 
               placeholder="http://localhost:26657" oninput="validateRpcUrl()">
        <p class="form-hint">This is your local node's RPC endpoint. The sentinel will proxy requests to it.</p>
      </div>
      
      <div id="rpcStatus"></div>
      
      <!-- Sentinel Setup -->
      <div style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1.5rem; margin: 1.5rem 0;">
        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
          üõ°Ô∏è Sentinel Setup
          <span style="font-size: 0.75rem; background: var(--warning); color: #000; padding: 0.25rem 0.5rem; border-radius: 0.25rem;">Required</span>
        </h3>
        <p style="color: var(--text-dim); font-size: 0.9rem; margin-bottom: 1rem;">
          The sentinel is a proxy that sits in front of your node. It handles authentication, metering, and rate limiting.
        </p>
        
        <div style="background: #1a1f2e; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem; font-family: monospace; font-size: 0.85rem; overflow-x: auto;">
          <div style="color: var(--text-dim); margin-bottom: 0.5rem;"># Run on your node server (separate from validator):</div>
          <div style="color: #10b981;">docker run -d --name arkeo-sentinel \</div>
          <div style="color: #10b981; padding-left: 1rem;">-p 3636:3636 \</div>
          <div style="color: #10b981; padding-left: 1rem;">-e PROXY_HOST=<span id="sentinelRpcPlaceholder" style="color: var(--arkeo);">localhost:26657</span> \</div>
          <div style="color: #10b981; padding-left: 1rem;">ghcr.io/arkeonetwork/sentinel:latest</div>
        </div>
        
        <button class="btn btn-secondary" style="font-size: 0.8rem;" onclick="copySentinelCommand()">
          üìã Copy Command
        </button>
        
        <div class="alert alert-warning" style="margin-top: 1rem; font-size: 0.85rem;">
          ‚ö†Ô∏è <strong>Important:</strong> Port 3636 must be accessible from the internet. This is your sentinel's public endpoint.
        </div>
      </div>
      
      <!-- Sentinel URL -->
      <div class="form-group">
        <label class="form-label">Your Sentinel URL (public)</label>
        <input type="url" class="form-input" id="sentinelUrl" 
               placeholder="https://your-server.com:3636" oninput="validateSentinelUrl()">
        <p class="form-hint">The public URL where users will connect. Must include protocol (https recommended).</p>
      </div>
      
      <div id="sentinelStatus"></div>
      
      <div class="btn-group">
        <button class="btn btn-secondary" onclick="goToStep(1)">‚Üê Back</button>
        <button class="btn btn-primary" id="nextBtn2" disabled onclick="testEndpoints()">
          Test Connections ‚Üí
        </button>
      </div>
    </div>

    <!-- Step 3: Service Configuration -->
    <div class="wizard-card hidden" id="step3">
      <h2 class="wizard-title">Service Configuration</h2>
      <p class="wizard-subtitle">Set your pricing and provider metadata.</p>
      
      <div class="form-group">
        <label class="form-label">Pay-As-You-Go Rate (uarkeo per request)</label>
        <input type="number" class="form-input" id="paygRate" 
               value="1" min="1" step="1" oninput="updateSummary()">
        <p class="form-hint">1 ARKEO = 100,000,000 uarkeo. Example: 1 uarkeo = 0.00000001 ARKEO per request.</p>
      </div>
      
      <!-- Metadata Section -->
      <div style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1.5rem; margin: 1.5rem 0;">
        <h3 style="margin-bottom: 1rem;">üìÑ Provider Metadata</h3>
        <p style="color: var(--text-dim); font-size: 0.9rem; margin-bottom: 1rem;">
          Your metadata tells users about your service. Host this JSON file at a public URL.
        </p>
        
        <div class="form-group">
          <label class="form-label">Provider Name</label>
          <input type="text" class="form-input" id="providerName" 
                 placeholder="My Arkeo Provider" oninput="updateMetadataPreview()">
        </div>
        
        <div class="form-group">
          <label class="form-label">Description (optional)</label>
          <input type="text" class="form-input" id="providerDesc" 
                 placeholder="High-performance RPC node" oninput="updateMetadataPreview()">
        </div>
        
        <div class="form-group">
          <label class="form-label">Location (optional)</label>
          <select class="form-input" id="providerLocation" onchange="updateMetadataPreview()">
            <option value="">Select region...</option>
            <option value="NA">North America</option>
            <option value="EU">Europe</option>
            <option value="ASIA">Asia Pacific</option>
            <option value="SA">South America</option>
            <option value="AF">Africa</option>
            <option value="OC">Oceania</option>
          </select>
        </div>
        
        <div style="background: #1a1f2e; border-radius: 0.5rem; padding: 1rem; margin: 1rem 0; font-family: monospace; font-size: 0.8rem; overflow-x: auto;">
          <div style="color: var(--text-dim); margin-bottom: 0.5rem;">// metadata.json - host this at a public URL:</div>
          <pre id="metadataPreview" style="color: #10b981; margin: 0; white-space: pre-wrap;">{
  "moniker": "My Arkeo Provider",
  "description": "",
  "location": "",
  "website": "",
  "sentinel_url": ""
}</pre>
        </div>
        
        <button class="btn btn-secondary" style="font-size: 0.8rem;" onclick="copyMetadata()">
          üìã Copy Metadata JSON
        </button>
        
        <div class="form-group" style="margin-top: 1rem;">
          <label class="form-label">Metadata URL</label>
          <input type="url" class="form-input" id="metadataUrl" 
                 placeholder="https://your-server.com/metadata.json" oninput="validateMetadataUrl()">
          <p class="form-hint">Where you'll host the metadata.json file. Can be GitHub, your server, IPFS, etc.</p>
        </div>
      </div>
      
      <!-- Summary -->
      <div class="summary-card">
        <div class="summary-row">
          <span class="summary-label">Chain</span>
          <span class="summary-value" id="summaryChain">-</span>
        </div>
        <div class="summary-row">
          <span class="summary-label">Sentinel URL</span>
          <span class="summary-value" id="summarySentinel">-</span>
        </div>
        <div class="summary-row">
          <span class="summary-label">Rate</span>
          <span class="summary-value" id="summaryRate">1 uarkeo/req</span>
        </div>
        <div class="summary-row">
          <span class="summary-label">Bond Required</span>
          <span class="summary-value">1 ARKEO</span>
        </div>
      </div>
      
      <div class="alert alert-info">
        üí° You need at least <strong>1 ARKEO</strong> in your wallet for the provider bond, plus gas fees (~0.001 ARKEO).
      </div>
      
      <div class="btn-group">
        <button class="btn btn-secondary" onclick="goToStep(2)">‚Üê Back</button>
        <button class="btn btn-primary" id="nextBtn3" onclick="goToStep(4)">
          Continue ‚Üí
        </button>
      </div>
    </div>

    <!-- Step 4: Register On-Chain -->
    <div class="wizard-card hidden" id="step4">
      <h2 class="wizard-title">Register On-Chain</h2>
      <p class="wizard-subtitle">Sign two transactions to bond and configure your provider.</p>
      
      <div id="walletRequired" class="alert alert-warning">
        ‚ö†Ô∏è Please connect your Keplr wallet to continue.
      </div>
      
      <div id="registrationSteps" class="hidden">
        <!-- Transaction Overview -->
        <div style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.5rem;">
          <h3 style="margin-bottom: 1rem;">üìã Two Transactions Required</h3>
          
          <div style="display: flex; flex-direction: column; gap: 1rem;">
            <!-- TX 1: Bond -->
            <div id="tx1Status" style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: var(--arkeo-dim); border: 1px solid var(--arkeo); border-radius: 0.5rem;">
              <span style="font-size: 1.5rem;">1Ô∏è‚É£</span>
              <div style="flex: 1;">
                <div style="font-weight: 600;">Bond Provider</div>
                <div style="font-size: 0.85rem; color: var(--text-dim);">Lock 1 ARKEO as provider collateral</div>
              </div>
              <span id="tx1Icon" style="font-size: 1.25rem;">‚è≥</span>
            </div>
            
            <!-- TX 2: ModProvider -->
            <div id="tx2Status" style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 0.5rem;">
              <span style="font-size: 1.5rem;">2Ô∏è‚É£</span>
              <div style="flex: 1;">
                <div style="font-weight: 600;">Configure Service</div>
                <div style="font-size: 0.85rem; color: var(--text-dim);">Set rates, metadata, and activate provider</div>
              </div>
              <span id="tx2Icon" style="font-size: 1.25rem;">‚è≥</span>
            </div>
          </div>
        </div>
        
        <!-- Summary -->
        <div class="summary-card">
          <div class="summary-row">
            <span class="summary-label">Service</span>
            <span class="summary-value" id="regChain">-</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Wallet</span>
            <span class="summary-value" id="regWallet" style="font-size: 0.8rem;">-</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Sentinel URL</span>
            <span class="summary-value" id="regSentinel" style="font-size: 0.8rem;">-</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">PAYG Rate</span>
            <span class="summary-value" id="regRate">-</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Total Cost</span>
            <span class="summary-value">~1.001 ARKEO</span>
          </div>
        </div>
        
        <div class="alert alert-warning" style="font-size: 0.9rem;">
          ‚ö†Ô∏è <strong>Before signing:</strong> Make sure your sentinel is running and accessible at the URL you provided. You can update settings later, but the service won't work until sentinel is reachable.
        </div>
        
        <div id="txStatus"></div>
        
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="goToStep(3)">‚Üê Back</button>
          <button class="btn btn-primary" id="registerBtn" onclick="registerProvider()">
            Sign Transactions ‚Üí
          </button>
        </div>
      </div>
    </div>

    <!-- Step 5: Success -->
    <div class="wizard-card hidden" id="step5">
      <div class="success-container">
        <div class="success-icon">üéâ</div>
        <h2 class="success-title">You're Live!</h2>
        <p class="success-subtitle">Your provider is now registered on the Arkeo network.</p>
        
        <div class="summary-card" style="text-align: left;">
          <div class="summary-row">
            <span class="summary-label">Service</span>
            <span class="summary-value" id="finalService">-</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Provider Address</span>
            <span class="summary-value" id="finalPubkey" style="font-size: 0.75rem; word-break: break-all;">-</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Bond TX</span>
            <span class="summary-value" id="finalBondTx">-</span>
          </div>
        </div>
        
        <div class="alert alert-info" style="text-align: left;">
          <strong>‚úÖ Your provider should now appear in the marketplace!</strong><br>
          <span style="color: var(--text-dim);">
            Make sure your sentinel is running and accessible. Users can now open contracts with you.
          </span>
        </div>
        
        <div style="margin-top: 2rem; display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
          <a href="index.html" class="btn btn-primary">View Marketplace</a>
          <a href="subscribe.html" class="btn btn-secondary">Test Your Provider</a>
        </div>
      </div>
    </div>
  </div>

    <!-- Infrastructure Best Practices (collapsible) -->
    <div style="margin-top: 2rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 1rem; overflow: hidden;">
      <button onclick="this.parentElement.querySelector('.infra-body').classList.toggle('hidden'); this.querySelector('.infra-arrow').textContent = this.querySelector('.infra-arrow').textContent === '‚ñ∏' ? '‚ñæ' : '‚ñ∏';"
        style="width: 100%; padding: 1.25rem 1.5rem; background: none; border: none; color: var(--arkeo); font-size: 1.1rem; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 0.75rem; text-align: left;">
        <span class="infra-arrow">‚ñ∏</span> üõ°Ô∏è Infrastructure Best Practices
      </button>
      <div class="infra-body hidden" style="padding: 0 1.5rem 1.5rem; color: var(--text-dim); font-size: 0.9rem; line-height: 1.7;">

        <!-- Sentinel Rate Limiting -->
        <div style="margin-bottom: 1.5rem;">
          <h3 style="color: var(--text); margin-bottom: 0.5rem;">‚ö° Sentinel Rate Limiting</h3>
          <p>The Arkeo <strong>sentinel</strong> automatically enforces QPM (Queries Per Minute) limits per contract. Each contract has a <code style="background: var(--bg-input); padding: 0.15rem 0.4rem; border-radius: 0.25rem; font-size: 0.85rem;">queries_per_minute</code> field ‚Äî the sentinel will reject requests that exceed the contracted rate. No extra configuration needed on your end for per-contract enforcement.</p>
        </div>

        <!-- Recommended Infrastructure -->
        <div style="margin-bottom: 1.5rem;">
          <h3 style="color: var(--text); margin-bottom: 0.5rem;">üîß Recommended Infrastructure: Nginx Reverse Proxy</h3>
          <p style="margin-bottom: 0.75rem;">Place Nginx in front of your sentinel for additional rate limiting, TLS termination, and DDoS mitigation:</p>
          <div style="background: var(--bg-input); border-radius: 0.5rem; padding: 1rem; font-family: monospace; font-size: 0.8rem; overflow-x: auto; margin-bottom: 0.75rem; position: relative;">
            <button onclick="navigator.clipboard.writeText(this.parentElement.querySelector('pre').textContent); this.textContent='‚úì Copied!'; setTimeout(()=>this.textContent='üìã Copy',2000);"
              style="position: absolute; top: 0.5rem; right: 0.5rem; background: var(--bg-card); border: 1px solid var(--border); color: var(--text-dim); padding: 0.25rem 0.5rem; border-radius: 0.25rem; cursor: pointer; font-size: 0.75rem;">üìã Copy</button>
<pre style="color: #10b981; margin: 0; white-space: pre-wrap;"># /etc/nginx/conf.d/arkeo-sentinel.conf

# Rate limit zone: 100 requests/min per IP
limit_req_zone $binary_remote_addr zone=sentinel:10m rate=100r/m;

server {
    listen 443 ssl http2;
    server_name your-provider.example.com;

    ssl_certificate     /etc/letsencrypt/live/your-provider.example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-provider.example.com/privkey.pem;

    location / {
        limit_req zone=sentinel burst=20 nodelay;
        limit_req_status 429;

        proxy_pass http://127.0.0.1:3636;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}</pre>
          </div>
        </div>

        <!-- Hardware Guidelines -->
        <div style="margin-bottom: 1.5rem;">
          <h3 style="color: var(--text); margin-bottom: 0.75rem;">üíª Hardware Guidelines</h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem;">
            <div style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1rem;">
              <div style="font-weight: 600; color: var(--text); margin-bottom: 0.25rem;">üü¢ Light (&lt;100 QPM)</div>
              <div>2 CPU, 4 GB RAM</div>
              <div style="font-size: 0.8rem; color: var(--text-muted);">Suitable for low-traffic chains</div>
            </div>
            <div style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1rem;">
              <div style="font-weight: 600; color: var(--text); margin-bottom: 0.25rem;">üü° Medium (100‚Äì1000 QPM)</div>
              <div>4 CPU, 8 GB RAM</div>
              <div style="font-size: 0.8rem; color: var(--text-muted);">Most providers start here</div>
            </div>
            <div style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1rem;">
              <div style="font-weight: 600; color: var(--text); margin-bottom: 0.25rem;">üî¥ Heavy (1000+ QPM)</div>
              <div>8+ CPU, 16+ GB RAM, SSD</div>
              <div style="font-size: 0.8rem; color: var(--text-muted);">High-demand or archive nodes</div>
            </div>
          </div>
        </div>

        <!-- DDoS Protection -->
        <div style="margin-bottom: 1.5rem;">
          <h3 style="color: var(--text); margin-bottom: 0.5rem;">üõ°Ô∏è DDoS Protection</h3>
          <ul style="padding-left: 1.5rem; margin-bottom: 0.75rem;">
            <li><strong>Cloudflare (free tier)</strong> ‚Äî Proxy your domain through Cloudflare for automatic DDoS mitigation and TLS.</li>
            <li><strong>UFW firewall</strong> ‚Äî Allow only necessary ports:</li>
          </ul>
          <div style="background: var(--bg-input); border-radius: 0.5rem; padding: 1rem; font-family: monospace; font-size: 0.8rem; overflow-x: auto; margin-bottom: 0.75rem;">
<pre style="color: #10b981; margin: 0; white-space: pre-wrap;">sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow ssh
sudo ufw allow 443/tcp    # HTTPS (Nginx)
sudo ufw allow 3636/tcp   # Sentinel (if no Nginx proxy)
sudo ufw enable</pre>
          </div>
          <ul style="padding-left: 1.5rem;">
            <li><strong>fail2ban</strong> ‚Äî Auto-ban repeat offenders:</li>
          </ul>
          <div style="background: var(--bg-input); border-radius: 0.5rem; padding: 1rem; font-family: monospace; font-size: 0.8rem; overflow-x: auto;">
<pre style="color: #10b981; margin: 0; white-space: pre-wrap;">sudo apt install fail2ban
sudo systemctl enable fail2ban
# Default config bans after 5 failed SSH attempts</pre>
          </div>
        </div>

        <!-- Setting Your Max QPM -->
        <div>
          <h3 style="color: var(--text); margin-bottom: 0.5rem;">üìä Setting Your Max QPM</h3>
          <p style="margin-bottom: 0.5rem;">QPM is set <strong>per contract</strong> when a user opens a contract with you. To decide your per-contract QPM limit:</p>
          <div style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1rem; margin-bottom: 0.75rem; text-align: center;">
            <div style="color: var(--arkeo); font-weight: 700; font-size: 1.1rem;">Per-Contract QPM = Total Hardware Capacity √∑ Max Expected Contracts</div>
            <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem;">Example: 500 QPM capacity with up to 10 contracts ‚Üí set 50 QPM per contract</div>
          </div>
          <ul style="padding-left: 1.5rem;">
            <li>Benchmark your node under load to find your actual capacity.</li>
            <li>Leave 20‚Äì30% headroom for spikes.</li>
            <li>You can update QPM settings by modifying your provider configuration on-chain.</li>
          </ul>
        </div>

      </div>
    </div>
  </div>

    <!-- Accept x402 Payments (collapsible) -->
    <div style="margin-top: 2rem; background: var(--bg-card); border: 1px solid rgba(139,92,246,0.4); border-radius: 1rem; overflow: hidden;">
      <button onclick="this.parentElement.querySelector('.x402-body').classList.toggle('hidden'); this.querySelector('.x402-arrow').textContent = this.querySelector('.x402-arrow').textContent === '‚ñ∏' ? '‚ñæ' : '‚ñ∏';"
        style="width: 100%; padding: 1.25rem 1.5rem; background: none; border: none; color: #a78bfa; font-size: 1.1rem; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 0.75rem; text-align: left;">
        <span class="x402-arrow">‚ñ∏</span> ‚ö° Accept x402 Payments (USDC Micropayments)
        <span style="font-size: 0.7rem; background: linear-gradient(135deg, #8b5cf6, #3b82f6); color: #fff; padding: 0.2rem 0.6rem; border-radius: 0.25rem; font-weight: 600; margin-left: 0.5rem;">NEW</span>
      </button>
      <div class="x402-body hidden" style="padding: 0 1.5rem 1.5rem; color: var(--text-dim); font-size: 0.9rem; line-height: 1.7;">

        <p style="margin-bottom: 1rem;">
          <a href="https://x402.org" target="_blank" style="color: var(--arkeo);">x402</a> is Coinbase's open HTTP payment standard. It lets clients pay per request with USDC ‚Äî no accounts, no KYC. 
          Add x402 middleware to your sentinel to accept micropayments from AI agents and developers on <strong>Base network</strong> (low fees).
        </p>

        <!-- Step 1: Install -->
        <div style="margin-bottom: 1.5rem;">
          <h3 style="color: var(--text); margin-bottom: 0.5rem;">1. Install x402 packages</h3>
          <div style="background: var(--bg-input); border-radius: 0.5rem; padding: 1rem; font-family: monospace; font-size: 0.85rem; overflow-x: auto; position: relative;">
            <button onclick="navigator.clipboard.writeText('npm install @x402/express @x402/core @x402/evm'); this.textContent='‚úì Copied!'; setTimeout(()=>this.textContent='üìã Copy',2000);"
              style="position: absolute; top: 0.5rem; right: 0.5rem; background: var(--bg-card); border: 1px solid var(--border); color: var(--text-dim); padding: 0.25rem 0.5rem; border-radius: 0.25rem; cursor: pointer; font-size: 0.75rem;">üìã Copy</button>
            <pre style="color: #10b981; margin: 0;">npm install @x402/express @x402/core @x402/evm</pre>
          </div>
        </div>

        <!-- Step 2: Add Middleware -->
        <div style="margin-bottom: 1.5rem;">
          <h3 style="color: var(--text); margin-bottom: 0.5rem;">2. Add x402 middleware to your sentinel</h3>
          <div style="background: #0d1117; border: 1px solid var(--border); border-radius: 0.5rem; padding: 1rem; font-family: 'SF Mono', Monaco, monospace; font-size: 0.8rem; overflow-x: auto; position: relative;">
            <button onclick="navigator.clipboard.writeText(this.parentElement.querySelector('pre').textContent); this.textContent='‚úì Copied!'; setTimeout(()=>this.textContent='üìã Copy',2000);"
              style="position: absolute; top: 0.5rem; right: 0.5rem; background: var(--bg-card); border: 1px solid var(--border); color: var(--text-dim); padding: 0.25rem 0.5rem; border-radius: 0.25rem; cursor: pointer; font-size: 0.75rem;">üìã Copy</button>
<pre style="color: #e6edf3; margin: 0; white-space: pre-wrap;"><span style="color: #7ee787;">import</span> express <span style="color: #7ee787;">from</span> <span style="color: #a5d6ff;">"express"</span>;
<span style="color: #7ee787;">import</span> { paymentMiddleware } <span style="color: #7ee787;">from</span> <span style="color: #a5d6ff;">"@x402/express"</span>;
<span style="color: #7ee787;">import</span> { createVerifier } <span style="color: #7ee787;">from</span> <span style="color: #a5d6ff;">"@x402/evm"</span>;

<span style="color: #7ee787;">const</span> app = express();

<span style="color: #8b949e;">// Your wallet address to receive USDC payments</span>
<span style="color: #7ee787;">const</span> WALLET_ADDRESS = <span style="color: #a5d6ff;">"0xYourWalletAddress"</span>;

<span style="color: #8b949e;">// Configure x402 payment verification</span>
<span style="color: #7ee787;">const</span> verifier = createVerifier({
  <span style="color: #79c0ff;">network</span>: <span style="color: #a5d6ff;">"base"</span>,  <span style="color: #8b949e;">// Base network for low fees</span>
});

<span style="color: #8b949e;">// Protect your RPC endpoint with x402</span>
app.use(<span style="color: #a5d6ff;">"/rpc"</span>, paymentMiddleware(verifier, {
  <span style="color: #79c0ff;">recipient</span>: WALLET_ADDRESS,
  <span style="color: #79c0ff;">amount</span>: <span style="color: #a5d6ff;">"0.0001"</span>,  <span style="color: #8b949e;">// $0.0001 USDC per request</span>
  <span style="color: #79c0ff;">asset</span>: <span style="color: #a5d6ff;">"USDC"</span>,
}));

<span style="color: #8b949e;">// Proxy to your node</span>
app.post(<span style="color: #a5d6ff;">"/rpc"</span>, <span style="color: #7ee787;">async</span> (req, res) => {
  <span style="color: #7ee787;">const</span> response = <span style="color: #7ee787;">await</span> fetch(<span style="color: #a5d6ff;">"http://localhost:26657"</span>, {
    <span style="color: #79c0ff;">method</span>: <span style="color: #a5d6ff;">"POST"</span>,
    <span style="color: #79c0ff;">body</span>: JSON.stringify(req.body),
  });
  res.json(<span style="color: #7ee787;">await</span> response.json());
});

app.listen(<span style="color: #79c0ff;">3637</span>);</pre>
          </div>
        </div>

        <!-- Requirements -->
        <div style="margin-bottom: 1rem;">
          <h3 style="color: var(--text); margin-bottom: 0.5rem;">3. Requirements</h3>
          <ul style="padding-left: 1.5rem; margin-bottom: 0.75rem;">
            <li>An EVM wallet address to receive USDC payments</li>
            <li>Runs on <strong>Base network</strong> ‚Äî transaction fees are fractions of a cent</li>
            <li>Works alongside your existing Arkeo sentinel ‚Äî run on a different port</li>
            <li>Set your own per-request price in USDC</li>
          </ul>
        </div>

        <!-- Benefits -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem; margin-bottom: 1rem;">
          <div style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1rem;">
            <div style="font-weight: 600; color: var(--text); margin-bottom: 0.25rem;">ü§ñ AI Agent Revenue</div>
            <div style="font-size: 0.8rem;">Agents can't sign up for accounts ‚Äî x402 lets them pay automatically.</div>
          </div>
          <div style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1rem;">
            <div style="font-weight: 600; color: var(--text); margin-bottom: 0.25rem;">üí∏ Instant Settlement</div>
            <div style="font-size: 0.8rem;">USDC payments settle on Base ‚Äî no waiting for on-chain contract claims.</div>
          </div>
          <div style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1rem;">
            <div style="font-weight: 600; color: var(--text); margin-bottom: 0.25rem;">üåê HTTP Standard</div>
            <div style="font-size: 0.8rem;">Uses HTTP 402 status code ‚Äî works with any HTTP client.</div>
          </div>
        </div>

        <p>
          <a href="https://x402.org/docs/sellers" target="_blank" style="color: var(--arkeo);">Full x402 seller documentation ‚Üí</a>
        </p>

      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div class="loading-overlay hidden" id="loadingOverlay">
    <div class="spinner" style="width: 48px; height: 48px; border-width: 3px;"></div>
    <div class="loading-text" id="loadingText">Processing...</div>
    <div class="loading-subtext" id="loadingSubtext"></div>
  </div>

  <script>
    // ============================================================
    // CONFIGURATION
    // ============================================================
    const CONFIG = {
      REST_API: 'https://rest-seed.arkeo.network',
      RPC_API: 'https://rpc-seed.arkeo.network',
      CHAIN_ID: 'arkeo-main-v1',
      ARKEO_DENOM: 'uarkeo',
      ARKEO_DIVISOR: 100_000_000,
      MIN_BOND: '100000000', // 1 ARKEO in uarkeo
      DEFAULT_GAS: '200000',
      GAS_PRICE: '0.001uarkeo',
      EXPLORER_TX: 'https://explorer.arkeo.network/arkeo/tx/',
    };

    // ============================================================
    // DISPLAY NAME & ICON MAPS
    // ============================================================
    const CHAIN_DISPLAY_NAMES = {
      'gaia-mainnet-rpc': 'Cosmos Hub (RPC)',
      'gaia-mainnet-fullnode': 'Cosmos Hub',
      'eth-mainnet-fullnode': 'Ethereum',
      'eth-mainnet-archive': 'Ethereum (Archive)',
      'btc-mainnet-fullnode': 'Bitcoin',
      'arkeo-mainnet-fullnode': 'Arkeo',
      'arkeo-mainnet-rest': 'Arkeo (REST)',
      'osmosis-mainnet-fullnode': 'Osmosis',
      'thorchain-mainnet-fullnode': 'THORChain',
      'maya-mainnet-fullnode': 'Maya Protocol',
      'base-mainnet-fullnode': 'Base',
      'cosmos-mainnet-fullnode': 'Cosmos Hub',
    };

    const CHAIN_ICONS = {
      'eth': '‚ü†',
      'btc': '‚Çø',
      'gaia': '‚öõ',
      'cosmos': '‚öõ',
      'thorchain': '‚ö°',
      'osmosis': 'üåä',
      'arkeo': 'üî∑',
      'base': 'üîµ',
      'maya': 'üèõ',
    };

    const SEARCH_ALIASES = {
      'cosmos': ['gaia', 'cosmos'],
      'thor': ['thorchain'],
      'btc': ['bitcoin', 'btc'],
      'bitcoin': ['btc'],
      'eth': ['ethereum', 'eth'],
      'ethereum': ['eth'],
      'atom': ['gaia', 'cosmos'],
      'rune': ['thorchain'],
      'osmo': ['osmosis'],
    };

    const KNOWN_PROVIDERS = [
      { pubkey: 'arkeopub1addwnpepq2ydhpj50hpfepq03d0sgatwj7srpjrqnc63vk0z5eaqfverv3rqzprl70', name: 'Arkeo Foundation', location: 'Global' },
      { pubkey: 'arkeopub1addwnpepqdvlra44yykhmmpwtfavs35a5w6h8xqtuceedkuxur6v0gs8yfxa59h7wnm', name: '0xFury', location: 'Europe' },
    ];

    function getChainDisplayName(rawName) {
      if (CHAIN_DISPLAY_NAMES[rawName]) return CHAIN_DISPLAY_NAMES[rawName];
      // Clean up: remove -mainnet-fullnode, capitalize
      return rawName
        .replace(/-mainnet-(fullnode|archive|rest|rpc)/g, '')
        .replace(/-/g, ' ')
        .replace(/\b\w/g, c => c.toUpperCase());
    }

    function getChainIcon(rawName) {
      const lower = rawName.toLowerCase();
      for (const [key, icon] of Object.entries(CHAIN_ICONS)) {
        if (lower.includes(key)) return icon;
      }
      return 'üîó';
    }

    // ============================================================
    // STATE
    // ============================================================
    let state = {
      walletConnected: false,
      walletAddress: null,
      walletPubkey: null,
      walletPubkeyBytes: null,
      selectedService: null,
      services: [],
      rpcUrl: null,
      sentinelUrl: null,
      metadataUrl: null,
      providerName: 'My Arkeo Provider',
      providerDesc: '',
      providerLocation: '',
      paygRate: 1,
      currentStep: 1,
    };

    // ============================================================
    // KEPLR INTEGRATION
    // ============================================================
    async function connectWallet() {
      const btn = document.getElementById('walletBtn');
      
      if (!window.keplr) {
        alert('Keplr wallet not found. Please install the Keplr browser extension.');
        window.open('https://www.keplr.app/', '_blank');
        return;
      }
      
      btn.disabled = true;
      btn.textContent = 'Connecting...';
      
      try {
        // Suggest chain to Keplr if not already added
        await suggestArkeoChain();
        
        // Enable the chain
        await window.keplr.enable(CONFIG.CHAIN_ID);
        
        // Get account info
        const offlineSigner = window.keplr.getOfflineSigner(CONFIG.CHAIN_ID);
        const accounts = await offlineSigner.getAccounts();
        
        if (accounts.length === 0) {
          throw new Error('No accounts found');
        }
        
        state.walletAddress = accounts[0].address;
        state.walletPubkeyBytes = accounts[0].pubkey;
        state.walletPubkey = bufferToBase64(accounts[0].pubkey);
        state.walletConnected = true;
        
        // Get the key info from Keplr
        const keyInfo = await window.keplr.getKey(CONFIG.CHAIN_ID);
        
        // Convert pubkey to arkeopub1... format
        state.walletPubkeyBech32 = pubkeyToBech32(accounts[0].pubkey, 'arkeopub');
        
        console.log('Wallet pubkey (base64):', state.walletPubkey);
        console.log('Wallet pubkey (bech32):', state.walletPubkeyBech32);
        
        // Update UI
        btn.textContent = `${state.walletAddress.slice(0, 10)}...${state.walletAddress.slice(-6)}`;
        btn.classList.add('connected');
        
        // If on step 4, update the UI
        if (state.currentStep === 4) {
          updateStep4UI();
        }
        
        console.log('Wallet connected:', state.walletAddress);
        
      } catch (err) {
        console.error('Wallet connection failed:', err);
        alert('Failed to connect wallet: ' + err.message);
        btn.textContent = 'Connect Keplr';
      }
      
      btn.disabled = false;
    }
    
    async function suggestArkeoChain() {
      try {
        await window.keplr.experimentalSuggestChain({
          chainId: CONFIG.CHAIN_ID,
          chainName: 'Arkeo Network',
          rpc: CONFIG.RPC_API,
          rest: CONFIG.REST_API,
          bip44: { coinType: 118 },
          bech32Config: {
            bech32PrefixAccAddr: 'arkeo',
            bech32PrefixAccPub: 'arkeopub',
            bech32PrefixValAddr: 'arkeovaloper',
            bech32PrefixValPub: 'arkeovaloperpub',
            bech32PrefixConsAddr: 'arkeovalcons',
            bech32PrefixConsPub: 'arkeovalconspub',
          },
          currencies: [{
            coinDenom: 'ARKEO',
            coinMinimalDenom: 'uarkeo',
            coinDecimals: 8,
          }],
          feeCurrencies: [{
            coinDenom: 'ARKEO',
            coinMinimalDenom: 'uarkeo',
            coinDecimals: 8,
            gasPriceStep: { low: 0.001, average: 0.002, high: 0.003 },
          }],
          stakeCurrency: {
            coinDenom: 'ARKEO',
            coinMinimalDenom: 'uarkeo',
            coinDecimals: 8,
          },
        });
      } catch (err) {
        console.log('Chain suggestion failed (may already exist):', err.message);
      }
    }

    // ============================================================
    // LOAD SERVICES FROM BLOCKCHAIN (sorted by marketplace demand)
    // ============================================================
    async function fetchAllContracts() {
      let allContracts = [];
      let nextKey = null;
      let page = 0;
      const maxPages = 20;
      
      do {
        const params = nextKey ? `?pagination.key=${encodeURIComponent(nextKey)}` : '';
        const response = await fetch(`${CONFIG.REST_API}/arkeo/contracts${params}`);
        if (!response.ok) throw new Error(`Contracts API returned ${response.status}`);
        const data = await response.json();
        const contracts = data.contract || data.contracts || [];
        allContracts = allContracts.concat(contracts);
        nextKey = data.pagination?.next_key || null;
        page++;
      } while (nextKey && page < maxPages);
      
      console.log(`Loaded ${allContracts.length} contracts across ${page} pages`);
      return allContracts;
    }
    
    function computeServiceDemand(contracts) {
      // Count active (deposit > paid) and total contracts per service
      const demand = {};
      for (const c of contracts) {
        const svc = c.service || c.service_id || '';
        if (!svc) continue;
        if (!demand[svc]) demand[svc] = { active: 0, total: 0 };
        demand[svc].total++;
        const deposit = parseInt(c.deposit || '0');
        const paid = parseInt(c.paid || '0');
        if (deposit > paid) demand[svc].active++;
      }
      return demand;
    }
    
    function getDemandIndicator(active) {
      if (active >= 5) return { icon: 'üî•', label: 'High demand', cls: 'demand-high' };
      if (active >= 2) return { icon: '‚ö°', label: 'Growing', cls: 'demand-growing' };
      if (active >= 1) return { icon: 'üìä', label: 'Some activity', cls: 'demand-some' };
      return { icon: '‚Äî', label: 'No contracts yet', cls: 'demand-none' };
    }
    
    async function loadServices() {
      const loadingDiv = document.getElementById('loadingChains');
      
      try {
        // Fetch services, contracts, and providers in parallel
        const [servicesRes, contracts, providersRes] = await Promise.all([
          fetch(`${CONFIG.REST_API}/arkeo/services`).then(r => { if (!r.ok) throw new Error(`${r.status}`); return r.json(); }),
          fetchAllContracts().catch(err => { console.warn('Contract fetch failed:', err); return []; }),
          fetch(`${CONFIG.REST_API}/arkeo/providers`).then(r => r.ok ? r.json() : null).catch(() => null),
        ]);
        
        // Count providers per service
        const providerCounts = {};
        if (providersRes) {
          const providers = providersRes.provider || providersRes.providers || [];
          for (const p of providers) {
            const svc = p.service || '';
            if (svc) providerCounts[svc] = (providerCounts[svc] || 0) + 1;
          }
        }
        
        // Parse services
        let services = servicesRes.services || servicesRes.service || [];
        if (Array.isArray(servicesRes)) services = servicesRes;
        
        state.services = services.map(s => ({
          id: s.service_id || s.id || s.service,
          name: s.name || `Service ${s.service_id || s.id}`,
          description: s.description || '',
        }));
        
        if (state.services.length === 0) {
          state.services = getDefaultServices();
        }
        
        // Compute demand from contracts
        state.serviceDemand = computeServiceDemand(contracts);
        
        // Enrich services with demand data and provider counts
        for (const svc of state.services) {
          const d = state.serviceDemand[svc.name] || state.serviceDemand[svc.id] || { active: 0, total: 0 };
          svc.activeContracts = d.active;
          svc.totalContracts = d.total;
          svc.providerCount = providerCounts[svc.name] || 0;
        }
        
        // Sort by active contracts (desc), then total contracts (desc), then name (asc)
        state.services.sort((a, b) => {
          if (b.activeContracts !== a.activeContracts) return b.activeContracts - a.activeContracts;
          if (b.totalContracts !== a.totalContracts) return b.totalContracts - a.totalContracts;
          return a.name.localeCompare(b.name);
        });
        
        loadingDiv.classList.add('hidden');
        renderServices(state.services);
        
      } catch (err) {
        console.error('Failed to load services:', err);
        state.services = getDefaultServices();
        state.serviceDemand = {};
        for (const svc of state.services) { svc.activeContracts = 0; svc.totalContracts = 0; }
        loadingDiv.innerHTML = `
          <span style="color: var(--warning);">‚ö†Ô∏è Using cached chain list (API unavailable)</span>
        `;
        setTimeout(() => {
          loadingDiv.classList.add('hidden');
          renderServices(state.services);
        }, 2000);
      }
    }
    
    function getDefaultServices() {
      return [
        { id: 1, name: 'arkeo-mainnet-fullnode', description: 'Arkeo Mainnet Full Node' },
        { id: 2, name: 'arkeo-mainnet-rest', description: 'Arkeo Mainnet REST API' },
        { id: 20, name: 'eth-mainnet-fullnode', description: 'Ethereum Mainnet Full Node' },
        { id: 21, name: 'eth-mainnet-archive', description: 'Ethereum Mainnet Archive' },
        { id: 30, name: 'btc-mainnet-fullnode', description: 'Bitcoin Mainnet Full Node' },
        { id: 40, name: 'cosmos-mainnet-fullnode', description: 'Cosmos Hub Full Node' },
        { id: 50, name: 'osmosis-mainnet-fullnode', description: 'Osmosis Mainnet Full Node' },
        { id: 74, name: 'thorchain-mainnet-fullnode', description: 'THORChain Mainnet Full Node' },
        { id: 89, name: 'base-mainnet-fullnode', description: 'Base Mainnet Full Node' },
      ];
    }
    
    function renderServices(services) {
      const grid = document.getElementById('chainGrid');
      
      grid.innerHTML = services.map(s => {
        const active = s.activeContracts || 0;
        const total = s.totalContracts || 0;
        const providerCount = s.providerCount || 0;
        const d = getDemandIndicator(active);
        const countText = active > 0 ? `${active} active contract${active !== 1 ? 's' : ''}` : (total > 0 ? `${total} total` : '');
        const displayName = getChainDisplayName(s.name);
        const icon = getChainIcon(s.name);
        
        return `
        <div class="chain-option" onclick="selectService(${s.id}, '${escapeHtml(s.name)}')">
          <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">${icon}</div>
          <div class="chain-name">${escapeHtml(displayName)}</div>
          <div class="chain-id">${escapeHtml(s.name)}</div>
          <div class="chain-demand ${d.cls}" title="${d.label}">
            <span>${d.icon}</span>
            <span class="demand-text">${countText || d.label}</span>
          </div>
          <div style="font-size: 0.65rem; color: var(--text-dim); margin-top: 0.25rem;">
            ${providerCount > 0 ? `üë• ${providerCount} provider${providerCount !== 1 ? 's' : ''}` : 'üÜï No providers yet'}
          </div>
        </div>`;
      }).join('');
    }
    
    function filterChains() {
      const search = document.getElementById('chainSearch').value.toLowerCase().trim();
      if (!search) { renderServices(state.services); return; }
      
      // Expand search term via aliases
      const aliasMatches = SEARCH_ALIASES[search] || [];
      
      const filtered = state.services.filter(s => {
        const name = s.name.toLowerCase();
        const displayName = getChainDisplayName(s.name).toLowerCase();
        if (name.includes(search) || displayName.includes(search) || String(s.id).includes(search)) return true;
        // Check aliases
        for (const alias of aliasMatches) {
          if (name.includes(alias) || displayName.includes(alias)) return true;
        }
        return false;
      });
      renderServices(filtered);
    }
    
    function selectService(id, name) {
      state.selectedService = { id, name };
      
      // Update UI
      document.querySelectorAll('.chain-option').forEach(el => {
        el.classList.remove('selected');
      });
      event.currentTarget.classList.add('selected');
      
      document.getElementById('nextBtn1').disabled = false;
      document.getElementById('selectedChainName').textContent = getChainDisplayName(name);
    }

    // ============================================================
    // INFRASTRUCTURE VALIDATION
    // ============================================================
    function validateRpcUrl() {
      const url = document.getElementById('rpcUrl').value;
      checkStep2Ready();
      
      // Update sentinel command preview
      try {
        const parsed = new URL(url);
        document.getElementById('sentinelRpcPlaceholder').textContent = parsed.host;
      } catch {}
    }
    
    function validateSentinelUrl() {
      checkStep2Ready();
    }
    
    function checkStep2Ready() {
      const rpcUrl = document.getElementById('rpcUrl').value;
      const sentinelUrl = document.getElementById('sentinelUrl').value;
      const btn = document.getElementById('nextBtn2');
      
      let rpcValid = false;
      let sentinelValid = false;
      
      try {
        new URL(rpcUrl);
        rpcValid = true;
      } catch {}
      
      try {
        new URL(sentinelUrl);
        sentinelValid = true;
      } catch {}
      
      btn.disabled = !(rpcValid && sentinelValid);
    }
    
    function copySentinelCommand() {
      const rpcUrl = document.getElementById('rpcUrl').value || 'localhost:26657';
      let host = 'localhost:26657';
      try {
        const parsed = new URL(rpcUrl);
        host = parsed.host;
      } catch {}
      
      const cmd = `docker run -d --name arkeo-sentinel \\
  -p 3636:3636 \\
  -e PROXY_HOST=${host} \\
  ghcr.io/arkeonetwork/sentinel:latest`;
      
      navigator.clipboard.writeText(cmd);
      event.target.textContent = '‚úì Copied!';
      setTimeout(() => event.target.textContent = 'üìã Copy Command', 2000);
    }
    
    async function testEndpoints() {
      const rpcUrl = document.getElementById('rpcUrl').value;
      const sentinelUrl = document.getElementById('sentinelUrl').value;
      const rpcStatus = document.getElementById('rpcStatus');
      const sentinelStatus = document.getElementById('sentinelStatus');
      const btn = document.getElementById('nextBtn2');
      
      btn.disabled = true;
      
      // RPC URL: Don't test from browser ‚Äî it's a local/internal URL that only the sentinel connects to.
      // Just validate format.
      rpcStatus.innerHTML = `
        <div class="status-box success">
          <span>‚úÖ</span>
          <span>RPC URL saved ‚Äî your sentinel will connect to this internally.</span>
        </div>
      `;
      
      // Test Sentinel ‚Äî try /metadata.json which sentinels always serve
      sentinelStatus.innerHTML = `
        <div class="status-box testing">
          <div class="spinner"></div>
          <span>Testing sentinel endpoint...</span>
        </div>
      `;
      
      let sentinelOk = false;
      try {
        const response = await fetch(sentinelUrl + '/metadata.json', {
          signal: AbortSignal.timeout(10000),
          mode: 'cors',
        });
        
        // Any response (even 400/403) means the sentinel is running
        sentinelStatus.innerHTML = `
          <div class="status-box success">
            <span>‚úÖ</span>
            <span>Sentinel is running!</span>
          </div>
        `;
        sentinelOk = true;
      } catch (err) {
        // CORS errors and network errors both throw TypeError
        // Try an opaque request to check if server is at least responding
        try {
          const opaqueResp = await fetch(sentinelUrl + '/metadata.json', {
            signal: AbortSignal.timeout(10000),
            mode: 'no-cors',
          });
          // no-cors returns opaque response (status 0) but proves server is reachable
          sentinelStatus.innerHTML = `
            <div class="status-box success">
              <span>‚úÖ</span>
              <span>Sentinel is reachable! (CORS headers not set ‚Äî this is normal for sentinels)</span>
            </div>
          `;
          sentinelOk = true;
        } catch (err2) {
          sentinelStatus.innerHTML = `
            <div class="status-box warning">
              <span>‚ö†Ô∏è</span>
              <span>Can't reach sentinel from browser. Make sure it's running and the URL is correct.</span>
            </div>
            <div style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-dim);">
              If your sentinel is behind a firewall or not yet started, you can continue and set it up later.
              <button class="btn btn-secondary" style="margin-left: 0.5rem; padding: 0.25rem 0.75rem; font-size: 0.8rem;" 
                      onclick="proceedWithoutSentinelTest()">Continue Anyway ‚Üí</button>
            </div>
          `;
        }
      }
      
      if (sentinelOk) {
        state.rpcUrl = rpcUrl;
        state.sentinelUrl = sentinelUrl;
        setTimeout(() => goToStep(3), 1500);
      } else {
        btn.disabled = false;
      }
    }
    
    function proceedWithoutSentinelTest() {
      state.rpcUrl = document.getElementById('rpcUrl').value;
      state.sentinelUrl = document.getElementById('sentinelUrl').value;
      goToStep(3);
    }
    
    // ============================================================
    // METADATA & CONFIGURATION
    // ============================================================
    function updateMetadataPreview() {
      state.providerName = document.getElementById('providerName').value || 'My Arkeo Provider';
      state.providerDesc = document.getElementById('providerDesc').value || '';
      state.providerLocation = document.getElementById('providerLocation').value || '';
      
      const metadata = {
        moniker: state.providerName,
        description: state.providerDesc,
        location: state.providerLocation,
        website: '',
        sentinel_url: state.sentinelUrl || ''
      };
      
      document.getElementById('metadataPreview').textContent = JSON.stringify(metadata, null, 2);
    }
    
    function copyMetadata() {
      const metadata = {
        moniker: state.providerName,
        description: state.providerDesc,
        location: state.providerLocation,
        website: '',
        sentinel_url: state.sentinelUrl || ''
      };
      
      navigator.clipboard.writeText(JSON.stringify(metadata, null, 2));
      event.target.textContent = '‚úì Copied!';
      setTimeout(() => event.target.textContent = 'üìã Copy Metadata JSON', 2000);
    }
    
    function validateMetadataUrl() {
      const url = document.getElementById('metadataUrl').value;
      try {
        new URL(url);
        state.metadataUrl = url;
      } catch {
        state.metadataUrl = null;
      }
    }
    
    function updateSummary() {
      const rate = document.getElementById('paygRate').value || 1;
      state.paygRate = parseInt(rate);
      
      document.getElementById('summaryChain').textContent = state.selectedService?.name || '-';
      document.getElementById('summarySentinel').textContent = state.sentinelUrl || '-';
      document.getElementById('summaryRate').textContent = `${rate} uarkeo/req`;
    }

    // ============================================================
    // STEP NAVIGATION
    // ============================================================
    function goToStep(step) {
      // Hide all steps
      for (let i = 1; i <= 5; i++) {
        document.getElementById('step' + i).classList.add('hidden');
        if (i <= 4) {
          document.getElementById('dot' + i).classList.remove('active', 'complete');
          document.getElementById('dot' + i).innerHTML = i;
          document.getElementById('label' + i).classList.remove('active');
        }
      }
      
      // Show current step
      document.getElementById('step' + step).classList.remove('hidden');
      
      // Update progress
      for (let i = 1; i <= Math.min(step, 4); i++) {
        const dot = document.getElementById('dot' + i);
        const label = document.getElementById('label' + i);
        if (i < step) {
          dot.classList.add('complete');
          dot.innerHTML = '‚úì';
        } else if (i === step) {
          dot.classList.add('active');
          label.classList.add('active');
        }
      }
      
      // Progress line
      const progressPercent = ((Math.min(step, 4) - 1) / 3) * 100;
      document.getElementById('progressLine').style.width = progressPercent + '%';
      
      state.currentStep = step;
      
      // Step-specific updates
      if (step === 3) {
        updateSummary();
      }
      if (step === 4) {
        updateStep4UI();
      }
    }
    
    function updateSummary() {
      const rate = document.getElementById('paygRate').value || 200;
      state.paygRate = parseInt(rate);
      
      document.getElementById('summaryChain').textContent = state.selectedService?.name || '-';
      document.getElementById('summaryRpc').textContent = state.rpcUrl || '-';
      document.getElementById('summaryRate').textContent = `${rate} uarkeo / 1000 req`;
    }
    
    function updateStep4UI() {
      const walletRequired = document.getElementById('walletRequired');
      const registrationSteps = document.getElementById('registrationSteps');
      
      if (state.walletConnected) {
        walletRequired.classList.add('hidden');
        registrationSteps.classList.remove('hidden');
        
        document.getElementById('regChain').textContent = state.selectedService?.name || '-';
        document.getElementById('regWallet').textContent = state.walletAddress;
        document.getElementById('regSentinel').textContent = state.sentinelUrl || '-';
        document.getElementById('regRate').textContent = `${state.paygRate} uarkeo/req`;
      } else {
        walletRequired.classList.remove('hidden');
        registrationSteps.classList.add('hidden');
      }
    }
    
    // Helper to convert Uint8Array to base64
    function bufferToBase64(buffer) {
      let binary = '';
      const bytes = new Uint8Array(buffer);
      for (let i = 0; i < bytes.byteLength; i++) {
        binary += String.fromCharCode(bytes[i]);
      }
      return btoa(binary);
    }
    
    // Convert pubkey bytes to bech32 format (arkeopub1...)
    function pubkeyToBech32(pubkeyBytes, prefix) {
      // Amino prefix for secp256k1 pubkey: eb5ae98721
      const aminoPrefix = [0xeb, 0x5a, 0xe9, 0x87, 0x21];
      const pubkey = new Uint8Array(pubkeyBytes);
      
      // Combine amino prefix + pubkey
      const combined = new Uint8Array(aminoPrefix.length + pubkey.length);
      combined.set(aminoPrefix);
      combined.set(pubkey, aminoPrefix.length);
      
      // Convert to 5-bit groups for bech32
      const words = toWords(combined);
      
      // Encode as bech32
      return bech32Encode(prefix, words);
    }
    
    // Convert bytes to 5-bit words
    function toWords(bytes) {
      const words = [];
      let value = 0;
      let bits = 0;
      
      for (const byte of bytes) {
        value = (value << 8) | byte;
        bits += 8;
        while (bits >= 5) {
          bits -= 5;
          words.push((value >> bits) & 0x1f);
        }
      }
      
      if (bits > 0) {
        words.push((value << (5 - bits)) & 0x1f);
      }
      
      return words;
    }
    
    // Bech32 encoding
    function bech32Encode(prefix, words) {
      const CHARSET = 'qpzry9x8gf2tvdw0s3jn54khce6mua7l';
      const GENERATOR = [0x3b6a57b2, 0x26508e6d, 0x1ea119fa, 0x3d4233dd, 0x2a1462b3];
      
      function polymod(values) {
        let chk = 1;
        for (const v of values) {
          const top = chk >> 25;
          chk = ((chk & 0x1ffffff) << 5) ^ v;
          for (let i = 0; i < 5; i++) {
            if ((top >> i) & 1) chk ^= GENERATOR[i];
          }
        }
        return chk;
      }
      
      function hrpExpand(hrp) {
        const result = [];
        for (const c of hrp) {
          result.push(c.charCodeAt(0) >> 5);
        }
        result.push(0);
        for (const c of hrp) {
          result.push(c.charCodeAt(0) & 31);
        }
        return result;
      }
      
      function createChecksum(hrp, data) {
        const values = hrpExpand(hrp).concat(data).concat([0, 0, 0, 0, 0, 0]);
        const mod = polymod(values) ^ 1;
        const result = [];
        for (let i = 0; i < 6; i++) {
          result.push((mod >> (5 * (5 - i))) & 31);
        }
        return result;
      }
      
      const checksum = createChecksum(prefix, words);
      const combined = words.concat(checksum);
      let result = prefix + '1';
      for (const w of combined) {
        result += CHARSET[w];
      }
      return result;
    }

    // ============================================================
    // PROVIDER REGISTRATION (ON-CHAIN)
    // ============================================================
    async function registerProvider() {
      if (!state.walletConnected) {
        alert('Please connect your wallet first.');
        return;
      }
      
      const btn = document.getElementById('registerBtn');
      const statusDiv = document.getElementById('txStatus');
      const tx1Status = document.getElementById('tx1Status');
      const tx2Status = document.getElementById('tx2Status');
      const tx1Icon = document.getElementById('tx1Icon');
      const tx2Icon = document.getElementById('tx2Icon');
      
      btn.disabled = true;
      
      // Get pubkey bytes for transactions
      const pubkeyBytes = state.walletPubkeyBytes;
      if (!pubkeyBytes) {
        statusDiv.innerHTML = `
          <div class="status-box error">
            <span>‚ùå</span>
            <span>Could not get wallet public key. Please reconnect.</span>
          </div>
        `;
        btn.disabled = false;
        return;
      }
      
      let bondTxHash = null;
      let modTxHash = null;
      
      try {
        // ============================================================
        // TRANSACTION 1: Bond Provider
        // ============================================================
        tx1Status.style.background = 'var(--arkeo-dim)';
        tx1Status.style.borderColor = 'var(--arkeo)';
        tx1Icon.textContent = 'üîÑ';
        
        showLoading('Transaction 1 of 2', 'Bond Provider - Approve in Keplr');
        
        const accountInfo1 = await getAccountInfo(state.walletAddress);
        
        // Use Direct signing with proper protobuf encoding
        const offlineSigner = window.keplr.getOfflineSignerOnlyAmino(CONFIG.CHAIN_ID);
        
        const bondMsg = {
          typeUrl: '/arkeo.arkeo.MsgBondProvider',
          value: {
            creator: state.walletAddress,
            provider: state.walletPubkeyBech32,
            service: state.selectedService.name,  // Use name not ID
            bond: "100000000",
          }
        };
        
        console.log('Bond message:', JSON.stringify(bondMsg, null, 2));
        
        const bondResult = await signAndBroadcastDirect(bondMsg, accountInfo1);
        
        if (bondResult.code !== 0) {
          throw new Error(`Bond failed: ${bondResult.rawLog || 'Unknown error'}`);
        }
        
        bondTxHash = bondResult.transactionHash;
        tx1Icon.textContent = '‚úÖ';
        tx1Status.style.background = 'var(--success-dim)';
        tx1Status.style.borderColor = 'var(--success)';
        
        // ============================================================
        // TRANSACTION 2: Mod Provider (configure service)
        // ============================================================
        tx2Status.style.background = 'var(--arkeo-dim)';
        tx2Status.style.borderColor = 'var(--arkeo)';
        tx2Icon.textContent = 'üîÑ';
        
        showLoading('Transaction 2 of 2', 'Configure Service - Approve in Keplr');
        
        // Wait a moment for sequence to update
        await new Promise(r => setTimeout(r, 2000));
        const accountInfo2 = await getAccountInfo(state.walletAddress);
        
        // Build metadata URL from sentinel URL
        const metadataUrl = state.sentinelUrl ? state.sentinelUrl.replace(/\/$/, '') + '/metadata.json' : '';
        
        const modMsg = {
          typeUrl: '/arkeo.arkeo.MsgModProvider',
          value: {
            creator: state.walletAddress,
            provider: state.walletPubkeyBech32,
            service: state.selectedService.name,
            metadataUri: metadataUrl,
            metadataNonce: '1',
            status: 1, // ONLINE = 1
            minContractDuration: '10',
            maxContractDuration: '1000000',
            subscriptionRate: [{ denom: CONFIG.ARKEO_DENOM, amount: '1' }],  // Must be positive
            payAsYouGoRate: [{ denom: CONFIG.ARKEO_DENOM, amount: String(state.paygRate || '1') }],
            settlementDuration: '10',
          }
        };
        
        console.log('Metadata URL:', metadataUrl);
        
        console.log('Mod message:', JSON.stringify(modMsg, null, 2));
        
        const modResult = await signAndBroadcastDirect(modMsg, accountInfo2);
        
        if (modResult.code !== 0) {
          throw new Error(`Configure failed: ${modResult.rawLog || 'Unknown error'}`);
        }
        
        modTxHash = modResult.transactionHash;
        tx2Icon.textContent = '‚úÖ';
        tx2Status.style.background = 'var(--success-dim)';
        tx2Status.style.borderColor = 'var(--success)';
        
        hideLoading();
        
        // Show success
        statusDiv.innerHTML = `
          <div class="status-box success">
            <span>‚úÖ</span>
            <span>Provider registered successfully!</span>
          </div>
        `;
        
        // Update final screen
        document.getElementById('finalService').textContent = state.selectedService.name;
        document.getElementById('finalPubkey').textContent = state.walletPubkeyBech32 || state.walletAddress;
        document.getElementById('finalBondTx').innerHTML = `
          <a href="${CONFIG.EXPLORER_TX}${bondTxHash}" target="_blank" class="tx-link">
            ${bondTxHash.slice(0, 16)}...
          </a>
        `;
        
        setTimeout(() => goToStep(5), 2000);
        
      } catch (err) {
        hideLoading();
        console.error('Registration failed:', err);
        
        if (bondTxHash && !modTxHash) {
          // Bond succeeded but mod failed
          statusDiv.innerHTML = `
            <div class="status-box warning">
              <span>‚ö†Ô∏è</span>
              <span>Bond succeeded but configuration failed. You can retry configuration.</span>
            </div>
            <div class="status-box error" style="margin-top: 0.5rem;">
              <span>‚ùå</span>
              <span>${err.message}</span>
            </div>
          `;
          tx2Icon.textContent = '‚ùå';
        } else {
          statusDiv.innerHTML = `
            <div class="status-box error">
              <span>‚ùå</span>
              <span>Registration failed: ${err.message}</span>
            </div>
          `;
          tx1Icon.textContent = '‚ùå';
        }
        
        btn.disabled = false;
      }
    }
    
    async function getAccountInfo(address) {
      const response = await fetch(`${CONFIG.REST_API}/cosmos/auth/v1beta1/accounts/${address}`);
      const data = await response.json();
      
      const account = data.account?.base_account || data.account || {};
      return {
        accountNumber: account.account_number || '0',
        sequence: account.sequence || '0',
      };
    }
    
    async function signAndBroadcastDirect(msg, accountInfo) {
      // Initialize the Arkeo TX helper
      await window.arkeoTx.init();
      
      console.log('Signing message:', msg);
      console.log('Account info:', accountInfo);
      
      // Get pubkey bytes from state
      const pubkeyBytes = state.walletPubkeyBytes;
      if (!pubkeyBytes) {
        throw new Error('No wallet pubkey bytes available');
      }
      
      // Build TxBody
      const bodyBytes = window.arkeoTx.buildTxBody([msg], 'Registered via Arkeo Marketplace');
      console.log('TxBody bytes:', bodyBytes);
      
      // Build AuthInfo
      const authInfoBytes = window.arkeoTx.buildAuthInfo(
        pubkeyBytes,
        parseInt(accountInfo.sequence),
        '10000',  // fee amount
        300000    // gas limit
      );
      console.log('AuthInfo bytes:', authInfoBytes);
      
      // Create SignDoc for Keplr
      const signDoc = {
        bodyBytes: bodyBytes,
        authInfoBytes: authInfoBytes,
        chainId: CONFIG.CHAIN_ID,
        accountNumber: accountInfo.accountNumber
      };
      
      console.log('SignDoc:', signDoc);
      
      // Sign with Keplr's signDirect
      const signResponse = await window.keplr.signDirect(
        CONFIG.CHAIN_ID,
        state.walletAddress,
        signDoc
      );
      
      console.log('Sign response:', signResponse);
      
      // Build TxRaw with signature
      const signatureBytes = window.arkeoTx.base64ToBytes(signResponse.signature.signature);
      const txRawBytes = window.arkeoTx.buildTxRaw(
        signResponse.signed.bodyBytes,
        signResponse.signed.authInfoBytes,
        [signatureBytes]
      );
      
      console.log('TxRaw bytes length:', txRawBytes.length);
      
      // Convert to base64 for broadcast
      const txBytesBase64 = window.arkeoTx.bytesToBase64(txRawBytes);
      console.log('TX bytes (base64):', txBytesBase64.substring(0, 100) + '...');
      
      // Broadcast via REST
      const broadcastResponse = await fetch(`${CONFIG.REST_API}/cosmos/tx/v1beta1/txs`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          tx_bytes: txBytesBase64,
          mode: 'BROADCAST_MODE_SYNC',
        }),
      });
      
      const result = await broadcastResponse.json();
      console.log('Broadcast result:', result);
      
      if (result.tx_response) {
        if (result.tx_response.code !== 0) {
          throw new Error(`TX failed: ${result.tx_response.raw_log}`);
        }
        return {
          code: result.tx_response.code || 0,
          transactionHash: result.tx_response.txhash,
          rawLog: result.tx_response.raw_log,
        };
      }
      
      throw new Error(result.message || JSON.stringify(result));
    }
    
    function bufferToHex(buffer) {
      return Array.from(new Uint8Array(buffer))
        .map(b => b.toString(16).padStart(2, '0'))
        .join('')
        .toUpperCase();
    }

    function makeSignedTxBytes(signResponse) {
      const combined = JSON.stringify({
        body: signResponse.signed,
        auth_info: {
          signer_infos: [{
            public_key: signResponse.signature.pub_key,
            mode_info: { single: { mode: 'SIGN_MODE_LEGACY_AMINO_JSON' } },
            sequence: signResponse.signed.sequence,
          }],
          fee: signResponse.signed.fee,
        },
        signatures: [signResponse.signature.signature],
      });
      return btoa(combined);
    }

    // ============================================================
    // UTILITIES
    // ============================================================
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function showLoading(text, subtext) {
      document.getElementById('loadingText').textContent = text;
      document.getElementById('loadingSubtext').textContent = subtext || '';
      document.getElementById('loadingOverlay').classList.remove('hidden');
    }
    
    function hideLoading() {
      document.getElementById('loadingOverlay').classList.add('hidden');
    }

    // ============================================================
    // INITIALIZE
    // ============================================================
    document.addEventListener('DOMContentLoaded', () => {
      loadServices();
      
      // Check if Keplr is already connected
      if (window.keplr) {
        window.keplr.getKey(CONFIG.CHAIN_ID).then(key => {
          if (key) {
            state.walletAddress = key.bech32Address;
            state.walletPubkey = Buffer.from(key.pubKey).toString('base64');
            state.walletConnected = true;
            
            const btn = document.getElementById('walletBtn');
            btn.textContent = `${state.walletAddress.slice(0, 10)}...${state.walletAddress.slice(-6)}`;
            btn.classList.add('connected');
          }
        }).catch(() => {});
      }
    });
    
    // Buffer polyfill for browser
    if (typeof Buffer === 'undefined') {
      window.Buffer = {
        from: (arr) => ({
          toString: (enc) => {
            if (enc === 'base64') {
              return btoa(String.fromCharCode.apply(null, arr));
            }
            return Array.from(arr).map(b => b.toString(16).padStart(2, '0')).join('');
          }
        })
      };
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Arkeo Data Engine | Subscriber Admin</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="images/favicon.ico">
    <link rel="shortcut icon" href="images/favicon.ico">
    <script src="vendor/cosmos.bundle.js"></script>
</head>
<body>

<div class="card header-card">
    <div class="row-between header-top">
        <div class="header-left">
            <div class="header-brand-row">
                <img src="images/arkeo-logo-200px_1.png" alt="Arkeo" class="header-logo">
                <div class="header-brand">
                    <span class="brand-main">Arkeo Data Engine</span>
                    <span class="brand-sep">|</span>
                    <span class="brand-sub">Subscriber</span>
                </div>
            </div>
            <h1>Admin Area</h1>
            <div class="muted">Quick links, health checks, and subscriber settings.</div>
        </div>
        <div class="header-right header-right-with-actions">
            <div class="header-actions">
                <a class="btn-ghost" href="index.html">Back to Dashboard</a>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="row-between align-center">
        <div class="inline">
            <h2 class="mt-0 mb-0">Admin Overview</h2>
        </div>
    </div>
    <div class="grid-two">
        <div class="panel stack">
            <div>
                <strong>Admin API</strong>
                <div id="adminApiVersion" class="muted mt-6">(loading...)</div>
            </div>
            <div>
                <strong>Admin API URL</strong>
                <div id="adminApiUrl" class="muted mt-6"></div>
            </div>
            <div>
                <strong>Admin UI URL</strong>
                <div id="adminUiUrl" class="muted mt-6"></div>
            </div>
        </div>
        <div class="panel stack">
            <div>
                <strong>Block Height</strong>
                <div id="blockHeightDisplay" class="muted mt-6">(loading...)</div>
            </div>
            <div>
                <strong>Subscriber Balance</strong>
                <div id="balanceDisplay" class="muted mt-6">(loading...)</div>
            </div>
            <div>
                <strong>Subscriber Pubkey</strong>
                <div id="overviewPubkeyDisplay" class="muted mt-6">(loading...)</div>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="row-between align-center">
        <div class="inline">
            <h2 class="mt-0 mb-0">Subscriber Settings</h2>
        </div>
    </div>
    <form id="subscriberSettingsForm" onsubmit="saveSubscriberSettings(event)">
    <table>
        <tr>
            <td class="label">
                Subscriber Name
                <div class="hint">Display name for this subscriber instance (for your reference).</div>
            </td>
            <td class="value"><input type="text" id="subscriberName" placeholder="Arkeo Core Subscriber" autocomplete="on" /></td>
        </tr>
        <tr class="hidden">
            <td class="label">Key Name</td>
            <td class="value"><input type="text" id="keyName" readonly /></td>
        </tr>
        <tr class="hidden">
            <td class="label">Keyring Backend <span class="muted" id="keyBackendLabel">(default)</span></td>
            <td class="value"><div id="keyBackendValue" class="muted">(read-only)</div></td>
        </tr>
        <tr>
            <td class="label">
                Chain ID
                <div class="hint">Target Arkeo chain ID (e.g., arkeo-main-v1).</div>
            </td>
            <td class="value"><input type="text" id="chainId" placeholder="arkeo-main-v1" /></td>
        </tr>
        <tr class="hidden">
            <td class="label">Arkeod Home <span class="muted" id="arkeodHomeLabel"></span></td>
            <td class="value"><div id="arkeodHomeValue" class="muted">(read-only)</div></td>
        </tr>
        <tr>
            <td class="label">
                Arkeo RPC
                <div class="hint">RPC endpoint used for syncing and queries (tcp:// or http://).</div>
            </td>
            <td class="value"><input type="text" id="arkeodNode" placeholder="tcp://127.0.0.1:26657" /></td>
        </tr>
        <tr>
            <td class="label">
                Osmosis RPC
                <div class="hint">Remote Osmosis RPC endpoint used for hot wallet balance/block checks.</div>
            </td>
            <td class="value"><input type="text" id="osmoRpc" placeholder="http://127.0.0.1:26660" /></td>
        </tr>
        <tr>
            <td class="label">
                Arkeo Hot Wallet Mnemonic
                <div class="hint">Stored for on-chain Arkeo operations.</div>
            </td>
            <td class="value"><textarea id="hotwalletMnemonic" rows="3"></textarea></td>
        </tr>
        <tr>
            <td class="label">
                Admin UI Port
                <div class="hint">Port the web UI listens on (front-end).</div>
            </td>
            <td class="value"><input type="text" id="adminPort" placeholder="8079" autocomplete="on" /></td>
        </tr>
        <tr>
            <td class="label">
                Admin API Port
                <div class="hint">Port for the admin API server (backend).</div>
            </td>
            <td class="value"><input type="text" id="adminApiPort" placeholder="9998" autocomplete="on" /></td>
        </tr>
        <tr>
            <td class="label">
                Cache Fetch Interval (seconds)
                <div class="hint">Background sync cadence. Set to 0 to disable background sync.</div>
            </td>
            <td class="value"><input type="number" id="cacheFetchInterval" placeholder="150" min="0" step="1" /></td>
        </tr>
        <tr>
            <td class="label">
                Wallet Sync Interval (seconds)
                <div class="hint">How often to refresh wallet info/balances. Set to 0 to disable.</div>
            </td>
            <td class="value"><input type="number" id="walletSyncInterval" placeholder="15" min="0" step="1" /></td>
        </tr>
        <tr>
            <td class="label">
                Admin Password
                <div class="hint">Leave blank to disable. When set, a password prompt can be required on this page.</div>
            </td>
            <td class="value"><input type="password" id="adminPasswordInput" class="full" autocomplete="new-password" placeholder="(optional)" /></td>
        </tr>
        <tr class="hidden">
            <td class="label">Derived Pubkey</td>
            <td class="value"><div id="subscriberPubkeyDisplay" class="muted">(loading...)</div></td>
        </tr>
    </table>
    <div class="row-between align-center mt-12">
        <div class="actions">
            <button class="primary" type="submit" form="subscriberSettingsForm">Save Settings</button>
        </div>
        <div id="subscriberSettingsResult" class="muted" aria-live="polite"></div>
    </div>
    </form>
</div>

<div class="card footer-card">
    <div class="footer-links">
        <div class="footer-brand">
            <img src="images/arkeo-logo-200px_1.png" alt="Arkeo" class="footer-logo">
            <span class="footer-title">
                <span class="brand-main">Arkeo Data Engine</span>
                <span class="brand-sep">|</span>
                <span class="brand-sub">Subscriber</span>
            </span>
        </div>
        <div class="footer-links-right">
            <div><a href="https://arkeo.network/" target="_blank" rel="noopener">Arkeo Marketplace Website</a></div>
            <div><a href="https://discord.gg/arkeo" target="_blank" rel="noopener">Arkeo Discord</a></div>
        </div>
    </div>
</div>

<div id="adminPasswordGate" class="overlay overlay-strong hidden">
    <div class="overlay-card password-card">
        <div class="password-title">
            <span>Arkeo Data Marketplace</span>
            <span class="sep">|</span>
            <span class="sub">Subscriber Manager</span>
        </div>
        <form onsubmit="submitAdminPasswordGate(); return false;">
            <div class="password-body">
                <h3 class="mt-6 mb-0">Password Required</h3>
                <p class="muted">Enter the admin password to continue.</p>
                <input type="text" name="admin-username-filler" autocomplete="username" value="admin" class="hidden" aria-hidden="true" tabindex="-1" />
                <input type="password" id="adminPasswordGateInput" autocomplete="current-password" placeholder="Admin password" />
            </div>
            <div class="actions center mt-6">
                <button class="primary" type="submit">Unlock</button>
            </div>
            <div id="adminPasswordGateStatus" class="muted mt-6"></div>
        </form>
    </div>
</div>

<script>
    const DEFAULT_ADMIN_API_PORT = "9998";
    const DEFAULT_ADMIN_UI_PORT = "8079";
    let adminHost = (window.location && window.location.hostname) || "localhost";
    let adminApiBase = buildBaseUrl(adminHost, DEFAULT_ADMIN_API_PORT);
    let subscriberSettingsCache = {};
    let adminPasswordEnabled = false;
    let adminSessionAuthed = false;
    const OSMOSIS_CHAIN_ID = "osmosis-1";
    let adminKeplrAddress = "";
    let adminKeplrListenerAttached = false;

    function getCosmosBundle() {
        if (!window.Cosmos) {
            throw new Error("Cosmos bundle not loaded.");
        }
        return window.Cosmos;
    }

    function requirePasswordGate() {
        sessionStorage.removeItem("adminAuthed");
        adminSessionAuthed = false;
        const gate = document.getElementById("adminPasswordGate");
        if (gate) gate.classList.remove("hidden");
    }

    const realFetch = window.fetch.bind(window);
    window.fetch = (url, options = {}) =>
        realFetch(url, { credentials: "include", ...options }).then((resp) => {
            if (resp && resp.status === 401) {
                requirePasswordGate();
            }
            return resp;
        });

    function buildBaseUrl(host, port) {
        const proto = (window.location && window.location.protocol === "https:") ? "https:" : "http:";
        const cleaned = (host || "").replace(/^https?:\/\//, "").replace(/\/+$/, "");
        return `${proto}//${cleaned}${port ? `:${port}` : ""}`;
    }

    function resolveApi(path) {
        if (!path.startsWith("/")) path = `/${path}`;
        return `${adminApiBase}${path}`;
    }

    function formatBalance(balanceObj) {
        const coins =
            (balanceObj && balanceObj.balance && balanceObj.balance.result && Array.isArray(balanceObj.balance.result) && balanceObj.balance.result) ||
            (balanceObj && balanceObj.balance && balanceObj.balance.balances && Array.isArray(balanceObj.balance.balances) && balanceObj.balance.balances) ||
            [];
        if (!coins.length) return "0 uarkeo";
        const fmtCoin = (c) => {
            const amount = c.amount || c.Amount || "";
            const denom = c.denom || c.Denom || "";
            if (denom === "uarkeo") {
                const num = parseInt(amount || "0", 10);
                const val = num / 1e8;
                return `${val.toLocaleString("en-US", { minimumFractionDigits: 8, maximumFractionDigits: 8 })} ARKEO`;
            }
            return `${amount}${denom}`;
        };
        return coins.map(fmtCoin).join(", ");
    }

    function formatBlockHeight(heightObj) {
        const h =
            (heightObj && heightObj.height) ||
            (heightObj && heightObj.status && (heightObj.status.latest_block_height || (heightObj.status.SyncInfo && heightObj.status.SyncInfo.latest_block_height)));
        if (!h) return "(unknown)";
        const num = Number(h);
        if (!Number.isFinite(num)) return String(h);
        return num.toLocaleString("en-US");
    }

    function formatPubkeyShort(pk) {
        if (!pk) return "";
        const str = String(pk);
        if (str.length <= 17) return str;
        return `${str.slice(0, 9)}...${str.slice(-8)}`;
    }

    function setAdminKeplrStatus(label, isConnected = false) {
        const statusEl = document.getElementById("adminKeplrStatus");
        if (statusEl) statusEl.textContent = label;
        const addrEl = document.getElementById("adminKeplrAddress");
        if (addrEl) addrEl.textContent = adminKeplrAddress || "—";
        if (statusEl) {
            statusEl.classList.toggle("status-success", !!isConnected);
            statusEl.classList.toggle("status-error", !isConnected);
        }
    }

    async function connectKeplrAdmin(evt) {
        if (evt && evt.preventDefault) evt.preventDefault();
        if (!window.keplr || !window.getOfflineSigner) {
            setAdminKeplrStatus("Keplr extension required", false);
            showResultModal("Connect Keplr", "Install and unlock Keplr, then try again.");
            return;
        }
        try {
            setAdminKeplrStatus("Connecting...", false);
            adminKeplrAddress = await getCosmosBundle().connectKeplr({ chainId: OSMOSIS_CHAIN_ID });
            setAdminKeplrStatus("Keplr Connected", true);
            registerAdminKeplrListener();
        } catch (err) {
            console.error("Keplr connect failed", err);
            setAdminKeplrStatus(`Connect failed: ${err}`, false);
        }
    }

    function registerAdminKeplrListener() {
        if (adminKeplrListenerAttached || !window.Cosmos) return;
        adminKeplrListenerAttached = true;
        getCosmosBundle().onKeplrKeystoreChange(async () => {
            try {
                adminKeplrAddress = await getCosmosBundle().connectKeplr({ chainId: OSMOSIS_CHAIN_ID });
                setAdminKeplrStatus(adminKeplrAddress ? "Keplr Connected" : "Connect Keplr", !!adminKeplrAddress);
            } catch (err) {
                console.error("Keplr keystore change handling failed", err);
                setAdminKeplrStatus("Connect Keplr", false);
            }
        }, { chainId: OSMOSIS_CHAIN_ID });
    }

    function setBadge() {
        // badge removed
        return;
    }

    async function loadAdminInfo() {
        setBadge("warn", "Refreshing…");
        const fetchNoStore = (url) => fetch(url, { cache: "no-store" });
        const parseSafe = async (settled) => {
            if (settled.status !== "fulfilled" || !settled.value) return { error: String(settled.reason || "request failed") };
            try {
                if (!settled.value.ok) {
                    const text = await settled.value.text().catch(() => "");
                    return { error: `${settled.value.status} ${settled.value.statusText || ""}`, body: text };
                }
                return await settled.value.json();
            } catch (err) {
                return { error: "invalid json", detail: String(err) };
            }
        };
        try {
            const [verRes, heightRes, balRes, infoRes] = await Promise.allSettled([
                fetchNoStore(resolveApi("/api/version")),
                fetchNoStore(resolveApi("/api/block-height")),
                fetchNoStore(resolveApi("/api/balance")),
                fetchNoStore(resolveApi("/api/subscriber-info")),
            ]);
            const version = await parseSafe(verRes);
            const height = await parseSafe(heightRes);
            const balance = await parseSafe(balRes);
            const info = await parseSafe(infoRes);

            const apiVersionEl = document.getElementById("adminApiVersion");
            if (apiVersionEl) apiVersionEl.textContent = version && !version.error ? version.arkeod_version || "(unknown)" : "Unavailable";

            const apiUrlEl = document.getElementById("adminApiUrl");
            if (apiUrlEl) apiUrlEl.textContent = buildBaseUrl(adminHost, DEFAULT_ADMIN_API_PORT) + "/api/version";

            const uiUrlEl = document.getElementById("adminUiUrl");
            if (uiUrlEl) uiUrlEl.textContent = buildBaseUrl(adminHost, DEFAULT_ADMIN_UI_PORT);

            const heightEl = document.getElementById("blockHeightDisplay");
            if (heightEl) heightEl.textContent = formatBlockHeight(height);

            const balEl = document.getElementById("balanceDisplay");
            if (balEl) balEl.textContent = formatBalance(balance);

            const pubEl = document.getElementById("overviewPubkeyDisplay");
            const bech32 = (info && info.pubkey && info.pubkey.bech32) || "";
            if (pubEl) {
                if (bech32) {
                    pubEl.textContent = formatPubkeyShort(bech32);
                } else if (!pubEl.textContent || pubEl.textContent === "(unavailable)") {
                    pubEl.textContent = "(unavailable)";
                }
            }

            const hasErrors = !!(version && version.error) || !!(height && height.error) || !!(balance && balance.error);
            setBadge(hasErrors ? "warn" : "ok", hasErrors ? "Partial data" : "Up to date");
        } catch (e) {
            setBadge("err", "Failed to refresh");
        }
    }

    function setSubscriberInput(id, val) {
        const el = document.getElementById(id);
        if (el) el.value = val || "";
    }

    const DEFAULTS = {
        SUBSCRIBER_NAME: "Arkeo Core Subscriber",
        KEY_NAME: "subscriber",
        KEY_KEYRING_BACKEND: "test",
        CHAIN_ID: "arkeo-main-v1",
        ARKEOD_HOME: "/root/.arkeo",
        ARKEOD_NODE: "tcp://127.0.0.1:26657",
        OSMOSIS_RPC: "",
        KEY_MNEMONIC: "",
        ETH_ADDRESS: "",
        ADMIN_PORT: "8079",
        ADMIN_API_PORT: "9998",
        CACHE_FETCH_INTERVAL: "150",
        WALLET_SYNC_INTERVAL: "15",
    };

    function setInputWithDefault(id, val, fallbackKey) {
        const el = document.getElementById(id);
        if (!el) return;
        const finalVal = val || DEFAULTS[fallbackKey] || "";
        el.value = finalVal;
    }

    function setStatusMessage(text, isError = false) {
        const resultEl = document.getElementById("subscriberSettingsResult");
        if (!resultEl) return;
        resultEl.textContent = text || "";
        resultEl.classList.toggle("status-error", isError);
        resultEl.classList.toggle("status-success", !isError && !!text);
        resultEl.classList.toggle("error", isError);
    }

    async function loadSubscriberSettings(showStatus = true) {
        const resultEl = document.getElementById("subscriberSettingsResult");
        if (showStatus && resultEl) {
            setStatusMessage("Loading subscriber settings...", false);
        }
        try {
            const res = await fetch(resolveApi("/api/subscriber-settings"), { cache: "no-store" });
            const data = await res.json();
            if (!res.ok) {
                throw new Error(data && data.error ? data.error : res.statusText);
            }
            subscriberSettingsCache = data.settings || {};
            await loadAdminPassword();
            setInputWithDefault("subscriberName", subscriberSettingsCache.SUBSCRIBER_NAME, "SUBSCRIBER_NAME");
            setInputWithDefault("keyName", subscriberSettingsCache.KEY_NAME, "KEY_NAME");
            const backendLabel = document.getElementById("keyBackendLabel");
            const backendVal = document.getElementById("keyBackendValue");
            const backendText = subscriberSettingsCache.KEY_KEYRING_BACKEND || DEFAULTS.KEY_KEYRING_BACKEND;
            if (backendLabel) backendLabel.textContent = backendText;
            if (backendVal) backendVal.textContent = backendText;
        setInputWithDefault("chainId", subscriberSettingsCache.CHAIN_ID, "CHAIN_ID");
        const homeLabel = document.getElementById("arkeodHomeLabel");
        const homeVal = document.getElementById("arkeodHomeValue");
        const homeText = subscriberSettingsCache.ARKEOD_HOME || DEFAULTS.ARKEOD_HOME;
        if (homeLabel) homeLabel.textContent = homeText ? `(${homeText})` : "";
        if (homeVal) homeVal.textContent = homeText || "(read-only)";
        setInputWithDefault("arkeodNode", subscriberSettingsCache.ARKEOD_NODE, "ARKEOD_NODE");
        setInputWithDefault("osmoRpc", subscriberSettingsCache.OSMOSIS_RPC, "OSMOSIS_RPC");
        setSubscriberInput("hotwalletMnemonic", subscriberSettingsCache.KEY_MNEMONIC);
        setInputWithDefault("adminPort", subscriberSettingsCache.ADMIN_PORT, "ADMIN_PORT");
        setInputWithDefault("adminApiPort", subscriberSettingsCache.ADMIN_API_PORT, "ADMIN_API_PORT");
            setInputWithDefault("cacheFetchInterval", subscriberSettingsCache.CACHE_FETCH_INTERVAL, "CACHE_FETCH_INTERVAL");
            setInputWithDefault("walletSyncInterval", subscriberSettingsCache.WALLET_SYNC_INTERVAL, "WALLET_SYNC_INTERVAL");
            const pubEl = document.getElementById("subscriberPubkeyDisplay");
            const pubkey = data.pubkey && data.pubkey.bech32 ? data.pubkey.bech32 : "";
            if (pubEl) pubEl.textContent = pubkey ? pubkey : "(unavailable)";
            const overviewEl = document.getElementById("overviewPubkeyDisplay");
            if (overviewEl) overviewEl.textContent = pubkey ? formatPubkeyShort(pubkey) : "(unavailable)";
            if (resultEl) {
                resultEl.textContent = `Loaded subscriber settings${data.subscriber_settings_path ? ` from ${data.subscriber_settings_path}` : ""}.`;
            }
        } catch (e) {
            if (resultEl) resultEl.textContent = `Failed to load subscriber settings: ${e}`;
        }
    }

    async function saveSubscriberSettings(event) {
        if (event && event.preventDefault) event.preventDefault();
        const normalizeRpc = (val) => {
            if (!val) return "";
            const trimmed = String(val).trim();
            const lower = trimmed.toLowerCase();
            if (lower.startsWith("tcp://")) return trimmed;
            if (lower.startsWith("http://")) return "tcp://" + trimmed.slice("http://".length);
            if (lower.startsWith("https://")) return "tcp://" + trimmed.slice("https://".length);
            return trimmed;
        };
        const payload = {
            settings: {
                SUBSCRIBER_NAME: document.getElementById("subscriberName")?.value || DEFAULTS.SUBSCRIBER_NAME,
                KEY_NAME: document.getElementById("keyName")?.value || DEFAULTS.KEY_NAME,
                KEY_KEYRING_BACKEND: subscriberSettingsCache.KEY_KEYRING_BACKEND || DEFAULTS.KEY_KEYRING_BACKEND,
                CHAIN_ID: document.getElementById("chainId")?.value || DEFAULTS.CHAIN_ID,
                ARKEOD_HOME: subscriberSettingsCache.ARKEOD_HOME || DEFAULTS.ARKEOD_HOME,
                ARKEOD_NODE: normalizeRpc(document.getElementById("arkeodNode")?.value || DEFAULTS.ARKEOD_NODE),
                OSMOSIS_RPC: document.getElementById("osmoRpc")?.value || DEFAULTS.OSMOSIS_RPC,
                KEY_MNEMONIC: document.getElementById("hotwalletMnemonic")?.value || "",
                ADMIN_PORT: document.getElementById("adminPort")?.value || DEFAULTS.ADMIN_PORT,
                ADMIN_API_PORT: document.getElementById("adminApiPort")?.value || DEFAULTS.ADMIN_API_PORT,
                CACHE_FETCH_INTERVAL: document.getElementById("cacheFetchInterval")?.value || DEFAULTS.CACHE_FETCH_INTERVAL,
                WALLET_SYNC_INTERVAL: document.getElementById("walletSyncInterval")?.value || DEFAULTS.WALLET_SYNC_INTERVAL
            },
        };
        const adminPasswordVal = document.getElementById("adminPasswordInput")?.value || "";
        const resultEl = document.getElementById("subscriberSettingsResult");
        let finalMessage = "Saving settings...";
        let isError = false;
        setStatusMessage(finalMessage, false);
        try {
            const res = await fetch(resolveApi("/api/subscriber-settings"), {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
            });
            const data = await res.json();
            if (!res.ok) {
                throw new Error(data && data.error ? data.error : res.statusText);
            }
            subscriberSettingsCache = data.settings || subscriberSettingsCache;
            if (data.pubkey && data.pubkey.bech32) {
                const pubEl = document.getElementById("subscriberPubkeyDisplay");
                if (pubEl) pubEl.textContent = data.pubkey.bech32;
                const overviewEl = document.getElementById("overviewPubkeyDisplay");
                if (overviewEl) overviewEl.textContent = formatPubkeyShort(data.pubkey.bech32);
            } else {
                const pubEl = document.getElementById("subscriberPubkeyDisplay");
                if (pubEl && (!pubEl.textContent || pubEl.textContent === "(unavailable)")) {
                    pubEl.textContent = "(unavailable)";
                }
                const overviewEl = document.getElementById("overviewPubkeyDisplay");
                if (overviewEl && (!overviewEl.textContent || overviewEl.textContent === "(unavailable)")) {
                    overviewEl.textContent = "(unavailable)";
                }
            }
            try {
                await fetch(resolveApi("/api/admin-password"), {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ password: adminPasswordVal }),
                });
                adminPasswordEnabled = !!adminPasswordVal;
            } catch (e) {
                // ignore password save errors to avoid blocking settings save
            }
            if (resultEl) {
                finalMessage = `Saved subscriber settings${data.subscriber_settings_path ? ` to ${data.subscriber_settings_path}` : ""}.`;
            }
            await loadAdminInfo();
            await loadSubscriberSettings(false);
            // Redirect to dashboard after successful save
            window.location.href = "index.html";
        } catch (e) {
            finalMessage = `Failed to save subscriber settings: ${e}`;
            isError = true;
        } finally {
            setStatusMessage(finalMessage, isError);
        }
    }

    async function loadAdminPassword() {
        try {
            const res = await fetch(resolveApi("/api/admin-password"), { cache: "no-store" });
            const data = await res.json();
            adminPasswordEnabled = !!(data && data.enabled);
            const pwd = data && data.password ? data.password : "";
            const adminPwdInput = document.getElementById("adminPasswordInput");
            if (adminPwdInput) adminPwdInput.value = pwd;
        } catch (e) {
            // ignore errors when loading admin password
        }
    }

    async function fetchAdminPasswordStatus(showGate = true) {
        try {
            const res = await fetch(resolveApi("/api/session"), { cache: "no-store" });
            const data = await res.json();
            adminPasswordEnabled = !!(data && data.enabled);
            adminSessionAuthed = !!(data && data.authed);
        } catch (e) {
            adminPasswordEnabled = false;
            adminSessionAuthed = false;
        }
        if (adminPasswordEnabled && !adminSessionAuthed) {
            sessionStorage.removeItem("adminAuthed");
        }
        const gate = document.getElementById("adminPasswordGate");
        const gateAuthed = sessionStorage.getItem("adminAuthed") === "1" || adminSessionAuthed;
        if (gate) {
            if (showGate && adminPasswordEnabled && !gateAuthed) {
                gate.classList.remove("hidden");
            } else {
                gate.classList.add("hidden");
            }
        }
    }

    async function submitAdminPasswordGate() {
        const input = document.getElementById("adminPasswordGateInput");
        const statusEl = document.getElementById("adminPasswordGateStatus");
        const pwd = (input && input.value) || "";
        if (statusEl) statusEl.textContent = "Verifying...";
        try {
            const res = await fetch(resolveApi("/api/login"), {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ password: pwd }),
            });
            const data = await res.json();
            if (data && data.ok) {
                sessionStorage.setItem("adminAuthed", "1");
                adminSessionAuthed = true;
                const gate = document.getElementById("adminPasswordGate");
                if (gate) gate.classList.add("hidden");
                if (statusEl) statusEl.textContent = "";
                window.location.href = "index.html";
            } else {
                if (statusEl) statusEl.textContent = "Incorrect password.";
            }
        } catch (e) {
            if (statusEl) statusEl.textContent = `Failed to verify: ${e}`;
        }
    }

    window.addEventListener("load", () => {
        fetchAdminPasswordStatus(true);
        loadAdminInfo();
        loadSubscriberSettings();
        setInterval(loadAdminInfo, 5000);
        maybeShowSettingsRequiredModal();
        try { registerAdminKeplrListener(); } catch (err) { console.warn("Keplr listener not attached", err); }
    });

    function maybeShowSettingsRequiredModal() {
        const params = new URLSearchParams(window.location.search);
        const needs = params.get("needsSettings") === "1" || (window.location.hash || "").toLowerCase().includes("needssettings");
        if (needs) {
            const modal = document.getElementById("settingsRequiredModal");
            if (modal) modal.classList.remove("hidden");
        }
    }

    function dismissSettingsRequired() {
        const modal = document.getElementById("settingsRequiredModal");
        if (modal) modal.classList.add("hidden");
    }
</script>

<div id="settingsRequiredModal" class="overlay hidden">
    <div class="overlay-card">
        <h3>Setup Required</h3>
        <p class="muted">Please configure subscriber settings before using the app.</p>
        <div class="actions center mt-6">
            <button class="primary" onclick="dismissSettingsRequired()">Got it</button>
        </div>
    </div>
</div>

</body>
</html>
